/*!
 * SAPUI5

(c) Copyright 2009-2019 SAP SE. All rights reserved
 */
sap.ui.define(['sap/chart/data/TimeDimension','sap/chart/utils/MeasureSemanticsUtils','sap/chart/utils/ChartUtils','sap/chart/utils/DateFormatUtil','sap/chart/data/MeasureSemantics','sap/chart/ChartLog',"sap/ui/thirdparty/jquery"],function(T,M,C,D,c,d,q){"use strict";function R(F){this._bTimeFed=false;}R.prototype.toFeedingId=function(o){if(o instanceof T&&!this._bTimeFed){this._bTimeFed=true;return"timeAxis";}else{return"@context";}};function e(a){return C.CONFIG.timeChartTypes.indexOf(a)>-1;}function s(S,m,o){var a={actualValues:[],targetValues:[]};q.each(S,function(i,t){if(t.actual){a.actualValues.push(m[t.actual]);t.valueAxisID='actualValues';}if(t.projected){a.actualValues.push(m[t.projected]);t.valueAxisID='actualValues';}if(t.reference){if((t.actual||t.projected)){a.targetValues.push(m[t.reference]);t.valueAxisID='targetValues';}else{a.actualValues.push(m[t.reference]);t.valueAxisID='actualValues';}}});delete o["@semanticBulletMsrs"];q.extend(o,a);}function f(S,m){var a=m["@semanticBulletMsrs"];if(a){var F={actualValues:[]};for(var i=0;i<a.length;i++){F.actualValues.push(a[i]);}for(var i=0;i<S.length;i++){S[i].valueAxisID='actualValues';}delete m["@semanticBulletMsrs"];q.extend(m,F);}}R.semantics={hasSemanticMeasures:function(F){return Object.keys(F.msrs).some(function(k){var r=false;var m=F.msrs[k];r=m.some(function(a){if(a.getSemantics){var b=a.getSemantics();return b&&b!=='actual';}});return r;});},semanticPatternMsrs:function(F,g,I){var A=[],h=[],m={},j,k;var n=e(g)&&(F.dims.timeAxis&&F.dims.timeAxis.length===1);var p;var o;if(n){var t=F.dims.timeAxis[0];p=t.getProjectedValueStartTime();if(p){var r=t.getTimeUnit();if(r==='fiscalyearperiod'||r==='fiscalyear'){o=p;}else{var u=D.getInstance(r);if(u){if(u.parse(p)){o=u.parse(p).getTime();}}else{o=new Date(p).getTime();}}}}var v=['valueAxis','valueAxis2'];var w=Object.keys(F.msrs).sort(function(a,b){return v.indexOf(a)-v.indexOf(b);});var x=this.hasSemanticMeasures(F);w.forEach(function(a){var b=F.msrs[a],H;k=null;q.extend(true,m,b.reduce(function(m,N){m[N.getName()]=N;return m;},{}));if(g&&g.indexOf('bullet')>-1&&F.invisibleMsrs){H=F.invisibleMsrs.filter(function(N){return N.getSemantics()==='actual'&&N.getSemanticallyRelatedMeasures();});}if(q.isEmptyObject(F.dims)){k=new d('error','Semantic Pattern',"Semantic Pattern doesn't work when there is no dimension.");I=I||true;}else if(F.dims.color&&F.dims.color.length>0){k=new d('error','Semantic Pattern',"Semantic pattern doesn't work when there is series dimension.");I=I||true;}var J;J=M.getTuples(b,H,I);if(g&&(g.indexOf('stacked_column')>-1||g.indexOf('stacked_bar')>-1)){var K=false;if(n&&p){if(!o){k=new d('error','Semantic Pattern',"The value of projectedValueStartTime is invalid.");k.display();K=true;}for(var l=0;l<J.length;l++){if(J[l].hasOwnProperty('actual')){if(!(J[l].hasOwnProperty('projected'))){K=true;break;}if(J[l].hasOwnProperty('reference')){K=true;break;}}else{K=true;break;}}}else{var L='';if(J[0].hasOwnProperty('actual')){L='actual';}else if(J[0].hasOwnProperty('projected')){L='projected';}else if(J[0].hasOwnProperty('reference')){L='reference';}if(L==='projected'||L==='reference'){for(var l=0;l<J.length;l++){if(!(J[l].hasOwnProperty(L))){K=true;break;}}}else{for(var l=0;l<J.length;l++){if(J[l].hasOwnProperty('projected')||J[l].hasOwnProperty('reference')){K=true;break;}}}}if(g.indexOf('dual')>-1&&w.length<=1){K=false;}if(K){k=new d('error','Semantic Pattern',"Actual, forecast or target can't be stacked in one bar or column.");I=true;J=M.getTuples(b,H,I);}}J.forEach(function(N){N.valueAxisID=a;});if(x&&I&&k){k.display();}A=A.concat(J);});if(g&&g.indexOf('bullet')>-1){n=n&&A.some(function(z){return z.actual&&z.projected;});j=A.some(function(z){return(z.actual&&z.projected)||(z.actual&&z.reference)||(z.projected&&z.reference);});if(j&&(!n)){s(A,m,F.msrs);}else{f(A,F.msrs);}}if((!I)&&n){k=null;var S=[];var y=function(a){var b=S.indexOf(a.getName())===-1;if(!b){h.push(a);}return b;};for(var i=0;i<A.length;i++){var z=A[i];if(p){if(o){var B=F.msrs[z.valueAxisID];if(z.actual&&z.projected){z.timeAxis=F.dims.timeAxis[0].getName();z.projectedValueStartTime=o;z.semanticMsrName=z.actual+"-"+z.projected;S.push(z.actual);S.push(z.projected);B.push(m[z.actual].clone().setName(z.semanticMsrName));if(A.length===1&&g.indexOf('combination')>-1){k=new d('error','Semantic Pattern',"Do not satisfy the minimum number of measure to work "+"with Projected Value Start Time in Time Series Combination.");}}F.msrs[z.valueAxisID]=B.filter(y);}else{k=new d('error','Semantic Pattern',"The value of projectedValueStartTime is invalid.");}}}if(k){k.display();}}if((A.length>0)&&(!I)){var E=[];var G=['actual','projected','semanticMsrName','reference'];A.forEach(function(a){for(var i=0;i<G.length;i++){if(a[G[i]]){E.push(a[G[i]]);}}});q.each(F.msrs,function(l){F.msrs[l].sort(function(a,b){return E.indexOf(a.getName())-E.indexOf(b.getName());});});}return{semanticTuples:A,contexts:h};}};return R;});
