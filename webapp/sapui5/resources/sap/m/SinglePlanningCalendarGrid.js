/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['./SinglePlanningCalendarUtilities','sap/ui/core/Control','sap/ui/core/LocaleData','sap/ui/core/Locale','sap/ui/core/InvisibleText','sap/ui/core/format/DateFormat','sap/ui/core/date/UniversalDate','sap/ui/core/dnd/DragInfo','sap/ui/core/dnd/DropInfo','sap/ui/core/dnd/DragDropInfo','sap/ui/unified/library','sap/ui/unified/calendar/DatesRow','sap/ui/unified/calendar/CalendarDate','sap/ui/unified/calendar/CalendarUtils','sap/ui/events/KeyCodes','./SinglePlanningCalendarGridRenderer'],function(S,C,L,a,I,D,U,b,c,d,u,e,f,g,K,h){"use strict";var R=69,k=48,B=34,l=25,H=3600000/2,O=60*1000,M=86400000;var m=C.extend("sap.m.SinglePlanningCalendarGrid",{metadata:{library:"sap.m",properties:{startDate:{type:"object",group:"Data"},enableAppointmentsDragAndDrop:{type:"boolean",group:"Misc",defaultValue:false}},aggregations:{appointments:{type:"sap.ui.unified.CalendarAppointment",multiple:true,singularName:"appointment",dnd:{draggable:true}},_columnHeaders:{type:"sap.ui.unified.calendar.DatesRow",multiple:false,visibility:"hidden"},_intervalPlaceholders:{type:"sap.m.SinglePlanningCalendarGrid._internal.IntervalPlaceholder",multiple:true,visibility:"hidden",dnd:{droppable:true}},_blockersPlaceholders:{type:"sap.m.SinglePlanningCalendarGrid._internal.IntervalPlaceholder",multiple:true,visibility:"hidden",dnd:{droppable:true}}},associations:{ariaLabelledBy:{type:"sap.ui.core.Control",multiple:true,singularName:"ariaLabelledBy"}},events:{appointmentSelect:{parameters:{appointment:{type:"sap.ui.unified.CalendarAppointment"}}},appointmentDrop:{parameters:{appointment:{type:"sap.ui.unified.CalendarAppointment"},startDate:{type:"object"},endDate:{type:"object"},copy:{type:"boolean"}}}}}});m.prototype.init=function(){var s=new Date(),o=new e(this.getId()+"-columnHeaders",{showDayNamesLine:false,showWeekNumbers:false,startDate:s}).addStyleClass("sapMSinglePCColumnHeader"),i=(60-s.getSeconds())*1000;this.setAggregation("_columnHeaders",o);this.setStartDate(s);this._setColumns(7);this._configureBlockersDragAndDrop();this._configureAppointmentsDragAndDrop();this._oUnifiedRB=sap.ui.getCore().getLibraryResourceBundle("sap.ui.unified");this._oFormatAria=D.getDateTimeInstance({pattern:"EEEE dd/MM/YYYY 'at' HH:mm:ss a"});setTimeout(this._updateRowHeaderAndNowMarker.bind(this),i);};m.prototype.onBeforeRendering=function(){var A=this._createAppointmentsMap(this.getAppointments()),s=this.getStartDate(),o=f.fromLocalJSDate(s),i=this._getColumns();this._oVisibleAppointments=this._calculateVisibleAppointments(A.appointments,this.getStartDate(),i);this._oAppointmentsToRender=this._calculateAppointmentsLevelsAndWidth(this._oVisibleAppointments);this._aVisibleBlockers=this._calculateVisibleBlockers(A.blockers,o,i);this._oBlockersToRender=this._calculateBlockersLevelsAndWidth(this._aVisibleBlockers);if(this._iOldColumns!==i||this._oOldStartDate!==s){this._createBlockersDndPlaceholders(s,i);this._createAppointmentsDndPlaceholders(s,i);}};m.prototype._configureBlockersDragAndDrop=function(){this.addDragDropConfig(new d({sourceAggregation:"appointments",targetAggregation:"_blockersPlaceholders",dragStart:function(E){if(!this.getEnableAppointmentsDragAndDrop()){E.preventDefault();return false;}var i=function(){var o=jQuery(".sapMSinglePCOverlay");setTimeout(function(){o.addClass("sapMSinglePCOverlayDragging");});jQuery(document).one("dragend",function(){o.removeClass("sapMSinglePCOverlayDragging");});};i();}.bind(this),dragEnter:function(E){var o=E.getParameter("dragSession"),A=o.getDragControl(),i=o.getDropControl(),j=this.isAllDayAppointment(A.getStartDate(),A.getEndDate()),p=function(){var $=jQuery(o.getIndicator()),q=A.$().outerHeight(),r=A.$().outerWidth(),G=i.$().closest(".sapMSinglePCBlockersColumns").get(0).getBoundingClientRect(),s=i.getDomRef().getBoundingClientRect(),t=(s.left+r)-(G.left+G.width);if(j){$.css("min-height",q);$.css("min-width",Math.min(r,r-t));}else{$.css("min-height",o.getDropControl().$().outerHeight());$.css("min-width",o.getDropControl().$().outerWidth());}};if(!o.getIndicator()){setTimeout(p,0);}else{p();}}.bind(this),drop:function(E){var o=E.getParameter("dragSession"),A=o.getDragControl(),p=o.getDropControl(),s=p.getDate().getJSDate(),i,j=E.getParameter("browserEvent"),q=(j.metaKey||j.ctrlKey),r=this.isAllDayAppointment(A.getStartDate(),A.getEndDate());i=new Date(s);if(r){i.setMilliseconds(A.getEndDate().getTime()-A.getStartDate().getTime());}this.$().find(".sapMSinglePCOverlay").removeClass("sapMSinglePCOverlayDragging");if(r&&A.getStartDate().getTime()===s.getTime()){return;}this.fireAppointmentDrop({appointment:A,startDate:s,endDate:i,copy:q});}.bind(this)}));};m.prototype._configureAppointmentsDragAndDrop=function(){this.addDragDropConfig(new d({sourceAggregation:"appointments",targetAggregation:"_intervalPlaceholders",dragStart:function(E){if(!this.getEnableAppointmentsDragAndDrop()){E.preventDefault();return false;}var i=function(){var o=jQuery(".sapMSinglePCOverlay");setTimeout(function(){o.addClass("sapMSinglePCOverlayDragging");});jQuery(document).one("dragend",function(){o.removeClass("sapMSinglePCOverlayDragging");});};i();}.bind(this),dragEnter:function(E){var o=E.getParameter("dragSession"),A=o.getDragControl(),i=o.getDropControl(),j=this.isAllDayAppointment(A.getStartDate(),A.getEndDate()),p=function(){var $=jQuery(o.getIndicator()),q=A.$().outerHeight(),G=i.$().closest(".sapMSinglePCColumn").get(0).getBoundingClientRect(),r=o.getDropControl().getDomRef().getBoundingClientRect(),s=(r.top+q)-(G.top+G.height);if(j){$.css("min-height",2*o.getDropControl().$().outerHeight());}else{$.css("min-height",Math.min(q,q-s));}};if(!o.getIndicator()){setTimeout(p,0);}else{p();}}.bind(this),drop:function(E){var o=E.getParameter("dragSession"),A=o.getDragControl(),p=o.getDropControl(),s=p.getDate().getJSDate(),i,j=E.getParameter("browserEvent"),q=(j.metaKey||j.ctrlKey),r=this.isAllDayAppointment(A.getStartDate(),A.getEndDate());i=new Date(s);if(r){i.setHours(i.getHours()+1);}else{i.setMilliseconds(A.getEndDate().getTime()-A.getStartDate().getTime());}this.$().find(".sapMSinglePCOverlay").removeClass("sapMSinglePCOverlayDragging");if(!r&&A.getStartDate().getTime()===s.getTime()){return;}this.fireAppointmentDrop({appointment:A,startDate:s,endDate:i,copy:q});}.bind(this)}));};m.prototype._adjustAppointmentsHeightforCompact=function(s,o,i){var A,$,j,p,q,r,t,v,w=this._getRowHeight(),x=this;if(this._oAppointmentsToRender[s]){this._oAppointmentsToRender[s].oAppointmentsList.getIterator().forEach(function(y){A=y.getData();$=jQuery("div[data-sap-day='"+s+"'].sapMSinglePCColumn #"+A.getId());j=A.getStartDate();p=A.getEndDate();t=o.getTime()>j.getTime();v=i.getTime()<p.getTime();q=t?0:x._calculateTopPosition(j);r=v?0:x._calculateBottomPosition(p);$.css("top",q);$.css("bottom",r);$.find(".sapUiCalendarApp").css("min-height",w/2-1);});}};m.prototype._adjustBlockersHeightforCompact=function(){var i=this._getBlockersToRender().iMaxlevel,j=(i+1)*this._getBlockerRowHeight(),o=this._getBlockerRowHeight();if(i>0){j=j+3;}this.$().find(".sapMSinglePCBlockersColumns").css("height",j);this._oBlockersToRender.oBlockersList.getIterator().forEach(function(p){p.getData().$().css("top",o*p.level+1);});};m.prototype.onAfterRendering=function(){var j=this._getColumns(),s=this.getStartDate(),r=this._getRowHeight();if(r===k){for(var i=0;i<j;i++){var o=new f(s.getFullYear(),s.getMonth(),s.getDate()+i),p=this._formatDayAsString(o),q=new U(o.getYear(),o.getMonth(),o.getDate(),this._getVisibleStartHour()),t=new U(o.getYear(),o.getMonth(),o.getDate(),this._getVisibleEndHour(),59,59);this._adjustAppointmentsHeightforCompact(p,q,t);}this._adjustBlockersHeightforCompact();}};m.prototype.onkeydown=function(E){var A;if(E.which===K.SPACE||E.which===K.ENTER){A=sap.ui.getCore().byId(E.target.id);if(A&&A.isA("sap.ui.unified.CalendarAppointment")){this._toggleAppointmentSelection(A,!(E.ctrlKey||E.metaKey));this.fireAppointmentSelect({appointment:A});}E.preventDefault();}};m.prototype.setStartDate=function(s){this._oOldStartDate=this.getStartDate();this.getAggregation("_columnHeaders").setStartDate(s);return this.setProperty("startDate",s);};m.prototype.getSelectedAppointments=function(){return this.getAppointments().filter(function(A){return A.getSelected();});};m.prototype._toggleAppointmentSelection=function(A,r){var j,i,o;if(r){j=this.getAppointments();for(i=0,o=j.length;i<o;i++){if(j[i].getId()!==A.getId()&&j[i].getSelected()){j[i].setProperty("selected",false,true);jQuery('[data-sap-ui='+j[i].getId()+']').find(".sapUiCalendarApp").removeClass("sapUiCalendarAppSel");}}}A.setProperty("selected",!A.getSelected(),true);jQuery('[data-sap-ui='+A.getId()+']').find(".sapUiCalendarApp").toggleClass("sapUiCalendarAppSel",A.getSelected());};m.prototype.ontap=function(E){var A=sap.ui.getCore().byId(E.target.parentElement.id);if(A&&A.isA("sap.ui.unified.CalendarAppointment")){this._toggleAppointmentSelection(A,!(E.ctrlKey||E.metaKey));this.fireAppointmentSelect({appointment:A});}};m.prototype._getVisibleStartHour=function(){return 0;};m.prototype._getVisibleEndHour=function(){return 23;};m.prototype._isVisibleHour=function(){return true;};m.prototype._isOutsideVisibleHours=function(){return false;};m.prototype._shouldHideRowHeader=function(r){var i=new Date().getHours(),j=g._areCurrentMinutesLessThan(15)&&i===r,o=g._areCurrentMinutesMoreThan(45)&&i===r-1;return j||o;};m.prototype._formatDayAsString=function(o){var r=""+o.getYear(),s=o.getMonth(),i=o.getDate();if(s<10){r+="0";}r+=s;if(i<10){r+="0";}r+=i;return r;};m.prototype._formatTimeAsString=function(o){var p=this._getHoursPattern()+":mm",F=D.getDateTimeInstance({pattern:p},new a(this._getCoreLocaleId()));return F.format(o);};m.prototype._addAMPM=function(o){var A=this._getAMPMFormat();return" "+A.format(o);};m.prototype._calculateTopPosition=function(o){var i=o.getHours()-this._getVisibleStartHour(),j=o.getMinutes(),r=this._getRowHeight();return(r*i)+(r/60)*j;};m.prototype._calculateBottomPosition=function(o){var i=this._getVisibleEndHour()+1-o.getHours(),j=o.getMinutes(),r=this._getRowHeight();return(r*i)-(r/60)*j;};m.prototype._updateRowHeaderAndNowMarker=function(){var o=new Date();this._updateNowMarker(o);this._updateRowHeaders(o);setTimeout(this._updateRowHeaderAndNowMarker.bind(this),O);};m.prototype._updateNowMarker=function(o){var $=this.$("nowMarker"),i=this.$("nowMarkerText"),j=this.$("nowMarkerAMPM"),p=this._isOutsideVisibleHours(o.getHours());$.toggleClass("sapMSinglePCNowMarkerHidden",p);$.css("top",this._calculateTopPosition(o)+"px");i.text(this._formatTimeAsString(o));j.text(this._addAMPM(o));i.append(j);};m.prototype._updateRowHeaders=function(o){var $=this.$(),i=o.getHours(),N=i+1;$.find(".sapMSinglePCRowHeader").removeClass("sapMSinglePCRowHeaderHidden");if(this._shouldHideRowHeader(i)){$.find(".sapMSinglePCRowHeader"+i).addClass("sapMSinglePCRowHeaderHidden");}else if(this._shouldHideRowHeader(N)){$.find(".sapMSinglePCRowHeader"+N).addClass("sapMSinglePCRowHeaderHidden");}};m.prototype._createAppointmentsMap=function(A){var t=this;return A.reduce(function(o,i){var j=i.getStartDate(),p=i.getEndDate(),q,r,s;if(!j||!p){return o;}if(!t.isAllDayAppointment(j,p)){q=f.fromLocalJSDate(j);r=f.fromLocalJSDate(p);while(q.isSameOrBefore(r)){s=t._formatDayAsString(q);if(!o.appointments[s]){o.appointments[s]=[];}o.appointments[s].push(i);q.setDate(q.getDate()+1);}}else{o.blockers.push(i);}return o;},{appointments:{},blockers:[]});};m.prototype._calculateVisibleAppointments=function(A,s,j){var v={},o,p,q;for(var i=0;i<j;i++){o=new f(s.getFullYear(),s.getMonth(),s.getDate()+i);p=this._formatDayAsString(o);q=this._isAppointmentFitInVisibleHours(o);if(A[p]){v[p]=A[p].filter(q,this).sort(this._sortAppointmentsByStartHourCallBack);}}return v;};m.prototype._isAppointmentFitInVisibleHours=function(o){return function(A){var i=A.getStartDate().getTime(),j=A.getEndDate().getTime(),p=(new U(o.getYear(),o.getMonth(),o.getDate(),this._getVisibleStartHour())).getTime(),q=(new U(o.getYear(),o.getMonth(),o.getDate(),this._getVisibleEndHour(),59,59)).getTime();var r=i<p&&j>q,s=i>=p&&i<q,E=j>p&&j<=q;return r||s||E;};};m.prototype._calculateAppointmentsLevelsAndWidth=function(v){var t=this;return Object.keys(v).reduce(function(A,s){var i=0,o=new S.list(),j=v[s];j.forEach(function(p){var q=new S.node(p),r=p.getStartDate().getTime();if(o.getSize()===0){o.add(q);return;}o.getIterator().forEach(function(w){var x=true,y=w.getData(),z=y.getStartDate().getTime(),E=y.getEndDate().getTime(),F=E-z;if(F<H){E=E+(H-F);}if(r>=z&&r<E){q.level++;i=Math.max(i,q.level);}if(w.next&&w.next.level===q.level){x=false;}if(r>=E&&x){this.interrupt();}});o.insertAfterLevel(q.level,q);});A[s]={oAppointmentsList:t._calculateAppointmentsWidth(o),iMaxLevel:i};return A;},{});};m.prototype._calculateAppointmentsWidth=function(A){A.getIterator().forEach(function(o){var i=o.getData(),j=o.level,p=o.level,q=i.getStartDate().getTime(),r=i.getEndDate().getTime(),s=r-q;if(s<H){r=r+(H-s);}new S.iterator(A).forEach(function(t){var v=t.getData(),w=t.level,x=v.getStartDate().getTime(),y=v.getEndDate().getTime(),z=y-x;if(z<H){y=y+(H-z);}if(p>=w){return;}if(q>=x&&q<y||r>x&&r<y||q<=x&&r>=y){o.width=w-p;this.interrupt();return;}if(j<w){j=w;o.width++;}});});return A;};m.prototype._calculateVisibleBlockers=function(i,o,j){var p=new f(o.getYear(),o.getMonth(),o.getDate()+j),q=this._isBlockerVisible(o,p);return i.filter(q).sort(this._sortAppointmentsByStartHourCallBack);};m.prototype._isBlockerVisible=function(v,V){return function(A){var o=f.fromLocalJSDate(A.getStartDate()),i=f.fromLocalJSDate(A.getEndDate());var j=o.isBefore(v)&&i.isAfter(V),s=o.isSameOrAfter(v)&&o.isBefore(V),E=g._isBetween(i,v,V,true);return j||s||E;};};m.prototype._calculateBlockersLevelsAndWidth=function(v){var i=0,o=new S.list();v.forEach(function(j){var p=new S.node(j),q=f.fromLocalJSDate(j.getStartDate()),r=f.fromLocalJSDate(j.getEndDate());p.width=g._daysBetween(r,q);if(o.getSize()===0){o.add(p);return;}o.getIterator().forEach(function(s){var t=true,w=s.getData(),x=f.fromLocalJSDate(w.getStartDate()),y=f.fromLocalJSDate(w.getEndDate());if(q.isSameOrAfter(x)&&q.isBefore(y)){p.level++;i=Math.max(i,p.level);}if(s.next&&s.next.level===p.level){t=false;}if(q.isSameOrAfter(y)&&t){this.interrupt();}});o.insertAfterLevel(p.level,p);},this);return{oBlockersList:o,iMaxlevel:i};};m.prototype._sortAppointmentsByStartHourCallBack=function(A,o){return A.getStartDate().getTime()-o.getStartDate().getTime()||o.getEndDate().getTime()-A.getEndDate().getTime();};m.prototype._getVisibleAppointments=function(){return this._oVisibleAppointments;};m.prototype._getAppointmentsToRender=function(){return this._oAppointmentsToRender;};m.prototype._getVisibleBlockers=function(){return this._aVisibleBlockers;};m.prototype._getBlockersToRender=function(){return this._oBlockersToRender;};m.prototype._setColumns=function(i){this._iOldColumns=this._iColumns;this._iColumns=i;this.getAggregation("_columnHeaders").setDays(i);this.invalidate();return this;};m.prototype._getColumns=function(){return this._iColumns;};m.prototype._getRowHeight=function(){return this._isCompact()?k:R;};m.prototype._getBlockerRowHeight=function(){return this._isCompact()?l:B;};m.prototype._isCompact=function(){var o=this.getDomRef();while(o&&o.classList){if(o.classList.contains("sapUiSizeCompact")){return true;}o=o.parentNode;}return false;};m.prototype._getCoreLocaleId=function(){if(!this._sLocale){this._sLocale=sap.ui.getCore().getConfiguration().getFormatSettings().getFormatLocale().toString();}return this._sLocale;};m.prototype._getCoreLocaleData=function(){var s,o;if(!this._oLocaleData){s=this._getCoreLocaleId();o=new a(s);this._oLocaleData=L.getInstance(o);}return this._oLocaleData;};m.prototype._hasAMPM=function(){var o=this._getCoreLocaleData();return o.getTimePattern("short").search("a")>=0;};m.prototype._getHoursFormat=function(){var s=this._getCoreLocaleId();if(!this._oHoursFormat||this._oHoursFormat.oLocale.toString()!==s){var o=new a(s),p=this._getHoursPattern();this._oHoursFormat=D.getTimeInstance({pattern:p},o);}return this._oHoursFormat;};m.prototype._getHoursPattern=function(){return this._hasAMPM()?"h":"H";};m.prototype._getAMPMFormat=function(){var s=this._getCoreLocaleId(),o=new a(s);if(!this._oAMPMFormat||this._oAMPMFormat.oLocale.toString()!==s){this._oAMPMFormat=D.getTimeInstance({pattern:"a"},o);}return this._oAMPMFormat;};m.prototype._getColumnHeaders=function(){return this.getAggregation("_columnHeaders");};m.prototype._getAppointmentStartEndInfo=function(A){var s=this._oUnifiedRB.getText("CALENDAR_START_TIME"),E=this._oUnifiedRB.getText("CALENDAR_END_TIME"),F=this._oFormatAria.format(A.getStartDate()),i=this._oFormatAria.format(A.getEndDate());return s+": "+F+"; "+E+": "+i;};m.prototype.enhanceAccessibilityState=function(o,A){if(o.getId()===this._getColumnHeaders().getId()){A.labelledby=I.getStaticId("sap.m","PLANNINGCALENDAR_DAYS");}};m.prototype.isAllDayAppointment=function(A,o){var s=A.getHours()===0,i=A.getMinutes()===0,j=A.getSeconds()===0,p=A.getMilliseconds()===0,q=s&&i&&j&&p,r=false;if(q){r=this._isEndTime0000(A,o);}return r;};m.prototype._isEndTime0000=function(A,o){return(o.getTime()-A.getTime())%M===0;};m.prototype._createBlockersDndPlaceholders=function(s,j){this.destroyAggregation("_blockersPlaceholders");for(var i=0;i<j;i++){var o=new U(s.getFullYear(),s.getMonth(),s.getDate()+i);var p=new n({date:o});this.addAggregation("_blockersPlaceholders",p,true);}};m.prototype._createAppointmentsDndPlaceholders=function(s,o){var p=this._getVisibleStartHour(),E=this._getVisibleEndHour();this._dndPlaceholdersMap={};this.destroyAggregation("_intervalPlaceholders");for(var i=0;i<o;i++){var q=new f(s.getFullYear(),s.getMonth(),s.getDate()+i);if(!this._dndPlaceholdersMap[q]){this._dndPlaceholdersMap[q]=[];}for(var j=p;j<=E;j++){var r=this._dndPlaceholdersMap[q],y=q.getYear(),t=q.getMonth(),v=q.getDate();r.push(this._createAppointmentsDndPlaceHolder(new U(y,t,v,j)));r.push(this._createAppointmentsDndPlaceHolder(new U(y,t,v,j,30)));}}};m.prototype._createAppointmentsDndPlaceHolder=function(o){var p=new n({date:o});this.addAggregation("_intervalPlaceholders",p,true);return p;};var n=C.extend("sap.m.SinglePlanningCalendarGrid._internal.IntervalPlaceholder",{metadata:{properties:{date:{type:"object",group:"Data"}}},renderer:function(r,o){r.write("<div");r.writeControlData(o);r.addClass("sapMSinglePCPlaceholder");r.writeClasses();r.write("></div>");}});return m;});
