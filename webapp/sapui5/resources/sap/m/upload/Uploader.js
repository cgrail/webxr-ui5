/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/Log","sap/m/library","sap/ui/core/Element","sap/ui/core/util/File","sap/ui/Device","sap/ui/core/Item","sap/m/upload/UploadSetItem"],function(L,M,E,F,D,H,U){"use strict";var a=E.extend("sap.m.upload.Uploader",{metadata:{publicMethods:["uploadItem","terminateItem","downloadItem"],properties:{uploadUrl:{type:"string",defaultValue:null},downloadUrl:{type:"string",defaultValue:null}},events:{uploadStarted:{parameters:{item:{type:"sap.m.upload.UploadSetItem"}}},uploadProgressed:{parameters:{item:{type:"sap.m.upload.UploadSetItem"},loaded:{type:"long"},total:{type:"long"}}},uploadCompleted:{parameters:{item:{type:"sap.m.upload.UploadSetItem"}}},uploadAborted:{parameters:{item:{type:"sap.m.upload.UploadSetItem"}}}}}});a.prototype.init=function(){this._mRequestHandlers={};};a.prototype.uploadItem=function(i,h){var x=new window.XMLHttpRequest(),f=i.getFileObject(),t=this,r={xhr:x,item:i};x.open("POST",this.getUploadUrl(),true);if((D.browser.edge||D.browser.internet_explorer)&&f.type&&x.readyState===1){x.setRequestHeader("Content-Type",f.type);}h.forEach(function(o){x.setRequestHeader(o.getKey(),o.getText());});x.upload.addEventListener("progress",function(e){t.fireUploadProgressed({item:i,loaded:e.loaded,total:e.total,aborted:false});});x.onreadystatechange=function(){var o=t._mRequestHandlers[i.getId()];if(this.readyState===window.XMLHttpRequest.DONE&&!o.aborted){t.fireUploadCompleted({item:i});}};this._mRequestHandlers[i.getId()]=r;x.send(i.getFileObject());this.fireUploadStarted({item:i});};a.prototype.terminateItem=function(i){var h=this._mRequestHandlers[i.getId()],t=this;h.xhr.onabort=function(){h.aborted=false;t.fireUploadAborted({item:i});};h.aborted=true;h.xhr.abort();};a.prototype.downloadItem=function(i,h,A){var u=this.getDownloadUrl()||i.getUrl();if(D.browser.name==="sf"){A=false;}if(!i.getUrl()){L.warning("Items to download do not have a URL.");return false;}else if(A){var b=null,x=new window.XMLHttpRequest();x.open("GET",u);h.forEach(function(o){x.setRequestHeader(o.getKey(),o.getText());});x.responseType="blob";x.onload=function(){var f=i.getFileName(),s=U._splitFileName(f,false);b=x.response;F.save(b,s.name,s.extension,i.getMediaType(),"utf-8");};x.send();return true;}else{M.URLHelper.redirect(u,true);return true;}};return a;});
