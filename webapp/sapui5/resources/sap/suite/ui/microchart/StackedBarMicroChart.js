/*!
 * SAPUI5

(c) Copyright 2009-2019 SAP SE. All rights reserved
 */
sap.ui.define(["sap/ui/thirdparty/jquery","./library","sap/ui/core/Control","sap/m/Size","sap/m/ValueColor","sap/ui/Device","sap/m/FlexBox","sap/suite/ui/microchart/MicroChartUtils","sap/ui/core/ResizeHandler"],function(q,l,C,S,V,D,F,M,R){"use strict";var c=C.extend("sap.suite.ui.microchart.StackedBarMicroChart",{metadata:{library:"sap.suite.ui.microchart",properties:{size:{type:"sap.m.Size",group:"Appearance",defaultValue:"Auto"},maxValue:{type:"float",group:"Appearance",defaultValue:null},precision:{type:"int",group:"Appearance",defaultValue:1},width:{type:"sap.ui.core.CSSSize",group:"Misc"},height:{type:"sap.ui.core.CSSSize",group:"Misc"},showLabels:{type:"boolean",group:"Misc",defaultValue:true}},associations:{ariaLabelledBy:{type:"sap.ui.core.Control",multiple:true,singularName:"ariaLabelledBy"}},defaultAggregation:"bars",aggregations:{bars:{type:"sap.suite.ui.microchart.StackedBarMicroChartBar",multiple:true,bindable:"bindable"}},events:{press:{}}}});c.THRESHOLD_SMALL_LOOK=1.125;c.BAR_COLOR_PARAM_DEFAULT="sapUiChartPaletteQualitativeHue";c.BAR_LABEL_CSSCLASS=".sapSuiteStackedMCBarLabel";c.BAR_CSSCLASS=".sapSuiteStackedMCBar";c.prototype.attachEvent=function(){C.prototype.attachEvent.apply(this,arguments);if(this.hasListeners("press")){this.$().attr("tabindex",0).addClass("sapSuiteUiMicroChartPointer");}return this;};c.prototype.detachEvent=function(){C.prototype.detachEvent.apply(this,arguments);if(!this.hasListeners("press")){this.$().removeAttr("tabindex").removeClass("sapSuiteUiMicroChartPointer");}return this;};c.prototype.onclick=function(e){if(D.browser.msie||D.browser.edge){this.$().focus();}if(this.hasListeners("press")){e.stopPropagation();this.firePress();}};c.prototype.onsapspace=c.prototype.onclick;c.prototype.onsapenter=c.prototype.onclick;c.prototype.setMaxValue=function(m){var b=q.isNumeric(m);this.setProperty("maxValue",b?m:null);return this;};c.prototype.setTooltip=function(t){this._title=null;this.setAggregation("tooltip",t,true);};c.prototype._getAccessibilityControlType=function(){return this._oRb.getText("ACC_CTR_TYPE_STACKEDBARMICROCHART");};c.prototype.init=function(){this._oRb=sap.ui.getCore().getLibraryResourceBundle("sap.suite.ui.microchart");this.setAggregation("tooltip","((AltText))",true);this._bThemeApplied=true;if(!sap.ui.getCore().isInitialized()){this._bThemeApplied=false;sap.ui.getCore().attachInit(this._handleCoreInitialized.bind(this));}else{this._handleCoreInitialized();}};c.prototype._handleCoreInitialized=function(){this._bThemeApplied=sap.ui.getCore().isThemeApplied();sap.ui.getCore().attachThemeChanged(this._handleThemeApplied,this);};c.prototype._handleThemeApplied=function(){this._bThemeApplied=true;this.invalidate();};c.prototype.onBeforeRendering=function(){if(this._sChartResizeHandlerId){R.deregister(this._sChartResizeHandlerId);}this.$().unbind("mouseenter");this.$().unbind("mouseleave");};c.prototype.onAfterRendering=function(){l._checkControlIsVisible(this,this._onControlIsVisible);};c.prototype._onControlIsVisible=function(){this._sChartResizeHandlerId=R.register(this,this._onResize.bind(this));this._onResize();this.$().bind("mouseenter",this._addTitleAttribute.bind(this));this.$().bind("mouseleave",this._removeTitleAttribute.bind(this));};c.prototype.exit=function(){R.deregister(this._sChartResizeHandlerId);};c.prototype._getLocalizedColorMeaning=function(a){return this._oRb.getText(("SEMANTIC_COLOR_"+a).toUpperCase());};c.prototype._calculateChartData=function(){var d=[];var e=this.getBars();var I=e.length;var f=12;var g=1;var p=this.getPrecision();var n=function(){if(f){if(g===f){g=1;}return c.BAR_COLOR_PARAM_DEFAULT+(g++);}};var t=0;var m=this.getMaxValue();var i=0;for(i;i<I;i++){if(!isNaN(e[i].getValue())){t=t+e[i].getValue();}}var T=Math.max(m,t);var v=m>=t;var P=0;var w=0;var o;for(i=0;i<I;i++){o={oBarData:e[i]};o.color=e[i].getValueColor();if(!o.color){o.color=n();}var h=isNaN(e[i].getValue())?0:e[i].getValue();var j=T===0?0:h*100/T;o.value=this._roundFloat(j,p);o.width=this._roundFloat(j,2);P=P+o.value;w=w+o.width;if(v){o.displayValue=e[i].getDisplayValue()||String(h);}else{o.displayValue=e[i].getDisplayValue()||String(o.value+"%");}d.push(o);}P=this._roundFloat(P,p);w=this._roundFloat(w,2);var k;if(w>100&&d.length>0){k=d.slice(0).sort(function(a,b){return b.width-a.width;})[0];k.width=this._roundFloat(k.width-w+100,2);}if(m>t){o={value:this._roundFloat(100-P,p),width:this._roundFloat(100-w,2)};d.push(o);}else if(d.length>0&&w<100){k=d.slice(0).sort(function(a,b){return b.width-a.width;})[0];k.width=this._roundFloat(k.width-w+100,2);}return d;};c.prototype._roundFloat=function(n,p){return parseFloat(n.toFixed(p));};c.prototype._onResize=function(){this._resizeVertically();this._resizeHorizontally();};c.prototype._resizeVertically=function(){var $=this.$();var i=parseFloat($.height());if(i<=this.convertRemToPixels(c.THRESHOLD_SMALL_LOOK)){$.addClass("sapSuiteStackedMCSmallLook");}else{$.removeClass("sapSuiteStackedMCSmallLook");}};c.prototype._resizeHorizontally=function(){this._hideTruncatedLabels(c.BAR_LABEL_CSSCLASS);};c.prototype._hideTruncatedLabels=function(a){var $=this.$();var L=$.find(a);L.removeClass("sapSuiteStackedMCBarLabelHidden");for(var i=0;i<L.length;i++){if(this._isLabelTruncated(L[i])){$.find(L[i]).addClass("sapSuiteStackedMCBarLabelHidden");}}};c.prototype._getAltHeaderText=function(I){var a=this._calculateChartData(),t=this._oRb.getText("STACKEDBARMICROCHART");if(I){t+=" "+this._oRb.getText("IS_ACTIVE");}t+="\n";if(!this._hasData()){t+=this._oRb.getText("NO_DATA");return t;}var d,b,B,A=false;for(var i=0;i<a.length;i++){d=a[i];b=d.oBarData;B=b&&b.getTooltip_AsString();if(b&&b._isTooltipSuppressed()){continue;}if(A){t+="\n";}A=true;if(B){t+=B;}else if(d.displayValue){t+=d.displayValue;if(V[d.color]){t+=" "+this._getLocalizedColorMeaning(d.color);}}}return t;};c.prototype._isTooltipSuppressed=function(){var t=this.getTooltip_AsString();return t&&q.trim(t).length===0;};c.prototype._addTitleAttribute=function(){if(this.$().attr("title")){return;}if(!this._title&&this._hasData()){this._title=this.getTooltip_AsString();}if(this._title){this.$().attr("title",this._title);}};c.prototype._removeTitleAttribute=function(){if(this.$().attr("title")){this._title=this.$().attr("title");this.$().removeAttr("title");}};c.prototype._hasData=function(){return this.getBars().length>0;};c.prototype.firePress=function(){if(this._hasData()){C.prototype.fireEvent.call(this,"press",arguments);}};M.extendMicroChart(c);return c;});
