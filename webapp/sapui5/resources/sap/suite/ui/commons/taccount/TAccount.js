sap.ui.define(["sap/suite/ui/commons/library","sap/ui/Device","sap/ui/core/Control","sap/ui/core/delegate/ItemNavigation","./TAccountGroup","sap/ui/core/IconPool","sap/ui/core/Icon","sap/ui/core/InvisibleText","sap/base/security/encodeXML","./TAccountUtils","sap/suite/ui/commons/Utils","sap/ui/thirdparty/jqueryui/jquery-ui-core","sap/ui/thirdparty/jqueryui/jquery-ui-widget","sap/ui/thirdparty/jqueryui/jquery-ui-mouse","sap/ui/thirdparty/jqueryui/jquery-ui-draggable","sap/ui/thirdparty/jqueryui/jquery-ui-droppable","sap/ui/thirdparty/jqueryui/jquery-ui-selectable"],function(l,D,C,I,T,a,b,c,e,d,U){"use strict";var r=sap.ui.getCore().getLibraryResourceBundle("sap.suite.ui.commons");var f=Object.freeze({UP:"UP",DOWN:"DOWN",PREVIOUS:"PREVIOUS",NEXT:"NEXT"});var s=D.os.macintosh?"metaKey":"ctrlKey";var g=C.extend("sap.suite.ui.commons.taccount.TAccount",{metadata:{library:"sap.suite.ui.commons",properties:{measureOfUnit:{type:"string",group:"Misc",defaultValue:""},collapsed:{type:"boolean",group:"Misc",defaultValue:false},title:{type:"string",group:"Misc",defaultValue:null},subtitle:{type:"string",group:"Misc",defaultValue:null},orderBy:{type:"string",group:"Misc",defaultValue:""},opening:{type:"boolean",group:"Misc",defaultValue:false},openingDebit:{type:"float",group:"Misc",defaultValue:0},openingCredit:{type:"float",group:"Misc",defaultValue:0}},aggregations:{debit:{type:"sap.suite.ui.commons.taccount.TAccountItem",multiple:true,singularName:"debit"},credit:{type:"sap.suite.ui.commons.taccount.TAccountItem",multiple:true,singularName:"credit"}}},renderer:function(R,A){var w=function(j,k){j.forEach(function(m,i){m._bIsDebit=k;m._index=i+1;m._indexSize=j.length;R.renderControl(m);});};var W=function(j){var k=A.getOrderBy();j.forEach(function(m){var p=m.getProperties();m._sOrderBy="";for(var i=0;i<p.length;i++){if(p[i].getKey().toLowerCase()===k.toLowerCase()){m._sOrderBy=p[i].getValue();break;}}});j.sort(function(i,m){return new Date(i._sOrderBy)>=new Date(m._sOrderBy)?1:-1;});A._setItemsAttrs(j);j.forEach(function(i){R.renderControl(i.addStyleClass(i._bIsDebit?"sapSuiteUiCommonsAccountItemLeft":"sapSuiteUiCommonsAccountItemRight"));});};var h=function(i){var j=i?A.getDebit():A.getCredit(),k=i?A.getOpeningDebit():A.getOpeningCredit();j.forEach(function(m){k+=m.getValue();});return d.formatCurrency(k,A.getMeasureOfUnit());};var u=A.getMeasureOfUnit(),o=d.formatCurrency(A.getOpeningDebit(),u),O=d.formatCurrency(A.getOpeningCredit(),u);R.write("<div");if(A.getCollapsed()){R.addClass("sapSuiteUiCommonsAccountCollapsed");}R.addClass("sapSuiteUiCommonsAccount");R.writeClasses(A);R.writeControlData(A);R.writeAttribute("role","region");R.writeAttribute("aria-labelledby",A.getId()+"-title"+" "+A.getId()+"-sum");R.writeAttribute("aria-describedby",A.getId());R.writeAttributeEscaped("aria-label",A._getAriaLabelText());R.writeAttribute("tabindex","0");R.write(">");R.write("<div class=\"sapSuiteUiCommonsTAccountDropZoneTop\"></div>");R.write("<div class=\"sapSuiteUiCommonsTAccountDropZoneBottom\"></div>");R.write("<div class=\"sapSuiteUiCommonsTAccountInfoIconWrapper sapSuiteUiCommonsTAccountBaseInfoIconWrapper\" aria-labelledby=\""+A.getId()+"-mark-text\" title=\""+r.getText("TACCOUNT_SELECTED")+"\">");R.renderControl(A._getAriaMarkText());R.write("<div class=\"sapSuiteUiCommonsInfoIcon\">");R.write("!");R.write("</div>");R.write("</div>");R.write("<div class=\"sapSuiteUiCommonsAccountHeader\">");R.write("<div class=\"sapSuiteUiCommonsAccountHeaderFirst\">");R.write("<div");R.addClass("sapSuiteUiCommonsAccountHeaderExpandWrapper");R.writeClasses();R.write(">");R.renderControl(A._getDownArrow());R.write("</div>");var t=e(A.getTitle()).replace(/&#xa;|\n/g,"<br>");if(A.getSubtitle()){var S=e(A.getSubtitle()).replace(/&#xa;|\n/g,"<br>");R.write("<div class=\"sapSuiteUiCommonsAccountHeaderTitleWrapper\">");R.write("<div id=\""+A.getId()+"-title"+"\" class=\"sapSuiteUiCommonsAccountHeaderTitleWithSubtitle\">"+t+"</div>");R.write("<div class=\"sapSuiteUiCommonsAccountHeaderSubtitle\">"+S+"</div>");R.write("</div>");}else{R.write("<span id=\""+A.getId()+"-title"+"\" class=\"sapSuiteUiCommonsAccountHeaderTitle\">"+t+"</span>");}R.write("</div>");R.write("<div class=\"sapSuiteUiCommonsAccountHeaderSecond\">");R.write("<span id=\""+A.getId()+"-sum"+"\" class=\"sapSuiteUiCommonsAccountHeaderSUM\">"+A._getSumText()+"</span>");R.write("</div>");R.write("</div>");R.write("<div id=\""+A.getId()+"-content"+"\" class=\"sapSuiteUiCommonsAccountTWrapper\"");if(A.getCollapsed()){R.write("style=\"display:none\"");}R.write(">");R.write("<div");R.addClass("sapSuiteUiCommonsAccountTHeader");if(A.getOpening()){R.addClass("sapSuiteUiCommonsAccountTHeaderOpening");}R.writeClasses();R.write(">");R.write("<span id=\""+A.getId()+"-debit-text"+"\" class=\"sapSuiteUiCommonsAccountTHeaderTitle\">"+r.getText("TACCOUNT_DEBIT")+"</span>");R.write("<span id=\""+A.getId()+"-credit-text"+"\" class=\"sapSuiteUiCommonsAccountTHeaderTitle\">"+r.getText("TACCOUNT_CREDIT")+"</span>");R.write("</div>");if(A.getOpening()){R.write("<div class=\"sapSuiteUiCommonsAccountOpeningHeader\">");R.write("<span id=\""+A.getId()+"-opening-debit-text"+"\" class=\"sapSuiteUiCommonsAccountTHeaderOpeningDebitTitle\">"+o+" "+u+"</span>");R.write("<span id=\""+A.getId()+"-opening-credit-text"+"\" class=\"sapSuiteUiCommonsAccountTHeaderOpeningCreditTitle\">"+O+" "+u+"</span>");R.write("</div>");}R.write("<div class=\"sapSuiteUiCommonsAccountTBody\"");R.writeAttribute("role","listbox");R.write(">");if(A._isOrdered()){R.write("<div class=\"sapSuiteUiCommonsAccountDebitCredit\"");R.writeAttribute("role","listbox");R.writeAttribute("aria-labelledby",A.getId()+"-debit-text "+A.getId()+"-credit-text");R.write(">");R.write("<div class=\"sapSuiteUiCommonsAccountMiddleBorder\"></div>");W(A.getDebit().concat(A.getCredit()));}else{R.write("<div class=\"sapSuiteUiCommonsAccountDebit\"");R.writeAttribute("role","listbox");R.writeAttribute("aria-labelledby",A.getId()+"-debit-text");R.write(">");w(A.getDebit(),true);}R.write("</div>");if(!A._isOrdered()){R.write("<div class=\"sapSuiteUiCommonsAccountCredit\"");R.writeAttribute("role","listbox");R.writeAttribute("aria-labelledby",A.getId()+"-credit-text");R.write(">");w(A.getCredit(),false);R.write("</div>");}R.write("</div>");if(A.getOpening()){R.write("<div class=\"sapSuiteUiCommonsAccountClosingHeaderLine\"></div>");R.write("<div class=\"sapSuiteUiCommonsAccountClosingHeader\">");R.write("<span id=\""+A.getId()+"-closing-debit-text"+"\" class=\"sapSuiteUiCommonsAccountTHeaderOpeningDebitTitle\">"+h(true)+" "+u+"</span>");R.write("<span id=\""+A.getId()+"-closing-credit-text"+"\" class=\"sapSuiteUiCommonsAccountTHeaderOpeningCreditTitle\">"+h(false)+" "+u+"</span>");R.write("</div>");}R.write("</div>");R.write("</div>");}});g.prototype.onBeforeRendering=function(){this._bRendered=false;};g.prototype.onAfterRendering=function(){var p=this.getParent();this._bRendered=true;this._setupDraggable();this._setupKeyboard();if(p&&this._hasGroupParent(p)&&!p._bRendered){p.addEventDelegate({onAfterRendering:this._setupTooltips.bind(this)});}else{this._setupTooltips();}this.$().find(".sapSuiteUiCommonsAccountGroupCollapseIcon").attr("aria-pressed",!this.getCollapsed());};g.prototype.onsapdownmodifiers=function(E){if(E[s]){this._handleArrowMoveEvent(E,f.DOWN);}};g.prototype.onsapupmodifiers=function(E){if(E[s]){this._handleArrowMoveEvent(E,f.UP);}};g.prototype.onsappreviousmodifiers=function(E){if(E[s]){this._handleArrowMoveEvent(E,f.PREVIOUS);}};g.prototype.onsapnextmodifiers=function(E){if(E[s]){this._handleArrowMoveEvent(E,f.NEXT);}};g.prototype._isOrdered=function(){return!!this.getOrderBy();};g.prototype._setupKeyboard=function(){if(!this._oItemNavigation){this._oItemNavigation=new I();this.addDelegate(this._oItemNavigation);}this._oItemNavigation.setRootDomRef(this.$().find(".sapSuiteUiCommonsAccountTBody")[0]);this._oItemNavigation.setItemDomRefs(this.$().find(".sapSuiteUiCommonsAccountItem"));this._oItemNavigation.setCycling(true);};g.prototype._isInGroup=function(){return this.getParent()instanceof T;};g.prototype._setupDraggable=function(){if(this._isInGroup()){var $=this.$(),p=this.getParent();$.draggable({revert:"invalid",delay:100,helper:function(){return $.clone().width($.width()).css("z-index",500);},opacity:0.6,scope:p.getId()+"-content",handle:".sapSuiteUiCommonsAccountHeader",start:function(){$.addClass("sapSuiteUiCommonsAccountItemDragging");p.$().find(".sapSuiteUiCommonsAccountGroupDroppingArea").addClass("sapSuiteUiCommonsAccountGroupDroppingAreaHighlight");p.$().find(".sapSuiteUiCommonsAccountHeader").css("cursor","grabbing");},stop:function(){$.removeClass("sapSuiteUiCommonsAccountItemDragging");p.$().find(".sapSuiteUiCommonsAccountGroupDroppingArea").removeClass("sapSuiteUiCommonsAccountGroupDroppingAreaHighlight");p.$().find(".sapSuiteUiCommonsAccountHeader").css("cursor","pointer");}});U._setupMobileDraggable($);}};g.prototype._setItemsAttrs=function(h){h.forEach(function(o,i){o._index=i+1;o._indexSize=h.length;});this.getDebit().forEach(function(i){i._bIsDebit=true;});};g.prototype._getExpandAltText=function(h){return(h?r.getText("TACCOUNT_COLLAPSE"):r.getText("TACCOUNT_EXPAND"))+" "+r.getText("TACCOUNT_TITLE");};g.prototype._getDownArrow=function(){if(!this._oArrowDown){this._oArrowDown=new b({alt:this._getExpandAltText(true),decorative:false,src:"sap-icon://navigation-down-arrow",press:function(){this.setCollapsed(!this.getCollapsed());}.bind(this)}).addStyleClass("sapSuiteUiCommonsAccountGroupCollapseIcon");}this._oArrowDown.$().attr("aria-pressed",!this.getCollapsed());return this._oArrowDown;};g.prototype._getAriaMarkText=function(){if(!this._oMarkText){this._oMarkText=new c({id:this.getId()+"-mark-text",text:r.getText("TACCOUNT_SELECTED")});this.addDependent(this._oMarkText);}return this._oMarkText;};g.prototype._getSum=function(){if(!this._iSum){var S=0;this.getCredit().forEach(function(i){S+=i.getValue();});this.getDebit().forEach(function(i){S-=i.getValue();});this._iSum=S;}return this._iSum;};g.prototype._getAriaLabelText=function(){return"T account "+this.getTitle()+" "+this._getSumText();};g.prototype._getSumText=function(){var h=this.getMeasureOfUnit(),v=d.formatCurrency(Math.abs(this._getSum()),h);return(this._getSum()>0?r.getText("TACCOUNT_CREDIT"):r.getText("TACCOUNT_DEBIT"))+": "+v+" "+e(h);};g.prototype._valueChanged=function(i){if(this._bRendered){this._iSum=this._getSum()+i;this.$("sum").text(this._getSumText());var p=this.getParent();if(this._hasGroupParent(p)){p._valueChanged(i);}}};g.prototype._hasGroupParent=function(p){return(p||this.getParent())instanceof T;};g.prototype._handleArrowMoveEvent=function(E,o){this._moveTAccount(o);E.preventDefault();E.stopImmediatePropagation();};g.prototype._moveTAccount=function(o){var $,h,i,m,j=o===f.UP,S=true,k=this.$();var M=function(A){if(i.length===0){S=false;return;}k.detach();$.detach();i[A](k);i[A]($);};if(j||o===f.DOWN){m=j?["next","prev","insertBefore","append"]:["prev","next","insertAfter","prepend"];$=k[m[0]](".sapSuiteUiCommonsAccountGroupDroppingArea");h=k[m[1]]()[m[1]](".sapSuiteUiCommonsAccount");if(h.length!==0){k.detach()[m[2]](h);$.detach()[m[2]](h);}else{i=k.parent()[m[1]](".sapSuiteUiCommonsAccountGroupColumn");M(m[3]);}}else{$=k.prev(".sapSuiteUiCommonsAccountGroupDroppingArea");i=k.parent()[o===f.NEXT?"next":"prev"](".sapSuiteUiCommonsAccountGroupColumn");M("append");}if(S){k.focus();}};g.prototype._setControlKeyName=function(k){s=k;};g.prototype._setupTooltips=function(){var h=function(i){var E=this.$().find(i);if(E[0].clientHeight<E[0].scrollHeight){E.attr("title",E.html());}}.bind(this);if(this.getSubtitle()){h(".sapSuiteUiCommonsAccountHeaderTitleWithSubtitle");h(".sapSuiteUiCommonsAccountHeaderSubtitle");}else{h(".sapSuiteUiCommonsAccountHeaderTitle");}};g.prototype.setCollapsed=function(v){this.setProperty("collapsed",v,true);this._getDownArrow().setSrc(!v?"sap-icon://navigation-down-arrow":"sap-icon://navigation-right-arrow");this._getDownArrow().$().attr("aria-label",this._getExpandAltText(!v));this.$()[v?"addClass":"removeClass"]("sapSuiteUiCommonsAccountCollapsed");this.$().find(".sapSuiteUiCommonsAccountGroupCollapseIcon").attr("aria-pressed",!v);if(this.getDomRef()){this.$("content")[v?"hide":"show"]("medium");}return this;};return g;});
