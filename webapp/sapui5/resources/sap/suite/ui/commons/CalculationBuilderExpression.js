sap.ui.define(["sap/ui/thirdparty/jquery","./library","./CalculationBuilderItem","sap/ui/core/Control","sap/ui/core/ValueState","sap/ui/core/Popup","sap/ui/core/TextAlign","sap/ui/core/delegate/ItemNavigation","sap/m/MessageBox","sap/m/OverflowToolbar","sap/m/OverflowToolbarToggleButton","sap/m/OverflowToolbarButton","sap/m/ToolbarSpacer","sap/m/Title","sap/m/ButtonType","sap/m/Button","sap/m/FlexBox","sap/m/FlexRendertype","sap/m/FlexAlignItems","sap/m/FlexDirection","sap/m/SegmentedButton","sap/m/SegmentedButtonItem","sap/m/StepInput","sap/m/Input","sap/m/InputType","sap/m/Page","sap/m/List","sap/m/ListMode","sap/m/ListType","sap/m/StandardListItem","sap/m/NavContainer","sap/m/SearchField","sap/m/Label","sap/m/Panel","sap/m/ResponsivePopover","sap/m/PlacementType","sap/m/Toolbar","sap/m/MessageStrip","./CalculationBuilderValidationResult","sap/suite/ui/commons/ControlProxy","sap/ui/thirdparty/jqueryui/jquery-ui-core","sap/ui/thirdparty/jqueryui/jquery-ui-widget","sap/ui/thirdparty/jqueryui/jquery-ui-mouse","sap/ui/thirdparty/jqueryui/jquery-ui-draggable","sap/ui/thirdparty/jqueryui/jquery-ui-droppable","sap/ui/thirdparty/jqueryui/jquery-ui-selectable"],function(q,l,C,a,V,P,T,I,M,O,b,c,d,e,B,f,F,g,h,j,S,m,n,o,p,r,L,s,t,u,N,v,w,x,R,y,z,A,D,E){"use strict";var G=l.CalculationBuilderItemType,H=l.CalculationBuilderOperatorType,J=l.CalculationBuilderComparisonOperatorType,K=l.CalculationBuilderLogicalOperatorType;var Q=Object.freeze({PAGE_MAIN:"-pagemain",PAGE_OPERATORS:"-pageoperators",PAGE_CONSTANT:"-pageconstant",PAGE_VARIABLE:"-pagevariable",PAGE_FUNCTIONS:"-pagefunctions"});var U=Object.freeze({OPERATORS_CATEGORY:"sap-icon://attachment-html",CONSTANTS_CATEGORY:"sap-icon://grid",VARIABLES_CATEGORY:"sap-icon://notes",FUNCTIONS_CATEGORY:"sap-icon://chalkboard",DELETE:"sap-icon://delete"});var W=Object.freeze({KEY_PREVIOUS:"previous",KEY_NEXT:"next",MOUSE:"mouse"});var X="##DEFAULT##";var Y=sap.ui.getCore().getLibraryResourceBundle("sap.suite.ui.commons");var Z=a.extend("sap.suite.ui.commons.CalculationBuilderExpression",{metadata:{library:"sap.suite.ui.commons",defaultAggregation:"items",aggregations:{items:{type:"sap.suite.ui.commons.CalculationBuilderItem",multiple:true,singularName:"item",bindable:"bindable"},variables:{type:"sap.suite.ui.commons.CalculationBuilderVariable",multiple:true,singularName:"Variable"},functions:{type:"sap.suite.ui.commons.CalculationBuilderFunction",multiple:true,singularName:"Function"},operators:{type:"sap.ui.core.Item",multiple:true,singularName:"operator"},groups:{type:"sap.suite.ui.commons.CalculationBuilderGroup",multiple:true,singularName:"Group"}},events:{change:{}}},renderer:function(k,$){k.write("<div");k.writeControlData($);k.addClass("sapCalculationBuilderInner");k.writeClasses($);k.write(">");k.write($._renderDelimiter(0));$.getItems().forEach(function(_,i){_._iIndex=i;_._bReadOnly=$._bReadOnly;k.renderControl(_);k.write($._renderDelimiter(i+1));},this);if(!$._bReadOnly){k.renderControl($._getNewItem());}k.write("<div class=\"sapCalculationBuilderSelected\"></div>");k.write("</div>");}});Z.prototype.init=function(){this._aErrors=[];this._bAreSelectedItemsDeleting=false;this._bDragging=false;this._bIsCalculationBuilderRendering=false;};Z.prototype._renderDelimiter=function(i){var k="";k+="<div class=\"sapCalculationBuilderDelimiter sapCalculationBuilderDroppable\" index=\""+i+"\">";k+="<div class=\"sapCalculationBuilderDroppableLine\"></div>";k+="<div class=\"sapCalculationBuilderDroppableCircle\"></div>";k+="<div class=\"sapCalculationBuilderDelimiterNewButton\" index=\""+i+"\">";k+="<span role=\"presentation\" aria-hidden=\"true\" data-sap-ui-icon-content=\"î€¸\""+"class=\"sapUiIcon sapUiIconMirrorInRTL sapCalculationBuilderDelimiterNewButtonIcon\" style=\"font-family:'SAP-icons'\"></span>";k+="</div>";k+="</div>";return k;};Z.prototype.onBeforeRendering=function(){this._reset();this._createPopup();this.getParent()._enableOrDisableExpandAllButton();this._aErrors=this._validateSyntax();this._fireAfterValidation();this._bIsCalculationBuilderRendering=true;};Z.prototype.onAfterRendering=function(){this._bIsCalculationBuilderRendering=false;if(!this._bReadOnly){this._setupDroppable();this._setupSelectable();this._setupNewButtonEvents();}this._setupKeyboard();};Z.prototype.onsapfocusleave=function(){if(!this._bAreSelectedItemsDeleting){this._deselect();}};Z.prototype.onsapenter=function(i){this._handleEnter(i);};Z.prototype.onsapspace=function(i){if(q(i.target).hasClass("sapCalculationBuilderItem")){this._handleSpace(i);}};Z.prototype.onsappreviousmodifiers=function(i){if(i.ctrlKey){this._handleCtrlPrevious(i);}};Z.prototype.onsapnextmodifiers=function(i){if(i.ctrlKey){this._handleCtrlNext(i);}};Z.prototype.onsapdelete=function(i){this._handleDelete(i);};Z.prototype.exit=function(){if(this._oPopover){this._oPopover.destroy();}if(this._oItemNavigation){this.removeDelegate(this._oItemNavigation);this._oItemNavigation.destroy();}};Z.prototype._createPopup=function(){var i={};this._createPopoverLayout(i);this._createPopoverConstantsItems(i);this._createPopoverFunctionsItems(i);this._createPopoverOperatorsItems(i);this._createPopoverNavContainer(i);this._createPopover(i);};Z.prototype._reset=function(){this.getItems().forEach(function(i){i._reset();});if(this._oPopover){this._oPopover.destroy();this._oPopover=null;}};Z.prototype._createPopoverLayout=function(i){var k=function(_){return new f({text:_==="*"?"x":_,press:this._updateOrCreateItem.bind(this,{type:G.Operator,key:_})}).addStyleClass("sapUiTinyMarginEnd");}.bind(this);var $=new F({renderType:g.Div});$.addStyleClass("sapCalculationBuilderItemPopupOperators");Object.keys(H).forEach(function(_){if(this.getParent()._isTokenAllowed(_)){var a1=k(H[_]);if(_===H[","]){this._attachAriaLabelToButton(a1,Y.getText("CALCULATION_BUILDER_COMMA_ARIA_LABEL"));}else if(_===H["-"]){this._attachAriaLabelToButton(a1,Y.getText("CALCULATION_BUILDER_MINUS_ARIA_LABEL"));}$.addItem(a1);}}.bind(this));i.layout=$.getItems().length>0?$:null;};Z.prototype._createPopoverConstantsItems=function(i){if(this.getParent().getAllowStringConstants()){i.constantInput=new o({width:"100%",placeholder:Y.getText("CALCULATION_BUILDER_ADD_CONSTANT_FIELD_PLACEHOLDER_ANY_STRING"),valueStateText:Y.getText("CALCULATION_BUILDER_ADD_CONSTANT_FIELD_PLACEHOLDER_ERROR"),liveChange:function(k){var $=k.getSource(),_=k.getParameter("value"),a1=_.indexOf("\"")===-1;$.setValueState(a1?V.None:V.Error);i.constantInput.okButton.setEnabled(a1);}});}else{i.constantInput=new n({width:"100%",placeholder:Y.getText("CALCULATION_BUILDER_ADD_CONSTANT_FIELD_PLACEHOLDER"),textAlign:T.Right,valueStateText:Y.getText("CALCULATION_BUILDER_ADD_CONSTANT_FIELD_ERROR_TEXT"),displayValuePrecision:3});}};Z.prototype._createPopoverVariablesItems=function(i){if(!i){return[];}var k=[];i.forEach(function(a1){var b1=new u({title:a1._getLabel()});b1._calculationBuilderKey=a1.getKey();k.push(b1);},this);k=k.sort(function(o1,o2){return o1.getTitle().localeCompare(o2.getTitle());});var $=new L({mode:s.SingleSelectMaster,selectionChange:function(a1){this._updateOrCreateItem({type:G.Variable,key:a1.getParameter("listItem")._calculationBuilderKey});}.bind(this),items:k});var _=new v({placeholder:Y.getText("CALCULATION_BUILDER_SEARCH_VARIABLE"),liveChange:function(a1){var b1=a1.getSource().getValue();if(b1||b1===""){$.removeAllItems();k.forEach(function(c1){if(c1.getTitle().toLowerCase().indexOf(b1.toLowerCase())!==-1){$.addItem(c1);}});}}});this._aVariableLists.push($);return[_,$];};Z.prototype._createPopoverFunctionsItems=function(i){var k=this,$=this.getParent();var _=function(a1){return new u({title:a1.title,description:a1.description,type:t.Active,customData:[{key:"functionKey",value:a1.key}],press:a1.press});};i.functionList=new L({mode:s.SingleSelectMaster,itemPress:function(){this.getSelectedItem().firePress();}});$._getAllFunctions().forEach(function(a1){i.functionList.addItem(_({key:a1.key,title:a1.title,description:a1.description,press:k._updateOrCreateItem.bind(k,{key:a1.key,type:a1.type,functionObject:a1.functionObject})}));});};Z.prototype._createPopoverOperatorsItems=function(i){var k=this.getParent();var $=function(d1,e1){var f1=[];Object.keys(d1).forEach(function(g1){var h1,i1,j1=d1[g1];if(k._isTokenAllowed(g1)){if(typeof j1==="object"){i1=j1.getText();h1=j1.getKey();}else{h1=i1=j1;}var k1=new f({text:i1,press:this._updateOrCreateItem.bind(this,{type:e1,key:h1})}).addStyleClass("sapCalculationBuilderPopoverOperatorsButton").addStyleClass("sapUiTinyMarginEnd");if(g1===J["!="]){this._attachAriaLabelToButton(k1,Y.getText("CALCULATION_BUILDER_NOT_EQUAL_ARIA_LABEL"));}f1.push(k1);}}.bind(this));return f1;}.bind(this);var _=function(d1,e1,f1){var g1=$(e1,f1);if(g1.length>0){return new x({content:[new w({width:"100%",text:d1}).addStyleClass("sapUiTinyMarginBottom"),g1]});}return null;};i.operatorsItems=[];if(this.getParent().getAllowComparisonOperators()){var a1=_(Y.getText("CALCULATION_BUILDER_COMPARISON_TITLE_SELECT"),J,G.Operator);a1&&i.operatorsItems.push(a1);}if(this.getParent().getAllowLogicalOperators()){var b1=_(Y.getText("CALCULATION_BUILDER_LOGICAL_TITLE_SELECT"),K,G.Operator);b1&&i.operatorsItems.push(b1);}var c1=this.getParent().getOperators();if(c1.length>0){i.operatorsItems.push(_(Y.getText("CALCULATION_BUILDER_OPERATORS_TITLE"),c1,G.CustomOperator));}};Z.prototype._createPopoverNavContainer=function(i){var k=function(d1){var e1=c1.getPage(d1);c1.to(e1);};var $=function(){var d1=new A({type:"Error",showIcon:true}).addStyleClass("sapUiTinyMarginBegin sapUiTinyMarginEnd sapUiTinyMarginTop");this._aStrips.push(d1);return d1;}.bind(this);this._aStrips=[];var _=[new u({title:Y.getText("CALCULATION_BUILDER_CONSTANTS_TITLE"),type:t.Active,description:Y.getText("CALCULATION_BUILDER_CONSTANTS_CATEGORY_DESCRIPTION"),icon:U.CONSTANTS_CATEGORY,press:k.bind(this,this.getId()+Q.PAGE_CONSTANT)})];var a1=this._createPopoverVariablesItems(this._mGroups[X]);if(a1.length>0){_.push(new u({title:Y.getText("CALCULATION_BUILDER_VARIABLES_TITLE"),description:Y.getText("CALCULATION_BUILDER_VARIABLES_CATEGORY_DESCRIPTION"),icon:U.VARIABLES_CATEGORY,press:k.bind(this,this.getId()+Q.PAGE_VARIABLE),type:t.Active}));}var b1=i.functionList.getItems();if(b1.length>0){_.push(new u({title:Y.getText("CALCULATION_BUILDER_FUNCTIONS_TITLE"),type:t.Active,description:Y.getText("CALCULATION_BUILDER_FUNCTIONS_CATEGORY_DESCRIPTION"),icon:U.FUNCTIONS_CATEGORY,press:k.bind(this,this.getId()+Q.PAGE_FUNCTIONS)}));}if(i.operatorsItems.length>0){_.unshift(new u({title:Y.getText("CALCULATION_BUILDER_OPERATORS_TITLE"),type:t.Active,description:Y.getText("CALCULATION_BUILDER_OPERATORS_CATEGORY_DESCRIPTION"),icon:U.OPERATORS_CATEGORY,press:k.bind(this,this.getId()+Q.PAGE_OPERATORS)}));}this.getGroups().forEach(function(d1){_.push(new u({title:d1._getTitle(),type:t.Active,description:d1.getDescription(),icon:d1.getIcon(),press:k.bind(this,this.getId()+d1.getKey())}));}.bind(this));var c1=new N({defaultTransitionName:"show",navigate:function(d1){var e1=d1.getParameters().to;e1.setFooter(this._getPageFooter(e1.getId(),i));}.bind(this),pages:[new r({id:this.getId()+Q.PAGE_MAIN,title:Y.getText("CALCULATION_BUILDER_DIALOG_TITLE"),content:[$(),i.layout,new F({direction:j.Column,items:[new L({items:_})]}).addStyleClass("sapUiSmallMarginBeginEnd").addStyleClass("sapUiTinyMarginTop").addStyleClass("sapCalculationBuilderNavMainPage")]})]});if(i.operatorsItems.length>0){c1.addPage(new r({id:this.getId()+Q.PAGE_OPERATORS,content:[$(),new F({direction:j.Column,items:[i.operatorsItems]}).addStyleClass("sapUiSmallMarginBeginEnd").addStyleClass("sapUiTinyMarginTop")],showNavButton:true,title:Y.getText("CALCULATION_BUILDER_OPERATORS_PAGE_TITLE"),navButtonPress:k.bind(this,this.getId()+Q.PAGE_MAIN)}));}c1.addPage(new r({id:this.getId()+Q.PAGE_CONSTANT,content:[$(),new F({direction:j.Column,items:[i.constantInput]}).addStyleClass("sapUiSmallMarginBeginEnd").addStyleClass("sapUiTinyMarginTop")],showNavButton:true,title:Y.getText("CALCULATION_BUILDER_CONSTANTS_PAGE_TITLE"),navButtonPress:k.bind(this,this.getId()+Q.PAGE_MAIN)}));if(a1.length>0){c1.addPage(new r({id:this.getId()+Q.PAGE_VARIABLE,content:[$(),new F({direction:j.Column,items:a1}).addStyleClass("sapUiSmallMarginBeginEnd").addStyleClass("sapUiTinyMarginTop")],showNavButton:true,title:Y.getText("CALCULATION_BUILDER_VARIABLES_PAGE_TITLE"),navButtonPress:k.bind(this,this.getId()+Q.PAGE_MAIN)}));}if(b1.length>0){c1.addPage(new r({id:this.getId()+Q.PAGE_FUNCTIONS,content:[$(),new F({direction:j.Column,items:[i.functionList]}).addStyleClass("sapUiSmallMarginBeginEnd").addStyleClass("sapUiTinyMarginTop")],showNavButton:true,title:Y.getText("CALCULATION_BUILDER_FUNCTIONS_PAGE_TITLE"),navButtonPress:k.bind(this,this.getId()+Q.PAGE_MAIN)}));}this.getGroups().forEach(function(d1){var e1=new r({id:this.getId()+d1.getKey(),showNavButton:true,title:d1._getTitle(),navButtonPress:k.bind(this,this.getId()+Q.PAGE_MAIN),content:$()});var f1=d1.getCustomView();if(f1){var g1=new E();g1.setAssociation("control",f1);e1.addContent(g1);}else{e1.addContent(new F({direction:j.Column,items:this._createPopoverVariablesItems(this._mGroups[d1.getKey()])}).addStyleClass("sapUiSmallMarginBeginEnd").addStyleClass("sapUiTinyMarginTop"));}c1.addPage(e1);}.bind(this));i.navContainer=c1;};Z.prototype._callFunctionFireSelection=function(k){this.getGroups().forEach(function(i){if(i.getCustomView()){i.fireSetSelection({key:k});}});};Z.prototype._clearVariableLists=function(){this._aVariableLists.forEach(function(i){var k=i.getSelectedItem();if(k){i.setSelectedItem(k,false);}});this._callFunctionFireSelection();};Z.prototype._setVariableListSelection=function($){for(var i=0;i<this._aVariableLists.length;i++){var _=this._aVariableLists[i],a1=this._aVariableLists[i].getItems();for(var k=0;k<a1.length;k++){if(a1[k]._calculationBuilderKey===$){_.setSelectedItem(a1[k],true);return;}}}this._callFunctionFireSelection($);};Z.prototype._sanitizeStringConstant=function(i){if(this.getParent()._isStringConstant(i)){i=i.substring(1,i.length-1);}return i;};Z.prototype._createPopover=function(k){var $=function(){var _=this._oCurrentItem,a1=k.navContainer.getCurrentPage().getId(),b1=k.functionList.getSelectedItem(),c1,d1,e1;k.constantInput.setValue(this.getParent().getAllowStringConstants()?"":0);this._clearVariableLists();if(b1){k.functionList.setSelectedItem(b1,false);}if(!_){c1=this.getId()+Q.PAGE_MAIN;}else{if(_._isFunction()){e1=_.getKey();c1=this.getId()+Q.PAGE_FUNCTIONS;d1=k.functionList.getItems();for(var i=0;i<d1.length;i++){var f1=d1[i].data("functionKey");if((f1&&f1.toLowerCase())===e1.toLowerCase()){k.functionList.setSelectedItem(d1[i],true);break;}}}else if(_._isConstant()){var g1=this._sanitizeStringConstant(_.getKey());k.constantInput.setValue(g1);c1=this.getId()+Q.PAGE_CONSTANT;}else if(_._isVariable()){this._setVariableListSelection(_.getKey());var h1=_._oVariable||_.getVariable(),i1=(h1&&h1.getGroup())||Q.PAGE_VARIABLE;c1=this.getId()+i1;}else if(_._isSecondaryOperator()){c1=this.getId()+Q.PAGE_OPERATORS;}else{c1=this.getId()+Q.PAGE_MAIN;}}if(c1!==a1){if(c1!==this.getId()+Q.PAGE_MAIN){k.navContainer.backToPage(this.getId()+Q.PAGE_MAIN);}k.navContainer.to(k.navContainer.getPage(c1),"show");}else{k.navContainer.getCurrentPage().setFooter(this._getPageFooter(a1,k));}var j1=this._oCurrentItem&&this._oCurrentItem._getItemError(),k1=j1&&(" "+j1.title);this._aStrips.forEach(function(l1){l1.setVisible(!!j1);l1.setText(k1?Y.getText("CALCULATION_BUILDER_INCORRECT_SYNTAX")+k1:"");});}.bind(this);this._oPopover=new R({showHeader:false,contentWidth:"400px",contentHeight:"450px",placement:y.Bottom,content:[k.navContainer],beforeOpen:$,afterClose:function(){this._bDragging=false;this._clearNewButtonPositions();}.bind(this)});};Z.prototype._getPageFooter=function(i,k){var $=false,_=false,a1=function(){};if(this._oCurrentItem&&!this._oCurrentItem._bIsNew){_=true;}if(i===(this.getId()+Q.PAGE_CONSTANT)){$=k.constantInput.getValueState()===V.None;a1=function(){if(k.constantInput.getValue()!==""){var b1=k.constantInput.getValue();if(this.getParent()&&this.getParent().getAllowStringConstants()&&!q.isNumeric(b1)){b1="\""+b1+"\"";}this._updateOrCreateItem({type:G.Constant,key:b1});k.constantInput.setValueState(V.None);}else{k.constantInput.setValueState(V.Error);}}.bind(this);}k.constantInput.okButton=new f({enabled:$,text:Y.getText("CALCULATION_BUILDER_CONFIRM_BUTTON"),press:a1});return new z({content:[new d(),k.constantInput.okButton,new f({enabled:_,text:Y.getText("CALCULATION_BUILDER_DELETE_BUTTON"),press:this._deleteItem.bind(this)}),new f({text:Y.getText("CALCULATION_BUILDER_CLOSE_BUTTON"),press:this._instantClose.bind(this)})]});};Z.prototype._insertFunctionItems=function(i,k){var $=function(_){i.push(_);};if(k&&k.length>0){k.forEach(function(_){$(_);});}else{$("");}$(")");};Z.prototype._updateOrCreateItem=function(i){var k=!this._oCurrentItem||this._oCurrentItem._bIsNew,$=this.getParent(),_=i.functionObject,a1;if(k){var b1=[i.key];a1=isNaN(this._iCurrentIndex)?this.getItems().length:this._iCurrentIndex;if(_){var c1=i.type===G.Function?_.template:$._convertToTemplate(_.getItems());this._insertFunctionItems(b1,c1);}var d1=this._getKeys();this._smartRender(d1.slice(0,a1).concat(b1,d1.slice(a1)));}else{this._oCurrentItem.setKey(i.key);if(i.type){this._oCurrentItem._sType=i.type;}}this._instantClose();this._fireChange();};Z.prototype._expandAllVariables=function(){this.getItems().forEach(function(i){if(i.isExpandable()){i._expandVariable(false);}});this._fireChange();};Z.prototype._handleDelete=function(i){if(this._isEmptySelected()){return;}this._bAreSelectedItemsDeleting=true;M.show(Y.getText("CALCULATION_BUILDER_DELETE_MESSAGE_TEXT"),{icon:M.Icon.WARNING,title:Y.getText("CALCULATION_BUILDER_DELETE_MESSAGE_TITLE"),actions:[M.Action.YES,M.Action.CANCEL],onClose:function(k){if(k===M.Action.YES){var $=this.$().find(".sapCalculationBuilderSelected .sapCalculationBuilderItem"),_=$.length,a1=$.first(),b1=sap.ui.getCore().byId(a1.attr("id"));if(b1){var c1=this._getKeys();c1.splice(b1._iIndex,_);this._smartRender(c1);this._fireChange();}}this._bAreSelectedItemsDeleting=false;}.bind(this)});};Z.prototype._handleEnter=function(i){var $=q(i.target),k;if(this._oItemNavigation&&!this._bReadOnly){if($.hasClass("sapCalculationBuilderNewItem")){k=this._getNewItem();if(k){k._buttonPress(i);}}else if($.hasClass("sapCalculationBuilderItem")){k=this._getItemById($[0].id);if(k){k._buttonPress(i);}}else if($.hasClass("sapCalculationBuilderItemExpandButton")){k=this._getItemById($.closest(".sapCalculationBuilderItem")[0].id);if(k){k._expandButtonPress(i);}}}};Z.prototype._createVariablesMap=function(){this._mGroups={};this._aVariableLists=[];this.getVariables().forEach(function(i){var k=i.getGroup()||X;if(!this._mGroups[k]){this._mGroups[k]=[];}this._mGroups[k].push(i);}.bind(this));};Z.prototype._handleSpace=function(i){this._selectItem(i.target);};Z.prototype._handleCtrlNext=function(i){this._moveItems(W.KEY_NEXT);};Z.prototype._handleCtrlPrevious=function(i){this._moveItems(W.KEY_PREVIOUS);};Z.prototype._getVariableByKey=function(k){var $=this.getVariables();if(!k){return null;}k=k.toLowerCase();for(var i=0;i<$.length;i++){if($[i].getKey().toLowerCase()===k){return $[i];}}return null;};Z.prototype.setTitle=function(i){var k=this._oToolbarTitle;if(k){k.setText(i);k.setVisible(!!i);}this.setProperty("title",i);};Z.prototype._getKeys=function(){return this.getItems().map(function(i){return i.getKey();});};Z.prototype._deleteItem=function(){var k=this._getKeys();k.splice(this._oCurrentItem._iIndex,1);this._smartRender(k);this._instantClose();this._fireChange();};Z.prototype._openDialog=function(i){this._oCurrentItem=i.currentItem;this._iCurrentIndex=i.index;this._oPopover.openBy(i.opener);};Z.prototype._setupDroppable=function(i){var k=this;i=i||this.$().find(".sapCalculationBuilderDroppable");i.droppable({scope:k.getId()+"-scope",tolerance:"pointer",activeClass:"sapCalculationBuilderDroppableActive",hoverClass:"sapCalculationBuilderDroppableActive",drop:function($,_){if(!_.draggable.hasClass("sapCalculationBuilderSelected")){k._selectItem(_.draggable[0]);}k._moveItems(W.MOUSE,parseInt(q(this).attr("index"),10));k._bDragging=false;},over:function($,_){k._bDragging=true;}});};Z.prototype._clearNewButtonPositions=function(){var $=this.$();$.find(".sapCalculationBuilderDelimiterNewButton").hide(200);$.find(".sapCalculationBuilderItem").animate({"left":0},300);};Z.prototype._setupNewButtonEvents=function(){var i=13,k=300;var $=this.$().find(".sapCalculationBuilderDelimiter[data-events!='bound']"),_=this.$().find(".sapCalculationBuilderDelimiterNewButton[data-events!='bound']"),a1=this,b1,c1;var d1=function(e1,f1){e1.prev().animate({"left":-f1},k);e1.next().animate({"left":f1},k);};_.click(function(ev){var e1=q(this),f1=parseInt(e1.attr("index"),10);e1.css("opacity",1);a1._oCurrentItem=null;a1._iCurrentIndex=f1;a1._openDialog({opener:this,index:f1});});_.attr("data-events","bound");$.mouseover(function(ev){var e1=q(this);if(!a1._bDragging&&!a1._oPopover.isOpen()){b1=true;c1=setTimeout(function(){if(b1){b1=false;d1(e1,i);e1.find(".sapCalculationBuilderDelimiterNewButton").show(200);}},400);}});$.mouseout(function(ev){var e1=q(this).find(".sapCalculationBuilderDelimiterNewButton"),f1=q(this);b1=false;clearTimeout(c1);if(a1._bDragging||a1._oPopover.isOpen()){return;}if(!e1.is(':hover')){d1(f1,0);e1.hide(200);}});$.attr("data-events","bound");};Z.prototype._setupSelectable=function(){this.$().selectable({cancel:".sapCalculationBuilderCancelSelectable",distance:5,start:function(){this._deselect();this._instantClose();}.bind(this),stop:function(){this._selectItems(this.$().find(".sapCalculationBuilderItem.ui-selected"));}.bind(this)});};Z.prototype._selectItemsTo=function($){var i=q($.next(".sapCalculationBuilderDelimiter")[0]),k=i.attr("index")-1,_=this.$(),a1,b1,c1,d1,e1;if($.parent().hasClass("sapCalculationBuilderSelected")||this._isEmptySelected()){this._selectItem($);return;}if(k>this._iLastSelectedIndex){a1=this._iFirstSelectedIndex;b1=k+1;}else{a1=k;b1=this._iLastSelectedIndex+1;}this._deselect();d1=_.find(".sapCalculationBuilderDelimiter[index=\""+a1+"\"]");e1=_.find(".sapCalculationBuilderDelimiter[index=\""+b1+"\"]");c1=d1.nextUntil(e1,".sapCalculationBuilderItem");this._selectItems(c1);};Z.prototype._selectItems=function(k){for(var i=0;i<k.length;i++){this._selectItem(k[i]);}};Z.prototype._selectItem=function(i){var $=this.$().find(".sapCalculationBuilderSelected"),k=q(i),_=q(k.next(".sapCalculationBuilderDelimiter")[0]),a1=$[0].children.length,b1=_.attr("index")-1,c1=true;if(!this._oItemNavigation||!this._getItemById(k[0].id)||this._bReadOnly){return;}if(a1===0){this._iFirstSelectedIndex=b1;this._iLastSelectedIndex=b1;}else{if(k.parent().hasClass("sapCalculationBuilderSelected")){if(this._iFirstSelectedIndex===b1){this._iFirstSelectedIndex++;this._deselectItem(k,false);}else if(this._iLastSelectedIndex===b1){this._iLastSelectedIndex--;this._deselectItem(k,true);}else{this._deselect();}this._setCorrectFocus();return;}if((this._iFirstSelectedIndex-b1)===1){this._iFirstSelectedIndex=b1;c1=false;}else if((b1-this._iLastSelectedIndex)===1){this._iLastSelectedIndex=b1;c1=true;}else{this._iFirstSelectedIndex=b1;this._iLastSelectedIndex=b1;this._deselect();}}var d1=this.$();if(this._isEmptySelected()){$.detach().insertBefore(k);$.draggable({revert:"invalid",cursor:"move",axis:"x",scope:this.getId()+"-scope",helper:function(e1){var f1=$.clone();f1.removeClass("sapCalculationBuilderSelected");f1.addClass("sapCalculationBuilderDraggingSelectedClone");return f1;},start:function(){$.addClass("sapCalculationBuilderDragging");d1.find(".sapCalculationBuilderItemContent").css("cursor","move");},stop:function(){$.removeClass("sapCalculationBuilderDragging");d1.find(".sapCalculationBuilderItemContent").css("cursor","pointer");}});}if(c1){k.detach().appendTo($);_.detach().appendTo($);}else{_.detach().prependTo($);k.detach().prependTo($);}if(k.hasClass("sapCalculationBuilderItem")){k.draggable("disable");k.addClass("ui-selected");}this._setCorrectFocus();};Z.prototype._isEmptySelected=function(){var $=this.$().find(".sapCalculationBuilderSelected");if($){return $.is(":empty");}return true;};Z.prototype._deselectItem=function($,i){var k=this.$().find(".sapCalculationBuilderSelected"),_=q($.next(".sapCalculationBuilderDelimiter")[0]);if(!$.hasClass("ui-selected")){return;}if(i){_.detach().insertAfter(k);$.detach().insertAfter(k);}else{$.detach().insertBefore(k);_.detach().insertBefore(k);}$.draggable("enable");$.removeClass("ui-selected");};Z.prototype._deselect=function(){var $=this.$().find(".sapCalculationBuilderSelected");if(this._isEmptySelected()){return;}this.$().find(".sapCalculationBuilderSelected .ui-selected").removeClass("ui-selected");$.children().each(function(){var i=q(this);if(i.hasClass("sapCalculationBuilderItem")){i.draggable("enable");}i.detach().insertBefore($);});};Z.prototype._setupKeyboard=function(){var i=this.getDomRef(),k=[];this.getItems().forEach(function($){k.push($.getFocusDomRef());if($.isExpandable()){k.push($.$("expandbutton"));}});k.push(this._getNewItem().getFocusDomRef());if(!this._oItemNavigation){this._oItemNavigation=new I();this.addDelegate(this._oItemNavigation);}this._oItemNavigation.setRootDomRef(i);this._oItemNavigation.setItemDomRefs(k);this._oItemNavigation.setCycling(true);this._oItemNavigation.setPageSize(250);};Z.prototype._setCorrectFocus=function(){q(this._oItemNavigation.getFocusedDomRef()).focus();};Z.prototype._getItemById=function(i){return this.getItems().filter(function(k){return k.getId()===i;})[0];};Z.prototype._getNewItem=function(){if(!this._oNewItem){this._oNewItem=new C();this._oNewItem._bIsNew=true;this._oNewItem.setParent(this,null,true);}return this._oNewItem;};Z.prototype._instantClose=function(){var i=this._oPopover.getAggregation("_popup");if(i&&i.oPopup&&i.oPopup.close){i.oPopup.close(0);this._setCorrectFocus();}};Z.prototype._attachAriaLabelToButton=function(i,k){i.addEventDelegate({onAfterRendering:function($){$.srcControl.$("content").attr("aria-label",k);}});};Z.prototype._printErrors=function(){this.getItems().forEach(function(i){var k=i._getItemError(),$=i.$(),_=!!k?"addClass":"removeClass";$[_]("sapCalculationBuilderItemErrorSyntax");});};Z.prototype._validateSyntax=function(k){var $=function(){var v1=this.getItems()[l1],w1=v1.getKey();return!v1._isOperator()||w1==="("||w1==="+"||w1==="-"||w1.toLowerCase()==="not";}.bind(this);var _=function(){var f1=this.getItems(),v1=f1[m1-1];return!v1._isOperator()||v1.getKey()===")";}.bind(this);var a1=function(i1){var v1=i1.getKey().toLowerCase();if(i1._isOperator()){return v1==="not"||v1==="("||v1===")"?v1:"#op#";}return i1._isFunction()?"#fun#":"#col#";};var b1=function(i1){return{index:i,item:i1,items:[],text:i1.getKey()+(i1._isFunction()?"(":"")};};var c1=function(r1){var v1=1,w1=i;i++;for(;i<f1.length;i++){var i1=f1[i],x1=i1.getKey(),y1=b1(i1);r1.items.push(y1);switch(x1){case")":v1--;break;case"(":v1++;break;case",":v1=1;break;}if(i1._isFunction()){c1(y1);r1.text+=y1.text;}else{r1.text+=x1;}if(v1===0){return r1;}}p1.push({index:w1,title:Y.getText("CALCULATION_BUILDER_CLOSING_BRACKET_ERROR_TEXT")});return r1;};var d1=function(r1){var v1=this.getParent()._getFunctionAllowParametersCount(r1.item.getKey()),w1=[],x1=[];r1.items.forEach(function(i1){if(i1.item._isComma()){w1.push(x1);x1=[];}else{x1.push(i1);}});if(x1.length>0&&x1[x1.length-1].text===")"){x1.pop();}w1.push(x1);if(w1.length!==v1){p1.push({index:r1.index,title:Y.getText(w1.length<v1?"CALCULATION_BUILDER_TOO_LITTLE_PARAMETERS":"CALCULATION_BUILDER_TOO_MANY_PARAMETERS")});}if(w1.length>0){w1.forEach(function(y1){if(y1.length>0){q.merge(p1,this._validateSyntax({from:y1[0].index,to:y1[y1.length-1].index+1}));}else{p1.push({index:r1.index,title:Y.getText("CALCULATION_BUILDER_EMPTY_PARAMETER")});}}.bind(this));}}.bind(this);var e1={"#op#":["(","#col#","#fun#","not"],"(":["(","+","-","#col#","#fun#","not"],")":["#op#",")"],"#col#":["#op#",")"],"#fun#":["(","+","-","#col#","#fun#"],"not":["#col#","#fun#","not","("]};k=k||{};var f1=k.items||this.getItems(),g1,h1,i1,j1,k1,l1=k.from||0,m1=k.to||f1.length,n1=(l1===0&&m1===f1.length),o1=[],p1=[];if(f1.length>0){if(!$()){p1.push({index:l1,title:Y.getText("CALCULATION_BUILDER_FIRST_CHAR_ERROR_TEXT")});}if(!_()){p1.push({index:m1-1,title:Y.getText("CALCULATION_BUILDER_LAST_CHAR_ERROR_TEXT")});}}for(var i=l1;i<m1;i++){i1=f1[i];if(i1._getType()===G.Error){p1.push({index:i,title:Y.getText("CALCULATION_BUILDER_SYNTAX_ERROR_TEXT")});continue;}if(!k.skipCustomValidation&&i1._isFunction()){var q1=i1._getCustomFunction(),r1=c1(b1(i1));if(q1&&!q1.getUseDefaultValidation()){var s1=new D();this.getParent().fireValidateFunction({definition:r1,customFunction:q1,result:s1});q.merge(p1,s1.getErrors());}else{d1(r1);}}if(i<m1-1){j1=f1[i+1];g1=a1(f1[i]);h1=a1(j1);k1=j1?j1.getKey().toLowerCase():"";var t1=j1._isCustomOperator()||i1._isCustomOperator();if(e1[g1].indexOf(h1)===-1&&e1[g1].indexOf(k1)===-1&&!t1){var u1={index:i+1};if(i1._isOperator()&&j1._isOperator()){u1.title=Y.getText("CALCULATION_BUILDER_BEFORE_OPERATOR_ERROR_TEXT",j1.getKey());}else if(!i1._isOperator()&&!j1._isOperator()){u1.title=Y.getText("CALCULATION_BUILDER_BETWEEN_NOT_OPERATORS_ERROR_TEXT",[i1.getKey(),j1.getKey()]);}else if(i1.getKey()===")"&&!j1._isOperator()){u1.title=Y.getText("CALCULATION_BUILDER_AFTER_CLOSING_BRACKET_ERROR_TEXT");}else if(!i1._isOperator()&&(j1.getKey()==="(")){u1.title=Y.getText("CALCULATION_BUILDER_BEFORE_OPENING_BRACKET_ERROR_TEXT");}else{u1.title=Y.getText("CALCULATION_BUILDER_CHAR_ERROR_TEXT");}p1.push(u1);}}if(i1._isFunction()){continue;}if(n1&&i1.getKey()===","){p1.push({index:i,title:Y.getText("CALCULATION_BUILDER_WRONG_PARAMETER_MARK")});}if((i1._isOperator()&&i1.getKey()==="(")||i1._isFunction()){o1.push(i);}if(i1._isOperator()&&i1.getKey()===")"){if(o1.length===0){p1.push({index:i,title:Y.getText("CALCULATION_BUILDER_OPENING_BRACKET_ERROR_TEXT")});}else{o1.pop();}}}for(i=0;i<o1.length;i++){p1.push({index:o1[i],title:Y.getText("CALCULATION_BUILDER_CLOSING_BRACKET_ERROR_TEXT")});}return p1;};Z.prototype._getType=function(k){return this.getParent()&&this.getParent()._getType(k);};Z.prototype._setItems=function(i){this._smartRender(i);};Z.prototype._moveItems=function(k,$){var _=[],a1=this.$(),b1=this.getItems(),c1=a1.find(".sapCalculationBuilderSelected"),d1,e1,f1,g1;if(this._isEmptySelected()){return;}g1=(c1.length>1)?q(c1[0]).children():c1.children();if(k===W.KEY_PREVIOUS){e1=this._iFirstSelectedIndex-1;}else if(k===W.KEY_NEXT){e1=this._iLastSelectedIndex+2;}else if(k===W.MOUSE){e1=$;}if(e1<0||e1===(b1.length+1)){return;}d1=this.$().find(".sapCalculationBuilderDelimiter[index=\""+e1+"\"]");for(var i=0;i<b1.length+1;i++){f1=b1[i];if(e1===i){g1.each(function(){var a1=q(this),f1;if(a1.hasClass("sapCalculationBuilderItem")){f1=sap.ui.getCore().byId(q(this)[0].id);_.push(f1);f1._bMovingItem=true;a1.draggable("enable");}a1.css("left",0);a1.detach().insertAfter(d1).removeClass("");d1=a1;});}if(f1&&!f1.$().parent().hasClass("sapCalculationBuilderSelected")&&!f1._bMovingItem){_.push(f1);}}c1.css("left","");a1.find(".sapCalculationBuilderDelimiter").each(function(i){q(this).attr("index",i);});this.removeAllAggregation("items",true);_.forEach(function(f1,i){f1._bMovingItem=false;f1._iIndex=i;this.addAggregation("items",f1,true);}.bind(this));this._setupKeyboard();this._selectItems(g1.filter(function(i,el){return q(el).hasClass("sapCalculationBuilderItem");}));this._fireChange();};Z.prototype._fireAfterValidation=function(){this.getParent().fireAfterValidation();};Z.prototype._smartRender=function(k){var $="",_=this.$(),a1=[],b1=this.getItems(),c1=b1.length;var d1=function(f1){if(typeof f1!=="object"){f1=new C({key:g1});}return f1;};var e1=function(g1){g1=d1(g1);this.addAggregation("items",g1,true);g1._iIndex=i;if(_[0]){$+=g1._render();$+=this._renderDelimiter(i+1);}g1.bOutput=true;a1.push(g1);}.bind(this);if(!this.getParent()._isExpressionVisible()){this.removeAllAggregation("items",true);(k||[]).forEach(function(f1){f1=d1(f1);this.addAggregation("items",f1,true);}.bind(this));return;}this._bIsCalculationBuilderRendering=true;this._deselect();for(var i=0;i<k.length;i++){var f1=b1[i],g1=k[i],h1=typeof g1==="object"&&g1.getKey?g1.getKey():g1,i1=g1._sType?g1._sType:"";if(!f1){e1(k[i]);}else if(f1.getKey()!==h1||f1._sType!==i1){f1.setKey(h1,true);f1._sType=i1;var j1=f1.$();j1[0].innerHTML=f1._innerRender();j1.attr("class",f1._getClass());j1.attr("title",f1._getTooltip());f1._setEvents();}}if(k.length<c1){for(var i=k.length;i<b1.length;i++){var j1=b1[i].$();j1.next().remove();j1.remove();this.removeAggregation("items",b1[i],true);}}if(_[0]&&a1.length>0){_.find(".sapCalculationBuilderDelimiter").last().after($);a1.forEach(function(f1){f1._afterRendering();});this._setupDroppable(_.find(".sapCalculationBuilderDroppable").filter(function(){return parseInt(q(this).attr("index"),10)>c1;}));}this._setupKeyboard();this._setupNewButtonEvents();this._bIsCalculationBuilderRendering=false;};Z.prototype._fireChange=function(){this.fireEvent("change");};return Z;});
