sap.ui.define(["sap/ui/thirdparty/jquery","./library","sap/ui/core/Control","sap/m/MessageBox","sap/base/security/encodeXML","./Utils","sap/ui/thirdparty/jqueryui/jquery-ui-core","sap/ui/thirdparty/jqueryui/jquery-ui-widget","sap/ui/thirdparty/jqueryui/jquery-ui-mouse","sap/ui/thirdparty/jqueryui/jquery-ui-draggable"],function(q,l,C,M,e,U){"use strict";var I=l.CalculationBuilderItemType,O=l.CalculationBuilderOperatorType,L=l.CalculationBuilderLogicalOperatorType;var r=sap.ui.getCore().getLibraryResourceBundle("sap.suite.ui.commons");var a=C.extend("sap.suite.ui.commons.CalculationBuilderItem",{constructor:function(i,s){if(typeof i!=="string"&&i!==undefined){s=i;}if(s&&s.key){s.key=this._sanitizeKey(s.key);}C.apply(this,arguments);},metadata:{library:"sap/suite/ui/commons",properties:{key:{type:"string",group:"Misc",defaultValue:null}}},renderer:function(R,i){R.write(i._render());}});a.prototype._innerRender=function(){var h="",A="",s=this._getLabel(),i={"!=":"NOT_EQUAL","-":"MINUS",",":"COMMA"};var R=function(){h+="<div class=\"sapCalculationBuilderItemFocusWrapper\">";h+="<div class=\"sapCalculationBuilderItemFocus\"></div>";h+="</div>";};var f=function(){h+="<div class=\"sapCalculationBuilderItemExpandButtonWrapper\" title=\""+r.getText("CALCULATION_BUILDER_EXPAND_BUTTON_TITLE")+"\">";h+="<div id=\""+this.getId()+"-expandbutton\" class=\"sapCalculationBuilderItemExpandButton "+(this._bReadOnly?"sapMBtnDisabled":"")+"\" tabindex=\"-1\">";if(!this._bReadOnly){h+="<div class=\"sapCalculationBuilderItemExpandButtonFocus\"></div>";}b("");h+="</div></div>";}.bind(this);var b=function(c){h+="<span aria-hidden=\"true\" data-sap-ui-icon-content=\""+c+"\" class=\"sapCalculationBuilderEmptyItemIcon sapUiIcon sapUiIconMirrorInRTL\" style=\"font-family:'SAP-icons'\"></span>";};var g=function(t){return" aria-label=\""+r.getText(t)+"\" ";};if(this._bIsNew||this._isEmpty()){A=" title=\""+r.getText("CALCULATION_BUILDER_NEW_ITEM_TITLE")+"\" ";}else if(i[s]){A=g("CALCULATION_BUILDER_"+i[s]+"_ARIA_LABEL");}h+="<div class=\"sapCalculationBuilderItemContentWrapper\">";h+="<div id=\""+this.getId()+"-content\" class=\"sapCalculationBuilderItemContent\""+A+">";R();if(this._isEmpty()){b("");h+="</div>";}else if(this._bIsNew){b("");h+="</div>";}else if(this._isFunction()){var F=this._getFunction();h+="<span class=\"sapCalculationBuilderItemLabel sapCalculationBuilderItemFunctionLabel\">";h+=e(F.title||this.getKey());h+="</span>";h+="<span class=\"sapCalculationBuilderItemLabel sapCalculationBuilderItemFunctionBracket\">";h+="&nbsp;(";h+="</span>";h+="</div>";}else{h+="<span class=\"sapCalculationBuilderItemLabel\">";h+=e(s);h+="</span>";h+="</div>";}h+="</div>";if(this._isVariable()&&this.isExpandable()){f();}return h;};a.prototype._getClass=function(h){var c="",i=this._isEmpty();c+=this._bIsNew?"sapCalculationBuilderNewItem  sapCalculationBuilderCancelSelectable":"sapCalculationBuilderItem";if(i){c+=" sapCalculationBuilderNewItem ";}if(this._isBracket()){c+=" sapCalculationBuilderItemBracket ";}else if(this._isOperator()){c+=" sapCalculationBuilderItemOperator sapCalculationBuilderItemOperatorLength-"+this._getLabel().length+" ";if(this._isLogicalOperator()){c+=" sapCalculationBuilderItemLogicalOperator ";}}else if(this._isCustomOperator()){c+=" sapCalculationBuilderItemOperator sapCalculationBuilderItemCustomOperator ";}else if(this._isFunction()){c+=" sapCalculationBuilderItemFunction ";}else if(this._isConstant()){c+=" sapCalculationBuilderItemConstant ";}else if(this._isVariable()){c+=" sapCalculationBuilderItemVariable ";if(this.isExpandable()){c+=" sapCalculationBuilderItemVariableSeparator ";}}else{c+=" sapCalculationBuilderUnknownItem ";}if(h){c+=" sapCalculationBuilderItemErrorSyntax ";}return c;};a.prototype._render=function(){var i=this._hasCorrectParent(),E=this._getItemError(),t=this._getTooltip(),T=t?"title=\""+t+"\"":"",h="";h+="<div "+" class=\""+this._getClass(!!E)+"\" id=\""+this.getId()+"\" tabindex=\""+(i?"-1":"0")+"\""+T+">";h+=this._innerRender();h+="</div>";return h;};a.prototype.init=function(){this._bIsNew=false;};a.prototype.onBeforeRendering=function(){this._oVariable=this.getVariable();};a.prototype.onAfterRendering=function(){this._afterRendering();};a.prototype._afterRendering=function(){var p=this.getParent();this._setEvents();if(!this._bIsNew&&!this._bReadOnly){this._setupDraggable();}if(this._hasCorrectParent(p)){if(!p._bIsCalculationBuilderRendering){p._setupKeyboard();p.getParent()._enableOrDisableExpandAllButton();}}};a.prototype._setEvents=function(){if(this.isExpandable()){this.$("expandbutton").click(this._expandButtonPress.bind(this));this.$("expandbutton").mousedown(function(E){E.stopPropagation();});}if(!this._bReadOnly){this.$("content").click(this._buttonPress.bind(this));}if(this._isBracket()||this._isFunction()){this._setBracketHover();}};a.prototype._buttonPress=function(E){var p=this.getParent();if(this._hasCorrectParent(p)&&!p._bDragging){if(E.ctrlKey){p._selectItem(this.$());}else if(E.shiftKey){p._selectItemsTo(this.$());}else{p._deselect();p._openDialog({opener:this,currentItem:this});}}};a.prototype._expandButtonPress=function(E){if(!this._bReadOnly){this._openExpandConfirmMessageBox();}};a.prototype.isExpandable=function(){var v=this._oVariable?this._oVariable:this.getVariable();return v&&v.getItems().length>0;};a.prototype.getVariable=function(){var p=this.getParent();return this._hasCorrectParent(p)&&p._getVariableByKey(this.getKey());};a.prototype.getType=function(){return this._getType();};a.prototype._setupDraggable=function(){var p=this.getParent(),$=p.$(),b=this.$();b.draggable({revert:"invalid",axis:"x",delay:100,cursor:"move",helper:function(c){var d=b.clone();d.addClass("sapCalculationBuilderDragging");d.css("pointer-events","none");return d;},scope:p.getId()+"-scope",start:function(){$.find(".sapCalculationBuilderBracket").removeClass("sapCalculationBuilderBracket");$.find(".sapCalculationBuilderItemContent").css("cursor","move");q(this).addClass("sapCalculationBuilderDragging");p._bDragging=true;if(!q(this).hasClass("ui-selected")){p._deselect();}},stop:function(){q(this).removeClass("sapCalculationBuilderDragging");$.find(".sapCalculationBuilderItemContent").css("cursor","pointer");p._bDragging=false;}});U._setupMobileDraggable(b);};a.prototype._setBracketHover=function(){var $=this.$("content"),b=this._isFunction()?O["("]:this.getKey(),c=b===O[")"],t=c?O["("]:O[")"],T;$.mouseenter(function(E){var o,f,B=0,d=(this._hasCorrectParent()&&this.getParent().getItems())||[],i=c?d.length:0;for(;c?i>=0:i<d.length;(c?i--:i++)){o=d[i];if(o===this){f=true;}if(f){if((o.getKey()===t)||(o._isFunction()&&c)){B--;if(B===0){T=o;break;}}else if((o.getKey()===b)||(o._isFunction()&&!c)){B++;}}}if(T){this.$().addClass("sapCalculationBuilderBracket");T.$().addClass("sapCalculationBuilderBracket");}}.bind(this));$.mouseleave(function(E){this.$().removeClass("sapCalculationBuilderBracket");if(T){T.$().removeClass("sapCalculationBuilderBracket");}}.bind(this));};a.prototype._expandVariable=function(f){var p=this.getParent(),t,v;if(p){t=p.getItems().indexOf(this);v=p._getVariableByKey(this.getKey());p.insertItem(new a({"key":"("}),t++);v.getItems().forEach(function(i){p.insertItem(i._cloneItem(),t++);});p.insertItem(new a({"key":")"}),t++);p.removeItem(this);if(f){p._aErrors=p._validateSyntax();p._fireChange();}}};a.prototype._cloneItem=function(){return new a({key:this.getKey()});};a.prototype._openExpandConfirmMessageBox=function(){M.show(r.getText("CALCULATION_BUILDER_EXPAND_MESSAGE_TEXT",this._getLabel()),{icon:M.Icon.WARNING,title:r.getText("CALCULATION_BUILDER_EXPAND_MESSAGE_TITLE"),actions:[M.Action.OK,M.Action.CANCEL],onClose:function(A){var p;if(A===M.Action.OK){this._expandVariable(true);}else{p=this.getParent();if(p){p._setCorrectFocus();}}}.bind(this)});};a.prototype._getItemError=function(){var p=this.getParent(),E;if(this._hasCorrectParent(p)){E=q.grep(p._aErrors,function(i){return i.index===this._iIndex;}.bind(this))[0];}return E;};a.prototype._getLabel=function(){var g=function(){if(this._isMultiplication()){return"X";}var i=this._getItem();if(!i){return this.getKey();}if(i.title){return i.title;}if(i._getLabel){return i._getLabel();}return i.getText()||i.getKey();}.bind(this);if(!this._sLabel){this._sLabel=g();if(this._isFunction()){this._sLabel+=" (";}}return this._sLabel;};a.prototype._sanitizeKey=function(k){if(!k||typeof k!=="string"){return k;}k=k.replace(/{/g,"&#125;");k=k.replace(/}/g,"&#123;");return k;};a.prototype._reset=function(){this._sType="";this._sLabel="";this._oVariable="";};a.prototype.setKey=function(k,s){this._reset();this.setProperty("key",this._sanitizeKey(k),s);return this;};a.prototype.getKey=function(){var k=this.getProperty("key");k=k.replace(/&#125;/g,"{");k=k.replace(/&#123;/g,"}");return k;};a.prototype._getType=function(){var p=this.getParent();if(!this._sType&&p){this._sType=p._getType(this.getKey());}return this._sType;};a.prototype._isEmpty=function(){return!this._bIsNew&&!this.getKey();};a.prototype._isOperator=function(){return this._getType()===I.Operator;};a.prototype._isSecondaryOperator=function(){var t=this._getType();if(this._getType()===I.Operator){return["+","-","/","x","(",")",","].indexOf(this.getKey())===-1;}return t===I.CustomOperator;};a.prototype._isCustomOperator=function(){return this._getType()===I.CustomOperator;};a.prototype._isVariable=function(){return this._getType()===I.Variable;};a.prototype._isConstant=function(){return this._getType()===I.Constant;};a.prototype._isFunction=function(){var t=this._getType();return t===I.Function||t===I.CustomFunction;};a.prototype._getFunction=function(){var t=this._getType();if(t===I.Function||t===I.CustomFunction){var b=this.getParent().getParent();return b._createFunctionObject(b._getFunctionDefinition(this.getKey()));}return null;};a.prototype._getItemInstance=function(t,c){if(this._getType()===t){var k=this.getKey(),b=this.getParent()[c]();return q.grep(b,function(i){return i.getKey().toLowerCase()===k.toLowerCase();})[0];}return null;};a.prototype._getItem=function(){var t=this._getType();switch(t){case I.Variable:return this._getVariable();case I.CustomFunction:return this._getCustomFunction();case I.CustomOperator:return this._getCustomOperator();}return null;};a.prototype._getTooltip=function(){var i=this._getItem();return i&&i.getTooltip_AsString?i.getTooltip_AsString():"";};a.prototype._getVariable=function(){return this._getItemInstance(I.Variable,"getVariables");};a.prototype._getCustomFunction=function(){return this._getItemInstance(I.CustomFunction,"getFunctions");};a.prototype._getCustomOperator=function(){return this._getItemInstance(I.CustomOperator,"getOperators");};a.prototype._isBracket=function(){return this._isOperator()&&(this.getKey()==="("||this.getKey()===")");};a.prototype._isAddition=function(){return this._isOperator()&&this.getKey()==="+";};a.prototype._isSubtraction=function(){return this._isOperator()&&this.getKey()==="-";};a.prototype._isDivision=function(){return this._isOperator()&&this.getKey()==="/";};a.prototype._isMultiplication=function(){return this._isOperator()&&this.getKey()==="*";};a.prototype._isComma=function(){return this._isOperator()&&this.getKey()===",";};a.prototype._isLogicalOperator=function(){return this._isOperator()&&!!L[this.getKey()];};a.prototype._hasCorrectParent=function(p){p=p||this.getParent();return p instanceof sap.suite.ui.commons.CalculationBuilderExpression;};return a;});
