sap.ui.define(["sap/suite/ui/generic/template/AnalyticalListPage/util/KpiUtil","sap/suite/ui/generic/template/AnalyticalListPage/util/CriticalityUtil","sap/suite/ui/generic/template/AnalyticalListPage/util/FilterUtil","sap/base/Log"],function(K,C,F,L){"use strict";var a=function(k){this._getDataFromAnnotations(k);};a.prototype._getDataFromAnnotations=function(c){var m=this;var M=c._oModel;var o=M.getMetaModel();var e=o.getODataEntitySet(c.getEntitySet());if(!e){L.error("KPI error details - Incorrect entity set");return;}var E=o.getODataEntityType(e.entityType);var q=c.getQualifier();var s,d,S,D;var p={};var k="com.sap.vocabularies.UI.v1.KPI#"+q;var b=E[k];if(b){if(b["DataPoint"]){D=this.getPathOrAnnotationPath(b["DataPoint"],true);}if(b["SelectionVariant"]){S=this.getPathOrAnnotationPath(b["SelectionVariant"],true);}if(b["ShortDescription"]){var f=K.getPrimitiveValue(b["ShortDescription"]);}var g=b.ID;var h=b.Detail&&b.Detail.SemanticObject;var i=b.Detail&&b.Detail.DefaultPresentationVariant;var A=b.Detail&&b.Detail.Action;p.kpiAnnotationPath=k;}else{var j="com.sap.vocabularies.UI.v1.SelectionPresentationVariant#"+q;p.selectionPresentationVariantPath=j;var l=E[j];if(!l){L.error("KPI error details - SelectionPresentationVariant does not have Path.");return;}if(l.SelectionVariant){S=this.getPathOrAnnotationPath(l.SelectionVariant);}if(l.PresentationVariant){var P=this.getPathOrAnnotationPath(l.PresentationVariant);}if(!P){L.error("KPI error details - PresentationVariant does not have Path.");return;}var n=E[P];var v=n&&n.Visualizations;if(v){v.forEach(function(O){if(O.AnnotationPath.indexOf("DataPoint")>0){D=m.getPathOrAnnotationPath(O);}});}}if(!D){L.error("KPI error details - DataPoint does not have Path.");return;}d=E[D];if(!S){L.error("KPI error details - SelectionVariant does not have a path");}s=E[S];p.dataPointPath=D;p.selectionVariantPath=S;var r=d.Value.Path;var t=s&&s.SelectOptions,u=s&&s.Parameters;var w=o.getODataProperty(E,d.Value.Path);var U=K.getUnitofMeasure(M,w);var x=d.Title,y=K.getPrimitiveValue(x);if(y===undefined){y="";}this.kpiConfig={entityTypeProperty:w,props:{title:y,value:r,unitOfMeasure:U},entitySet:e,dataPoint:d,selectionVariant:s,selectOptions:t,parameters:u,kpiPropertyPath:p};if(b){this.kpiConfig.bIsKpiAnnotaion=true;}if(h&&A&&g){this.kpiConfig.navigation={semanticObject:h.String,action:A.String,kpiId:g.String};}if(b&&!i){this.kpiConfig.oDefaultPV=false;}if(f){this.kpiConfig.props.shortDescription=f;}var z=F.readProperty(d,"Criticality"),B=z&&(z.EnumMember)?K.getPrimitiveValue(z):undefined,G=(z&&z.Path)?this._getCriticalityParameters(z):undefined;if(B){this.kpiConfig.criticality={criticalityType:B};}else if(G){this.kpiConfig.criticality={criticalityPath:G};}else{var I=(!B&&F.readProperty(d,"CriticalityCalculation.ImprovementDirection.EnumMember"))?K.getPrimitiveValue(d.CriticalityCalculation.ImprovementDirection):undefined;if(I){var T=this._getCriticalityParameters(d.CriticalityCalculation.ToleranceRangeLowValue),H=this._getCriticalityParameters(d.CriticalityCalculation.ToleranceRangeHighValue),J=this._getCriticalityParameters(d.CriticalityCalculation.DeviationRangeLowValue),N=this._getCriticalityParameters(d.CriticalityCalculation.DeviationRangeHighValue);this.kpiConfig.criticalityCalculation={improveDirection:I,toleranceLow:T,toleranceHigh:H,deviationLow:J,deviationHigh:N};}}};a.prototype._getCriticalityParameters=function(c){if(c){if(c.Path){return{path:"/"+c.Path};}else{return K.getPrimitiveValue(c);}}};a.prototype.getCriticalityFromEnum=function(c){return C.getCriticalityIndicatorFromEnum(c);};a.prototype.getConfig=function(){return this.kpiConfig;};a.prototype.getImproveDirection=function(d,D,s,b,v){C.setVals(d,D,s,b,v);return(C[this.kpiConfig.criticalityCalculation.improveDirection]());};a.prototype.getPathOrAnnotationPath=function(e,i){var p=i?e.Path:(e.Path||e.AnnotationPath);if(/^@/.test(p)){p=p.slice(1);}return p;};return a;},true);
