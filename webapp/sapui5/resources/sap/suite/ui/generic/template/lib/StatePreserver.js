sap.ui.define(["jquery.sap.global","sap/ui/base/Object","sap/suite/ui/generic/template/lib/testableHelper","sap/base/Log"],function(q,B,t,L){"use strict";var c=(sap&&sap.ushell&&sap.ushell.Container)?sap.ushell.Container.getService("CrossApplicationNavigation"):(function(){var r=q.Deferred();r.resolve(Object.create(null));return{createEmptyAppState:function(){return{getKey:function(){return"";},setData:q.noop,save:function(){return Promise.resolve();}};},getAppState:function(){return r;}};})();t.testableStatic(function setCrossAppNavService(s){c=s;},"StatePreserver_setCrossAppNavService");function g(T,s){var r="";var I=false;var a=Promise.resolve();var n=null;var A=false;var S=null;var b=null;var l,d;var C=Object.create(null);var o={};var e={};function f(){C.permanentEntries=Object.create(null);C.sessionEntries=Object.create(null);C.pageEntries=Object.create(null);C.allEntries=Object.create(null);}f();function h(i){f();for(var K in i){var M=q.extend(true,{},i[K]);C.allEntries[K]=M;var N=M.lifecycle||Object.create(null);if(N.permanent){C.permanentEntries[K]=M;}else if(N.session){C.sessionEntries[K]=M;}if(N.page||N.pagination){C.pageEntries[K]=M;}}return C;}function m(i,P){if(P===i){return;}var N=P.next.next;P.next.next=i.next;i.next=P.next;P.next=N;}function j(i,K,P){if(q.isEmptyObject(K)){return{appStateKey:""};}var M=JSON.stringify(K);var N=0;var O;for(O=i;O.next&&N<10;N++){if(O.next.serialize===M){m(i,O);return{appStateKey:i.next.appStateKey};}O=O.next;}O.next=null;var Q=c.createEmptyAppState(s.oComponent.getAppComponent(),!P);var U={next:i.next,serialize:M,appStateKey:Q.getKey()};Q.setData(K);Q.save();i.next=U;return{appStateKey:U.appStateKey};}function k(){var i=j(e,C.sessionEntries,false);var K=Object.create(null);if(i.appStateKey){K.sessionAppStateKey=i.appStateKey;}if(!q.isEmptyObject(C.permanentEntries)){K.permanentEntries=C.permanentEntries;}S=j(o,K,true);A=false;if(b===S.appStateKey){S=null;}else{T.oNavigationControllerProxy.navigateByExchangingQueryParam(s.appStateName,S.appStateKey);}}function p(){if(!A){return;}var i=s.getCurrentState()||Object.create(null);h(i);k();}function u(){var K=T.componentRegistry[s.oComponent.getId()];var M=K.aKeys;var N="";var O=K.route;for(var i=M.length-1;i>0;i--){var P=T.mRoutingTree[O];var Q=i===1?P.entitySet:P.navigationProperty;N="/"+Q+(M[i]?"("+M[i]+")":"")+N;O=P.parentRoute;}return N;}function v(P,i){return a.then(function(){var K=Object.create(null);var M=(!P||u()===P)&&l;if(M){K[s.appStateName]=[M];}return K;});}function w(){if(I){return;}if(!A){A=true;if(n){p();}else{setTimeout(p,0);}}}function x(i){r=i;S=null;l=i;}function y(i,K,U){if(!K){return;}for(var M in K){var N=K[M];if(U||N.lifecycle.page){i[M]=N;}}}function R(i,K,N){h(N);var M=Object.create(null);for(var O in N){M[O]=N[O].data;}s.applyState(M,i);if(n){n();n=null;}x(K);k();}function z(i,K,M){for(var N=i;N.next;N=N.next){if(N.next.appStateKey===M){m(i,N);return;}}var O={next:i.next,serialize:JSON.stringify(K),appStateKey:M};i.next=O;}function D(i,K,M,N,O,P,Q,U){if(I){K();return;}if(b===null){b=M;}else if(M!==b){K();return;}if(U){var V=U.getData();z(e,V,Q);y(O,V,true);}y(O,P,true);R(N,b,O);i();}function E(i,K,M,N,O,P){var Q=P.getData();z(o,Q,M);if(Q.sessionAppStateKey){var U=c.getAppState(s.oComponent.getAppComponent(),Q.sessionAppStateKey);U.done(D.bind(null,i,K,M,N,O,Q.permanentEntries,Q.sessionAppStateKey));U.fail(D.bind(null,i,K,M,N,O,Q.permanentEntries,"",null));}else{D(i,K,M,N,O,Q.permanentEntries,"",null);}}function F(i){var K=T.componentRegistry[s.oComponent.getId()];var M=K.utils.getHeaderDataAvailablePromise()||Promise.resolve();return M.then(function(){return T.oApplicationProxy.areTwoKnownPathesIdentical(d,i,K.viewLevel===1);});}function G(i,K){var M=new Promise(function(N,O){F(i).then(function(P){d=i;var Q=Object.create(null);y(Q,C[P?"allEntries":"pageEntries"],P||K);if(b===r||!b){if(b||P){y(Q,C.sessionEntries,true);y(Q,C.permanentEntries,true);}R(P,b,Q);N();return;}if(!n){a=new Promise(function(V){n=V;});}var U=c.getAppState(s.oComponent.getAppComponent(),b);U.done(E.bind(null,N,O,b,P,Q));U.fail(O);},O);});return M;}function H(i){var K=i.getParameter("arguments");var Q=K&&K["?query"];b=(Q&&Q[s.appStateName])||"";if(S){if(S.appStateKey!==b){L.error("StatePreserver: Got AppstateKey "+b+" expected "+S.appStateKey);return false;}x(b);return true;}return false;}function J(){return{isStateChange:H};}return{getUrlParameterInfo:v,stateChanged:w,applyAppState:G,getAsStateChanger:J};}return B.extend("sap.suite.ui.generic.template.lib.StatePreserver",{constructor:function(T,s){q.extend(this,g(T,s));}});});
