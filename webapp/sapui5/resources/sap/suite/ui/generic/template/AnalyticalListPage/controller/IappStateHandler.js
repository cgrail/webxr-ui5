sap.ui.define(["jquery.sap.global","sap/ui/base/Object","sap/ui/generic/app/navigation/service/SelectionVariant","sap/ui/Device","sap/ui/comp/state/UIState","sap/ui/core/mvc/ControllerExtension","sap/base/Log"],function(q,B,S,D,U,C,L){"use strict";function g(s,c,n){var a="sap.suite.ui.generic.template.customData";var b="sap.suite.ui.generic.template.genericData";var d="sap.suite.ui.generic.template.extensionData";var F="visual";var e="compact";var p;var I=false,f=false,_=null,h;var o=null;var A=null;var r={appStateKey:"",urlParams:{}};var j={};function k(){return p.then(function(){if(r.appStateKey){return{"sap-iapp-state":[r.appStateKey]};}return r.urlParams;});}function R(i){if(i&&i.editStateFilter!==undefined){var b1=c.byId("editStateFilter");if(b1){b1.setSelectedKey((i.editStateFilter===null)?0:i.editStateFilter);}}var c1=s.oController.getOwnerComponent().getModel("_templPriv");if(i.chartVariantId&&s.oSmartChart){s.oSmartChart.setCurrentVariantId(i.chartVariantId);}if(i.filterMode){c1.setProperty('/alp/filterMode',i.filterMode);s.filterBarController.handleFilterSwitch(i.filterMode);}else{u();}if(i.contentView){((D.system.phone||D.system.tablet&&!D.system.desktop)&&i.contentView==="charttable")?c1.setProperty('/alp/contentView',"chart"):c1.setProperty('/alp/contentView',i.contentView);}if(i.autoHide){c1.setProperty('/alp/autoHide',i.autoHide);}}function l(i){if(!i){return;}var b1=true;var c1=function(d1){if(!(d1 instanceof C)){throw new Error("State must always be retrieved with respect to a ControllerExtension");}var e1=d1.getMetadata().getNamespace();if(!b1){throw new Error("State must always be restored synchronously");}return i[e1];};c.templateBaseExtension.restoreExtensionAppStateData(c1);b1=false;}function m(i){i=i||{};if(i.hasOwnProperty(a)&&i.hasOwnProperty(b)){R(i[b]);J(i[a]);l(i[d]);}else{if(i._editStateFilter!==undefined){R({editStateFilter:i._editStateFilter});delete i._editStateFilter;}u();J(i);}}function t(i){if(s.oSmartFilterbar.isPending()){var b1=function(c1){var d1=c1.getParameters();if(!d1.pendingValue){s.oSmartFilterbar.detachPendingChange(b1);m(i);}};s.oSmartFilterbar.attachPendingChange(b1);}else{m(i);}}function u(){var i=s.oController.getOwnerComponent().getModel("_templPriv"),b1=s.oSmartFilterbar.isCurrentVariantStandard()?s.oController.getOwnerComponent().getDefaultFilterMode():i.getProperty('/alp/filterMode');if(!(b1===F||b1===e)){L.error("Defaulting to Visual filter due to incorrect value of defaultFilterMode in App descriptor");b1=F;}if(b1===F&&s.hideVisualFilter){L.error("Visual filter is hidden defaulting to compact");b1=e;}s.filterBarController.setDefaultFilter(b1);}function v(i){var b1=s.oController.getOwnerComponent().getProperty('smartVariantManagement');if(b1){var c1=i['sap-ui-fe-variant-id'];if(c1&&c1[0]){s.oSmartFilterbar.getSmartVariant().setCurrentVariantId(c1[0]);}}else{var d1=i['sap-ui-fe-variant-id'],e1=i['sap-ui-fe-filterbar-variant-id'],f1=i['sap-ui-fe-chart-variant-id'],g1=i['sap-ui-fe-table-variant-id'];w(e1&&e1[0],f1&&f1[0],g1&&g1[0],d1&&d1[0]);}}function w(i,b1,c1,d1){if(i||d1){s.oSmartFilterbar.getSmartVariant().setCurrentVariantId(i||d1);}if(s.oSmartChart&&(b1||d1)){s.oSmartChart.attachAfterVariantInitialise(function(e1){s.oSmartChart.setCurrentVariantId(b1||d1);});s.oSmartChart.setCurrentVariantId(b1||d1);}if(s.oSmartTable&&(c1||d1)){s.oSmartTable.attachAfterVariantInitialise(function(e1){s.oSmartTable.setCurrentVariantId(c1||d1);});s.oSmartTable.setCurrentVariantId(c1||d1);}}function x(i,b1,c1){s.oSmartFilterbar.setSuppressSelection(false);var d1=i.appStateKey||"";if(I){return;}A=d1;I=true;var e1=(!d1&&b1)||{};if(e1){v(e1);}if(c1!==sap.ui.generic.app.navigation.service.NavType.initial){var f1=i&&i.bNavSelVarHasDefaultsOnly;var g1=new S(i.selectionVariant);j=JSON.parse(i.selectionVariant);if((g1.getSelectOptionsPropertyNames().indexOf("DisplayCurrency")===-1)&&(g1.getSelectOptionsPropertyNames().indexOf("P_DisplayCurrency")===-1)&&(g1.getParameterNames().indexOf("P_DisplayCurrency")===-1)){z(g1,i);}if((!f1||s.oSmartFilterbar.isCurrentVariantStandard())){var h1={selectionVariant:g1};if(c1!==sap.ui.generic.app.navigation.service.NavType.iAppState){s.oController.modifyStartupExtension(h1);}N(h1.selectionVariant);M(h1.selectionVariant);}else{var i1=new S(JSON.stringify(s.oSmartFilterbar.getUiState().getSelectionVariant())),j1=i1.getSelectOption("sap.suite.ui.generic.template.customData"),k1=i1.getSelectOption("sap.suite.ui.generic.template.genericData");y(i1,j1,k1,true);var h1={selectionVariant:i1};s.oController.modifyStartupExtension(h1);y(h1.selectionVariant,j1,k1,false);if(!q.sap.equal(h1.selectionVariant,new S(JSON.stringify(s.oSmartFilterbar.getUiState().getSelectionVariant())))){N(h1.selectionVariant);M(h1.selectionVariant);}}if(i.tableVariantId&&s.oSmartTable){s.oSmartTable.setCurrentVariantId(i.tableVariantId);}var l1=s.oController.getOwnerComponent().getModel("_templPriv");if(c1===sap.ui.generic.app.navigation.service.NavType.xAppState&&l1.getProperty('/alp/filterMode')===F){K();}if(i.customData){t(i.customData);}else{u();}if(!f1){s.oSmartFilterbar.checkSearchAllowed(s);if(s.oController.getView().getModel("_templPriv").getProperty("/alp/searchable")){f=true;s.oSmartFilterbar.search();}}else{if(s.oSmartFilterbar.isLiveMode()||s.oSmartFilterbar.isCurrentVariantExecuteOnSelectEnabled()){s.oSmartFilterbar.checkSearchAllowed(s);if(s.oController.getView().getModel("_templPriv").getProperty("/alp/searchable")){f=true;}}}r={appStateKey:d1,urlParams:e1};}else{var g1=new S(JSON.stringify(s.oSmartFilterbar.getUiState().getSelectionVariant())),j1=g1.getSelectOption("sap.suite.ui.generic.template.customData"),k1=g1.getSelectOption("sap.suite.ui.generic.template.genericData");y(g1,j1,k1,true);var h1={selectionVariant:g1};s.oController.modifyStartupExtension(h1);y(h1.selectionVariant,j1,k1,false);if(!q.sap.equal(h1.selectionVariant,new S(JSON.stringify(s.oSmartFilterbar.getUiState().getSelectionVariant())))){N(h1.selectionVariant);M(h1.selectionVariant);}if(s.oSmartFilterbar.isLiveMode()||s.oSmartFilterbar.isCurrentVariantExecuteOnSelectEnabled()){s.oSmartFilterbar.checkSearchAllowed(s);if(s.oController.getView().getModel("_templPriv").getProperty("/alp/searchable")){f=true;}}u();}T();o=null;if(!f){Y();}else{I=false;}}function y(i,b1,c1,d1){if(d1){i.removeSelectOption("sap.suite.ui.generic.template.customData");i.removeSelectOption("sap.suite.ui.generic.template.genericData");}else{i.massAddSelectOption("sap.suite.ui.generic.template.customData",b1);i.massAddSelectOption("sap.suite.ui.generic.template.genericData",c1);}}function z(i,b1){var c1=s.oSmartFilterbar.determineMandatoryFilterItems(),d1;for(var e1=0;e1<c1.length;e1++){if(c1[e1].getName().indexOf("P_DisplayCurrency")!==-1){if(b1.oDefaultedSelectionVariant.getSelectOption("DisplayCurrency")&&b1.oDefaultedSelectionVariant.getSelectOption("DisplayCurrency")[0].Low){d1=b1.oDefaultedSelectionVariant.getSelectOption("DisplayCurrency")[0].Low;}if(d1){i.addParameter("P_DisplayCurrency",d1);}if(s.alr_visualFilterBar&&d1){s.alr_visualFilterBar.setDisplayCurrency(d1);}break;}}}function E(){var i={};i[a]={};var b1=s.oController.getOwnerComponent().getModel("_templPriv");i[b]={chartVariantId:s.oSmartChart&&s.oSmartChart.getCurrentVariantId(),filterMode:b1.getProperty('/alp/filterMode'),contentView:b1.getProperty('/alp/contentView'),autoHide:b1.getProperty('/alp/autoHide')};var c1=c.byId("editStateFilter");if(c1){i[b].editStateFilter=c1.getSelectedKey();}c.getCustomAppStateDataExtension(i[a]);var d1;var e1=true;var f1=function(g1,h1){if(!(g1 instanceof C)){throw new Error("State must always be set with respect to a ControllerExtension");}if(!e1){throw new Error("State must always be provided synchronously");}if(h1){d1=d1||Object.create(null);var i1=g1.getMetadata().getNamespace();d1[i1]=h1;}};c.templateBaseExtension.provideExtensionAppStateData(f1);e1=false;if(d1){i[d]=d1;}return i;}function G(){return j;}function H(){var b1=s.oSmartFilterbar.getUiState({allFilters:false}).getSelectionVariant();var c1=c.getVisibleSelectionsWithDefaults();for(var i=0;i<c1.length;i++){if(!b1.getValue(c1[i])){b1.addSelectOption(c1[i],"I","EQ","");}}if(s.oController.byId('template::PageVariant').currentVariantGetModified()&&b1.SelectionVariantID){b1.SelectionVariantID="";}return{selectionVariant:JSON.stringify(b1),tableVariantId:s.oSmartTable&&s.oSmartTable.getCurrentVariantId(),customData:E()};}function J(i){c.restoreCustomAppStateDataExtension(i||{});}function K(){var i=q.extend(true,{},s.oSmartFilterbar.getFilterData(true)),b1=s.oController.getOwnerComponent().getModel("_filter");b1.setData(i);s.filterBarController._updateFilterLink();}function M(i){s.oSmartFilterbar.clearVariantSelection();s.oSmartFilterbar.clear();h=i;V(i.toJSONObject(),true,false);}function N(b1){var c1=b1.getParameterNames().concat(b1.getSelectOptionsPropertyNames());for(var i=0;i<c1.length;i++){s.oSmartFilterbar.addFieldToAdvancedArea(c1[i]);}if(s.alr_visualFilterBar&&s.bVisualFilterInitialised){s.alr_visualFilterBar.addVisualFiltersToBasicArea(c1);}}function O(){if(s._bIsStartingUp){return;}if(I){return;}var i=H();try{o=n.storeInnerAppStateWithImmediateReturn(i);}catch(b1){L.error("AnalyticalListPage.fnStoreCurrentAppStateAndAdjustURL: "+b1);}if(o instanceof sap.ui.generic.app.navigation.service.NavError){o=null;return;}if(o&&A!==o.appStateKey){r.appStateKey=o.appStateKey;}}function P(){var i=s.oController.getOwnerComponent().getModel("_templPriv");if(i.getProperty('/alp/filterMode')===F){if(s.alr_visualFilterBar&&s.alr_visualFilterBar.bIsInitialised&&i.getProperty("/alp/searchable")===false){s.oSmartFilterbar.showFilterDialog();}}}function Q(){if(s.oSmartFilterbar.isInitialised()){s.oSmartFilterbar.checkSearchAllowed(s);}}function T(){var i=s.oController.getOwnerComponent().getModel("_filter");i.setData(q.extend(true,{},s.oSmartFilterbar.getFilterData(true)));s.filterBarController._updateFilterLink();}function V(i,b1,c1){var d1=new U({selectionVariant:i});s.oSmartFilterbar.setUiState(d1,{replace:b1,strictMode:c1});}function W(i){p=n.parseNavigation();}function X(){try{var i=new Promise(function(c1,d1){_=c1;p.done(x);p.fail(d1);});return i;}catch(b1){a1();}}function Y(){I=false;_();}function Z(){return h;}function $(i){if(!i){var b1=s.oIappStateHandler.fnGetStartUpSelectionVariant();if(b1){var c1=b1.getParameterNames().concat(b1.getSelectOptionsPropertyNames());s.alr_visualFilterBar.addVisualFiltersToBasicArea(c1);}}s.alr_visualFilterBar.updateVisualFilterBindings(true);if(s.oSmartFilterbar.isCurrentVariantStandard()){s.oIappStateHandler.fnCheckMandatory();s.oIappStateHandler.fnCheckToLaunchDialog();}}function a1(){u();T();if(s.alr_visualFilterBar&&s.alr_visualFilterBar.bIsInitialised){s.oIappStateHandler.fnUpdateVisualFilterBar(true);}}return{getFilterState:E,fnCheckMandatory:Q,fnCheckToLaunchDialog:P,getCurrentAppState:H,fnUpdateSVFB:T,fnSetDefaultFilter:u,fnRestoreFilterState:t,getUrlParameterInfo:k,onSmartFilterBarInitialise:W,onSmartFilterBarInitialized:X,fnStoreCurrentAppStateAndAdjustURL:O,fnSetFiltersUsingUIState:V,fnResolveStartUpPromise:Y,fnGetStartUpSelectionVariant:Z,fnUpdateVisualFilterBar:$,fnOnError:a1,getInitialNavigationContext:G};}return B.extend("sap.suite.ui.generic.template.AnalyticalListPage.controller.IappStateHandler",{constructor:function(s,c,n){q.extend(this,g(s,c,n));}});});
