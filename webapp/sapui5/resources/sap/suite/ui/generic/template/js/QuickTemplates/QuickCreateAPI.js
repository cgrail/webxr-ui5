sap.ui.define(["sap/ui/base/ManagedObject","sap/ui/generic/app/transaction/DraftContext","sap/m/MessageToast","sap/base/Log"],function(M,D,a,L){"use strict";var Q=M.extend("sap.suite.ui.generic.template.js.QuickTemplates.QuickCreateAPI",{metadata:{library:"sap.suite.ui.generic.template",properties:{},events:{objectCreated:{parameters:{context:{type:"sap.ui.model.Context"}}},destroyed:{parameters:{collectionItemGuid:{type:"String"}}},autofillLineItems:{parameters:{numberOfLineItems:{type:"Number"}}}}}});Q.EVENT_CONSTANTS={EventChannel:"sap.fiori.cp.quickactions.EventChannel",QUICKCREATE_LINE_ITEMS_FOUND:"LineItemsFound",QUICKCREATE_VIEW_CREATED:"QuickCreateViewCreated"};var A="items",b="participants";Q.CopilotModelName="FioriCopilotODataModel";Q._Instances={};Q.getInstance=function(c){if(!c){return undefined;}if(c.copilotEntity){return Q._Instances[c.copilotEntity.getODataKey()];}else{return Q._Instances[c];}};Q.createAPI=function(c,C,o){function g(){return o.getView().getBindingContext().getObject();}function d(){return o.getQuickCreateItem();}function e(){return C;}function f(){return c;}function h(){return sap.ui.getCore().getModel(Q.CopilotModelName);}function u(i){if(this._bDestroyed){return;}var N=this.getQuickCreateItem();if(N.draftid===i){return;}N.draftid=i;N.copilotEntity.update(N,{error:jQuery.proxy(function(O){L.error(O,"","QuickCreateAPI");},this)});}function j(){return C.getAggregation("rootControl");}function k(){return this.oRootView;}function s(i){this.oRootView=i;this.calculateViewHeight(this.oRootView,true);}function l(){if(this.oRootView&&this.oRootView.getController()&&this.oRootView.getController().bDraftEnabled!==undefined){return this.oRootView.getController().bDraftEnabled;}if(!this.oRootView||!this.oRootView.getBindingContext()){return undefined;}var i=new D(this.getQuickCreateModel());return i.hasDraft(this.oRootView.getBindingContext());}function m(){var i=this.getComponentInstance().getModel();if(!i&&this.oRootView){i=this.oRootView.getModel();}return i;}function n(){return o.isCurrentUserCreator();}function p(){if(!this.oRootView){return undefined;}return this.oRootView.getBindingContext();}function q(){var i=this.getQuickCreateRootBindingContext();if(i&&i.getObject()){return i.getObject().__metadata.type;}return undefined;}function _(i,N,P){var O=P.numberOfLineItems;if(O<=0){return;}this.fireAutofillLineItems({numberOfLineItems:O});}function r(){this._attachToModelBindingChanges();if(!this.oRootView){var V=o.oViewUtils.findFirstViewFromControlHierarchy(this.getRootControl());if(V){this.setRootView(V);}}}function t(){if(!this._bBindingChangeAttached){var i=C.getModel();if(i){var N=i.addBinding.bind(i);var O=this;i.addBinding=function(P){N(P);P.attachEvent("change",O._onDataBindingChanged);};this._bBindingChangeAttached=true;}}}function v(){return new Promise(jQuery.proxy(function(i,N){var O=this.getCopilotModel();O.read("/"+O.getKey(this.getQuickCreateItem()),{success:jQuery.proxy(function(P,R){if(P.modeljson){var S=this.getQuickCreateModel();this._loadingJSON=true;if(this.isDraftEnabled()){S.oData=JSON.parse(P.modeljson);}else{var T=JSON.parse(P.modeljson);S.mChangedEntities=T.mChangedEntities;S.mChangeHandles=T.mChangeHandles;S.mDeferredRequests=T.mDeferredRequests;S.oData=T.oData;}S.updateBindings();}if(i){i();}delete this._loadingJSON;},this),error:jQuery.proxy(function(P){if(N){N(P);}},this)});},this));}function w(){if(!this._oUpdateModelJSONTimer){this._oUpdateModelJSONTimer=setTimeout(this._updateModelJSON,2000);}}function x(){if(this._loadingJSON||this._bDestroyed||!this.isCurrentUserCreator()){return;}this._oUpdateModelJSONTimer=null;var N=this.getQuickCreateItem();var O=this.getQuickCreateModel();var P="";if(this.isDraftEnabled()){var R={};var S=Object.keys(O.mChangedEntities);var T=Object.keys(O.oData);var U={};jQuery.each(T,jQuery.proxy(function(i,W){if(O.mChangedEntities[W]){U={};jQuery.extend(U,O.oData[W]);jQuery.extend(U,O.mChangedEntities[W]);R[W]=U;}else{R[W]=O.oData[W];}},this));jQuery.each(S,jQuery.proxy(function(i,W){if(!R[W]){R[W]=O.mChangedEntities[W];}},this));P=JSON.stringify(R);}else{var V={};V.mChangedEntities=O.mChangedEntities;V.mChangeHandles=O.mChangeHandles;V.mDeferredRequests=O.mDeferredRequests;V.oData=O.oData;P=JSON.stringify(V);}if(P===N.modeljson){return;}N.modeljson=P;N.copilotEntity.update(N,{error:jQuery.proxy(function(i){L.error(i,"","QuickCreateAPI");},this)});}function y(){return new Promise(jQuery.proxy(function(i,N){var O=this.getQuickCreateModel();if(this.oRootView&&this.oRootView.getBindingContext()){if(this.isDraftEnabled()){O.remove(this.oRootView.getBindingContext().getPath(),{success:function(){a.show("Draft has been discarded");i();},error:function(P){N(P);}});}else{O.resetChanges();i();}}else{i();}},this));}function z(V,i){if(V){o.calculateViewHeight(V,i);}}function B(i){o.setComponentContainerHeight(i);}function E(i){if(this._bDestroyed){return;}this.fireObjectCreated({context:i});}function F(){sap.ui.getCore().getEventBus().publish(Q.EVENT_CONSTANTS.EventChannel,Q.EVENT_CONSTANTS.QUICKCREATE_VIEW_CREATED,{api:this});}function G(){if(this._bDestroyed){return;}if(this._oUpdateModelJSONTimer){clearTimeout(this._oUpdateModelJSONTimer);this._oUpdateModelJSONTimer=null;}delete Q._Instances[this._InstanceKey];if(c&&!c._bIsBeingDestroyed&&!c.bIsDestroyed){c.destroy();}this.oRootView=undefined;sap.ui.getCore().getEventBus().unsubscribe(Q.EVENT_CONSTANTS.EventChannel,Q.EVENT_CONSTANTS.QUICKCREATE_LINE_ITEMS_FOUND,this._onLineItemsFound,this);this.fireDestroyed({collectionItemGuid:this._InstanceKey});M.prototype.destroy.call(this);this._bDestroyed=true;}function H(P,i){if(this.getCollectionItem()&&this.getCollectionItem().copilotEntity&&this.getCollectionItem().copilotEntity.getParentEntity()&&this.getCollectionItem().copilotEntity.getParentEntity().copilotEntity){if(P===A){return this.getCollectionItem().copilotEntity.getParentEntity().copilotEntity.getItemsPublic(i);}else if(P===b){return this.getCollectionItem().copilotEntity.getParentEntity().copilotEntity.getParticipantsPublic();}else{return new Promise(function(N,O){if(O){O("Error: "+P+" is not a valid part of a collection.");}else{N([]);}});}}return new Promise(function(N,O){if(O){O("Error: Cannot load collection "+P+". Copilot collection entity cannot be accessed");}else{N([]);}});}function I(i){return H.call(this,A,i);}function J(){return H.call(this,b);}var K=new Q();K.COLLECTION_ITEM_TYPES={};K.COLLECTION_ITEM_TYPES.ITEM_TYPE_NOTE="NOTE";K.COLLECTION_ITEM_TYPES.ITEM_TYPE_RELOBJ="RO";K.COLLECTION_ITEM_TYPES.ITEM_TYPE_SCREENSHOT="SCRS";K.COLLECTION_ITEM_TYPES.ITEM_TYPE_IMAGE="IMG";K.COLLECTION_ITEM_TYPES.ITEM_TYPE_DOCUMENT="DOC";K.COLLECTION_ITEM_TYPES=Object.freeze(K.COLLECTION_ITEM_TYPES);jQuery.extend(K,{getCollectionItem:g.bind(K),getQuickCreateItem:d.bind(K),updateDraftID:u.bind(K),getRootControl:j.bind(K),isDraftEnabled:l.bind(K),isCurrentUserCreator:n.bind(K),getQuickCreateRootBindingContext:p.bind(K),getQuickCreateRootEntityType:q.bind(K),_onComponentContainerAfterRendering:r.bind(K),calculateViewHeight:z.bind(K),setComponentContainerHeight:B.bind(K),getQuickCreateModel:m.bind(K),objectCreated:E.bind(K),destroy:G.bind(K),getRootView:k.bind(K),setRootView:s.bind(K),getComponentInstance:e.bind(K),getComponentContainer:f.bind(K),_onDataBindingChanged:w.bind(K),_attachToModelBindingChanges:t.bind(K),loadQuickCreateModelFromJSON:v.bind(K),_updateModelJSON:x.bind(K),getCopilotModel:h.bind(K),discardQuickCreateDraft:y.bind(K),_onLineItemsFound:_.bind(K),fireQuickCreateViewCreated:F.bind(K),getCollectionItems:I.bind(K),getCollectionParticipants:J.bind(K)});c.addEventDelegate({onAfterRendering:K._onComponentContainerAfterRendering});K._InstanceKey=K.getCollectionItem().copilotEntity.getODataKey();if(Q._Instances[K._InstanceKey]){Q._Instances[K._InstanceKey].destroy();}delete Q._Instances[K._InstanceKey];Q._Instances[K._InstanceKey]=K;sap.ui.getCore().getEventBus().subscribe(Q.EVENT_CONSTANTS.EventChannel,Q.EVENT_CONSTANTS.QUICKCREATE_LINE_ITEMS_FOUND,K._onLineItemsFound,K);C.oQuickCreateAPI=K;return C.oQuickCreateAPI;};return Q;},true);
