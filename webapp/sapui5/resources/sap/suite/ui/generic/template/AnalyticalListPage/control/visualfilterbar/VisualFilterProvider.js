sap.ui.define(["sap/ui/comp/odata/MetadataAnalyser","sap/suite/ui/generic/template/AnalyticalListPage/util/FilterUtil","sap/suite/ui/generic/template/AnalyticalListPage/util/V4Terms","sap/base/Log"],function(M,F,V,L){"use strict";var a=function(f){L.setLevel(L.Level.WARNING,"VisualFilter");this._filter=f;this._oMetadataAnalyser=new M(f.getModel());this._groupList=[];this._groupListByName={};this._groupMap={};this._measureList=[];this._measureMap={};this._dimensionMap={};this._selectionFieldsLength=0;this._selectionFieldsParsed=0;this._annotationData={Filters:[]};this._allSelectionFields;this._initMetadata();};a.prototype._initMetadata=function(){var e=this._filter.getEntitySet();var b=this._oMetadataAnalyser.getEntityTypeNameFromEntitySetName(e);this._getFieldAnnotations(e,b);this._getVisualFilterAnnotation(b);};a.prototype.getVisualFilterConfig=function(){return JSON.parse(JSON.stringify(this._filterConfig));};a.prototype.getMetadataAnalyser=function(){return this._oMetadataAnalyser;};a.prototype._getFieldAnnotations=function(e,b){if(!e){return;}var c=this._oMetadataAnalyser.getEntityTypeNameFromEntitySetName(e);if(!c){return;}var m=this._filter.getModel();var d=m.getMetaModel();if(!b||!d){return;}var g={};var f={};var h=this._oMetadataAnalyser.getFieldGroupAnnotation(c);for(var i=0;i<h.length;i++){var k=h[i];var l={name:k.groupName,label:k.groupLabel,fieldList:k.fields};f[l.name]=l;for(var j=0;j<k.fields.length;j++){g[k.fields[j]]=l;}}var n=d.getODataEntityType(b);var s=n[V.SelectionFields];var o={};if(s){for(var i=0;i<s.length;i++){var p=s[i];o[p.PropertyPath]=p;}}var u={};var q=this._oMetadataAnalyser.getFieldsByEntityTypeName(c);for(var i=0;i<q.length;i++){var r=q[i];var t=r.name;var v=d.getODataProperty(n,t);var w=v["sap:aggregation-role"];if(w=="dimension"){var x={name:t,fieldInfo:r,propInfo:v};var l=g[t];if(l){for(var j=0;j<l.fieldList.length;j++){if(l.fieldList[j]==t){l.fieldList[j]=x;break;}}}else{var y=n[V.Label]?n[V.Label].String:undefined;var z=o[t]?"_BASIC":(n[y]||n.name);var l=f[z];if(!l){l={name:z,label:z=="_BASIC"?this._filter.getModel("i18n").getResourceBundle().getText("VIS_FILTER_GRP_BASIC_TITLE"):z,fieldList:[]};f[z]=l;}l.fieldList.push(x);g[t]=l;}u[l.name]=true;}}var A=[];if(u["_BASIC"]){A.push(f["_BASIC"]);delete f["_BASIC"];}for(var i=0;i<h.length;i++){var z=h[i].groupName;if(z=="_BASIC"){continue;}if(u[z]){A.push(f[z]);}delete f[z];}for(var z in f){if(u[z]){A.push(f[z]);}delete f[z];}f={};for(var i=0;i<A.length;i++){var l=A[i];f[l.name]=l;}};a.prototype.getGroupList=function(){return this._groupList?this._groupList:[];};a.prototype.getGroupMap=function(){return this._groupMap?this._groupMap:{};};a.prototype.getMeasureMap=function(){return this._measureMap;};a.prototype.getDimensionMap=function(){return this._dimensionMap;};a.prototype.getEntityType=function(e){return this._oMetadataAnalyser.getEntityTypeNameFromEntitySetName(e);};a.prototype._updateGroupList=function(e,b,p,d){var i=function(g){return g.PropertyPath===p;};var c;if(this._allSelectionFields){c=this._allSelectionFields.filter(i);}c=(c&&c.length)?true:false;var m=this._filter.getModel().getMetaModel();var f=m.getODataEntityType(e);f=f[V.Label]?f[V.Label].String:f.name;var u=function(g,h){for(var k in h._groupList){var j=h._groupList[k],l=false;if(j.name===g){var n=j.fieldList;for(var o in n){if(n[o].name===d){l=true;}else{continue;}}if(!l){var q=m.getODataEntityType(b);var r=h._oMetadataAnalyser.getFieldsByEntityTypeName(b);for(var k in r){if(r[k].name===d){var s=m.getODataProperty(q,r[k].name);n.push({name:r[k].name,fieldInfo:r[k],propInfo:s});}}}}else{continue;}}};if(c){u('_BASIC',this);}else{u(f,this);}};a.prototype._createDimensionMap=function(e,b){var c,m=this._filter.getModel(),d=m.getMetaModel(),f,g={},p,h,i,j={};if(!d){return false;}f=d.getODataEntityType(b);c=this._oMetadataAnalyser.getFieldsByEntityTypeName(b);if(!this._dimensionMap[e]||!this._measureMap[e]){for(var k in c){var D=c[k];p=d.getODataProperty(f,D.name);if(D['aggregationRole']==='dimension'){h={name:D.name,fieldInfo:D,propInfo:p};g[D.name]=h;}else if(D['aggregationRole']==='measure'){i={name:D.name,label:D.fieldLabel,fieldInfo:D,propInfo:p};j[D.name]=i;}}if(Object.keys(g).length){this._dimensionMap[e]=g;}if(Object.keys(j).length){this._measureMap[e]=j;}}};a.prototype._createGroupList=function(f,p,i,g){var b;if(i){b=this._filter.getModel("i18n").getResourceBundle().getText("VIS_FILTER_GRP_BASIC_TITLE");this._addToGroupListByName('_BASIC',b,f,p);}else{b=f.groupTitle;this._addToGroupListByName(g,b,f,p);}};a.prototype._addToGroupListByName=function(g,b,f,p){if(this._groupListByName[g]===undefined){this._groupListByName[g]=[];this._groupListByName[g].push({name:g,label:b,fieldList:[]});this._groupListByName[g][0].fieldList.push({name:f.name,fieldInfo:f,propInfo:p});}else{this._groupListByName[g][0].fieldList.push({name:f.name,fieldInfo:f,propInfo:p});}};a.prototype._setGroupListForDialog=function(){if(Object.keys(this._groupListByName).length){for(var k in this._groupListByName){this._groupList.push(this._groupListByName[k][0]);}}var g={};for(var i=0;i<this._groupList.length;i++){var b=this._groupList[i];g[b.name]=b;}this._groupMap=g;};a.prototype._getScaleFactor=function(e,A){if(!A){return"";}if(A.indexOf("com.sap.vocabularies.UI.v1.DataPoint")>-1){A=A.toString();if(A.charAt(0)==="@"){A=A.slice(1);}var E=e[A];if(E&&E.ValueFormat&&E.ValueFormat.ScaleFactor){return F.getPathOrPrimitiveValue(E.ValueFormat.ScaleFactor);}else{return"";}}};a.prototype._getNumberOfFractionalDigits=function(e,A){if(!A){return"";}if(A.indexOf("com.sap.vocabularies.UI.v1.DataPoint")>-1){A=A.toString();if(A.charAt(0)==="@"){A=A.slice(1);}var E=e[A];if(E&&E.ValueFormat&&E.ValueFormat.NumberOfFractionalDigits){return F.getPathOrPrimitiveValue(E.ValueFormat.NumberOfFractionalDigits);}else{return"";}}};a.prototype._getVisualFilterAnnotation=function(e){var m=this._filter.getModel();var b=m.getMetaModel();if(!e||!b){return null;}var c=b.getODataEntityType(e);if(!c){return null;}this._allSelectionFields=c[V.SelectionFields];var d=this._filter._smartFilterContext.getFilterBarViewMetadata(),i,f,g,G,h,v,j,k,l,n=[],o,p,q;for(var r in d){n=d[r].fields;G=d[r].groupName;for(var P in n){i=n[P].filterable;f=n[P].filterRestriction;l=n[P].hasFixedValues===true;q=n[P].displayBehaviour;if(f==="auto"){f="multiple";}if(f!=="interval"&&i!=="false"){o=n[P];var I=(o[V.Hidden]&&o[V.Hidden].Bool==="true")||(o[V.HiddenFilter]&&o[V.HiddenFilter].Bool==="true");j=n[P].fieldName;g=n[P].isMandatory;h=n[P].requiredFilterField;for(var s in n[P]){if(s.indexOf(V.ValueList)>-1&&n[P][s].PresentationVariantQualifier){if(I){L.warning("The dimension "+j+" is set to UI.Hidden in the collection "+o.groupEntitySet+". Corresponding chart cannot be displayed as VisualFilter.","","VisualFilter");break;}k=(G==="_BASIC")||g||h;p=b.getODataProperty(c,j);v=n[P][s];this._createGroupList(o,p,k,G);this._getAnnotationFromValueList(e,k,v,j,f,l,g,q);}}}}}this._setGroupListForDialog();this._filterConfig=this._getConfig(this._annotationData);};a.prototype._getAnnotationFromValueList=function(e,i,v,p,f,b,I,d,c){var P=e;if(v!==undefined){var g={Filters:[]},s,h=F.readProperty(v,"PresentationVariantQualifier.String"),j=F.readProperty(v,"SelectionVariantQualifier.String"),k=F.readProperty(v,"CollectionPath"),l=F.readProperty(v,"Parameters"),m=F.readProperty(k,"String"),P=this.getEntityType(m),n=this._filter.getModel(),o=n.getMetaModel(),q=o.getODataEntityType(P);if(j){var r=this._oMetadataAnalyser.getSelectionVariantAnnotationList(P);s=this._getFiltersAndParamsFromSV(r,j);}if(h){var Q=h,t=this._oMetadataAnalyser.getPresentationVariantAnnotation(P,Q),u={},w=F.readProperty(t,"chartAnnotation.annotation.Dimensions.0.PropertyPath");if(w){this._createDimensionMap(k.String,P);this._updateGroupList(e,P,p,w);if(!d){var E=this._oMetadataAnalyser.getTextArrangementValue(e);if(b){d=E?E:sap.ui.comp.smartfilterbar.DisplayBehaviour.descriptionOnly;}else{d=E?E:sap.ui.comp.smartfilterbar.DisplayBehaviour.descriptionAndId;}}u=this._createConsumeableObjectFromAnnotation(t,k,i,l,p,f,b,I,d,q,s);if(u){g.Filters.push(u);this._annotationData.Filters.push(u);}}}}};a.prototype._createSortObject=function(c,m,d,D){var s=m,S=true;if(c==="Line"){s=d;if(!D){S=false;}}var o={};o.Field={"String":s};o.Descending={"Boolean":S};return o;};a.prototype._createSortOrderFromAnnotation=function(p,m,d,c,A,D){A.SortOrder=[];var s=p.annotation.SortOrder,S,b;if(s!==undefined&&s.length){for(var i=0;i<s.length;i++){var e=F.readProperty(s,i+".Property.PropertyPath"),I=F.readProperty(s,i+".Descending.Bool");if(e&&I){if(c==="Line"){if(!D){if(e===d){b=d;S=!(I==="false");break;}}}else if(e===m){b=m;S=!(I==="false");break;}}}if(b){var o={};o.Field={"String":b};o.Descending={"Boolean":S};A.SortOrder.push(o);}}if(!A.SortOrder.length){A.SortOrder.push(this._createSortObject(c,m,d,D));}return A;};a.prototype._getChartQualifier=function(p){var v=p.annotation.Visualizations,A;A=v?(v[0].AnnotationPath).substring(1):undefined;return A;};a.prototype._IsDimensionDateTime=function(e,d){var D=this.getDimensionMap(),o=F.readProperty(D,e+"."+d+".fieldInfo"),b=false,f;if(o.type==="Edm.DateTime"||o.type==="Edm.Time"){b=true;}else{f=o[V.CalendarYear]||o[V.CalendarYearMonth]||o[V.CalendarYearMonthDay];if(f&&f.Bool&&f.Bool==="true"){b=true;}}return b;};a.prototype._IsDimensionDateTimeOffset=function(e,d){var D=this.getDimensionMap(),o=F.readProperty(D,e+"."+d+".fieldInfo"),b=false;if(o.type==="Edm.DateTimeOffset"){b=true;}return b;};a.prototype._isDimensionDateFilterStringType=function(e,d){var D=this.getDimensionMap(),o=D&&F.readProperty(D,e+"."+d+".fieldInfo"),f=o&&o[V.CalendarYearMonthDay],b=false;if(o&&o.type==="Edm.String"){if(f&&f.Bool&&f.Bool==="true"){b=true;}}return b;};a.prototype._createConsumeableObjectFromAnnotation=function(p,c,i,b,d,f,e,I,g,h,s){var j={},E=this._oMetadataAnalyser.getEntitySetNameFromEntityTypeName(this.getEntityType(c.String)),k=p.chartAnnotation.annotation.ChartType.EnumMember.split("/"),l=k[k.length-1],D,m,n=false;if(l){j.Type={"String":l};}var o=F.readProperty(p,"chartAnnotation.annotation.Dimensions.0.PropertyPath");var q=F.readProperty(p,"chartAnnotation.annotation.Measures.0.PropertyPath");var r=this._isValidDimensionandMeasure(E,o,q);if(!r){return r;}D=this._IsDimensionDateTime(E,o);if(D){m=this._isDimensionDateFilterStringType(E,o);j.stringdate=m;}else{n=this._IsDimensionDateTimeOffset(E,o);}j.dimensionFieldIsDateTime=D;j.dimensionFieldIsDateTimeOffset=n;j=this._createSortOrderFromAnnotation(p,q,o,l,j,D);var t="";if(p.chartAnnotation.measureAttributes[q]){t=p.chartAnnotation.measureAttributes[q].dataPoint;}var u=this._getScaleFactor(h,t);var v=this._getNumberOfFractionalDigits(h,t);var w=this._getChartQualifier(p);j.scaleFactor={"String":u};j.numberOfFractionalDigits={"String":v};j.chartQualifier=w;if(f){j.filterRestriction={"String":f};}else{j.filterRestriction={"String":undefined};}j.isDropDown=e;j.Dimensions=[];var x={};x.Field={"String":o};j.Dimensions.push(x);j.Measures=[];var y={};y.Field={"String":q};j.Measures.push(y);if(i){j.Selected={"Boolean":"true"};}else{j.Selected={"Boolean":"false"};}if(c){j.CollectionPath=c;}if(b&&b.length){j.InParameters=[];for(var z in b){var A=b[z]?b[z]:undefined,B=(A&&A.RecordType)?A.RecordType:undefined,C=(A.ValueListProperty&&A.ValueListProperty.String)?A.ValueListProperty.String:undefined,G=(A.LocalDataProperty&&A.LocalDataProperty.PropertyPath)?A.LocalDataProperty.PropertyPath:undefined;if(A&&B&&C&&G){if(j.OutParameter===undefined&&(B===V.ValueListParameterOut||B===V.ValueListParameterInOut)&&C===o&&G===d){j.OutParameter=G;}if(G!==d&&(B===V.ValueListParameterIn||B===V.ValueListParameterInOut)){var H=this._filter.getModel().getMetaModel(),J=this.getEntityType(c.String),K=H.getODataEntityType(J),N=H.getODataEntitySet(E),O=H.getODataProperty(K,C);var P=F.isPropertyNonFilterable(N,O.name);if(P){L.error('IN Parameter valueListProperty: '+C+' is non filterable');}else{if(!F.isPropertyHidden(O)){j.InParameters.push({localDataProperty:G,valueListProperty:C});}}}}}}if(d){j.ParentProperty=d;}j.isMandatoryProperty=I;j.displayBehaviour=g;if(s){j.selectionVariant=s;}return j;};a.prototype._getConfig=function(b){var c={filterList:[]};if(!b){return c;}var f={};var d={};var e=b.Filters;for(var i=0;i<e.length;i++){var g=e[i];var p=g.ParentProperty;var h=g.Dimensions[0].Field.String;var l=g.CollectionPath.String;var m=this._dimensionMap[l][h];if(!m){L.error("Unknown Dimension :"+h);continue;}var n=g.Measures[0].Field.String;var o=this._measureMap[l][n];if(!o){L.error("Unknown Measure :"+n);continue;}var q=m.fieldInfo.description;if(!q){q=h;}if(!f[h]){f[h]=[];}if(!d[p]){d[p]=[];}var r={type:g.Type.String,selected:g.Selected.Boolean=="true",dimension:{field:h,fieldDisplay:q},measure:{field:g.Measures[0].Field.String},sortOrder:g.SortOrder,scaleFactor:g.scaleFactor.String,numberOfFractionalDigits:g.numberOfFractionalDigits.String,chartQualifier:g.chartQualifier,dimensionFieldIsDateTime:g.dimensionFieldIsDateTime,dimensionFieldIsDateTimeOffset:g.dimensionFieldIsDateTimeOffset,stringdate:g.stringdate,selectionVariant:g.selectionVariant};r.collectionPath=g.CollectionPath.String;r.outParameter=g.OutParameter;r.inParameters=g.InParameters;r.parentProperty=g.ParentProperty;r.filterRestriction=g.filterRestriction.String;r.isMandatory=g.isMandatoryProperty;r.isDropDown=g.isDropDown;r.displayBehaviour=g.displayBehaviour;d[p].push(r);f[h].push(r);}var u={};for(var i=0;i<this._groupList.length;i++){var s=this._groupList[i];for(var j=0;j<s.fieldList.length;j++){var t=s.fieldList[j];var e=d[t.name];if(!e){continue;}u[s.name]=true;for(var k=0;k<e.length;k++){c.filterList.push(e[k]);}}}for(var i=this._groupList.length-1;i>=0;i--){var s=this._groupList[i];if(u[s.name]){continue;}this._groupList.splice(i,1);delete this._groupMap[s.name];}return c;};a.prototype._isValidDimensionandMeasure=function(e,d,m){if(!(d&&m)){return false;}var D=this.getDimensionMap(),o=F.readProperty(D,e+"."+d+".fieldInfo","","VisualFilter");var b=this.getMeasureMap(),c=F.readProperty(b,e+"."+m+".fieldInfo","","VisualFilter"),f=b[e],g=0;if(!(o&&c)){L.error("The dimension "+d+" or the measure "+m+" or both are either NOT given in the chart, or IS given but undefined in metadata. Corresponding chart cannot be displayed as VisualFilter.");return false;}for(var i in f){var h=f[i].fieldInfo;if(h[V.Hidden]&&h[V.Hidden].Bool==="true"){L.warning("The measure "+h.name+" is set to UI.Hidden in the collection "+e+". Chart configured with this measure cannot be rendered.","","VisualFilter");g++;}}var I=o[V.Hidden]&&o[V.Hidden].Bool==="true";if(o&&I){L.warning("The dimension "+d+" is set to UI.Hidden in the collection "+e+". Corresponding chart cannot be displayed as VisualFilter.","","VisualFilter");return false;}if(!(o['aggregationRole']==="dimension"&&c['aggregationRole']==="measure")){L.error("The dimension "+d+" or the measure "+m+" or both have NO 'sap:aggregation-role' defined in metadata. Corresponding chart cannot be displayed as VisualFilter.");return false;}if(Object.keys(f).length===g){L.warning("All the measures in the collection "+e+" are set to UI.Hidden. Corresponding chart cannot be displayed as VisualFilter.","","VisualFilter");return false;}return true;};a.prototype._getFiltersAndParamsFromSV=function(s,b){for(var i in s){if(s[i].qualifier===b){return s[i].annotation;}}};return a;},true);
