/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["jquery.sap.global","sap/ui/core/UIComponent","sap/m/NavContainer","sap/f/FlexibleColumnLayout","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/json/JSONModel","sap/ui/model/resource/ResourceModel","sap/ui/generic/app/ApplicationController","sap/suite/ui/generic/template/lib/Application","sap/suite/ui/generic/template/lib/BusyHelper","sap/suite/ui/generic/template/lib/NavigationController","sap/suite/ui/generic/template/lib/ProcessObserver","sap/suite/ui/generic/template/lib/TemplateAssembler","sap/suite/ui/generic/template/lib/CRUDHelper","sap/suite/ui/generic/template/lib/ViewDependencyHelper","sap/suite/ui/generic/template/lib/testableHelper","sap/suite/ui/generic/template/support/lib/CommonMethods","sap/suite/ui/generic/template/library","sap/base/Log"],function(q,U,N,F,a,b,J,R,A,c,B,d,P,T,C,V,t,e,f,L){"use strict";A=t.observableConstructor(A);var D=sap.m.DraftIndicatorState;var r=T.getRegisterAppComponent();var o;function g(){o=o||new R({bundleName:"sap/suite/ui/generic/template/lib/i18n/i18n"}).getResourceBundle();return o.getText.apply(o,arguments);}function h(){return new P({processObservers:[]});}var m=sap.ui.getCore().getMessageManager().getMessageModel();var v=new a({path:"validation",operator:b.EQ,value1:true});function j(k,l){var n={oAppComponent:k,componentRegistry:Object.create(null),aRunningSideEffectExecutions:[],getText:g,mRouteToTemplateComponentPromise:Object.create(null),oTemplatePrivateGlobalModel:(new J()).setDefaultBindingMode("TwoWay"),aStateChangers:[],oPaginatorInfo:Object.create(null),oStatePreserversAvailablePromise:Promise.resolve(),oValidationMessageBinding:m.bindList("/",null,null,v)};n.oValidationMessageBinding.attachChange(q.noop);var p;var s;var u;function w(){var i=sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService("URLParsing");n.oTemplatePrivateGlobalModel.setProperty("/generic",{crossAppNavSupport:!!i&&i.isIntentUrl(document.URL),draftIndicatorState:D.Clear,shellServiceUnavailable:false,forceFullscreenCreate:false});k.setModel(n.oTemplatePrivateGlobalModel,"_templPrivGlobal");n.oShellServicePromise.catch(function(){n.oTemplatePrivateGlobalModel.setProperty("/generic/shellServiceUnavailable",true);});}function x(){n.fnAddSideEffectPromise=function(_){var i=0;for(;n.aRunningSideEffectExecutions[i];){i++;}n.aRunningSideEffectExecutions[i]=_;var a1=function(){n.aRunningSideEffectExecutions[i]=null;};_.then(a1,a1);};p.attachEvent("beforeSideEffectExecution",function(i){if(i.getParameter("valueChange")||i.getParameter("fieldControl")){var _=i.getParameter("promise");n.oBusyHelper.setBusy(_);n.fnAddSideEffectPromise(_);}});var Z=k.getModel("_templPrivGlobal");var $="/generic/draftIndicatorState";p.attachBeforeQueueItemProcess(function(i){if(i.draftSave){Z.setProperty($,D.Saving);}});p.attachOnQueueCompleted(function(){if(Z.getProperty($)===D.Saving){Z.setProperty($,D.Saved);}});p.attachOnQueueFailed(function(){if(Z.getProperty($)===D.Saving){Z.setProperty($,D.Clear);}});Z.setProperty("/generic/appComponentName",k.getMetadata().getComponentName());}function y(){var i={appComponent:k,oTemplateContract:n,application:new c(n),oViewDependencyHelper:new V(n)};n.oViewDependencyHelper=i.oViewDependencyHelper;n.oShellServicePromise=k.getService("ShellUIService").catch(function(){var $=sap.ui.core.service.ServiceFactoryRegistry.get("sap.ushell.ui5service.ShellUIService");return(($&&$.createInstance())||Promise.reject());});n.oShellServicePromise.catch(function(){L.warning("No ShellService available");});(U.prototype.init||q.noop).apply(k,arguments);n.oBusyHelper.setBusy(n.oShellServicePromise);u=r(i);var Z=k.getModel();n.bCanonicalRequests=false;p=new A(Z);w();s=new d(n);x();C.enableAutomaticDraftSaving(n);if((!Z.oMetadata||!Z.oMetadata.isLoaded())||Z.oMetadata.isFailed()){Z.attachMetadataFailed(function(){s.navigateToMessagePage({title:g("ST_GENERIC_ERROR_TITLE"),text:g("ST_GENERIC_ERROR_SYSTEM_UNAVAILABLE"),icon:"sap-icon://message-error",description:g("ST_GENERIC_ERROR_SYSTEM_UNAVAILABLE_DESC")});for(var $ in n.componentRegistry){n.componentRegistry[$].fnViewRegisteredResolve(true);}});}if(k&&k.getMetadata()&&k.getMetadata().getManifest()){e.setAppComponent(k);}e.setApplicationStatus(e.mApplicationStatus.LOADING);e.publishEvent("elements","ViewRenderingStarted",{});n.oBusyHelper.setBusyReason("initAppComponent",false);}function z(){if(n.oNavigationHost){return"";}if(n.sRoutingType==="f"){var i=new F();n.oNavigationHost=i;n.aNavigationObservers=[new P({processName:"BeginColumnNavigation",eventHandlers:{attachProcessStart:i.attachBeginColumnNavigate.bind(i),attachProcessStop:i.attachAfterBeginColumnNavigate.bind(i)}}),new P({processName:"MidColumnNavigation",eventHandlers:{attachProcessStart:i.attachMidColumnNavigate.bind(i),attachProcessStop:i.attachAfterMidColumnNavigate.bind(i)}}),new P({processName:"EndColumnNavigation",eventHandlers:{attachProcessStart:i.attachEndColumnNavigate.bind(i),attachProcessStop:i.attachAfterEndColumnNavigate.bind(i)}})];n.oNavigationObserver=new P({processObservers:n.aNavigationObservers});n.aHeaderLoadingObservers=[h(),h(),h()];}else{var Z=new N({id:k.getId()+"-appContent"});n.oNavigationHost=Z;n.oNavigationObserver=new P({processName:"Navigation",eventHandlers:{attachProcessStart:Z.attachNavigate.bind(Z),attachProcessStop:Z.attachAfterNavigate.bind(Z)}});}n.oHeaderLoadingObserver=new P({processObservers:n.aHeaderLoadingObservers||[]});n.oPagesDataLoadedObserver=new P({processObservers:[n.oHeaderLoadingObserver,n.oNavigationObserver]});n.oNavigationHost.addStyleClass(n.oApplicationProxy.getContentDensityClass());n.oBusyHelper=new B(n);n.oBusyHelper.setBusyReason("initAppComponent",true,true);return n.oNavigationHost;}function E(){if(n.oNavigationHost){n.oNavigationHost.destroy();}if(p){p.destroy();}if(s){s.destroy();}if(n.oValidationMessageBinding){n.oValidationMessageBinding.destroy();}e.setAppComponent(null);(U.prototype.exit||q.noop).apply(k,arguments);u();t.endApp(l);}function G(i){var Z=Object.keys(i).map(function($){var _=i[$];if(_.pages){_.pages=G(_.pages);}return i[$];});return Z;}function H(Z,$){if(!Z){return;}for(var i=0;i<Z.length;i++){var _=Z[i];if(_.routingSpec&&_.routingSpec.noOData){_.entitySet=_.routingSpec.routeName;if($>1){_.navigationProperty=_.routingSpec.routeName;}}H(_.pages,$+1);if(_.embeddedComponents){for(var a1 in _.embeddedComponents){var b1=_.embeddedComponents[a1];if(b1.pages){b1.pages=G(b1.pages);H(b1.pages,$+1);}}}if(_.implementingComponent&&_.implementingComponent.pages){_.implementingComponent.pages=G(_.implementingComponent.pages);H(_.implementingComponent.pages,$+1);}}}var I;function K(){if(!I){var i=k.getMetadata();I=i.getManifestEntry("sap.ui.generic.app");if(I._version==="1.3.0"&&I.pages&&q.isPlainObject(I.pages)){I.pages=G(I.pages);}H(I.pages,0);}return I;}var M;function O(){if(!M){M=q.extend({},k.getMetadata().getManifest());M["sap.ui.generic.app"]=K();}return M;}function Q(){var i=k.getManifestObject();var Z=i.getEntry("sap.ui.generic.app").settings;n.sRoutingType=(Z&&Z.flexibleColumnLayout)?"f":"m";return"sap."+n.sRoutingType+".routing.Router";}var S=Promise.resolve();function W(){var i=new Promise(function(Z){S.then(function(){var $=[];n.oNavigationControllerProxy.getActiveComponents().forEach(function(_){var a1=n.componentRegistry[_];var b1=a1.oComponent.getComponentContainer();var c1=b1.getParent();if(c1.getMetadata().getName()!=="sap.m.NavContainer"){throw new Error("Recreation only possible for sap.m.NavContainer");}var d1=n.oNavigationControllerProxy.createComponentInstance(n,a1.routeConfig,n.oNavigationControllerProxy.mRouteToComponentResolve[a1.route]);$.push(d1.loaded().then(function(d1){var e1=b1.getComponentInstance().getBindingContext();c1.removePage(b1);c1.addPage(d1);c1.to(d1);b1.destroy();var f1=d1.getComponentInstance();var g1=n.componentRegistry[f1.sId];n.mRouteToTemplateComponentPromise[a1.route]=Promise.resolve(f1);if(e1){Promise.all([g1.viewRegistered,g1.reuseComponentsReady]).then(function(){g1.utils.bindComponent(e1.getPath(),true);});}return g1.oViewRenderedPromise;}));});Z(Promise.all($));});});S=i.then(q.noop);return S;}var X={init:y,createContent:z,exit:E,_getRouterClassName:Q,getConfig:K,getInternalManifest:O,getTransactionController:function(){return p.getTransactionController();},getApplicationController:function(){return p;},getNavigationController:function(){return s;}};var Y={retemplateActiveComponents:W};if(sap.ui.getCore().getConfiguration().getDesignMode()){q.extend(X,Y);}return X;}return U.extend("sap.suite.ui.generic.template.lib.AppComponent",{metadata:{config:{title:"SAP UI Application Component",fullWidth:true},properties:{forceGlobalRefresh:{type:"boolean",defaultValue:true},"considerAnalyticalParameters":{"type":"boolean","defaultValue":"false"},"showDraftToggle":{"type":"boolean","defaultValue":false}},events:{pageDataLoaded:{}},routing:{config:{async:true,viewType:"XML",viewPath:"",clearTarget:false},routes:[],targets:[]},library:"sap.suite.ui.generic.template"},constructor:function(){var i=t.startApp();q.extend(this,j(this,i));(U.prototype.constructor||q.noop).apply(this,arguments);}});});
