/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/gantt/library","sap/base/util/ObjectPath","./AxisTimeStrategyBase","../misc/Utility","../misc/Format"],function(l,O,A,U,F){"use strict";sap.gantt.axistime.ProportionTimeLineOptions=l.config.DEFAULT_TIME_ZOOM_STRATEGY;var P=A.extend("sap.gantt.axistime.ProportionZoomStrategy");P.prototype.init=function(){this._aZoomRate=new Array(10);this.setProperty("coarsestTimeLineOption",sap.gantt.axistime.ProportionTimeLineOptions["1month"],true);this.setProperty("finestTimeLineOption",sap.gantt.axistime.ProportionTimeLineOptions["5min"],true);this.setProperty("timeLineOptions",sap.gantt.axistime.ProportionTimeLineOptions,true);this.setProperty("timeLineOption",sap.gantt.axistime.ProportionTimeLineOptions["4day"],true);this.setProperty("zoomLevel",0,true);this.setProperty("zoomLevels",10,true);};P.prototype.applySettings=function(s){A.prototype.applySettings.call(this,s);};P.prototype.setVisibleHorizon=function(v){this.setVisibleHorizonWithReason(v,"visibleHorizonUpdated");return this;};P.prototype.setVisibleHorizonWithReason=function(v,r,o){if(v&&!v.getStartTime()&&!v.getEndTime()){this._bHorizontalScroll=false;}else if(v&&(!v.getStartTime()||!v.getEndTime())){this._bHorizontalScroll=true;}else{this._bHorizontalScroll=false;}A.prototype.setVisibleHorizon.apply(this,arguments);var L=this.getVisibleHorizon();if(L){this.fireRedrawRequest(false,r,L,o);}return this;};P.prototype.setTotalHorizon=function(t){A.prototype.setTotalHorizon.apply(this,arguments);if(this.getAxisTime()){this.calZoomBase();this.createAxisTime(this.getAxisTime().getLocale());this.fireRedrawRequest(true,"totalHorizonUpdated");}return this;};P.prototype.updateStopInfo=function(s){this.setZoomLevel(s.index);return this;};P.prototype.setZoomLevel=function(z){if(z>=0&&z!==this.getZoomLevel()){this.setProperty("zoomLevel",z,true);if(this._aZoomRate[z]){var n=this.calVisibleHorizonByRate(this._aZoomRate[z]);this.setVisibleHorizonWithReason(n,"zoomLevelChange");}}return this;};P.prototype.setZoomLevels=function(z){this.setProperty("zoomLevels",z,true);if(z>1){this._aZoomRate=new Array(z);}else{this._aZoomRate=[1];}this._updateZoomRateOnStops();return this;};P.prototype.syncContext=function(n){var a=false,z=false;var r={zoomLevel:undefined,axisTimeChanged:false};var o=this.getGanttVisibleWidth();if((o!==undefined)&&(n!==o)){this._updateVisibleHorizon(n);}var d=this._determineZoomBoundaryByStrategy();var D=this._determineZoomRateByChartWidth(n);if(D){this.updateGanttVisibleWidth(n);var L=this._oZoom.minRate||-1;this._oZoom.minRate=Math.max(d.minRate,D.minRate)||d.minRate;var f=this._oZoom.maxRate||-1;this._oZoom.maxRate=d.maxRate;var b=this._oZoom.rate||-1;z=!U.floatEqual(L,this._oZoom.minRate)||!U.floatEqual(f,this._oZoom.maxRate);if(z){this._updateZoomRateOnStops();this._adjustRateByBoundary();}if(D.suitableRate&&!this._bHorizontalScroll){this._oZoom.rate=D.suitableRate;this._adjustRateByBoundary();}var i=this.getZoomLevel(),Z=this._calcZoomLevelFromZoomRate(this._oZoom.rate);var c=i!==Z;if(c){this.setProperty("zoomLevel",Z,true);}r.zoomLevel=this.getZoomLevel();a=!U.floatEqual(b,this._oZoom.rate);if(a){this.getAxisTime().setZoomRate(this._oZoom.rate);this._updateTimeLineOption();}r.axisTimeChanged=a;}return r;};P.prototype._updateVisibleHorizon=function(n){var o=this.getVisibleHorizon();var i=this.getGanttVisibleWidth();var c=U.calculateHorizonByWidth(o,i,n);A.prototype.setVisibleHorizon.call(this,c);};P.prototype._adjustRateByBoundary=function(){if(this._oZoom.rate){this._oZoom.rate=Math.max(this._oZoom.rate,this._oZoom.minRate);this._oZoom.rate=Math.min(this._oZoom.rate,this._oZoom.maxRate);}};P.prototype._updateZoomRateOnStops=function(){if(this._oZoom&&this._oZoom.maxRate&&this._oZoom.minRate){var m=this._oZoom.maxRate,M=this._oZoom.minRate,s=this.getZoomLevels();this._oLog={};this._oLog.fMax=Math.log(m);this._oLog.fMin=Math.log(M);this._oLog.fStep=(this._oLog.fMax-this._oLog.fMin)/s;if(s>0){for(var i=0;i<s;i++){this._aZoomRate[i]=Math.pow(Math.E,this._oLog.fMin+this._oLog.fStep*i);}}else{this._aZoomRate[0]=1;}}};P.prototype._calcZoomLevelFromZoomRate=function(r){if(this._oZoom&&this._oLog&&r){return Math.round((Math.log(r)-this._oLog.fMin)/this._oLog.fStep);}};P.prototype._determineZoomBoundaryByStrategy=function(){if(this._oZoom&&this._oZoom.base){var c=this.getCoarsestTimeLineOption(),f=this.getFinestTimeLineOption();return{minRate:this._oZoom.base.scale/this.calZoomScale(c.innerInterval.unit,c.innerInterval.span,c.innerInterval.range),maxRate:this._oZoom.base.scale/this.calZoomScale(f.innerInterval.unit,f.innerInterval.span,f.innerInterval.range*4)};}};P.prototype._determineZoomRateByChartWidth=function(n){var t=this.getTotalHorizon(),v=this.getVisibleHorizon(),r={};if(!this._oZoom){return null;}if(!U.judgeTimeHorizonValidity(v,t)){this.getVisibleHorizon().setStartTime(t.getStartTime(),true);this.getVisibleHorizon().setEndTime(t.getEndTime(),true);jQuery.sap.log.warning("Visible horizon is not in total horizon, so convert visible horizon to total horizon",null,"sap.gantt.axistime.ProportionZoomStrategy.syncContext()");}if(t){var m=this.calZoomScaleByDate(F.abapTimestampToDate(t.getStartTime()),F.abapTimestampToDate(t.getEndTime()),n);r.minRate=this._oZoom.base.scale/m;}if(v&&v.getStartTime()&&v.getEndTime()){var s=this.calZoomScaleByDate(F.abapTimestampToDate(v.getStartTime()),F.abapTimestampToDate(v.getEndTime()),n);r.suitableRate=this._oZoom.base.scale/s;}return r;};P.prototype._updateTimeLineOption=function(){var s=F.getTimeStampFormatter().parse("20000101000000"),c,i,t=this.getTimeLineOptions(),T=this.getProperty("timeLineOption");var a=this.getAxisTime();if(a){var b=a.timeToView(s);for(i in t){var d=t[i].innerInterval;var e=a.timeToView(O.get(d.unit).offset(s,d.span));var r=Math.abs(Math.ceil((e-b)));if(r>=d.range){c=i;break;}}T=c?t[c]:t[i];this.setProperty("timeLineOption",T,true);}};P.prototype.onSetTimeZoomRate=function(t){var n=this.calVisibleHorizonByRate(t);this.setVisibleHorizon(n);};return P;},true);
