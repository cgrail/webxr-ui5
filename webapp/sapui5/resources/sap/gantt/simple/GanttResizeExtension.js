/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["jquery.sap.global","sap/ui/core/Core","./GanttExtension","./CoordinateUtils","./GanttUtils"],function(q,C,G,a,b){"use strict";var c=G.extend("sap.gantt.simple.GanttResizeExtension",{_init:function(g,s){this._initResizeStatus();return"ResizeExtension";}});var _=".sapGanttResizing";var D={color:"#596468",strokeWidth:1,strokeDasharray:"5, 1"};var R={None:0,LeftResize:1,RightResize:2};var v=function($,d){return parseFloat($.attr(d),10);};c.prototype.getSelectionSettings=function(){if(!this.mSelectionSettings){var m=this.getGantt().getShapeSelectionSettings();if(q.isEmptyObject(m)){return D;}var d=q.extend(true,{},D);for(var s in d){if(m[s]){d[s]=m[s];}}this.mSelectionSettings=d;}return this.mSelectionSettings;};c.prototype.getSelectionInlineStyle=function(){var s=this.getSelectionSettings();var S={fill:"transparent",stroke:s.color,"stroke-width":s.strokeWidth,"stroke-dasharray":s.strokeDasharray};return Object.keys(S).reduce(function(d,e){d+=(e+":"+S[e]+";");return d;},"");};c.prototype.initDomSelector=function(){this.mDoms={};};c.prototype.updateDomSelector=function(e){if(e){this.origin.shapeUid=q(e.target).parents("g").attr(b.SELECT_FOR_DATASET_KEY);}var r='g['+b.SELECT_FOR_DATASET_KEY+'="'+this.origin.shapeUid+'"]';var s={leftLine:r+" .leftLine",rightLine:r+" .rightLine",topLine:r+" .topLine",bottomLine:r+" .bottomLine",leftLineTrigger:r+" line.leftTrigger",rightLineTrigger:r+" line.rightTrigger",leftRectTrigger:r+" rect.leftTrigger",rightRectTrigger:r+" rect.rightTrigger",resizeRectCover:r+" rect.resizeCover"};for(var k in s){if(s.hasOwnProperty(k)){this.mDoms[k]=q(s[k]);}}};c.prototype.getSvgElement=function(){var $=q.sap.byId(this.getGantt().getId());if($.length===0){q.sap.log.warning("can not find gantt chart, use gantt chart instance sId as the key is required");}return $.find("svg.sapGanttChartSvg").get(0);};c.prototype._getShapeSelectionRootNode=function(){var s=this.getSvgElement(),$=q(s).find("g.sapGanttChartSelection");return d3.select($.get(0));};c.prototype.toggleOutline=function(e){if(!e.getSelected()){this.removeOutline(e);return;}this.setFrame(e.getDomRef().getBBox());var d=e.getConnectable(),r=e.getResizable();if(d||r){this.renderResizerOutline(e);}else{this.renderPlainOutline(e);}};c.prototype.clearAllOutline=function(s){this._getShapeSelectionRootNode().selectAll("*").remove();};c.prototype.renderPlainOutline=function(e){var d=e.getDomRef();if(d){var r=!!e.getRlsAnchors;var B={x:e.getXBias(),y:e.getYBias()};var E=r?e.getD():this.determineOutlineByFrame(d.getBBox(),B);var s=this._getShapeSelectionRootNode();var p=r?this.createOutlineRlsNode(e,E):this.createOutlinePathNode(e,E);s.node().appendChild(p);}};c.prototype.createOutlineRlsNode=function(e,o){var g=document.createElementNS(d3.ns.prefix.svg,"g");var l=document.createElementNS(d3.ns.prefix.svg,"path");var A=document.createElementNS(d3.ns.prefix.svg,"path");g.setAttribute("id",e.getShapeUid()+"-selected");g.setAttribute("aria-hidden","false");g.setAttribute("class","resizeContainer sapGanttSelectedPath");g.setAttribute("style",e.getSelectedStyle());l.setAttribute("d",o);A.setAttribute("d",e.getArrowPathD(o));g.appendChild(l);g.appendChild(A);return g;};c.prototype.createOutlinePathNode=function(e,o){var p=document.createElementNS(d3.ns.prefix.svg,"path");p.setAttribute("id",e.getShapeUid()+"-selected");p.setAttribute("aria-hidden","false");p.setAttribute("class","resizeContainer sapGanttSelectedPath");var s=e.getSelectedStyle?e.getSelectedStyle():this.getSelectionInlineStyle();p.setAttribute("style",s);p.setAttribute("d",o);return p;};c.prototype.determineOutlineByFrame=function(r,B){var x=r.x,y=r.y,w=r.width,h=r.height,d=x+w,e=y+h;var s=this.getSelectionSettings().strokeWidth,H=s/2;x=x-H+B.x;y=y-H+B.y;d=d+H+B.x;e=e+H+B.y;var f=["M",x,y,"L",d,y,"L",d,e,"L",x,e,"z"].join(" ").trim();return f;};c.prototype.removeOutline=function(e){var r=document.getElementById(e.getShapeUid()+"-selected");if(r){q(r).remove();}};c.prototype.renderResizerOutline=function(e){this.removeOutline(e);var d=e.getConnectable(),r=e.getResizable();var p=this.getOutlineLines();var s=this.createResizeContainer(e);this.renderSelectionBorders(p,s);if(r){this.renderResizeTriggerAndCover(p,s);this.attachMousedownEvent();}if(d){this.renderShapeConnectTrigger(e,s);this.getGantt()._getConnectExtension().attachShapeConnectEvents();}if(this.isResizing()){this.updateDomSelector();this.updateOriginShapeFrame();this.attachResizeEvents();}};c.prototype.showShapeConnectTrigger=function(e){var E=this.getGantt()._getConnectExtension();var s=E.getRlsStartShape().shapeUid;return E.isShapeConnecting()?s===e.getShapeUid():true;};c.prototype.renderSelectionBorders=function(p,g){g.selectAll(".border").data(p.border).enter().append("line").each(function(d){d3.select(this).attr(d);}).attr("class",function(d){return"border "+d.class+"Line";});};c.prototype.renderResizeTriggerAndCover=function(p,g){g.selectAll(".lineTrigger").data(p.indicator).enter().append("line").each(function(d){d3.select(this).attr(d);}).attr("class",function(d){return"resizeTrigger lineTrigger "+d.class+"Trigger";}).attr({opacity:0,"stroke-width":3,style:"cursor: ew-resize"});var m=this.getResizeRectCoverAttrs();g.append("rect").attr(m);};c.prototype.createResizeContainer=function(e){var s=this._getShapeSelectionRootNode();var g=s.append("g").classed("resizeContainer",true).attr("id",e.getShapeUid()+"-selected").attr(b.SELECT_FOR_DATASET_KEY,e.getShapeUid());return g;};c.prototype.renderShapeConnectTrigger=function(e,g){var s=this.showShapeConnectTrigger(e);var r=this.getConnectSquaresData(s);g.selectAll(".rectTrigger").data(r.slice()).enter().append("rect").each(function(d){d3.select(this).attr(d);}).attr("class",function(d){return"shapeConnectTrigger rectTrigger "+d.class+"Trigger";}).attr({stroke:"#000","stroke-width":1});};c.prototype.attachMousedownEvent=function(){var $=q("#"+this.getGantt().getId()+" svg.sapGanttChartSvg");var d=$.find(".resizeTrigger");d.off(_);d.bind("mousedown"+_,q.proxy(this.beforeResizing,this));};c.prototype.attachResizeEvents=function(){this._removeDragEvents();var $=q(document);$.bind("mousemove"+_,q.proxy(this.onResizing,this));$.bind("mouseup"+_,q.proxy(this.endResizing,this));$.bind("keydown"+_,q.proxy(this.onKeydown,this));};c.prototype._removeDragEvents=function(){var $=q(document);$.off(_);};c.prototype.beforeResizing=function(e){var $=q(e.target),s=$.parents("g").attr(b.SELECT_FOR_DATASET_KEY);var E=this._getShapeByUid(s);if(!E){return;}this.setFrame(E.getDomRef().getBBox());this.updateDomSelector(e);this.origin.eventTarget=e.target;this.updateOriginShapeFrame();this.origin.resizeFor=s;if($.hasClass("leftTrigger")){this.currentAction=R.LeftResize;}else{this.currentAction=R.RightResize;}this._updateResizingEffect(true);this.attachResizeEvents();};c.prototype.updateOriginShapeFrame=function(){var f=this.getFrame();this.origin.minX=f.x;this.origin.maxX=f.x+f.width;};c.prototype.onResizing=function(e){if(this._shallSkip(e)){return;}this._updateResizingEffect(true);var s=this.getSvgElement();var E=a.getEventSVGPoint(s,e).x;var p=this.getGantt()._getPointerExtension();E=E+p._getAutoScrollStep();if(this.currentAction===R.RightResize){this._updateRightPartDoms(E);}else if(this.currentAction===R.LeftResize){this._updateLeftPartDoms(E);}};c.prototype._updateResizingEffect=function(r){var o=r?0.4:0;this.mDoms.resizeRectCover.attr("opacity",o);};c.prototype.isResizing=function(){return this.currentAction===R.LeftResize||this.currentAction===R.RightResize;};c.prototype._updateRightPartDoms=function(e){var n=function(x){if(x-this.origin.minX<=2*this.getMargin()){return this.origin.minX+2*this.getMargin();}return x;}.bind(this);var x=n(e);this.mDoms.rightLine.attr({x1:x,x2:x});this.mDoms.rightLineTrigger.attr({x1:x,x2:x});this.mDoms.topLine.attr({x2:x});this.mDoms.bottomLine.attr({x2:x});this.mDoms.rightRectTrigger.attr({x:x+b.SHAPE_CONNECT_INDICATOR_WIDTH/2-2});var N=x-this.origin.minX;this.mDoms.resizeRectCover.attr({width:N});};c.prototype._updateLeftPartDoms=function(e){var n=function(x){var m=this.origin.maxX;var l=2*this.getMargin();if(m-x<=l){return m-l;}return x;}.bind(this);var x=n(e);this.mDoms.leftLine.attr({x1:x,x2:x});this.mDoms.leftLineTrigger.attr({x1:x,x2:x});this.mDoms.topLine.attr({x1:x});this.mDoms.bottomLine.attr({x1:x});this.mDoms.leftRectTrigger.attr({x:x-this.getMargin()-b.SHAPE_CONNECT_INDICATOR_WIDTH-2});var r=Math.abs(x-v(this.mDoms.rightLineTrigger,"x1"))-2;this.mDoms.resizeRectCover.attr({x:x+this.getMargin(),width:r<0?0:r});};c.prototype.onKeydown=function(e){if(e.keyCode===q.sap.KeyCodes.ESCAPE){if(this.isResizing()){this._updateLeftPartDoms(this.origin.minX-this.getMargin());this._updateRightPartDoms(this.origin.maxX+this.getMargin());this._updateResizingEffect(false);this._initResizeStatus();}this._removeDragEvents();}};c.prototype.endResizing=function(e){this._removeDragEvents();if(this._shallSkip(e)){return;}var m=v(this.mDoms.leftLine,"x1")+this.getMargin(),d=v(this.mDoms.rightLine,"x1")-this.getMargin();var s=this._getShapeByUid(this.origin.resizeFor),g=this.getGantt();if(s){this.renderResizerOutline(s);this._initResizeStatus();this._fireShapeResizeEvent(g,s,m,d);}else{this._initResizeStatus();}};c.prototype._getShapeByUid=function(s){var S=b.getShapesWithUid(this.getGantt().getId(),[s]);if(S.length>0){return S[0];}};c.prototype._fireShapeResizeEvent=function(g,s,m,d){var e=g.getAxisTime().viewToTime(m),f=g.getAxisTime().viewToTime(d),t;var r=C.getConfiguration().getRTL();if(r){t=f;f=e;e=t;}g.fireShapeResize({shape:s,shapeUid:s.getShapeUid(),rowObject:s.getParent(),oldTime:[s.getTime(),s.getEndTime()],newTime:[e,f]});};c.prototype._initResizeStatus=function(){this.currentAction=R.None;this.origin={minX:-1,maxX:-1,eventTarget:null,resizeFor:null};this.mElementFrame=null;this.iOutlineMargin=0;this.initDomSelector();};c.prototype.setFrame=function(f){this.mElementFrame=f;};c.prototype.getFrame=function(){return this.mElementFrame;};c.prototype.setMargin=function(m){this.iOutlineMargin=m;};c.prototype.getMargin=function(){return this.iOutlineMargin;};c.prototype._shallSkip=function(e){if(!this.isResizing()){return true;}if(this.origin.eventTarget&&!q(this.origin.eventTarget).hasClass("resizeTrigger")){return true;}return false;};c.prototype.getConnectSquaresData=function(s){var f=this.getFrame(),x=f.x,y=f.y,w=f.width,h=f.height;var m=this.getMargin();var r=s?b.SHAPE_CONNECT_INDICATOR_WIDTH:0;var d={width:r,height:r,stroke:"#000","stroke-width":1};var l=x-m-r-2,L=y+(h/2)-(r/2);var i=(x+w+m)+2,e=L;return[q.extend({x:l,y:L,"class":"left"},d),q.extend({x:i,y:e,"class":"right"},d)];};c.prototype.getResizeRectCoverAttrs=function(){var f=this.getFrame(),m=this.getMargin(),s=this.getSelectionSettings().strokeWidth;var d={stroke:"none","stroke-width":0,fill:"red","class":"resizeCover",opacity:0,style:"pointer-events: none;"};var o=(2*m)-(2*s);return q.extend({x:f.x-m+s,y:f.y-m+s,width:f.width+o,height:f.height+o},d);};c.prototype.getOutlineLines=function(){var f=this.getFrame(),x=f.x,y=f.y,w=f.width,h=f.height;var m=this.getMargin();var s=this.getSelectionSettings();var d={"stroke-dasharray":s.strokeDasharray,fill:"transparent",stroke:s.color,"stroke-width":s.strokeWidth};var p={minX:x-m,minY:y-m,maxX:x+w+m,maxY:y+h+m};var P={top:{x1:p.minX,y1:p.minY,x2:p.maxX,y2:p.minY},right:{x1:p.maxX,y1:p.minY,x2:p.maxX,y2:p.maxY},bottom:{x1:p.minX,y1:p.maxY,x2:p.maxX,y2:p.maxY},left:{x1:p.minX,y1:p.minY,x2:p.minX,y2:p.maxY}};var e=["top","right","bottom","left"];var l=e.map(function(j){return q.extend(P[j],{"class":j},d);});var g=q.extend(true,P);var i=["left","right"].map(function(j){return q.extend(g[j],{"class":j},d);});return{border:l,indicator:i};};c.prototype._getResizeTime=function(e){var m=v(this.mDoms.leftLine,"x1")+this.getMargin(),d=v(this.mDoms.rightLine,"x1")-this.getMargin();if(isNaN(m)||isNaN(d)){return null;}var g=this.getGantt();var s=g.getAxisTime().viewToTime(m),f=g.getAxisTime().viewToTime(d),t;var r=C.getConfiguration().getRTL();if(r){t=f;f=s;s=t;}return{time:s,endTime:f};};return c;});
