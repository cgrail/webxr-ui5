/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["jquery.sap.global","sap/ui/core/Core","sap/gantt/library","./GanttExtension","./CoordinateUtils","./GanttUtils","sap/gantt/misc/Format"],function(q,C,l,G,a,b,F){"use strict";var _=".sapGanttDragDrop";var e=["mousemove","mouseup","keydown"];var m="mousedown";var B=e.reduce(function(g,n){g[n]=n;return g;},{});B[m]=m;var E=e.map(function(s){return s+_;});var M=m+_;var I=3;var c=l.dragdrop.GhostAlignment;var D=sap.gantt.DragOrientation;var d={dispatchEvent:function(o){var g=this._getDragDropExtension();if(o.type===B.mousedown){g.onMouseDown(o);}else if(o.type===B.mousemove){g.onMouseMove(o);}else if(o.type===B.mouseup){g.onMouseUp(o);}else if(o.type===B.keydown){g.onKeydown(o);}},addEventListeners:function(g){this.removeEventListeners(g);var s=q(g._getDragDropExtension().getDomRefs().ganttSvg);s.on(M,d.dispatchEvent.bind(g));},removeEventListeners:function(g){var s=q(g._getDragDropExtension().getDomRefs().ganttSvg);s.off(_);},addDragDropEventListeners:function(g){this.removeDragDropEventListeners(g);E.forEach(function(s){q(document).on(s,d.dispatchEvent.bind(g));});},removeDragDropEventListeners:function(g){E.forEach(function(s){q(document).off(s);});}};var f=G.extend("sap.gantt.simple.GanttDragDropExtension",{_init:function(g,s){this._initDragStates();return"DragDropExtension";},_attachEvents:function(){var g=this.getGantt();d.addEventListeners(g);},_detachEvents:function(){var g=this.getGantt();d.removeEventListeners(g);}});f.prototype._initDragStates=function(){this.bDragging=false;this.bElementDraggable=false;this.oMouseDownTarget=null;this.oLastDraggedShapeData=null;this.mDragPoint={};this.bDragging=false;this.$ghost=null;};f.prototype.onMouseDown=function(o){this.bElementDraggable=this.isEventTargetDraggable(o);if(this.bElementDraggable){var p=a.getEventSVGPoint(this.getDomRefs().ganttSvg,o);var g=this.getDraggableDOMElement(o.target),h=g.getBBox();this.mDragPoint={cursorX:p.x,cursorY:p.y,shapeX:h.x,shapeY:h.y,shapeWidth:h.width};var i=this.getShapeElementByTarget(g);this.oMouseDownTarget=g;this.oLastDraggedShapeData={shapeUid:i.getShapeUid(),startTime:i.getTime(),endTime:i.getEndTime()};d.addDragDropEventListeners(this.getGantt());}};f.prototype.updateCursorStyle=function(s){document.body.style.cursor=s;this.getDomRefs().ganttSvg.style.cursor=s;};f.prototype.onMouseMove=function(o){if(this.skipEvent(o)){return;}if(this.bDragging===false){var n=a.getEventSVGPoint(this.getDomRefs().ganttSvg,o),g=this.isExceedDraggingThreshold(n),s=g&&this.isAllowedVerticalOrentationDrag();this.bDragging=s;if(s&&this.oMouseDownTarget){this._hideScrollBarOnBody(true);this.$ghost=this.createDragGhost(this.oMouseDownTarget);var h=this._getDragStartEventData(o);if(h){this.getGantt().fireDragStart(h);}}else if(g){this.updateCursorStyle("not-allowed");}}else{this.onDragging(o);}};f.prototype.onMouseUp=function(o){if(this.bElementDraggable===true&&this.bDragging===false){this.stopDragging(o);return;}var g=this._getShapeDropEventData(o);this.stopDragging(o);if(g){this.getGantt().fireShapeDrop(g);}};f.prototype._getDragStartEventData=function(o){return{sourceGanttChart:this.getGantt(),draggedShapeDates:this._getDraggedShapeDates(),lastDraggedShapeUid:this.oLastDraggedShapeData.shapeUid,cursorDateTime:this._getGhostTime(o).cursorTime};};f.prototype._getShapeDropEventData=function(o){if(this.isValidDropZone(o)){var g=this.getGantt();var s=this._getDraggedShapeDates();var t=this.getGanttChartByTarget(o.target);var h=b.getRowInstance(o,t.getTable());var T=this.getShapeElementByTarget(o.target);var i=this._getGhostTime(o);return{sourceGanttChart:g,targetGanttChart:t,draggedShapeDates:s,lastDraggedShapeUid:this.oLastDraggedShapeData.shapeUid,targetRow:h,cursorDateTime:i.cursorTime,newDateTime:i.newDateTime,targetShape:T};}};f.prototype._getGhostTime=function(o){var g=this.getGantt();var t=this.getGanttChartByTarget(o.target);var h=t!=null?(t.getId()!==g.getId()):false;var A=h?t.getAxisTime():g.getAxisTime();var i=h?q.sap.domById(t.getId()+"-svg"):q.sap.domById(g.getId()+"-svg");var j=a.getEventSVGPoint(i,o).x;var k=A.viewToTime(j);var n=k;var r=C.getConfiguration().getRTL();var s=this.mDragPoint.shapeX,S=r?-this.mDragPoint.shapeWidth:this.mDragPoint.shapeWidth,p=this.mDragPoint.cursorX;var u=k;var v=k;if(this.getGantt().getDragOrientation()===D.Vertical){u=this.oLastDraggedShapeData.startTime;v=this.oLastDraggedShapeData.endTime;n=u;}else{if(this.getGantt().getGhostAlignment()===c.Start){v=A.viewToTime(j+S);n=k;}else if(this.getGantt().getGhostAlignment()===c.End){u=A.viewToTime(j-S);n=k;}else if(this.getGantt().getGhostAlignment()===c.None){var N=r?(j-S-(p-s)):(j-(p-s));var w=A.viewToTime(N);u=w;v=A.viewToTime(N+S);n=w;}}return{newDateTime:n,cursorTime:k,time:u,endTime:v};};f.prototype._getDraggedShapeDates=function(){var s=this.getGantt().getSelection();var S=s.allSelectedDraggableUid();var o={};S.forEach(function(u){var g=s.getSelectedShapeDataByUid(u);o[u]={time:g.time,endTime:g.endTime};});return o;};f.prototype.getDroppedShapeStartTime=function(i,A,o){if(this.getGantt().getGhostAlignment()===c.None){var s=this.mDragPoint.shapeX,S=this.mDragPoint.shapeWidth,g=this.mDragPoint.cursorX;var r=C.getConfiguration().getRTL();var n=r?(i+S-(g-s)):(i-(g-s));var N=A.viewToTime(n),h=F.abapTimestampToDate(N);return h;}return o;};f.prototype.isValidDropZone=function(o){return q(o.target).closest("svg.sapGanttChartSvg").length===1;};f.prototype._hideScrollBarOnBody=function(h){q(document.body).toggleClass("sapGanttDraggingOverflow",h);};f.prototype.onKeydown=function(o){if(this.skipEvent(o)){return;}if(o.keyCode===q.sap.KeyCodes.ESCAPE){this.stopDragging(o);}};f.prototype.stopDragging=function(o){this._enableTextSelection();this._avoidShapeSelectionAfterDragging();this.removeGhost();this._initDragStates();this.updateCursorStyle("default");this._hideScrollBarOnBody(false);this._stopAutoScroll();d.removeDragDropEventListeners(this.getGantt());};f.prototype._avoidShapeSelectionAfterDragging=function(){if(this.bDragging&&this.oMouseDownTarget){var o=this.getShapeElementByTarget(this.oMouseDownTarget);q.sap.delayedCall(100,this,function(){if(o){q.sap.clearDelayedCall(o.iSingleClickTimer);}},[]);}};f.prototype.isEventTargetDraggable=function(o){var s=this.getShapeElementByTarget(o.target);if(s){return s.getSelected()&&s.getDraggable();}return false;};f.prototype.getShapeElementByTarget=function(t){return q(this.getDraggableDOMElement(t)).control(0,true);};f.prototype.getGanttChartByTarget=function(t){return q(t).closest("svg.sapGanttChartSvg").control(0,true);};f.prototype.getDraggableDOMElement=function(t){return q(t).closest("["+b.SHAPE_ID_DATASET_KEY+"]").get(0);};f.prototype.isExceedDraggingThreshold=function(p){return Math.abs(p.x-this.mDragPoint.cursorX)>I||Math.abs(p.y-this.mDragPoint.cursorY)>I;};f.prototype.onDragging=function(o){if(this.$ghost){var p=this.getGantt()._getPointerExtension();if(p.isPointerInGanttChart()===false){this.updateCursorStyle("not-allowed");this._stopAutoScroll();}else{this.updateCursorStyle("move");}this.showGhost(o);this._disableTextSelection();}};f.prototype._stopAutoScroll=function(){var p=this.getGantt()._getPointerExtension();p._bAutoScroll=false;};f.prototype.isDragging=function(){return this.bDragging;};f.prototype.skipEvent=function(o){return this.bElementDraggable===false;};f.prototype.showGhost=function(o){var A=this.getGantt().getGhostAlignment();var O=this.calcGhostOffsetByAlignment(o,A);q.sap.byId("sapGanttDragGhostWrapper").css(O).css({"visibility":"visible"});};f.prototype.calcGhostOffsetByAlignment=function(o,A){var r=C.getConfiguration().getRTL();var s=this.mDragPoint.shapeWidth,S=this.mDragPoint.shapeX,i=this.mDragPoint.cursorX;var g;var h=a.xPosOfEvent(o);if(this.getGantt().getDragOrientation()===D.Vertical){var j=a.getSvgScreenPoint(this.getDomRefs().ganttSvg,{pageX:this.mDragPoint.shapeX,clientX:this.mDragPoint.shapeX,pageY:this.mDragPoint.shapeY,clientY:this.mDragPoint.shapeY});g=j.x;}else{if(A===c.Start){g=r?(h-s):h;}else if(A===c.None){g=h+(S-i);}else if(A===c.End){g=r?h:(h-s);}}var t=(a.getEventPosition(o).pageY-2);if(this.getGantt().getDragOrientation()===D.Horizontal){var k=a.getSvgScreenPoint(this.getDomRefs().ganttSvg,{pageX:this.mDragPoint.shapeX,clientX:this.mDragPoint.shapeX,pageY:this.mDragPoint.shapeY,clientY:this.mDragPoint.shapeY});t=k.y;}return{left:g+"px",top:t+"px"};};f.prototype.removeGhost=function(){this.$ghost=null;q.sap.byId("sapGanttDragGhostWrapper").remove();};f.prototype.createDragGhost=function(L){var $=q("<div id='sapGanttDragGhostWrapper'></div>");q(document.body).append($);var g=document.createElement("canvas");var h=L.getBBox();g.width=this.normalizeGhostImageWidth(h.width);g.height=h.height;this.createGhostImage(L,g);return $;};f.prototype.normalizeGhostImageWidth=function(w){return w;};f.prototype.createGhostImage=function(L,g){var s=this.serializeClonedSvg(g,L);var h=this._b64EncodeUnicode(s);var i="data:image/svg+xml;base64,"+h;this.appendGhostImageToWrapper(L,i);};f.prototype._b64EncodeUnicode=function(s){return btoa(encodeURIComponent(s).replace(/%([0-9A-F]{2})/g,function toSolidBytes(g,p){return String.fromCharCode('0x'+p);}));};f.prototype.appendGhostImageToWrapper=function(L,g){var n=this.getNumberOfDragObject(L);var $=q.sap.byId("sapGanttDragGhostWrapper");var s=this._getDragTextOverlayStyle(L);q("<div class='sapGanttDragGhost'>"+"<img class='sapGanttDragGhostImg' src='"+g+"'/>"+"<div class='sapGanttDragTextOverlay "+s.css+"' style='"+s.style+"'>"+n+"</div>"+"</div>").appendTo($);};f.prototype._getDragTextOverlayStyle=function(L){var r=C.getConfiguration().getRTL();var A=this.getGantt().getGhostAlignment();var s=this.mDragPoint.shapeWidth,S=this.mDragPoint.shapeX,i=this.mDragPoint.cursorX;var g=i-S;var h="";var j="";if(A===c.None){j=r?("right: "+(s-g)+"px;"):("left: "+(g)+"px;");}else if(A===c.End){h="sapGanttDragTextOverlayGhostAlignEnd";}var k="line-height: "+L.getBBox().height+"px;"+j;return{style:k,css:h};};f.prototype.serializeClonedSvg=function(g,o){var s=d3.ns.prefix.svg;var h=o.getBBox();var i=document.createElementNS(s,"svg");i.setAttribute("width",g.width);i.setAttribute("height",g.height);var j=o.cloneNode(true);this.removeOriginalTextNode(j);var k=document.createElementNS(s,"g");k.setAttribute("transform","translate("+-(h.x)+", "+-(h.y)+")");k.appendChild(j);var S=this.getGantt().getSvgDefs();if(S){var n=q.sap.byId(S.getId()).get(0).cloneNode(true);i.appendChild(n);}i.appendChild(k);return new XMLSerializer().serializeToString(i);};f.prototype.removeOriginalTextNode=function(n){if(n.tagName==="text"){n.parentNode.removeChild(n);}var g=n.children||n.childNodes;for(var i=0;i<g.length;i++){this.removeOriginalTextNode(g[i]);}};f.prototype.getNumberOfDragObject=function(L){var s=this.getGantt().getSelection();var S=s.numberOfSelectedDraggableShapes();var r=C.getLibraryResourceBundle("sap.gantt");var o=r.getText("GNT_DRAGGED_OBJECT");var O=r.getText("GNT_DRAGGED_OBJECTS");var g=S>1?O:o;return S+" "+g;};f.prototype._disableTextSelection=function(){q(document.body).attr("unselectable","on").css({"-moz-user-select":"none","-webkit-user-select":"none","user-select":"none"}).bind("selectstart",function(o){o.preventDefault();return false;});};f.prototype._enableTextSelection=function(){q(document.body).attr("unselectable","off").css({"-moz-user-select":"","-webkit-user-select":"","user-select":""}).unbind("selectstart");};f.prototype.isAllowedVerticalOrentationDrag=function(){var g=this.getGantt();if(g.getDragOrientation()===D.Vertical){return g.oSelection.numberOfSelectedDraggableShapes()<2;}return true;};return f;});
