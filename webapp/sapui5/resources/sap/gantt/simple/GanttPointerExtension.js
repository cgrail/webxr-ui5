/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["jquery.sap.global","sap/ui/core/Core","./GanttExtension","../drawer/CursorLine","./CoordinateUtils"],function(q,C,G,a,b){"use strict";var n=".sapGanttPointer";var c="contextmenu"+n;var m=["mouseenter","mouseleave","click","dblclick","mouseup","mousedown"],M=m.map(function(E){return E+n;});var s="mousemove",d=s+n,e=d+" mouseup"+n;var B=m.reduce(function(i,j){i[j]=j;return i;},{});B[s]=s;var D={Forward:"forward",Backward:"backward",Bottom:"bottom",Top:"top"};var f=200;var g={addEventListeners:function(o){var E=o._getPointerExtension(),$=q(E.getDomRefs().ganttSvg),i=q(E.getDomRefs().headerSvg);g.removeEventListeners(o);M.forEach(function(j){$.on(j,E.onGanttChartMouseEvent.bind(E));});$.on(e,E.onCrossSvgMouseEvent.bind(E));$.on(d,E.updateGanttCursorLine.bind(E));this.bindBackgroundRowEvent($,E);i.on(B.mousedown+n,function(j){j.preventDefault();j.stopPropagation();j.stopImmediatePropagation();return false;});q("body #"+o.getId()).on(d,b.updateCursorPosition);},removeEventListeners:function(o){var E=o._getPointerExtension(),$=q(E.getDomRefs().ganttSvg),i=q(E.getDomRefs().headerSvg);$.off(n);i.off(B.mousedown+n);this.unbindBackgroundRowEvent($);},doGanttAutoScroll:function(o,i,E,l){var j=o._getPointerExtension();if(j.iTableAutoScrollTimerId){q.sap.clearDelayedCall(j.iTableAutoScrollTimerId);j.iTableAutoScrollTimerId=null;}if(j._bAutoScroll){if(!j.allowAutoScroll()){return;}j._toggleCursorLine(false);var r=o._getResizeExtension();if(r.isResizing()){r.onResizing(E);}var k=o._getConnectExtension();if(k.isShapeConnecting()){k.onShapeConnecting(E);}var p=o._getPopoverExtension();p._updatePopoverWhenAutoScroll(E);var z=o._getZoomExtension();z._handleAutoScroll(E);var R=C.getConfiguration().getRTL();var S=30;if(D.Backward===i||D.Top===i){S=(-1)*S;}if(D.Backward===i||D.Forward===i){j._iStep=S;}else{j._iStep=0;}var $=this.getScrollArea(o,i);var t,H=false;if(i===D.Forward||i===D.Backward){t=R?"scrollLeftRTL":"scrollLeft";H=true;}else{t="scrollTop";H=false;}k.storeScrollDistance(S,H);var T=$[t]()+S;$[t](T);var u=$[t]();if(u!==T){k.storeScrollDistance(u-T,H);}if(!(l!==undefined&&l===u)){j.iTableAutoScrollTimerId=q.sap.delayedCall(f,g,g.doGanttAutoScroll,[o,i,E,u]);}}},getScrollArea:function(o,i){var S;var t=o.getTable();var T=q(t.getDomRef(sap.ui.table.SharedDomRef.VerticalScrollBar));if(i===D.Forward||i===D.Backward){S=q.sap.byId(o.getId()+"-hsb");}else{S=T;}return S;},bindBackgroundRowEvent:function($,E){function j(r){q(r).on(B.mouseenter+n+" "+B.mouseleave+n,function(o){var I=E._getRowIndexFromEvent(o);E.onMouseHover(I,o.type===B.mouseenter);});q(r).on(B.click+n+" "+B.dblclick+n,function(o){E.dispatchGanttClick(o);});q(r).on(c,function(o){E.onGanttChartContextMenu(o);});}var k=$.find("rect.sapGanttBackgroundSVGRow");var l=k.length;for(var i=0;i<l;i++){j(k[i]);}},unbindBackgroundRowEvent:function($){var j=$.find("rect.sapGanttBackgroundSVGRow");var l=j.length;for(var i=0;i<l;i++){q(j[i]).off(n);}}};var h=G.extend("sap.gantt.simple.GanttPointerExtension",{_init:function(o,S){this._oCursorLineDrawer=new a();this.bPreventSingleClick=false;this.iTableAutoScrollTimerId=null;this._iStep=0;return"PointerExtension";},_attachEvents:function(){var o=this.getGantt();g.addEventListeners(o);},_detachEvents:function(){var o=this.getGantt();g.removeEventListeners(o);},destroy:function(){if(this._oCursorLineDrawer){this._oCursorLineDrawer.destroy();}delete this.bPreventSingleClick;}});h.prototype.onGanttChartContextMenu=function(E){E.preventDefault();if(E.target===E.currentTarget){var o=this.getGantt();var i=this._getRowIndexFromEvent(E);var r=o.getTable().getRows()[i];o.fireShapeContextMenu({row:r,pageX:E.pageX,pageY:E.pageY});}};h.prototype.onGanttChartMouseEvent=function(E){this.updateGanttCursorLine(E);if(E.type===B.mousedown){this.oMousedownTargetElement=E.target;}this.onMouseEnterLeaveEvent(E);};h.prototype.onCrossSvgMouseEvent=function(E){var o=this.getGantt();if(E.type===B.mousemove){if(this.needAutoscrollInContainerIfNecessary()){this.updateCursorStyle("move");this.tableAutoScroll(E);}else{var i=o._getDragDropExtension();var j=o._getConnectExtension();var r=o._getResizeExtension();var z=o._getZoomExtension();if((i.isDragging()||r.isResizing()||j.isShapeConnecting()||z.isTimeZooming())){this.tableAutoScroll(E);}}}if(E.type===B.mouseup){this.oMouseupTargetElement=E.target;this._bAutoScroll=false;}};h.prototype.needAutoscrollInContainerIfNecessary=function(){var o=this.getGantt().getParent();if(o&&o.getGanttCharts){var i=o.getGanttCharts();var j=this.getGantt();return i.some(function(k){return k!==j&&k._getDragDropExtension().isDragging();});}return false;};h.prototype.updateCursorStyle=function(S){document.body.style.cursor=S;this.getDomRefs().ganttSvg.style.cursor=S;};h.prototype.isPointerInGanttChart=function(E){return this._bMouseOnSvg;};h.prototype.onMouseEnterLeaveEvent=function(E){this.updateCursorStyle("default");if(E.type===B.mouseenter){this._bMouseOnSvg=true;}else if(E.type===B.mouseleave){this._bMouseOnSvg=false;}};h.prototype.dispatchGanttClick=function(E){if(this.isEventTargetOnGanttRow(E)===false){return;}if(E.type===B.click){if(this.oMousedownTargetElement===this.oMouseupTargetElement){this.onGanttSingleClick(E);delete this.oMouseupTargetElement;delete this.oMousedownTargetElement;}}else if(E.type===B.dblclick){this.onGanttDoubleClick(E);}};h.prototype.isEventTargetOnGanttRow=function(E){return q(E.target).hasClass("sapGanttBackgroundSVGRow");};h.prototype._getRowIndexFromEvent=function(E){return parseInt(E.target.getAttribute("data-sap-ui-index"),10);};h.prototype.onGanttSingleClick=function(E){this.getGantt().getSelection().update(null,{selected:false,ctrl:E.ctrlKey||E.metaKey});var o=this.getGantt();var i=this._getRowIndexFromEvent(E);var r=o.getTable().getRows()[i];if(!r){return;}this.iSingleClickTimer=q.sap.delayedCall(300,this,function(){if(this.bPreventSingleClick===false){this._selectTableRow(o,i);}this.bPreventSingleClick=false;},[]);};h.prototype.onGanttDoubleClick=function(E){q.sap.clearDelayedCall(this.iSingleClickTimer);this.bPreventSingleClick=true;var o=this.getGantt();var i=this._getRowIndexFromEvent(E);var r=o.getTable().getRows()[i];this._selectTableRow(o,i);o.fireShapeDoubleClick({shape:null,row:r});};h.prototype._selectTableRow=function(o,i){var t=this.getGantt().getTable().getSelectionBehavior();var S=sap.ui.table.SelectionBehavior;if(S.Row===t||S.RowOnly===t){o.getSyncedControl().syncRowSelection(i);}};h.prototype.onMouseHover=function(i,H){this.getGantt().getSyncedControl().syncRowHover(i,H);};h.prototype._getAutoScrollStep=function(){if(this._bAutoScroll){return this._iStep;}return 0;};h.prototype.updateGanttCursorLine=function(E){if(this.getGantt().getEnableCursorLine()===false){return;}if(E.type===B.mousemove){var S=b.getEventSVGPoint(this.getDomRefs().ganttSvg,E);this._toggleCursorLine(true,S);}else if(E.type===B.mouseleave){this._toggleCursorLine(false);}};h.prototype._toggleCursorLine=function(S,p){var i=this._getCursorLineDOMs();if(S){this._oCursorLineDrawer.drawSvg(i.allGanttSvg,i.allHeaderSvg,this.getGantt().getLocale(),p);}else{this._oCursorLineDrawer.destroySvg(i.allGanttSvg,i.allHeaderSvg);}};h.prototype._getCursorLineDOMs=function(){return{allHeaderSvg:d3.selectAll(".sapGanttChartWithSingleTable .sapGanttChartHeaderSvg"),allGanttSvg:d3.selectAll(".sapGanttChartWithSingleTable .sapGanttChartSvg")};};h.prototype.tableAutoScroll=function(E){this._bAutoScroll=false;if(this.ifAutoScrollToRight()){q.sap.delayedCall(f,this,function(){g.doGanttAutoScroll(this.getGantt(),D.Forward,E);});}else if(this.ifAutoScrollToLeft()){q.sap.delayedCall(f,this,function(){g.doGanttAutoScroll(this.getGantt(),D.Backward,E);});}else if(this.ifAutoScrollToDown()){q.sap.delayedCall(f,this,function(){g.doGanttAutoScroll(this.getGantt(),D.Bottom,E);});}else if(this.ifAutoScrollToUp()){q.sap.delayedCall(f,this,function(){g.doGanttAutoScroll(this.getGantt(),D.Top,E);});}else{this._bAutoScroll=false;}};h.prototype.ifAutoScrollToRight=function(){var A=this.getAutoScrollPosition();this._bAutoScroll=A.iLocationX>A.oScrollAreaRect.left+A.iScrollAreaWidth-A.iScrollTriggerAreaWidth&&A.iLocationX<A.oScrollAreaRect.left+A.iScrollAreaWidth&&A.iScrollAreaScrollLeft+A.iScrollAreaWidth<A.oScrollArea.scrollWidth;return this._bAutoScroll;};h.prototype.ifAutoScrollToLeft=function(){var A=this.getAutoScrollPosition();this._bAutoScroll=A.iLocationX<A.oScrollAreaRect.left+A.iScrollTriggerAreaWidth&&A.iLocationX>A.oScrollAreaRect.left&&A.iScrollAreaScrollLeft>0;return this._bAutoScroll;};h.prototype.ifAutoScrollToDown=function(){var A=this.getAutoScrollPosition();this._bAutoScroll=A.iLocationY>A.oVisibleScrollAreaRect.top+A.iVisibleScrollAreaHeight-A.iScrollTriggerAreaHeight&&A.iLocationY<A.oVisibleScrollAreaRect.top+A.iVisibleScrollAreaHeight&&A.iScrollAreaScrollTop+A.iScrollAreaHeight-A.iBaseRowHeight<=A.iScrollHeight;return this._bAutoScroll;};h.prototype.ifAutoScrollToUp=function(){var A=this.getAutoScrollPosition();this._bAutoScroll=A.iLocationY<A.oVisibleScrollAreaRect.top+A.iScrollTriggerAreaHeight&&A.iLocationY>A.oVisibleScrollAreaRect.top;return this._bAutoScroll;};h.prototype.getAutoScrollPosition=function(){var r=C.getConfiguration().getRTL();var t=this.getGantt().getTable();var i=10,j=10,o=q.sap.domById(this.getGantt().getId()+"-gantt"),S=q(o),k=o.getBoundingClientRect(),l=S.outerWidth(),p=S.outerHeight(),u=k,v=p,w=this.getGantt()._oExpandModel.getBaseRowHeight(),x=r?S.scrollLeftRTL():S.scrollLeft();var T=q(t.getDomRef(sap.ui.table.SharedDomRef.VerticalScrollBar)),y=T.scrollTop(),z=T.get(0).scrollHeight;var A=b.getLatestCursorPosition().pageX,E=b.getLatestCursorPosition().pageY;return{iLocationX:A,iLocationY:E,oScrollAreaRect:k,oScrollArea:o,iScrollAreaWidth:l,iScrollTriggerAreaWidth:i,iScrollTriggerAreaHeight:j,iScrollAreaScrollLeft:x,oVisibleScrollAreaRect:u,iVisibleScrollAreaHeight:v,iScrollAreaScrollTop:y,iBaseRowHeight:w,iScrollHeight:z,iScrollAreaHeight:p};};h.prototype.allowAutoScroll=function(){return this.ifAutoScrollToRight()||this.ifAutoScrollToLeft()||this.ifAutoScrollToDown()||this.ifAutoScrollToUp();};return h;});
