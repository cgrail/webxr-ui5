/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["jquery.sap.global","sap/ui/core/Core","./GanttExtension","./GanttUtils","./CoordinateUtils"],function(q,C,G,a,b){"use strict";var _=".sapGanttPopover";var m="mousedown";var M=m+_;var e=["mousemove","mouseup","keydown"];var B=e.reduce(function(d,n){d[n]=n;return d;},{});var E=e.map(function(s){return s+_;});var P={dispatchEvent:function(o){var d=this._getPopoverExtension();if(o.type===B.mousemove){d.onMouseMove(o);}else if(o.type===B.mouseup){d.onMouseUp(o);}else if(o.type===B.keydown){d.onKeydown(o);}},entry:function(o){if(this.getShowShapeTimeOnDrag()){var d=this._getPopoverExtension();d.onMouseDown(o);}},addEventListeners:function(g){this.removeEventListeners(g);var s=q(g._getPopoverExtension().getDomRefs().ganttSvg);s.on(M,P.entry.bind(g));},removeEventListeners:function(g){var s=q(g._getPopoverExtension().getDomRefs().ganttSvg);s.off(M);},addPopoverEventListeners:function(g){this.removePopoverEventListeners(g);E.forEach(function(s){q(document).on(s,P.dispatchEvent.bind(g));});},removePopoverEventListeners:function(g){q(document).off(_);}};var c=G.extend("sap.gantt.simple.GanttPopoverExtension",{_init:function(g,s){this._initPopoverStates();return"PopoverExtension";},_attachEvents:function(){var g=this.getGantt();P.addEventListeners(g);},_detachEvents:function(){var g=this.getGantt();P.removeEventListeners(g);}});c.prototype._initPopoverStates=function(){this._iOffsetX=10;this._iOffsetY=32;this._bNeedReverse=false;};c.prototype.onMouseMove=function(o){if(this.isDraggingOrResizing(o)){this._showPopover(o);}};c.prototype.onMouseDown=function(o){P.addPopoverEventListeners(this.getGantt());};c.prototype.onMouseUp=function(o){P.removePopoverEventListeners(this.getGantt());this._hidePopover(o);this._initPopoverStates();};c.prototype.onKeydown=function(o){if(!this.isDraggingOrResizing(o)){return;}if(o.keyCode===q.sap.KeyCodes.ESCAPE){P.removePopoverEventListeners(this.getGantt());this._hidePopover(o);this._initPopoverStates();}};c.prototype.isDraggingOrResizing=function(o){var d=this.getGantt()._getDragDropExtension();var r=this.getGantt()._getResizeExtension();return d.isDragging()||r.isResizing();};c.prototype._buildPopover=function(o){var s=C.getLibraryResourceBundle("sap.gantt").getText("GNT_CURRENT_START");var d=C.getLibraryResourceBundle("sap.gantt").getText("GNT_CURRENT_END");var f=function(l,S){var g="<span class='sapUiTinyMarginEnd sapMLabel'>"+l+"</span>"+"<span class='sapMLabel "+S+"'></span>";return"<div class='sapUiTinyMargin'>"+g+"</div>";};this.oTimePopover=q("<div id='sapGanttPopoverWrapper'>"+f(s,"sapGanttPopoverStartTime")+f(d,"sapGanttPopoverEndTime")+"</div>");this.createAnchor();this._calcPopoverOffset();var $=q.sap.byId("sapGanttPopoverAnchor");$.append(this.oTimePopover);var p=this._getPopoverData(o);this._updateTime(p);};c.prototype._updateTime=function(p){var r=C.getConfiguration().getRTL();var s=r?"marginRight":"marginLeft";var S={marginTop:p.offsetY+"px"};S[s]=p.offsetX+"px";var w=q.sap.byId("sapGanttPopoverWrapper").css(S);w.find(".sapGanttPopoverStartTime").html(p.startNewDate);w.find(".sapGanttPopoverEndTime").html(p.endNewDate);};c.prototype._getDragDropOrResizingDom=function(){var d=this.getGantt()._getDragDropExtension();var r=this.getGantt()._getResizeExtension();if(d.isDragging()){return d.$ghost.get(0);}else if(r.isResizing()){var s=a.getShapesWithUid(this.getGantt().getId(),[r.origin.resizeFor]);if(s.length===1&&s[0]){return document.getElementById(s[0].getShapeUid()+"-selected");}}};c.prototype.createAnchor=function(o){var $=q.sap.byId("sapGanttPopoverAnchor");if($.length===0){$=q("<div id='sapGanttPopoverAnchor'></div>");q(document.body).append($);}this._oTargetDom=$.get(0);};c.prototype.moveAnchor=function(o){var p=b.getEventPosition(o),i=p.pageX,d=p.pageY,s=window.screen.width,S=window.screen.height;if(i<-this._iOffsetX){i=-this._iOffsetX;}else if(i>s+this._iOffsetX){i=s+this._iOffsetX;}var f=this._iOffsetY;if(this.oTimePopover){f+=this.oTimePopover.height();}if(d<-this._iOffsetY){d=-this._iOffsetY;}else if(d>S-f){d=S-f;}var l={left:i+"px",top:d+"px",visibility:"visible"};q.sap.byId("sapGanttPopoverAnchor").css(l);};c.prototype.checkIfNeedReverse=function(o){var r=C.getConfiguration().getRTL();var p=b.getEventPosition(o);var w=this.oTimePopover.width()+10;if(r&&p.pageX<w||!r&&p.pageX+w>window.screen.width){this._bNeedReverse=true;}else{this._bNeedReverse=false;}};c.prototype._showPopover=function(o){this.moveAnchor(o);if(this.oTimePopover){this.checkIfNeedReverse(o);this._calcPopoverOffset();var p=this._getPopoverData(o);this._updateTime(p);}else{this._buildPopover(o);}};c.prototype._hidePopover=function(){if(this.oTimePopover){var $=q.sap.byId("sapGanttPopoverAnchor");$.css({"visibility":"hidden"});}};c.prototype._getPopoverData=function(o){var d=this._getCurrentTime(o);var O=this._iOffsetX;if(this._bNeedReverse){O=-O-this.oTimePopover.width();}var p={offsetX:O,offsetY:this._iOffsetY};if(d){var f=a.getTimeFormaterBySmallInterval(this.getGantt());p.startNewDate=f.format(d.time);p.endNewDate=f.format(d.endTime);}return p;};c.prototype._getCurrentTime=function(o){var d=this.getGantt()._getDragDropExtension();var r=this.getGantt()._getResizeExtension();if(d.isDragging()){return d._getGhostTime(o);}else if(r.isResizing()){return r._getResizeTime(o);}};c.prototype._calcPopoverOffset=function(){this._iOffsetY=this._getOffsetY();};c.prototype._getOffsetY=function(){var d=this._getDragDropOrResizingDom();var D=d&&d.getBoundingClientRect();var o=32;if(D){o=D.height+2;}return Math.ceil(o);};c.prototype._updatePopoverWhenAutoScroll=function(o){if(this.getGantt().getShowShapeTimeOnDrag()){var d=this.getGantt()._getDragDropExtension();var r=this.getGantt()._getResizeExtension();if(d.isDragging()||r.isResizing()){this._showPopover(o);}}};return c;});
