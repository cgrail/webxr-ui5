/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["jquery.sap.global","sap/ui/core/Core","sap/gantt/library","./GanttExtension","./CoordinateUtils","./GanttUtils"],function(q,C,l,G,a,b){"use strict";var _=".sapGanttShapeConnect";var R=l.simple.RelationshipType;var S={addEventListeners:function(g){this.removeEventListeners(g);var e=g._getConnectExtension();e.shapeConnectDoms().shapeConnectTriggers.on("mousedown"+_,e.beforeShapeConnect.bind(e));},removeEventListeners:function(g){var e=g._getConnectExtension();e.shapeConnectDoms().shapeConnectTriggers.off(_);},addShapeConnectEventListeners:function(g){this.removeShapeConnectEventListeners(g);var e=g._getConnectExtension();var $=q(document);$.on("mousemove"+_,e.onMousemove.bind(e));$.on("mouseup"+_,e.endShapeConnect.bind(e));$.on("keydown"+_,e.onKeydown.bind(e));},removeShapeConnectEventListeners:function(g){q(document).off(_);}};var c=G.extend("sap.gantt.simple.GanttConnectExtension",{_init:function(g,s){this._initShapeConnectStates();return"ConnectExtension";}});c.prototype.attachShapeConnectEvents=function(){var g=this.getGantt();S.addEventListeners(g);if(this.isShapeConnecting()){S.addShapeConnectEventListeners(g);}};c.prototype._initShapeConnectStates=function(){this.mDom={};this._oStartShape={};this._bShapeConnecting=false;this._oScrollDistance={x:0,y:0};this._bElementConnectable=false;};c.prototype.getRlsStartShape=function(){return this._oStartShape;};c.prototype.getSvgElement=function(){return this.getDomRefs().ganttSvg;};c.prototype._getShapeConnectRootNode=function(){var $=this.shapeConnectDoms().shapeConnect;return d3.select($.get(0));};c.prototype.setDomSelector=function(){var d=this.shapeConnectDoms();this.mDom.connectLine=d.connectLine;this.mDom.ghostRect=d.shapeConnectGhost;};c.prototype.createConnectLine=function(f,s){var p=this.getGantt()._getPointerExtension();var x=s.x+p._getAutoScrollStep();var L={"class":"shapeConnectLine",x1:f.x+f.width/2,y1:f.y+f.width/2,x2:x,y2:s.y};if(this.getD3Doms().shapeConnectLine.empty()){var o=this._getShapeConnectRootNode();o.append("line").attr(L);}};c.prototype.createGhostRect=function(f,s){var p=this.getGantt()._getPointerExtension();var x=f.x+p._getAutoScrollStep();var g={"class":"shapeConnectGhost",x:x-f.width/2,y:s.y-f.width/2,width:f.width,height:f.width};if(this.getD3Doms().shapeConnectGhost.empty()){var o=this._getShapeConnectRootNode();o.append("rect").attr(g);}};c.prototype.isShapeConnecting=function(){return this._bShapeConnecting;};c.prototype.updateShapeConnectEffect=function(g){if(this.isShapeConnecting()){var o=a.getLatestCursorPosition();var f=this.getStartShapeFrame();var s=this.getSvgElement();var d=a.getEventSVGPoint(s,o);this.createConnectLine(f,d);this.createGhostRect(f,d);this.showIndicator();this.setDomSelector();this.attachShapeConnectEvents();}};c.prototype.beforeShapeConnect=function(e){var $=q(e.target);var s=$.parents("g").attr(b.SELECT_FOR_DATASET_KEY);this._bElementConnectable=true;var r=C.getConfiguration().getRTL();var f=e.target.getBBox();var d;if(r){d=$.hasClass("rightTrigger")?"Start":"Finish";}else{d=$.hasClass("leftTrigger")?"Start":"Finish";}this._oScrollDistance={x:0,y:0};this._oStartShape={startTriggerFrame:f,x:f.x+f.width/2,y:f.y+f.width/2,shapeUid:s,isRightTrigger:$.hasClass("rightTrigger"),startPoint:d};S.addShapeConnectEventListeners(this.getGantt());};c.prototype.toggleShapeConnectTrigger=function(){var g=this.getGantt();g._updateShapeSelections(g.getSelectedShapeUid(),[]);};c.prototype.getStartShapeFrame=function(){var f={x:0,y:0,width:b.SHAPE_CONNECT_INDICATOR_WIDTH};if(this.isShapeConnecting()){var $=this.shapeConnectDoms().startShapeConnectTrigger;if($&&$.length===1){return $.get(0).getBBox();}else{f.x=this._oStartShape.x-this._oScrollDistance.x;f.y=this._oStartShape.y-this._oScrollDistance.y;}}return f;};c.prototype._getAcceptableShapeElements=function(){var A=[];var t=this;this.shapeConnectDoms().connectableShapes.each(function(i,s){var o=q(s).control(0,true);if(o&&t._oStartShape.shapeUid!==o.getShapeUid()&&o.getDomRef()){A.push(o);}});return A;};c.prototype.showIndicator=function(){if(!this.isShapeConnecting()){return;}var i=[];var t=this;this._getAcceptableShapeElements().forEach(function(s){i.push(t._getIndicatorData(s));});this.getD3Doms().shapeConnectContainers.data(i).enter().append("g").classed("shapeConnectContainer",true).attr("id",function(d){return d.id+"-shape-connect";}).attr(b.SHAPE_CONNECT_FOR_DATASET_KEY,function(d){return d.id;}).each(function(d){var g=d3.select(this);g.append("rect").attr(d.left);g.append("rect").attr(d.right);});this.attachEventHandlerToIndicator();};c.prototype.onMousemove=function(e){if(this._bElementConnectable===false){return;}if(!this.isShapeConnecting()){this._bShapeConnecting=true;var s=this.getSvgElement();var o=a.getEventSVGPoint(s,e);this.createConnectLine(this._oStartShape.startTriggerFrame,o);this.createGhostRect(this._oStartShape.startTriggerFrame,o);this.showIndicator();this.toggleShapeConnectTrigger();this.setDomSelector();}else{this.onShapeConnecting(e);}};c.prototype.onShapeConnecting=function(e){var s=this.getSvgElement();var o=a.getEventSVGPoint(s,e);var p=this.getGantt()._getPointerExtension();var x=o.x+p._getAutoScrollStep();this.mDom.connectLine.attr({x2:x,y2:o.y});var i=b.SHAPE_CONNECT_INDICATOR_WIDTH;this.mDom.ghostRect.attr({x:x-i/2,y:o.y-i/2});};c.prototype.fireEvent=function(e){var $=q(e.target);var t=$.parents("g").attr(b.SHAPE_CONNECT_FOR_DATASET_KEY);var r=C.getConfiguration().getRTL();var E=(r?$.hasClass("rightIndicator"):$.hasClass("leftIndicator"))?"Start":"Finish";var T=this._oStartShape.startPoint+"To"+E;var o={fromShapeUid:this._oStartShape.shapeUid,toShapeUid:q.sap.byId(t).control(0).getShapeUid(),type:R[T]};var g=this.getGantt();g.fireShapeConnect(o);};c.prototype.endShapeConnect=function(e){if(this.isShapeConnecting()){var s=this._getShapeConnectRootNode();s.selectAll("*").remove();}S.removeShapeConnectEventListeners(this.getGantt());this._initShapeConnectStates();this.toggleShapeConnectTrigger();};c.prototype.onKeydown=function(e){if(this.isShapeConnecting()&&e.keyCode===q.sap.KeyCodes.ESCAPE){this.endShapeConnect(e);}};c.prototype.toggleGhostRect=function(e){if(this.isShapeConnecting()){this.shapeConnectDoms().shapeConnectGhost.toggleClass("hideShapeConnectGhost");q(e.target).toggleClass("hoverOnShapeConnectIndicator");}};c.prototype.attachEventHandlerToIndicator=function(){var i=this.shapeConnectDoms().indicators;i.off(_);i.on("mouseup"+_,this.fireEvent.bind(this));i.on("mouseover"+_+" mouseout"+_,this.toggleGhostRect.bind(this));};c.prototype._getIndicatorData=function(s){var e=s.getId();var f=s.getDomRef().getBBox(),x=f.x,y=f.y,w=f.width,h=f.height;var r=b.SHAPE_CONNECT_INDICATOR_WIDTH-2;var m=2;var L=x-m-r,i=y+(h/2)-(r/2);var d=(x+w+m),g=i;var j={width:r,height:r};return{id:e,left:q.extend({x:L,y:i,"class":"leftIndicator shapeConnectIndicator"},j),right:q.extend({x:d,y:g,"class":"rightIndicator shapeConnectIndicator"},j)};};c.prototype.storeScrollDistance=function(s,h){if(h){this._oScrollDistance.x+=s;}else{this._oScrollDistance.y+=s;}};c.prototype.shapeConnectDoms=function(){var $=q(this.getSvgElement());var s='g['+b.SELECT_FOR_DATASET_KEY+'="'+this._oStartShape.shapeUid+'"]';var t=".shapeConnectTrigger."+(this._oStartShape.isRightTrigger?"rightTrigger":"leftTrigger");var d=$.find("g.sapGanttChartShapeConnect");var e=$.find("g.sapGanttChartSelection");return{shapeConnect:d,indicators:d.find(".shapeConnectContainer .shapeConnectIndicator"),shapeConnectGhost:d.find(".shapeConnectGhost"),connectLine:d.find(".shapeConnectLine"),connectableShapes:$.find("["+b.CONNECTABLE_DATASET_KEY+"=true]"),shapeConnectTriggers:e.find(".shapeConnectTrigger"),startShapeConnectTrigger:e.find(s+' '+t)};};c.prototype.getD3Doms=function(){var n=this._getShapeConnectRootNode();return{shapeConnectLine:n.selectAll(".shapeConnectLine"),shapeConnectGhost:n.selectAll(".shapeConnectGhost"),shapeConnectContainers:n.selectAll(".shapeConnectContainer")};};return c;});
