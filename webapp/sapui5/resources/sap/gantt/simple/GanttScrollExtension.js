/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["jquery.sap.global","sap/ui/core/Core","sap/ui/Device","../misc/Format","../config/TimeHorizon","./GanttExtension","./RenderUtils"],function(q,C,D,F,T,G,R){"use strict";var s=function($,v){var r=C.getConfiguration().getRTL();var b=r?"scrollLeftRTL":"scrollLeft";if(typeof v==="number"){$[b](v);}return $[b]();};var n=".sapGanttScroll";var S="scroll"+n;var H={onHSBScroll:function(e){this._getScrollExtension().updateVisibleHorizonIfNecessary();},onMouseWheelScrolling:function(e){var o=this._getScrollExtension();var h=Math.abs(e.deltaX)>Math.abs(e.deltaY),b=h&&e.shiftKey;var i=h?e.deltaX:e.deltaY,c=i>0,d=false;if(i===0){return;}if(b){var f=o.getGanttHsb();if(c){d=f.scrollLeft===f.scrollWidth-f.offsetWidth;}else{d=f.scrollLeft===0;}if(!d){f.scrollLeft=f.scrollLeft+i;}e.preventDefault();e.stopPropagation();}},getEventListenerTargets:function(g){var e=[g.getDomRef("svg"),g.getDomRef("header-svg")];return e.filter(function(E){return E!=null;});},onTouchStart:function(e){if(e.type==="touchstart"||e.pointerType==="touch"){var o=this._getScrollExtension(),h=o.getGanttHsb();var t=e.touches?e.touches[0]:e;o._mTouchSessionData={initialPageX:t.pageX,initialPageY:t.pageY,initialScrollLeft:h?h.scrollLeft:0,initialScrolledToEnd:null};}},onTouchMoveHorizontalScrolling:function(e){if(e.type==="touchmove"||e.pointerType==="touch"){var o=this._getScrollExtension();var t=o._mTouchSessionData;var b=e.touches?e.touches[0]:e;var i=(b.pageX-t.initialPageX);var c=(b.pageY-t.initialPageY);var d=false;var f=false;var h=Math.abs(i)>Math.abs(c);if(!t||!h){return;}var g=o.getGanttHsb();if(i<0){d=g.scrollLeft===g.scrollWidth-g.offsetWidth;}else{d=g.scrollLeft===0;}if(!t.initialScrolledToEnd){t.initialScrolledToEnd=d;}if(!d&&!t.initialScrolledToEnd){g.scrollLeft=t.initialScrollLeft-i;f=true;}if(f){e.preventDefault();}}},addEventListeners:function(g){var e=g._getScrollExtension();this.removeEventListeners(g);q(e.getGanttHsb()).on(S,this.onHSBScroll.bind(g));var E=this.getEventListenerTargets(g);e._mTouchEventListener=this.addTouchEventListener(E,g);e._mMouseWheelEventListener=this.addMouseWheelEventListener(E,g);},removeEventListeners:function(g){var e=g._getScrollExtension();q(e.getGanttHsb()).off(n);H.removeScrollEventListeners(g);},addMouseWheelEventListener:function(e,g){var o=H.onMouseWheelScrolling.bind(g);for(var i=0;i<e.length;i++){e[i].addEventListener("wheel",o);}return{wheel:o};},addTouchEventListener:function(e,g){var o=H.onTouchStart.bind(g);var O=H.onTouchMoveHorizontalScrolling.bind(g);var l={};for(var i=0;i<e.length;i++){if(D.support.pointer&&D.system.desktop){e[i].addEventListener("pointerdown",o);e[i].addEventListener("pointermove",O,D.browser.chrome?{passive:true}:false);}else if(D.support.touch){e[i].addEventListener("touchstart",o);e[i].addEventListener("touchmove",O);}}if(D.support.pointer&&D.system.desktop){l={pointerdown:o,pointermove:O};}else if(D.support.touch){l={touchstart:o,touchmove:O};}return l;},removeScrollEventListeners:function(g){var o=g._getScrollExtension();var e=H.getEventListenerTargets(g);function r(t,E){for(var b in E){var l=E[b];if(l){t.removeEventListener(b,l);}}}for(var i=0;i<e.length;i++){r(e[i],o._mTouchEventListener);r(e[i],o._mMouseWheelEventListener);}delete o._mTouchEventListener;delete o._mMouseWheelEventListener;}};var a=G.extend("sap.gantt.GanttScrollExtension",{_init:function(g,m){this.oGanttHsb=null;this._bSuppressSetVisibleHorizon=false;this.mOffsetWidth=null;return"ScrollExtension";},_attachEvents:function(){var g=this.getGantt();H.addEventListeners(g);},_detachEvents:function(){var g=this.getGantt();H.removeEventListeners(g);},destroy:function(){this._detachEvents();this._delegate=null;this.oGanttHsb=null;this.mOffsetWidth=null;G.prototype.destroy.apply(this,arguments);}});a.prototype.updateVisibleHorizonIfNecessary=function(){if(!this._bSuppressSetVisibleHorizon){var t=this._scrollLeftToVisibleHorizon();this.getGantt()._updateVisibleHorizon(t,"horizontalScroll",this.getVisibleWidth());}this._bSuppressSetVisibleHorizon=false;};a.prototype.jumpToVisibleHorizon=function(r){var t=this.getGantt().getAxisTimeStrategy().getVisibleHorizon();this.getGantt()._updateVisibleHorizon(t,r?r:"horizontalScroll",this.getVisibleWidth());};a.prototype._getGanttHsbScrollLeft=function(){return s(q(this.getGanttHsb()));};a.prototype.getContentWidth=function(){var g=this.getGantt();var A=g.getAxisTime(),r=A.getViewRange();return Math.abs(Math.ceil(r[1])-Math.ceil(r[0]));};a.prototype.updateGanttScrollWidth=function(){var g=this.getGantt();g.getSyncedControl().setInnerWidth(g.getContentWidth()+"px");};a.prototype.getVisibleWidth=function(){return q.sap.byId(this.getGantt().getId()+"-gantt").width();};a.prototype.scrollGanttChartToVisibleHorizon=function(){var b=this._visibleHorizonToScrollLeft();var r=C.getConfiguration().getRTL();var c=b-this.mOffsetWidth.svgOffset;var d=this.getDomRefs(),$=q(d.gantt),e=q(d.header);if(Math.abs(s($)-c)>0){if(r&&D.browser.msie){c+=$.get(0).scrollWidth-R.getGanttRenderWidth(this.getGantt());}var h=this.getGanttHsb();if(h){if(s(q(h))===0&&!(D.browser.msie&&r)){s($,0);s(e,0);}else{s($,c);var f=0;if(r&&D.browser.msie){var o=this.getDomRefs();f=o.header.scrollWidth-o.gantt.scrollWidth;}s(e,c+f);}}}this.getGantt()._getConnectExtension().updateShapeConnectEffect(this);};a.prototype.clearOffsetWidth=function(){this.mOffsetWidth=null;this.getGantt().getAxisTime().setViewOffset(0);};a.prototype.needRerenderGantt=function(r){if(this.mOffsetWidth===null){this.updateGanttScrollWidth();}var b=this.getGantt().getSyncedControl().getRowsHeightChanged();if(this.mOffsetWidth&&this.doesSvgScrollWithinBuffer()&&!b){this._scrollTableToVisibleHorizon(true);this.scrollGanttChartToVisibleHorizon();return false;}this._scrollTableToVisibleHorizon(true);this.updateSvgOffsetWidth();if(r){r.apply(this.getGantt());}this.scrollGanttChartToVisibleHorizon();return true;};a.prototype._scrollTableToVisibleHorizon=function(b){var $=q(this.getGanttHsb()),c=s($);var e=this._visibleHorizonToScrollLeft();if(Math.abs(c-e)>1){this._bSuppressSetVisibleHorizon=b;s($,e);}};a.prototype.updateSvgOffsetWidth=function(){var o=this.calcSvgLatestOffsetWidth();this.getGantt().getAxisTime().setViewOffset(o.svgOffset);this.getGantt().iGanttRenderedWidth=o.svgWidth;this.mOffsetWidth={svgWidth:o.svgWidth,svgOffset:o.svgOffset};};a.prototype.doesSvgScrollWithinBuffer=function(){var v=this.getVisibleWidth(),c=this.getContentWidth(),i=this._visibleHorizonToScrollLeft();if(this.mOffsetWidth===null){return false;}var b=this.mOffsetWidth.svgOffset,d=this.mOffsetWidth.svgWidth;var I=(v>=c)||(i-b>=0&&d>=i-b+v);return I;};a.prototype.calcSvgLatestOffsetWidth=function(){var c=this.getContentWidth(),v=this.getVisibleWidth();var i=this._getGanttHsbScrollLeft()||0;var b=R.getGanttRenderWidth(this.getGantt());var o=i-(v*R.RENDER_EXTEND_FACTOR);if(o<0){b+=o;o=0;}if(o+b>c){b=c-o;}return{svgWidth:b,svgOffset:o};};a.prototype._visibleHorizonToScrollLeft=function(){var t=this.getGantt().getAxisTimeStrategy().getVisibleHorizon();var r=C.getConfiguration().getRTL(),b=t.getStartTime();var i=this.getGantt().getAxisTime().timeToView(F.abapTimestampToDate(b),true);if(r){i=i-this.getVisibleWidth();}if(i<0){i=0;}return i;};a.prototype._scrollLeftToVisibleHorizon=function(){var r=C.getConfiguration().getRTL(),A=this.getGantt().getAxisTime();var i=this._getGanttHsbScrollLeft();var o=A.viewToTime(i,true),e;if(r){e=A.viewToTime(i,true);o=undefined;}return new T({startTime:o,endTime:e});};a.prototype.getGanttHsb=function(){var g=this.getGantt();if(g){this.oGanttHsb=g.getDomRef("hsb");}return this.oGanttHsb;};return a;});
