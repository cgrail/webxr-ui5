/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/Dialog","sap/m/Text","sap/m/Button","sap/m/Input","sap/m/Label","sap/m/MessageBox","sap/ui/fl/support/apps/contentbrowser/lrepConnector/LRepConnector","sap/ui/fl/support/apps/contentbrowser/utils/DataUtils","sap/m/library"],function(C,D,T,B,I,L,M,a,b,m){"use strict";var c=m.ButtonType;return C.extend("sap.ui.fl.support.apps.contentbrowser.controller.ContentDetails",{oSelectedContentModel:undefined,oDataUtils:b,onInit:function(){this._initAndBindSelectedContentModel();var r=sap.ui.core.UIComponent.getRouterFor(this);r.getRoute("ContentDetails").attachMatched(this._onRouteMatched,this);r.getRoute("ContentDetailsFlip").attachMatched(this._onRouteMatched,this);},_initAndBindSelectedContentModel:function(){this.oSelectedContentModel=new sap.ui.model.json.JSONModel();this.getView().setModel(this.oSelectedContentModel,"selectedContent");},_onRouteMatched:function(r){var t=this;var R=r.getParameter("arguments");var o={};o.layer=R.layer;o.namespace=decodeURIComponent(R.namespace);o.fileName=R.fileName;o.fileType=R.fileType;if(o.namespace[o.namespace.length-1]!=="/"){o.namespace+="/";}var s=o.namespace+o.fileName+"."+o.fileType;var p=t.getView().getContent()[0];p.setBusy(true);return a.getContent(o.layer,s,null,null,true).then(t._onContentReceived.bind(t,o,p,s),function(){p.setBusy(false);});},_onContentReceived:function(o,p,s,d){var t=this;o.data=b.formatData(d,o.fileType);if(o.fileType){return a.getContent(o.layer,s,true).then(t._onContentMetadataReceived.bind(t,o,p),function(){p.setBusy(false);});}else{return Promise().resolve();}},_onContentMetadataReceived:function(o,p,d){o.metadata=d;this.oSelectedContentModel.setData(o);var e=sap.ui.getCore();var i=this.getView().createId("contentDetailsIconTabBar");var f=e.getElementById(i);if(f){var F=f.getItems()[0];if(f.getSelectedKey()!==F.getId()){f.setSelectedItem(F);}}p.setBusy(false);},onEditClicked:function(){var s=this.getView().getModel("selectedContent");var o=s.getData();var r=sap.ui.core.UIComponent.getRouterFor(this);r.navTo("ContentDetailsEdit",{"layer":o.layer,"namespace":encodeURIComponent(o.namespace),"fileName":o.fileName,"fileType":o.fileType});},onDeleteClicked:function(){var t=this;var d=new D({title:"{i18n>confirmDeletionTitle}",type:"Message",content:new T({text:"{i18n>questionFileDeletion}"}),beginButton:new B({text:"{i18n>confirm}",type:c.Reject,press:function(){d.close();t._selectTransportAndDeleteFile();}}),endButton:new B({text:"{i18n>cancel}",press:function(){d.close();}}),afterClose:function(){d.destroy();}});this.getView().addDependent(d);d.open();},_selectTransportAndDeleteFile:function(){var t=this;var s=this.getView().getModel("selectedContent");var o=s.getData();var S=o.layer;var d="";var f,p,g;o.metadata.some(function(k){if(k.name==="layer"){d=k.value;return true;}});o.metadata.some(function(k){if(k.name==="transportId"){f=k.value;return true;}});try{p=JSON.parse(o.data).packageName;}catch(e){}var n=o.namespace;var F=o.fileName;var h=o.fileType;if((d==="USER")||(d==="LOAD")||(d==="VENDOR_LOAD")||(!f&&(!p||p==="$TMP"))){g=undefined;t._deleteFile(d,n,F,h,g,S);}else if(f==="ATO_NOTIFICATION"){g=f;t._deleteFile(d,n,F,h,g,S);}else{var i=new I({placeholder:"Transport ID or ATO_NOTIFICATION"});var j=new D({title:"{i18n>transportInput}",type:"Message",content:[new T({text:"{i18n>transportInputDescription}"}),i],beginButton:new B({text:"{i18n>confirm}",type:c.Accept,press:function(){g=i.getValue();j.close();t._deleteFile(d,n,F,h,g,S);}}),endButton:new B({text:"{i18n>cancel}",press:function(){j.close();}}),afterClose:function(){j.destroy();}});this.getView().addDependent(j);j.open();}},_deleteFile:function(l,n,f,F,t,s){return a.deleteFile(l,n,f,F,t,s).then(function(){var r=sap.ui.core.UIComponent.getRouterFor(this);r.navTo("LayerContentMaster",{"layer":s,"namespace":encodeURIComponent(n)});}.bind(this));}});});
