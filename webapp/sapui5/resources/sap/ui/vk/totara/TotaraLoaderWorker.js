
function HttpConnection(){"use strict";var u;var a;var o;var r=[];var m=4;var b=0;function c(u){var p=new Promise(function(d,e){var x=new XMLHttpRequest();x.onload=function(){if(this.status>=200&&this.status<300){d(x.response);}else{e({status:this.status,statusText:x.statusText});}};x.onerror=function(){e({status:this.status,statusText:x.statusText});};x.open("GET",u,true);if(a){x.setRequestHeader("Authorization",a);}x.responseType="arraybuffer";x.send();});return p;}this.getUrl=function(){return u;};this.close=function(){};this.send=function(d,e,f){if(!d){return;}r.push({message:d,context:e,onResponse:f||this.onResponse});if(b<m){_();}};function _(){if(!r.length){return;}var d=r.shift();b++;c(encodeURI(u+d.message)).then(function(e){if(d.onResponse){d.onResponse(e);}b--;_();}).catch(function(e){if(o){o({errorText:"could not connect to server:"+u,error:e.status,reason:e,context:d.context});}b--;_();});}this.init=function(s,d){return new Promise(function(e,f){u=s;if(d!=null){d(s).then(function(t){if(t!=null){a=t.token_type+" "+t.access_token;}else{a=null;}e({});}).catch(function(g){return f(g);});}else{e({});}});};this.setOnErrorCallback=function(d){o=d;};this.onResponse=null;}
function WebSocketConnection(){"use strict";var l;var t=this;var c;var o;function i(){if(c&&c.readyState===1){return true;}return false;}function a(m,e,h){if(o){o({errorText:m,error:h,context:e});}}this.setOnErrorCallback=function(e){o=e;};this.getUrl=function(){return l;};this.close=function(){if(c){c.close();c=null;}};this.send=function(m,h){if(!m){return;}if(!i()){a("websocket connection lost",h,4);}else{try{c.send(m);}catch(e){a(e,h);}}};var b=0;function k(){var e=60000;if(c.readyState==1){c.send("");}b=setTimeout(k,e);}function d(){if(b){clearTimeout(b);b=0;}}var f=false;var g=function(e){var r=JSON.stringify(e);var h="setStreamingToken"+("["+r.length+"]")+r;return h;};this.init=function(s,h){return new Promise(function(r,j){if(s){l=s;}else{s=l;}c=new WebSocket(s);c.binaryType="arraybuffer";c.onopen=function(){f=true;if(h!=null){h(s).then(function(e){if(e!=null){var m=g({"token":e.access_token});c.send(m);}k();r({});}).catch(function(e){return j(e);});}else{k();r({});}};c.onclose=function(){d();};c.onmessage=function(e){var m=e.data;if(t.onResponse){t.onResponse(m);}};c.onerror=function(e){if(!f){j("error connecting to "+s);}else{a(e);}};});};this.onResponse=null;}
function findChar(c,s,u){"use strict";for(var i=s;i<u.length;i++){if(u[i]===c){return i;}}return-1;}
function getContentLength(c){"use strict";var l=c.split(",");if(l.length<0||l.length>2){throw"invalid content length";}var j=0;var b=0;try{j=parseInt(l[0],10);if(l.length===2){b=parseInt(l[1],10);}}catch(e){throw"invalid content length";}return{jsonContentLength:j,binaryContentLength:b};}
function Parser(){"use strict";}
Parser.createCommandList=function(a,o){"use strict";var b=new Uint8Array(a);var c=[];var s=0;var d=0;var f;var j;var g;while(d<b.length){d=findChar("[".charCodeAt(0),s,b);if(d===-1){break;}var h=Decoder.decode(b.slice(s,d)).replace(/\n|\r|\s/g,"");s=d+1;d=findChar("]".charCodeAt(0),s,b);if(d===-1){throw"No matching [] for command length. abort";}f=getContentLength(Decoder.decode(b.slice(s,d)));s=d+1;d=s+f.jsonContentLength;j=Decoder.decode(b.slice(s,d));try{j=JSON.parse(j);}catch(e){var i=h+": "+e;throw i;}if(f.binaryContentLength){s=d;d=s+f.binaryContentLength;g=b.slice(s,d);}else{g=undefined;}s=d;var k={name:h,jsonContent:j,binaryContent:g};if(o){o(k);}c.push(k);}return c;};
function Decoder(){"use strict";}
Decoder.uint8ArrayToString=function(u){"use strict";var f="";try{var C=0x8000;var i=0;var l=u.length;var s;while(i<l){s=u.slice(i,Math.min(i+C,l));f+=String.fromCharCode.apply(null,s);i+=C;}}catch(e){f="";}return f;};
Decoder.decode=function(u){"use strict";var e=Decoder.uint8ArrayToString(u);return decodeURIComponent(escape(e));};
function LoaderProxy(){"use strict";this.init=function(a,h,b){this._connection=a;this._connectionHTTP=h;this._sceneBuilderId=b;if(!a){throw"no connection provided for loader!";}this._connection.onResponse=function(r){var c=Parser.createCommandList(r);p(c);};};function p(c){var d;for(var i=0;i<c.length;i++){var a=c[i];if(a.binaryContent){d={name:a.name,jsonContent:a.jsonContent,binaryContent:a.binaryContent};self.postMessage(d,[d.binaryContent.buffer]);}else{d={name:a.name,jsonContent:a.jsonContent};self.postMessage(d);}}}this.getConnection=function(){return this._connection;};this._sendGetImage=function(i,c){this._connectionHTTP.send("images/"+i,c,function(r){p([{name:"setImage",jsonContent:{id:i},binaryContent:new Uint8Array(r)}]);});};this._sendGetGeometries=function(g,c){var r="geometry?";for(var i=0;i<g.length;i++){r+=(i>0?"&id=":"id=")+g[i];}this._connectionHTTP.send(r,c,function(a){var d=new DataView(a);var b=d.getUint16(2,true),o=0;var e=[];while(b-->0){var f={id:d.getUint32(o+4,true).toString(),box:[d.getFloat32(o+14,true),d.getFloat32(o+18,true),d.getFloat32(o+22,true),d.getFloat32(o+26,true),d.getFloat32(o+30,true),d.getFloat32(o+34,true)]};var h=d.getUint16(o+8,true);if(h!==3){f.flags=d.getUint16(o+38,true);f.pointCount=d.getUint16(o+46,true);f.elementCount=d.getUint16(o+48,true);}var j=d.getUint32(o+52,true);var k=new Uint8Array(a,o+56,j);e.push({name:"setGeometry",jsonContent:f,binaryContent:k.slice()});o+=52+j;}p(e);});};this.send=function(c){if(this._connectionHTTP&&c.resources){switch(c.method){case"getImage":for(var i=0;i<c.resources.length;i++){this._sendGetImage(c.resources[i],c);}return;case"getGeometry":this._sendGetGeometries(c.resources,c);return;default:break;}}if(this._connection){this._connection.send(c.command);}};this.setSceneBuilderId=function(i){this._sceneBuilderId=i;};this.getSceneBuilderId=function(){return this._sceneBuilderId;};this.authorizationHandler=function(u){return new Promise(function(r,a){var d={name:"getAuthorization",jsonContent:{"url":u},sceneId:self.loader.sceneId};self.loader.resolveFunctions.push(r);self.loader.rejectFunctions.push(a);self.postMessage(d);});};}
LoaderProxy.HttpConnection=HttpConnection;LoaderProxy.WebSocketConnection=WebSocketConnection;var loader=new LoaderProxy();loader.resolveFunctions=[];loader.rejectFunctions=[];var reportError=function(e){"use strict";postMessage({name:"notifyError",jsonContent:{error:e}});};var onmessage=function(e){"use strict";var d=e.data;switch(d.method){case"initializeConnection":if(!d.url){break;}if(d.sceneId){loader.sceneId=d.sceneId;}var a="";if(d.url[d.url.length-1]!=="/"){d.url+="/";}if(d.url.toLowerCase().startsWith("ws")){a=d.url+"streaming?";}else if(d.url.toLowerCase().startsWith("http")){a=d.url+"streaming-http?request=";}else{a=(d.useSecureConnection?"wss://":"ws://")+d.url+"streaming?";}var b=loader.getConnection();if(!b||b.getUrl()!==a){if(b){b.close();}var c;var f=null;if(d.url.toLowerCase().startsWith("ws")){c=new WebSocketConnection();}else if(d.url.toLowerCase().startsWith("http")){c=new HttpConnection();f=d.url;}else{c=new WebSocketConnection();f=(d.useSecureConnection?"https://":"http://")+d.url;}c.init(a,loader.authorizationHandler).then(function(){var i=function(c,h){loader.init(c,h,d.sceneBuilderId);if(d.command){loader.send(d);}};if(f){var h=new HttpConnection();h.init(f,loader.authorizationHandler).then(function(){i(c,h);}).catch(function(j){reportError(j);});}else{i(c,null);}}).catch(function(h){reportError(h);});}else if(d.command){loader.send(d);}break;case"setAuthorization":var r=loader.resolveFunctions.shift();var g=loader.rejectFunctions.shift();if(d.error==null){r(d.authorizationToken);}else{g(d.error);}break;default:if(d.command){loader.send(d);}break;}};self.onmessage=onmessage;postMessage({ready:true});
