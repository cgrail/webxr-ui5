sap.ui.define(["jquery.sap.global","./ListMap","./RequestCommandGenerator","./CallbackHandler","./SceneStateContext","./Processor","./Commands","./Generator","./SceneState","./TotaraUtils","sap/ui/thirdparty/URI"],function(q,L,R,C,S,P,a,G,b,T,U){"use strict";var c=function(){var _=new b();var d=false;var e=false;var f=new P();var g=null;var h=this;_.loader=this;function s(r,t){if(!h._worker){return false;}var i=false;if(r){while(r.canGenerateCommand()){var n=r.generateRequestCommand(true,t);h._worker.postMessage(n);i=true;}}return i;}function j(){var i=false;var t;var v=_.contextMap.values();var k=v.next();while(!k.done){var m=k.value;k=v.next();if(s(m.requestCommandGenerator,m.token)){i=true;}t=m.token;}if(!i){s(_.requestCommandGenerator,t);}}this.getUrl=function(){return g;};this.init=function(k){g=k;function o(i){if(i){i.phase=S.Phase.FinishedHierarchy;}if(!d){var m=i.meshGroupListMap;var n=new Set(m.keys());i.requestCommandGenerator.pushMeshIds(n);if(n.size===0){if(i.retrievalType===S.RetrievalType.Initial){i.onInitialSceneFinishedCallbacks.execute();}if(i.retrievalType===S.RetrievalType.Partial){i.onPartialRetrievalFinishedCallbacks.execute();}if(i.isSceneCompleted()){i.onSceneCompletedCallbacks.execute();}}}var p=_.materialIdsToRequest;if(p&&p.size){p.forEach(function(r){_.materialIdsRequested.add(r);});_.requestCommandGenerator.pushMaterialIds(p);_.materialIdsToRequest.clear();}if(!e&&i.annotationNodeMap.size>0){i.requestCommandGenerator.pushAnnotationIds(Array.from(i.annotationNodeMap.keys()));}j();}f.setCommandCallback(a.notifyFinishedTree,function(i){if(i.error){return;}var m=i.context;o(m);});f.setCommandCallback(a.setMesh,function(m){if(m.error){return;}var n=_.materialIdsToRequest;if(n&&n.size){n.forEach(function(r){_.materialIdsRequested.add(r);});_.requestCommandGenerator.pushMaterialIds(n);_.materialIdsToRequest.clear();}_.requestCommandGenerator.pushGeometryIds(m.geometryIdMap);if(m.updatedContexts){for(var i=0;i<m.updatedContexts.length;i++){var p=m.updatedContexts[i];if(p.meshGroupListMap.size===0){p.phase=S.Phase.FinishedMesh;p.onMeshFinishedCallbacks.execute();if(p.retrievalType===S.RetrievalType.Initial){p.onInitialSceneFinishedCallbacks.execute();}else if(p.retrievalType===S.RetrievalType.Partial){p.onPartialRetrievalFinishedCallbacks.execute();}if(p.isSceneCompleted()){p.onSceneCompletedCallbacks.execute();}p.progressCount.geometry.total=p.boundingBoxNodeIdsListMap.size;var t=p.token;if(p.isSceneCompleted()){l(p,"sceneCompleted",t);}else{l(p,"meshFinished",t);}}}}j();});f.setCommandCallback(a.setGeometry,function(m){if(m.error){return;}_.onSetGeometryCallbacks.execute(m);if(m.updatedContexts){for(var i=0;i<m.updatedContexts.length;i++){var n=m.updatedContexts[i];if(n.isSceneCompleted()){n.onSceneCompletedCallbacks.execute();var t=n.token;if(n.isSceneCompleted()){l(n,"sceneCompleted",t);}else{l(n,"geometryFinished",t);}n.finishedTime=Date.now();}}}});f.setCommandCallback(a.setAnnotation,function(i){var m=_.materialIdsToRequest;if(m&&m.size){m.forEach(function(n){_.materialIdsRequested.add(n);});_.requestCommandGenerator.pushMaterialIds(m);_.materialIdsToRequest.clear();j();}});f.setCommandCallback(a.setTree,function(i){if(i.result&&i.result==="failure"&&i.context){_.contextMap.delete(i.context.sceneId);}});f.setCommandCallback(a.setViewGroup,function(r){if(r.context){r.context.requestCommandGenerator.pushViewIds(r.viewIdSet);_.requestCommandGenerator.pushImageIds(r.imageIdSet);j();}});f.setCommandCallback(a.notifyFinishedView,function(r){if(r.error){return;}var i=r.context;if(i){var m=_.materialIdsToRequest;if(m&&m.size){m.forEach(function(y){_.materialIdsRequested.add(y);});_.requestCommandGenerator.pushMaterialIds(m);_.materialIdsToRequest.clear();j();}if(r.view){var n=[];i.updatedNodes.forEach(function(y){n.push(y);});r.view.updatedNodes=n;i.viewIds.delete(r.viewId);}var p=true;var v=_.contextMap.values();var t=v.next();while(!t.done){var u=t.value;if(u.viewIds.size>0){p=false;break;}t=v.next();}if(p){_.sceneBuilder.finalizeViewGroups();_.onViewGroupUpdatedCallbacks.execute();_.onViewGroupFinishedCallbacks.execute();}if(i.meshGroupListMap.size===0){i.onViewFinishedCallbacks.execute(r.view);}else{var w=new Set(i.meshGroupListMap.keys());i.requestCommandGenerator.pushMeshIds(w);var x=function(){i.onPartialRetrievalFinishedCallbacks.detach(x);i.onViewFinishedCallbacks.execute(r.view);};i.onPartialRetrievalFinishedCallbacks.attach(x);l(i,"notifyFinishedView",i.token);j();}}j();});f.setCommandCallback(a.setMaterial,function(r){if(r.error){return;}_.requestCommandGenerator.pushImageIds(r.imageIdSet);if(_.materialIdsRequested.size===0){_.onMaterialFinishedCallbacks.execute();}j();});f.setCommandCallback(a.setImage,function(r){if(r.error){return;}if(_.texturesToUpdate.size===0){_.onImageFinishedCallbacks.execute(r);}});f.setCommandCallback(a.setView,function(r){if(r.error){return;}var i=r.context;var t=i?i.token:null;l(i,"setView",t);});f.setCommandCallback(a.setPlayback,function(r){if(r.error){return;}if(r.sequenceIdSet.size>0){_.hasAnimation=true;var i=_.viewIdSceneIdMap.get(r.viewId);var m=_.getContext(i);if(m){m.requestCommandGenerator.pushSequenceIds(r.sequenceIdSet);}j();}else{_.hasAnimation=false;}});f.setCommandCallback(a.setSequence,function(r){if(r.error){return;}if(_.sequenceIds.size>0){j();}if(r.trackIdSet.size>0){_.requestCommandGenerator.pushTrackIds(r.trackIdSet);j();}else{_.hasAnimation=false;_.onSetSequenceCallbacks.execute();}});f.setCommandCallback(a.setTrack,function(r){if(r.error){return;}if(_.trackIds.size>0){s();}else{_.sceneBuilder.finalizeAnimation();_.sceneBuilder.finalizePlaybacks();_.onSetTrackCallbacks.execute();}});f.setCommandCallback(a.notifyError,function(r){_.onErrorCallbacks.execute(r);});var h=this;return new Promise(function(r){if(!h._worker){var u=new U(sap.ui.require.toUrl("sap/ui/vk/totara/TotaraLoaderWorker.js"));if(u.is("relative")){u=u.absoluteTo(new U(location.href));}h._worker=new Worker((window.URL||window.webkitURL).createObjectURL(new Blob(["importScripts('"+u.toString()+"');"],{"type":"application/javascript"})));h._worker.onmessage=function(i){var m=i.data;if(m.ready){return;}if(m.name==="getAuthorization"){var n;if(m.sceneId){n=_.getContext(m.sceneId);}if(n&&n.authorizationHandler){n.authorizationHandler(m.jsonContent.url).then(function(t){h._worker.postMessage({"method":"setAuthorization","authorizationToken":t});}).catch(function(t){h._worker.postMessage({"method":"setAuthorization","authorizationToken":null,"error":t.toString()});});}else{h._worker.postMessage({"method":"setAuthorization","authorizationToken":null});}return;}var p={name:m.name,jsonContent:m.jsonContent};if(m.binaryContent){p.binaryContent=m.binaryContent;}f.process(_,p);};h._worker.onerror=function(i){};}});};this.enablePushMesh=function(i){d=i;};this.dispose=function(){f=null;if(_){if(_.contextMap){var v=_.contextMap.values();var i=v.next();while(!i.done){var k=i.value;i=v.next();k.dispose();}}_.dispose();_=null;}if(this._worker){this._worker.terminate();this._worker=undefined;}};function l(i,n,t){if(i&&i.progressLogger&&t&&n){i.progressLogger.logPerformance(n,t);}}this.request=function(i,k,m){if(!k.root){throw"context must include root where three js objects are attached to";}var n=_.createContext(i,k);_.currentSceneInfo.id=i;n.retrievalType=S.RetrievalType.Initial;n.authorizationHandler=m;n.initialRequestTime=Date.now();var t;if(n.enableLogger){var o=T.createLogger(i,n,this);if(o){t=T.generateToken();n.token=t;}}var p=k.includeHidden!==undefined?k.includeHidden:true;var r=k.includeAnimation!==undefined?k.includeAnimation:true;var u=k.$select!==undefined?k.$select:"name,transform,meshId,annotationId,materialId,contentType,visible,opacity,renderOrder";var v=k.pushViewGroups!==undefined?k.pushViewGroups:true;var w={pushMaterials:true,pushMeshes:d,includeHidden:p,includeAnimation:r,pushPMI:k.pushPMI||false,metadataFilter:k.metadataFilter,token:t,pushViewGroups:v,$select:u};if(k.activateView){w.activateView=k.activateView;}w.sceneId=i;w.context=i;var x=G.createGetTreeCommand(w);l(n,"modelRequested",t);this._worker.postMessage({method:"initializeConnection",url:g,useSecureConnection:k.useSecureConnection,token:n.token,command:x,sceneId:i});};this.postMessage=function(m){this._worker.postMessage(m);};this.update=function(i,k,v){var h=this;_.currentSceneInfo.id=i;return new Promise(function(r,m){var n=_.getContext(i);if(!n){m("no context for ${sceneVeId}.");}n.nodeSidsForPartialTree=new Set(k);n.retrievalType=S.RetrievalType.Partial;var o=n.includeHidden!==undefined?n.includeHidden:true;var p=n.includeAnimation!==undefined?n.includeAnimation:true;var t=n.$select!==undefined?n.$select:"name,transform,meshId,materialId,contentType,visible,opacity,renderOrder";var u=n.pushViewGroups!==undefined?n.pushViewGroups:true;var w={pushMaterials:true,pushMeshes:d,filter:k.join(),includeAnimation:p,includeHidden:o,pushPMI:n.pushPMI||false,metadataFilter:n.metadataFilter,pushViewGroups:u,$select:t,breadcrumbs:true};var x;if(n.progressLogger){x=T.generateToken();n.token=x;}w.sceneId=i;w.context=i;if(v){w.activateView=v;}var y=G.createGetTreeCommand(w);var z=function(){n.onPartialRetrievalFinishedCallbacks.detach(z);l(n,"updateFinished(mesh)",x);var A=[];var B=[];n.replacedNodes.forEach(function(F,H){B.push(F);A.push(H);});var D=A;var E=B;r({sceneVeId:i,sids:k,replacedNodeRefs:D,replacementNodeRefs:E});};n.onPartialRetrievalFinishedCallbacks.attach(z);l(n,"updateRequested",x);h._worker.postMessage({method:"update",command:y});});};this.requestViewGroup=function(i,v){if(!v){return Promise.reject("invalid arg: viewGroupId undefined");}var k=_.getContext(i);if(!k){return Promise.reject("no scene exist for ${sceneVeId}");}var h=this;var p=new Promise(function(r,m){var n=_.sceneBuilder.getViewGroup(v,i);if(n&&n.length){r(n);return;}var t;if(k.progressLogger){t=T.generateToken();k.token=t;}var o={sceneId:i,id:v,token:t};var u=G.createGetViewGroupsCommand(o);var w=a.getViewGroups;var x=function(){_.onViewGroupFinishedCallbacks.detach(x);l(k,"onViewGroupFinished",t);var y=_.sceneBuilder.getViewGroup(v,i);if(y&&y.length){r(y);}else{m("no view ground data");}};_.onViewGroupFinishedCallbacks.attach(x);k.currentViewGroupId=v;h._worker.postMessage({method:w,command:u});});return p;};this.requestView=function(i,v,k,u){_.currentSceneInfo.id=i;if(v!=="static"&&v!=="dynamic"){return Promise.reject("invalid arg: supported type - static, dynamic");}if(!k){return Promise.reject("invalid arg: viewId undefined");}var m=_.getContext(i);if(!m){return Promise.reject("no scene exist for ${sceneVeId}");}_.viewIdSceneIdMap.set(k,i);var t;if(m.progressLogger){t=T.generateToken();m.token=t;}var n=m.includeHidden!==undefined?m.includeHidden:false;var o=m.includeAnimation!==undefined?m.includeAnimation:true;var p=m.$select!==undefined?m.$select:undefined;_.hasAnimation=false;var h=this;var r;var w=new Promise(function(x,y){if(u){var z=_.sceneBuilder.getView(k,i);if(z){x(z);return;}}var A="";var B;if(v==="static"){r={sceneId:i,id:k,token:t,includeHidden:n,includeAnimation:o,$select:p};A+=G.createGetViewCommand(r);B=a.getView;}else{r={sceneId:i,type:k,token:t};A+=G.createGetDynamicViewCommand(r);B=a.getDynamicView;}var D=function(H){m.onViewFinishedCallbacks.detach(D);l(m,"onViewFinished",t);if(!_.hasAnimation){if(H){x(H);}else{y("no view data");}}else{m.currentView=H;}};m.onViewFinishedCallbacks.attach(D);var E=function(){_.onSetSequenceCallbacks.detach(E);l(m,"onSetSequence",t);if(m.currentView){x(m.currentView);}else{y("no view data");}};_.onSetSequenceCallbacks.attach(E);var F=function(H){_.onSetTrackCallbacks.detach(F);l(m,"onSetTrack",t);if(m.currentView){x(m.currentView);}else{y("no view data");}};_.onSetTrackCallbacks.attach(F);l(m,"viewRequested",t);h._worker.postMessage({method:B,command:A});});return w;};this.requestMaterial=function(i){if(!i){return Promise.reject("invalid arg: materialId undefined");}var p=new Promise(function(r,k){var n=_.sceneBuilder.getMaterial(i);if(n){r(n);return;}_.requestCommandGenerator.pushMaterialIds([i]);_.materialIdsRequested.add(i);var o=function(u){var m=_.sceneBuilder.getMaterial(i);if(m&&m.userData&&m.userData.idsOfImagesToRead){if(!m.userData.idsOfImagesToRead.has(u.id)){return;}else{m.userData.idsOfImagesToRead.delete(u.id);}if(m.userData.idsOfImagesToRead.size){return;}else{r(m);}}else{k("no material data");}_.onImageFinishedCallbacks.detach(o);};var t=function(){_.onMaterialFinishedCallbacks.detach(t);var m=_.sceneBuilder.getMaterial(i);if(m&&m.userData&&m.userData.idsOfImagesToRead&&m.userData.idsOfImagesToRead.size){return;}_.onImageFinishedCallbacks.detach(o);if(m!=null){r(m);}else{k("no material data");}};_.onMaterialFinishedCallbacks.attach(t);_.onImageFinishedCallbacks.attach(o);j();});return p;};this.getState=function(){return _;};this.decrementResourceCountersForDeletedTreeNode=function(i,k,n){i.sceneBuilder.decrementResourceCountersForDeletedTreeNode(n,k.sceneId);};this.printLogTokens=function(){if(!_||!_.contextMap){console.log("printLogTokens:no data to print");return;}var i=_.contextMap.entries();var k=i.next();while(!k.done){var m=k.key;var n=k.value;k=i.next();console.log("log tokens for scene => "+m);console.log("---------------------------------------");if(n.progressLogger){var o=n.progressLogger.getTokens();var p=o.keys();var r=p.next();while(!r.done){var t=r.value;p.next();console.log(t);}}console.log("---------------------------------------");}};this.getSceneBuilder=function(){if(_){return _.sceneBuilder;}return null;};};return c;});
