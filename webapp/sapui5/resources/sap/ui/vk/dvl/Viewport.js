/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["jquery.sap.global","../library","../ViewportBase","sap/ui/core/ResizeHandler","../Loco","../ViewportHandler","../Smart2DHandler","../Messages","../ContentConnector","../ViewStateManager","./GraphicsCore","./ViewportRenderer"],function(q,l,V,R,L,a,S,M,C,b,G,c){"use strict";var d={encodedProjectionType:{},decodedProjectionType:{},encodedBindingType:{},decodedBindingType:{},decodedZoomTo:{}};d.decodedProjectionType[sap.ui.vk.CameraProjectionType.Perspective]=sap.ve.dvl.DVLCAMERAPROJECTION.PERSPECTIVE;d.decodedProjectionType[sap.ui.vk.CameraProjectionType.Orthographic]=sap.ve.dvl.DVLCAMERAPROJECTION.ORTHOGRAPHIC;d.encodedProjectionType[sap.ve.dvl.DVLCAMERAPROJECTION.PERSPECTIVE]=sap.ui.vk.CameraProjectionType.Perspective;d.encodedProjectionType[sap.ve.dvl.DVLCAMERAPROJECTION.ORTHOGRAPHIC]=sap.ui.vk.CameraProjectionType.Orthographic;d.decodedBindingType[sap.ui.vk.CameraFOVBindingType.Minimum]=sap.ve.dvl.DVLCAMERAFOVBINDING.MIN;d.decodedBindingType[sap.ui.vk.CameraFOVBindingType.Maximum]=sap.ve.dvl.DVLCAMERAFOVBINDING.Max;d.decodedBindingType[sap.ui.vk.CameraFOVBindingType.Horizontal]=sap.ve.dvl.DVLCAMERAFOVBINDING.HORZ;d.decodedBindingType[sap.ui.vk.CameraFOVBindingType.Vertical]=sap.ve.dvl.DVLCAMERAFOVBINDING.VERT;d.encodedBindingType[sap.ve.dvl.DVLCAMERAFOVBINDING.MIN]=sap.ui.vk.CameraFOVBindingType.Minimum;d.encodedBindingType[sap.ve.dvl.DVLCAMERAFOVBINDING.MAX]=sap.ui.vk.CameraFOVBindingType.Maximum;d.encodedBindingType[sap.ve.dvl.DVLCAMERAFOVBINDING.HORZ]=sap.ui.vk.CameraFOVBindingType.Horizontal;d.encodedBindingType[sap.ve.dvl.DVLCAMERAFOVBINDING.VERT]=sap.ui.vk.CameraFOVBindingType.Vertical;d.decodedZoomTo[sap.ui.vk.ZoomTo.All]=sap.ve.dvl.DVLZOOMTO.DVLZOOMTO_ALL;d.decodedZoomTo[sap.ui.vk.ZoomTo.Visible]=sap.ve.dvl.DVLZOOMTO.DVLZOOMTO_VISIBLE;d.decodedZoomTo[sap.ui.vk.ZoomTo.Selected]=sap.ve.dvl.DVLZOOMTO.DVLZOOMTO_SELECTED;d.decodedZoomTo[sap.ui.vk.ZoomTo.Node]=sap.ve.dvl.DVLZOOMTO.DVLZOOMTO_NODE;d.decodedZoomTo[sap.ui.vk.ZoomTo.NodeSetIsolation]=sap.ve.dvl.DVLZOOMTO.DVLZOOMTO_NODE_SETISOLATION;d.decodedZoomTo[sap.ui.vk.ZoomTo.Restore]=sap.ve.dvl.DVLZOOMTO.DVLZOOMTO_RESTORE;d.decodedZoomTo[sap.ui.vk.ZoomTo.RestoreRemoveIsolation]=sap.ve.dvl.DVLZOOMTO.DVLZOOMTO_RESTORE_REMOVEISOLATION;d.decodedZoomTo[sap.ui.vk.ZoomTo.ViewLeft]=sap.ve.dvl.DVLZOOMTO.VIEW_LEFT;d.decodedZoomTo[sap.ui.vk.ZoomTo.ViewRight]=sap.ve.dvl.DVLZOOMTO.VIEW_RIGHT;d.decodedZoomTo[sap.ui.vk.ZoomTo.ViewTop]=sap.ve.dvl.DVLZOOMTO.VIEW_TOP;d.decodedZoomTo[sap.ui.vk.ZoomTo.ViewBottom]=sap.ve.dvl.DVLZOOMTO.VIEW_BOTTOM;d.decodedZoomTo[sap.ui.vk.ZoomTo.ViewBack]=sap.ve.dvl.DVLZOOMTO.VIEW_BACK;d.decodedZoomTo[sap.ui.vk.ZoomTo.ViewFront]=sap.ve.dvl.DVLZOOMTO.VIEW_FRONT;var e=V.extend("sap.ui.vk.dvl.Viewport",{metadata:{library:"sap.ui.vk",properties:{showAllHotspots:{type:"boolean",defaultValue:false},hotspotColorABGR:{type:"int",defaultValue:0xc00000ff},hotspotColor:{type:"sap.ui.core.CSSColor",defaultValue:"rgba(255, 0, 0, 0.7529411764705882)"},backgroundColorTopABGR:{type:"int",defaultValue:0xff000000},backgroundColorBottomABGR:{type:"int",defaultValue:0xffffffff}},events:{pan:{parameters:{dx:"int",dy:"int"}},zoom:{parameters:{zoomFactor:"float"}},rotate:{parameters:{dx:"int",dy:"int"}},viewActivated:{parameters:{type:{type:"string"}}},frameRenderingFinished:{}}}});var g=e.getMetadata().getParent().getClass().prototype;e.prototype.init=function(){if(g.init){g.init.call(this);}this._graphicsCore=null;this._dvl=null;this._dvlRendererId=null;this._viewStateManager=null;this._canvas=null;this._resizeListenerId=null;this._is2D=false;this._viewportHandler=new a(this);this._loco=new L();this._loco.addHandler(this._viewportHandler);this._smart2DHandler=null;this._lastPlayedStep=null;this._contentConnector=null;};e.prototype.exit=function(){this._loco.removeHandler(this._viewportHandler);this._viewportHandler.destroy();if(this._resizeListenerId){R.deregister(this._resizeListenerId);this._resizeListenerId=null;}this._clearContentConnector();this.setViewStateManager(null);this.setScene(null);this.setGraphicsCore(null);if(g.exit){g.exit.call(this);}};e.prototype.setGraphicsCore=function(f){if(f!=this._graphicsCore){if(this._graphicsCore){this._dvl.Client.detachFrameFinished(this._handleFrameFinished,this);this._dvl.Client.detachStepEvent(this._updateLastPlayedStep,this);this._dvl.Renderer.SetViewStateManager(null,this._dvlRendererId);this._graphicsCore._deregisterViewport(this);this._dvl=null;}this._graphicsCore=f;if(this._graphicsCore){this._dvl=this._graphicsCore._getDvl();this._graphicsCore._registerViewport(this);this.setShowDebugInfo(this.getShowDebugInfo());this._dvl.Client.attachStepEvent(this._updateLastPlayedStep,this);this._dvl.Client.attachFrameFinished(this._handleFrameFinished,this);this._dvl.Renderer.SetViewStateManager(this._viewStateManager,this._dvlRendererId);}}return this;};e.prototype.getGraphicsCore=function(){return this._graphicsCore;};e.prototype._setCanvas=function(f){var i=this.getDomRef()&&this._canvas!==f;this._canvas=f;if(i){this.invalidate();}return this;};e.prototype._setRenderer=function(f){this._dvlRendererId=f;return this;};e.prototype._updateLastPlayedStep=function(f){if(f.type===sap.ve.dvl.DVLSTEPEVENT.DVLSTEPEVENT_STARTED){this._lastPlayedStep=f.stepId;}};e.prototype.setScene=function(f){if(this._dvlRendererId){this._dvl.Renderer.AttachScene(f&&f.getSceneRef()||null,this._dvlRendererId);this._dvlSceneRef=f?f.getSceneRef():null;if(f){this._dvl.Client.attachUrlClicked(this._fireUrlClicked,this);var i=this._isSmart2DContent()||this._isSmart2DContentLegacy();if(i){this._dvl.Renderer.SetBackgroundColor(1,1,1,1,1,1,1,1,this._dvlRendererId);}else{var j=this._getDecomposedABGR(this.getBackgroundColorTopABGR());var m=this._getDecomposedABGR(this.getBackgroundColorBottomABGR());this._dvl.Renderer.SetBackgroundColor(j.red,j.green,j.blue,j.alpha,m.red,m.green,m.blue,m.alpha,this._dvlRendererId);}this.fireViewActivated({type:i?"2D":"3D"});}else{this._dvl.Client.detachUrlClicked(this._fireUrlClicked,this);if(this._smart2DHandler){var x=new L();x.removeHandler(this._smart2DHandler);}this.invalidate();}}return this;};e.prototype._isSmart2DContent=function(){var f=sap.ui.vk.dvl.getJSONObject(this._dvl.Scene.RetrieveSceneInfo(this._dvlSceneRef,sap.ve.dvl.DVLSCENEINFO.DVLSCENEINFO_HOTSPOTS).ChildNodes);return f&&f.length>0;};e.prototype._isSmart2DContentLegacy=function(){var f=this._dvl.Scene.GetCurrentCamera(this._dvlSceneRef),i=this._dvl.Camera.GetRotation(f),j=this._dvl.Camera.GetProjection(f);return i[0]===90&&i[1]===-90&&i[2]===0&&j===sap.ve.dvl.DVLCAMERAPROJECTION.ORTHOGRAPHIC;};e.prototype._initializeSmart2DHandler=function(){if(this._viewStateManager){if(this._smart2DHandler){this._loco.removeHandler(this._smart2DHandler);}this._smart2DHandler=new S(this,this._viewStateManager);this._loco.addHandler(this._smart2DHandler);}if(this.getShowAllHotspots()){var f=this._viewStateManager.getNodeHierarchy(),i=f.getHotspotNodeIds();this.showHotspots(i,true);}};e.prototype._fireUrlClicked=function(f){this.fireUrlClicked({url:f.url,nodeRef:f.nodeId});};e.prototype.setHotspotColorABGR=function(f){this.setProperty("hotspotColorABGR",f,true);this.setProperty("hotspotColor",sap.ui.vk.colorToCSSColor(sap.ui.vk.abgrToColor(this.getProperty("hotspotColorABGR"))),true);return this;};e.prototype.setHotspotColor=function(f){this.setProperty("hotspotColor",f,true);this.setProperty("hotspotColorABGR",sap.ui.vk.colorToABGR(sap.ui.vk.cssColorToColor(this.getProperty("hotspotColor"))),true);return this;};e.prototype._getStepAndProcedureIndexes=function(f,m){var x=-1,y=-1,z=false;for(var i=0;i<f.length;i++){if(!z){for(var j=0;j<f[i].steps.length;j++){if(f[i].steps[j].id===m){y=j;x=i;z=true;break;}}}else{break;}}return{stepIndex:y,procedureIndex:x};};e.prototype._getStepVeIdById=function(f){if(f){var i=this._dvl.Scene.RetrieveVEIDs(this._dvlSceneRef,f);if(Array.isArray(i)){for(var j=0,m=i.length;j<m;++j){var x=i[j];if(x.source==="SAP"&&x.type==="VE_VIEWPORT"&&Array.isArray(x.fields)){for(var y=0,z=x.fields.length;y<z;++y){var A=x.fields[y];if(A.name==="ID"){return A.value;}}}}}}return null;};e.prototype._getStepIdByVeId=function(f,i){for(var j=0,m=f.length;j<m;++j){var x=f[j].steps;for(var y=0,z=x.length;y<z;++y){var A=x[y].id;if(this._getStepVeIdById(A)===i){return A;}}}return null;};var s=function(f){f.camera={};};var h=function(f){if(typeof f.camera==="object"&&f.camera!==null){f.camera.matrices=false;}};var k=function(f){if(typeof f.camera==="object"&&f.camera!==null){f.camera.useTransitionCamera=false;}};var n=function(f){f.animation=true;};var o=function(f){f.visibility=false;};var p=function(f){if(typeof f.visibility==="object"&&f.visibility!==null){f.visibility.mode=sap.ui.vk.VisibilityMode.Complete;}};e.prototype.getViewInfo=function(f){if(!this._dvlSceneRef){return null;}var i={};if(typeof f!=="object"||f===null){s(i);h(i);k(i);n(i);o(i);p(i);}else{if(typeof f.camera==="object"&&f.camera!==null){i.camera={};if(typeof f.camera.matrices==="boolean"){i.camera.matrices=f.camera.matrices;}else if("matrices"in f.camera){i.camera.matrices=false;}else{h(i);}if(typeof f.camera.useTransitionCamera==="boolean"){i.camera.useTransitionCamera=f.camera.useTransitionCamera;}else if("useTransitionCamera"in f.camera){i.camera.useTransitionCamera=false;}else{k(i);}}else if(typeof f.camera==="boolean"){if(f.camera===true){i.camera={};h(i);k(i);}else{i.camera=false;}}else if("camera"in f){i.camera=false;}else{s(i);h(i);k(i);}if(typeof f.animation==="boolean"){i.animation=f.animation;}else if("animation"in f){i.animation=false;}else{n(i);}if(typeof f.visibility==="object"&&f.visibility!==null){i.visibility={};if(f.visibility.mode===sap.ui.vk.VisibilityMode.Complete||f.visibility.mode===sap.ui.vk.VisibilityMode.Differences){i.visibility.mode=f.visibility.mode;}else{p(i);}}else if(typeof f.visibility==="boolean"){if(f.visibility===true){i.visibility={};p(i);}else{i.visibility=false;}}else if("visibility"in f){i.visibility=false;}else{o(i);p(i);}}var j={};if(i.camera){var m=null;if(i.camera.useTransitionCamera){m=this._dvl.Renderer.GetTransitionCamera(this._dvlRendererId);if(m===sap.ve.dvl.DVLID_INVALID){m=null;}}if(m===null){m=this._dvl.Renderer.GetCurrentCamera(this._dvlRendererId);}var x=this._dvl.Camera.GetRotation(m),y=this._dvl.Camera.GetOrigin(m);j.camera={rotation:{yaw:x[0],pitch:x[1],roll:x[2]},position:{x:y[0],y:y[1],z:y[2]},projectionType:d.encodedProjectionType[this._dvl.Camera.GetProjection(m)],bindingType:d.encodedBindingType[this._dvl.Camera.GetFOVBinding(m)]};if(this._matView){j.viewMatrix=this._matView.slice();}if(this._matProj){j.projectionMatrix=this._matProj.slice();}if(j.camera.projectionType===sap.ui.vk.CameraProjectionType.Perspective){j.camera.fieldOfView=this._dvl.Camera.GetFOV(m);}else if(j.camera.projectionType===sap.ui.vk.CameraProjectionType.Orthographic){j.camera.zoomFactor=this._dvl.Camera.GetOrthoZoomFactor(m);}if(i.camera.matrices){var z=this._dvl.Renderer.GetCameraMatrices(this._dvlRendererId);j.camera.matrices={view:z.view,projection:z.projection};}}if(i.animation){var A=this._dvl.Scene.RetrieveSceneInfo(this._dvlSceneRef,sap.ve.dvl.DVLSCENEINFO.DVLSCENEINFO_STEP_INFO),B=A.StepId!==sap.ve.dvl.DVLID_INVALID;var D=B?A.StepId:this._lastPlayedStep,E=B?A.StepTime:0,F=this._dvl.Scene.RetrieveProcedures(this._dvlSceneRef),H=this._getStepAndProcedureIndexes(F.procedures,D),I=this._getStepVeIdById(D);j.animation={animationTime:E,stepIndex:H.stepIndex,procedureIndex:H.procedureIndex};if(I){j.animation.stepVeId=I;}}if(i.visibility&&this._viewStateManager){j.visibility={mode:i.visibility.mode};if(i.visibility.mode===sap.ui.vk.VisibilityMode.Complete){var J=this._viewStateManager.getVisibilityComplete();j.visibility.visible=J.visible;j.visibility.hidden=J.hidden;}else if(this._viewStateManager.getShouldTrackVisibilityChanges()){j.visibility.changes=this._viewStateManager.getVisibilityChanges();}else{q.sap.log.warning(sap.ui.vk.getResourceBundle().getText(M.VIT32.summary),M.VIT32.code,"sap.ui.vk.dvl.Viewport");}}return j;};e.prototype.setViewInfo=function(f,i){var j=false;if(f.animation){var m=this._dvl.Scene.RetrieveProcedures(this._dvlSceneRef),x=f.animation.procedureIndex,y=f.animation.stepIndex,z=f.animation.stepVeId,A,B=f.animation.animationTime||0;if(z||y>=0&&x>=0){if(z){A=this._getStepIdByVeId(m.procedures,f.animation.stepVeId);}else if(x>=0&&x<m.procedures.length){if(y>=0&&y<m.procedures[x].steps.length){A=m.procedures[x].steps[y].id;}else{q.sap.log.error(sap.ui.vk.getResourceBundle().getText(M.VIT26.summary),M.VIT26.code,"sap.ui.vk.dvl.Viewport");}}else{q.sap.log.error(sap.ui.vk.getResourceBundle().getText(M.VIT27.summary),M.VIT27.code,"sap.ui.vk.dvl.Viewport");}if(A){this._dvl.Renderer.ActivateStep(this._dvlRendererId,A,false,false,B);this._dvl.Renderer.PauseCurrentStep(this._dvlRendererId);}}else{j=true;}}if(f.camera){var D;if(f.camera.projectionType===sap.ui.vk.CameraProjectionType.Perspective||f.camera.projectionType===sap.ui.vk.CameraProjectionType.Orthographic){D=d.decodedProjectionType[f.camera.projectionType];}else{q.sap.log.error(sap.ui.vk.getResourceBundle().getText(M.VIT19.summary),M.VIT19.code,"sap.ui.vk.dvl.Viewport");D=sap.ve.dvl.DVLCAMERAPROJECTION.PERSPECTIVE;}var E=this._dvl.Scene.CreateCamera(this._dvlSceneRef,D,sap.ve.dvl.DVLID_INVALID);if(D===sap.ve.dvl.DVLCAMERAPROJECTION.PERSPECTIVE){this._dvl.Camera.SetFOV(E,f.camera.fieldOfView);}else if(D===sap.ve.dvl.DVLCAMERAPROJECTION.ORTHOGRAPHIC){this._dvl.Camera.SetOrthoZoomFactor(E,f.camera.zoomFactor);}if(f.camera.position){this._dvl.Camera.SetOrigin(E,f.camera.position.x,f.camera.position.y,f.camera.position.z);}if(f.camera.rotation){this._dvl.Camera.SetRotation(E,f.camera.rotation.yaw,f.camera.rotation.pitch,f.camera.rotation.roll);}if(f.camera.bindingType){var F=d.decodedBindingType[f.camera.bindingType]||sap.ve.dvl.DVLCAMERAFOVBINDING.MIN;this._dvl.Camera.SetFOVBinding(E,F);}i=i||0;this._dvl.Renderer.ActivateCamera(this._dvlRendererId,E,i);this._dvl.Scene.DeleteNode(this._dvlSceneRef,E);}if(f.viewMatrix){this._matView=f.viewMatrix.slice();}if(f.projectionMatrix){this._matProj=f.projectionMatrix.slice();}if(f.visibility){var H=this._viewStateManager.getNodeHierarchy(),I=new Map(),J=H.findNodesByName();J.forEach(function(O){var P=H.createNodeProxy(O),Q=q.grep(P.getVeIds(),function(Q){return Q.type==="VE_LOCATOR";});Q=Array.isArray(Q)&&Q.length>0?Q[0].fields[0].value:null;H.destroyNodeProxy(P);if(Q){I.set(Q,O);}});switch(f.visibility.mode){case sap.ui.vk.VisibilityMode.Complete:var K=f.visibility.visible,N=f.visibility.hidden;K.forEach(function(O){this._viewStateManager.setVisibilityState(I.get(O),true,false);},this);N.forEach(function(O){this._viewStateManager.setVisibilityState(I.get(O),false,false);},this);break;case sap.ui.vk.VisibilityMode.Differences:if(j){this.resetView({camera:false,visibility:true,transition:false});}f.visibility.changes.forEach(function(O){var P=I.get(O);if(P){this._viewStateManager.setVisibilityState(P,!this._viewStateManager.getVisibilityState(P),false);}},this);break;default:q.sap.log.error(sap.ui.vk.getResourceBundle().getText(M.VIT28.summary),M.VIT28.code,"sap.ui.vk.dvl.Viewport");break;}}return this;};e.prototype.setSelectionRect=function(f){if(!f){this._dvl.Renderer.DrawSelectionRect(0,0,0,0,this._dvlRendererId);}else{this._dvl.Renderer.DrawSelectionRect(f.x1,f.y1,f.x2,f.y2,this._dvlRendererId);}};e.prototype.getOutputSize=function(){var f=this.getViewInfo().camera.bindingType,i=this.getDomRef().getBoundingClientRect(),j=i.width,m=i.height,x;switch(d.decodedBindingType[f]){case sap.ve.dvl.DVLCAMERAFOVBINDING.MIN:x=Math.min(j,m);break;case sap.ve.dvl.DVLCAMERAFOVBINDING.MAX:x=Math.max(j,m);break;case sap.ve.dvl.DVLCAMERAFOVBINDING.HORZ:x=j;break;case sap.ve.dvl.DVLCAMERAFOVBINDING.VERT:x=m;break;default:break;}return{left:(j-x)/2,top:(m-x)/2,sideLength:x};};e.prototype.onBeforeRendering=function(){if(this._resizeListenerId){R.deregister(this._resizeListenerId);this._resizeListenerId=null;}};e.prototype.onAfterRendering=function(){var f=this.getDomRef();if(this._canvas){f.appendChild(this._canvas);}this._resizeListenerId=R.register(this,this._handleResize.bind(this));this._handleResize({size:{width:f.clientWidth,height:f.clientHeight}});};e.prototype._handleResize=function(f){if(this._dvlRendererId&&this._canvas){var i=f.size.width*window.devicePixelRatio;var j=f.size.height*window.devicePixelRatio;if(this._matProj){var m=this._matProj[0];var x=this._matProj[5];var y=Math.max(m,x);if(i>j){m=y*j/i;x=y;}else{m=y;x=y*i/j;}this._matProj[8]*=m/this._matProj[0];this._matProj[9]*=x/this._matProj[5];this._matProj[0]=m;this._matProj[5]=x;}this._dvl.Renderer.SetDimensions(i,j,this._dvlRendererId);this._dvl.Renderer.SetOptionF(sap.ve.dvl.DVLRENDEROPTIONF.DVLRENDEROPTIONF_DPI,96*window.devicePixelRatio,this._dvlRendererId);this._canvas.width=i;this._canvas.height=j;this._canvas.style.width=f.size.width+"px";this._canvas.style.height=f.size.height+"px";this.fireResize({size:{width:f.size.width,height:f.size.height}});return true;}};e.prototype._handleVisibilityChanged=e.prototype._handleSelectionChanged=e.prototype._handleOpacityChanged=e.prototype._handleTintColorChanged=function(f){if(this._dvlRendererId){this._dvl.Renderer.ForceRenderFrame(this._dvlRendererId);}};e.prototype.showHotspots=function(f,i,j){var m=sap.ui.vk.dvl.NodeProxy.prototype[typeof j==="string"?"setTintColor":"setTintColorABGR"];var x=function(z,j,E){var F=z.createNodeProxy(E);m.call(F,j);z.destroyNodeProxy(F);};if(!Array.isArray(f)){f=[f];}var y=j===undefined?this.getHotspotColorABGR():j;if(!i){y=0;}var z=this._viewStateManager.getNodeHierarchy();if(this._isSmart2DContent()){var A=[];f.forEach(function(E){var F=sap.ui.vk.dvl.getJSONObject(this._dvl.Scene.RetrieveNodeInfo(this._dvlSceneRef,E,sap.ve.dvl.DVLNODEINFO.DVLNODEINFO_CHILDREN).ChildNodes);Array.prototype.push.apply(A,F);}.bind(this));Array.prototype.push.apply(A,f);A.forEach(x.bind(null,z,y));}else{var B=[];var D=function(E){var A=z.getChildren(E);Array.prototype.push.apply(B,A);A.forEach(D);};f.forEach(D);Array.prototype.push.apply(B,f);B.forEach(x.bind(null,z,y));}return this;};e.prototype._getDecomposedABGR=function(i){return{red:(i>>>0&0xff)/255,green:(i>>>8&0xff)/255,blue:(i>>>16&0xff)/255,alpha:(i>>>24&0xff)/255};};e.prototype._setBackgroundColor=function(){if(this._dvl){var f=this._getDecomposedABGR(this.getBackgroundColorTopABGR()),i=this._getDecomposedABGR(this.getBackgroundColorBottomABGR());this._dvl.Renderer.SetBackgroundColor(f.red,f.green,f.blue,f.alpha,i.red,i.green,i.blue,i.alpha,this._dvlRendererId);}};e.prototype.setBackgroundColorTopABGR=function(i){this.setProperty("backgroundColorTopABGR",i,true);this._setBackgroundColor();return this;};e.prototype.setBackgroundColorTop=function(f){this.setProperty("backgroundColorTop",f,true);return this.setBackgroundColorTopABGR(sap.ui.vk.colorToABGR(sap.ui.vk.cssColorToColor(f)));};e.prototype.setBackgroundColorBottomABGR=function(i){this.setProperty("backgroundColorBottomABGR",i,true);this._setBackgroundColor();return this;};e.prototype.setBackgroundColorBottom=function(f){this.setProperty("backgroundColorBottom",f,true);return this.setBackgroundColorBottomABGR(sap.ui.vk.colorToABGR(sap.ui.vk.cssColorToColor(f)));};e.prototype.setShouldRenderFrame=function(){if(this._dvlRendererId){this._dvl.Renderer.ForceRenderFrame(this._dvlRendererId);}return this;};e.prototype.shouldRenderFrame=function(){return this._dvlRendererId&&this._dvl.Renderer.ShouldRenderFrame(this._dvlRendererId);};e.prototype.renderFrame=function(){if(this._dvlRendererId){if(this._matView&&this._matProj){this.renderFrameEx(this._matView,this._matProj,this._dvlRendererId);}else{this._dvl.Renderer.RenderFrame(this._dvlRendererId);}}return this;};e.prototype.renderFrameEx=function(f,i){if(this._dvlRendererId){this._dvl.Renderer.RenderFrameEx.apply(this,[].concat(f,i),this._dvlRendererId);}return this;};e.prototype.resetView=function(f){if(f!==undefined&&!q.isPlainObject(f)){q.sap.log.error(sap.ui.vk.getResourceBundle().getText(M.VIT31.summary),M.VIT31.code,"sap.ui.vk.dvl.Viewport");}var i={camera:true,transition:true,visibility:false};q.extend(i,f);if(i.camera||i.visibility){var j=(i.camera?sap.ve.dvl.DVLRESETVIEWFLAG.CAMERA:0)|(i.transition?sap.ve.dvl.DVLRESETVIEWFLAG.SMOOTHTRANSITION:0)|(i.visibility?sap.ve.dvl.DVLRESETVIEWFLAG.VISIBILITY:0);if(this._dvlRendererId){this._dvl.Renderer.ResetView(j,this._dvlRendererId);this._lastPlayedStep=null;}}return this;};e.prototype.canIsolateNode=function(f){if(this._dvlRendererId){return this._dvl.Renderer.CanIsolateNode(f,this._dvlRendererId);}else{return false;}};e.prototype.setIsolatedNode=function(f){if(this._dvlRendererId){this._dvl.Renderer.SetIsolatedNode(f,this._dvlRendererId);}return this;};e.prototype.getIsolatedNode=function(){if(this._dvlRendererId){return this._dvl.Renderer.GetIsolatedNode(this._dvlRendererId);}else{return sap.ve.dvl.DVLID_INVALID;}};e.prototype.hitTest=function(x,y){if(this._dvlRendererId){var f=this._dvl.Renderer.HitTest(x*window.devicePixelRatio,y*window.devicePixelRatio,this._dvlRendererId).id;this.setShouldRenderFrame();return f;}else{return null;}};e.prototype.setShowDebugInfo=function(f){this.setProperty("showDebugInfo",f,true);if(this._dvlRendererId){this._dvl.Renderer.SetOption(sap.ve.dvl.DVLRENDEROPTION.DVLRENDEROPTION_SHOW_DEBUG_INFO,f,this._dvlRendererId);}return this;};e.prototype._handleFrameFinished=function(f){if(f.rendererId===this._dvlRendererId){this.fireFrameRenderingFinished();}};e.prototype.beginGesture=function(x,y){if(this._dvlRendererId){this._gesturePoint={x:x,y:y};this._dvl.Renderer.BeginGesture(x*window.devicePixelRatio,y*window.devicePixelRatio,this._dvlRendererId);}return this;};e.prototype.endGesture=function(){if(this._dvlRendererId){this._dvl.Renderer.EndGesture(this._dvlRendererId);}return this;};e.prototype._activateRedline=function(){this.renderFrame();var m=this._dvl.Renderer.GetCameraMatrices();this._matView=m.view;this._matProj=m.projection;};e.prototype._deactivateRedline=function(){this._matView=null;this._matProj=null;};e.prototype.pan=function(f,i){if(this._dvlRendererId&&!this.getFreezeCamera()){if(this._matProj){var j=this.getDomRef();this._matProj[8]-=f*2/j.clientWidth;this._matProj[9]+=i*2/j.clientHeight;this.setShouldRenderFrame();}else{this._dvl.Renderer.Pan(f*window.devicePixelRatio,i*window.devicePixelRatio,this._dvlRendererId);}this.firePan({dx:f,dy:i});}return this;};e.prototype.rotate=function(f,i){if(this._dvlRendererId&&!this.getFreezeCamera()){this._dvl.Renderer.Rotate(f*window.devicePixelRatio,i*window.devicePixelRatio,this._dvlRendererId);this.fireRotate({dx:f,dy:i});}return this;};function r(f){var m=f;var i=m[15]===1;var j=2/m[0];var x=2/m[5];var y,z;if(i){y=-m[12]*j;z=-m[13]*x;}else{y=m[8]*j;z=m[9]*x;}var A=(j+y)*0.5;var B=y-A;var D=(x+z)*0.5;var E=z-D;return{left:B,top:D,right:A,bottom:E};}function t(f,i){var m=f;var j=m[15]===1;m[0]=2/(i.right-i.left);m[5]=2/(i.top-i.bottom);if(j){m[12]=-(i.right+i.left)/(i.right-i.left);m[13]=-(i.top+i.bottom)/(i.top-i.bottom);}else{m[8]=(i.right+i.left)/(i.right-i.left);m[9]=(i.top+i.bottom)/(i.top-i.bottom);}}e.prototype.zoom=function(i){if(this._dvlRendererId&&!this.getFreezeCamera()){if(this._matProj){var j=this.getDomRef();var m=r(this._matProj);var x=m.left+(m.right-m.left)*this._gesturePoint.x/j.clientWidth;var y=m.top+(m.bottom-m.top)*this._gesturePoint.y/j.clientHeight;var f=1/i;m.left=x+(m.left-x)*f;m.right=x+(m.right-x)*f;m.top=y+(m.top-y)*f;m.bottom=y+(m.bottom-y)*f;t(this._matProj,m);this.setShouldRenderFrame();}else{this._dvl.Renderer.Zoom(i,this._dvlRendererId);}this.fireZoom({zoomFactor:i});}return this;};e.prototype.zoomTo=function(f,j,m,x){if(this._dvlRendererId){var y=0;if(Array.isArray(f)){for(var i in f){y|=d.decodedZoomTo[f[i]];}}else{y=d.decodedZoomTo[f];}this._dvl.Renderer.ZoomTo(y,j,m,x,this._dvlRendererId);}return this;};e.prototype.tap=function(x,y,i){if(this._dvlRendererId){var f=x*window.devicePixelRatio,j=y*window.devicePixelRatio;if(!i){var m=this.hitTest(x,y);var z={picked:m===sap.ve.dvl.DVLID_INVALID||m==null?[]:[m]};this.fireNodesPicked(z);if(this.getSelectionMode()===sap.ui.vk.SelectionMode.Exclusive){this.exclusiveSelectionHandler(z.picked);}else if(this.getSelectionMode()===sap.ui.vk.SelectionMode.Sticky){this.stickySelectionHandler(z.picked);}if(m!==sap.ve.dvl.DVLID_INVALID){this.fireNodeClicked({nodeRef:m,nodeId:m,x:x,y:y},true,true);}this._dvl.Renderer.Tap(f,j,false,false,this._dvlRendererId);}else if(!this.getFreezeCamera()){this._dvl.Renderer.Tap(f,j,true,false,this._dvlRendererId);}}return this;};e.prototype.rectSelect=function(x,y,f,i){var j=[];if(this._dvlRendererId){var m=sap.ui.vk.dvl.getJSONObject(this._dvl.Renderer.RectSelect(x,y,f,i,this._dvlRendererId));if(m.SelectedNodes){j=m.SelectedNodes;}}return j;};e.prototype.queueCommand=function(f){if(this._dvlRendererId){this._dvl.Renderer._queueCommand(f,this._dvlRendererId);}return this;};e.prototype._setContent=function(f){var i=null;if(f&&f instanceof sap.ui.vk.dvl.Scene){i=f;}this._setScene(i);};e.prototype._onAfterUpdateContentConnector=function(){this._setContent(this._contentConnector.getContent());};e.prototype._onBeforeClearContentConnector=function(){this._setScene(null);};e.prototype._handleContentReplaced=function(f){var i=f.getParameter("newContent");this._setContent(i);};e.prototype._setScene=function(f){var i=f&&f.getGraphicsCore();this.setGraphicsCore(i);this.setScene(f);if(f&&(this._isSmart2DContent()||this._isSmart2DContentLegacy())){this._initializeSmart2DHandler();}};e.prototype._handleContentChangesFinished=function(f){if(f.getSource().getContentResources().length>1){this.zoomTo(sap.ui.vk.ZoomTo.Visible,sap.ve.dvl.DVLID_INVALID,0,0);}this.setShouldRenderFrame();};e.prototype._onAfterUpdateViewStateManager=function(){if(this._dvl){this._dvl.Renderer.SetViewStateManager(this._viewStateManager,this._dvlRendererId);}};e.prototype._onBeforeClearViewStateManager=function(){if(this._dvl){this._dvl.Renderer.SetViewStateManager(null,this._dvlRendererId);}};var u={x:-2,y:-2};var v=2;var w=5;[{key:"left",dx:-v,dy:0},{key:"right",dx:+v,dy:0},{key:"up",dx:0,dy:-v},{key:"down",dx:0,dy:+v}].forEach(function(i){e.prototype["onsap"+i.key]=function(f){this.beginGesture(u.x,u.y);this.rotate(i.dx,i.dy);this.endGesture();this.setShouldRenderFrame();f.preventDefault();f.stopPropagation();};});[{key:"left",dx:-w,dy:0},{key:"right",dx:+w,dy:0},{key:"up",dx:0,dy:-w},{key:"down",dx:0,dy:+w}].forEach(function(i){e.prototype["onsap"+i.key+"modifiers"]=function(f){if(f.shiftKey&&!(f.ctrlKey||f.altKey||f.metaKey)){this.beginGesture(u.x,u.y);this.pan(i.dx,i.dy);this.endGesture();this.setShouldRenderFrame();f.preventDefault();f.stopPropagation();}};});[{key:"minus",d:0.98},{key:"plus",d:1.02}].forEach(function(i){e.prototype["onsap"+i.key]=function(f){this.beginGesture(this.$().width()/2,this.$().height()/2);this.zoom(i.d);this.endGesture();this.setShouldRenderFrame();f.preventDefault();f.stopPropagation();};});C.injectMethodsIntoClass(e);b.injectMethodsIntoClass(e);return e;});
