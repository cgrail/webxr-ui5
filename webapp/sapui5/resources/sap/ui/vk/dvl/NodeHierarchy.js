/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["jquery.sap.global","../library","../NodeHierarchy","sap/ui/base/ObjectPool","./BaseNodeProxy","./NodeProxy","./LayerProxy","../Messages","../DvlException"],function(q,l,N,O,B,a,L,M,D){"use strict";var g=sap.ui.vk.dvl.getJSONObject;var b=q.sap.log;var s={modeDictionary:{equals:function(i){return i?sap.ve.dvl.DVLFINDNODEMODE.DVLFINDNODEMODE_EQUAL:sap.ve.dvl.DVLFINDNODEMODE.DVLFINDNODEMODE_EQUAL_CASE_INSENSITIVE;},contains:function(i){return i?sap.ve.dvl.DVLFINDNODEMODE.DVLFINDNODEMODE_SUBSTRING:sap.ve.dvl.DVLFINDNODEMODE.DVLFINDNODEMODE_SUBSTRING_CASE_INSENSITIVE;},startsWith:function(i){return i?sap.ve.dvl.DVLFINDNODEMODE.DVLFINDNODEMODE_STARTS_WITH:sap.ve.dvl.DVLFINDNODEMODE.DVLFINDNODEMODE_STARTS_WITH_CASE_INSENSITIVE;}}};var c=N.extend("sap.ui.vk.dvl.NodeHierarchy",{metadata:{},_baseNodeProxyPool:new O(B),constructor:function(d){N.call(this);this._graphicsCore=d.getGraphicsCore();this._scene=d;this._dvlSceneRef=this._scene.getSceneRef();this._dvl=this._graphicsCore._getDvl();this._nodeProxies=[];this._layerProxies=[];}});c.prototype.destroy=function(){this._layerProxies.slice().forEach(this.destroyLayerProxy,this);this._nodeProxies.slice().forEach(this.destroyNodeProxy,this);this._dvl=null;this._dvlSceneRef=null;this._scene=null;this._graphicsCore=null;N.prototype.destroy.call(this);};c.prototype.getGraphicsCore=function(){return this._graphicsCore;};c.prototype.getScene=function(){return this._scene;};c.prototype.getSceneRef=function(){return this._dvlSceneRef;};c.prototype.enumerateChildren=function(n,d,e,p){if(typeof n==="function"){p=e;e=d;d=n;n=undefined;}var f;if(n){if(e||(g(this._dvl.Scene.RetrieveNodeInfo(this._dvlSceneRef,n,sap.ve.dvl.DVLNODEINFO.DVLNODEINFO_FLAGS)).Flags&sap.ve.dvl.DVLNODEFLAG.DVLNODEFLAG_CLOSED)===0){f=g(this._dvl.Scene.RetrieveNodeInfo(this._dvlSceneRef,n,sap.ve.dvl.DVLNODEINFO.DVLNODEINFO_CHILDREN)).ChildNodes;}else{f=[];}}else{f=g(this._dvl.Scene.RetrieveSceneInfo(this._dvlSceneRef,sap.ve.dvl.DVLSCENEINFO.DVLSCENEINFO_CHILDREN)).ChildNodes;}if(p){f.forEach(d);}else{var h=this._baseNodeProxyPool.borrowObject();try{f.forEach(function(n){h.init(this,n);d(h);h.reset();}.bind(this));}finally{this._baseNodeProxyPool.returnObject(h);}}return this;};c.prototype.enumerateAncestors=function(n,d,p){var e=g(this._dvl.Scene.RetrieveNodeInfo(this._dvlSceneRef,n,sap.ve.dvl.DVLNODEINFO.DVLNODEINFO_PARENTS)).ParentNodes;if(p){e.forEach(d);}else{var f=this._baseNodeProxyPool.borrowObject();try{e.forEach(function(n){f.init(this,n);d(f);f.reset();}.bind(this));}finally{this._baseNodeProxyPool.returnObject(f);}}return this;};c.prototype.createNodeProxy=function(n){var d=new a(this,n);this._nodeProxies.push(d);return d;};c.prototype.destroyNodeProxy=function(n){var i=this._nodeProxies.indexOf(n);if(i>=0){this._nodeProxies.splice(i,1)[0].destroy();}return this;};c.prototype.getChildren=function(n,d){if(typeof n==="boolean"){d=n;n=undefined;}if(n){if(d||(g(this._dvl.Scene.RetrieveNodeInfo(this._dvlSceneRef,n,sap.ve.dvl.DVLNODEINFO.DVLNODEINFO_FLAGS)).Flags&sap.ve.dvl.DVLNODEFLAG.DVLNODEFLAG_CLOSED)===0){return g(this._dvl.Scene.RetrieveNodeInfo(this._dvlSceneRef,n,sap.ve.dvl.DVLNODEINFO.DVLNODEINFO_CHILDREN)).ChildNodes;}else{return[];}}else{return g(this._dvl.Scene.RetrieveSceneInfo(this._dvlSceneRef,sap.ve.dvl.DVLSCENEINFO.DVLSCENEINFO_CHILDREN)).ChildNodes;}};c.prototype.getAncestors=function(n){return g(this._dvl.Scene.RetrieveNodeInfo(this._dvlSceneRef,n,sap.ve.dvl.DVLNODEINFO.DVLNODEINFO_PARENTS)).ParentNodes;};c.prototype.findNodesByName=function(d){var e=sap.ve.dvl.DVLFINDNODETYPE.DVLFINDNODETYPE_NODE_NAME,f=[],h,j;if(d===undefined||d===null||q.isEmptyObject(d)){h=s.modeDictionary.contains(false);j=[""];}else{if(d.value===undefined||d.value===null||d.value===""){q.sap.log.error(sap.ui.vk.getResourceBundle().getText(M.VIT6.summary),M.VIT6.code,"sap.ui.vk.dvl.NodeHierarchy");return[];}var p=d.hasOwnProperty("predicate")?d.predicate:"equals";if(p===undefined||p===null||p===""){q.sap.log.error(sap.ui.vk.getResourceBundle().getText(M.VIT7.summary),M.VIT7.code,"sap.ui.vk.dvl.NodeHierarchy");return[];}else if(["equals","contains","startsWith"].indexOf(p)===-1){q.sap.log.error(sap.ui.vk.getResourceBundle().getText(M.VIT8.summary),M.VIT8.code,"sap.ui.vk.dvl.NodeHierarchy");return[];}h=s.modeDictionary[p](d.caseSensitive);j=(typeof d.value==="string")?[d.value]:d.value;}for(var i=0;i<j.length;i++){f=f.concat(g(this._dvl.Scene.FindNodes(this._dvlSceneRef,e,h,j[i])).nodes);}return q.sap.unique(f);};c.prototype.createLayerProxy=function(d){var e=new L(this,d);this._layerProxies.push(e);return e;};c.prototype.destroyLayerProxy=function(d){var i=this._layerProxies.indexOf(d);if(i>=0){this._layerProxies.splice(i,1)[0].destroy();}return this;};c.prototype.getLayers=function(){return g(this._dvl.Scene.RetrieveSceneInfo(this._dvlSceneRef,sap.ve.dvl.DVLSCENEINFO.DVLSCENEINFO_LAYERS)).Layers;};c.prototype.getHotspotNodeIds=function(){var h=g(this._dvl.Scene.RetrieveSceneInfo(this._dvlSceneRef,sap.ve.dvl.DVLSCENEINFO.DVLSCENEINFO_HOTSPOTS).ChildNodes);return h.length>0?h:this._getLegacyHotspotNodeIds();};c.prototype._getLegacyHotspotNodeIds=function(){var d=this.getLayers(),h=[];for(var i=0;i<d.length;i++){var e=this.createLayerProxy(d[i]),f=e.getName();if(f.toLowerCase()==="hotspots"){h=e.getNodes();this.destroyLayerProxy(e);break;}this.destroyLayerProxy(e);}return h;};c.prototype.createNode=function(p,n,i){var d=this._dvl.Scene.CreateNode(this._dvlSceneRef,p,n,i);this.fireNodeCreated({nodeRef:d,nodeId:d});this.fireChanged();return d;};c.prototype.createNodeCopy=function(n,p,d,i){var e=this._dvl.Scene.CreateNodeCopy(this._dvlSceneRef,n,p,sap.ve.dvl.DVLCREATENODECOPYFLAG.COPY_CHILDREN,d,i);this.fireNodeCreated({nodeRef:e,nodeId:e});this.fireChanged();return e;};c.prototype.removeNode=function(n){var d=[].concat(n);d.forEach(function(n){this.fireNodeRemoving({nodeRef:n,nodeId:n});try{sap.ui.vk.dvl.checkResult(this._dvl.Scene.DeleteNode(this._dvlSceneRef,n));}catch(e){var m="Failed to delete node with ID = "+n+".";if(e instanceof D){m+=" Error code: "+e.code+". Message: "+e.message+".";}b.error(m);}}.bind(this));this.fireChanged();return this;};return c;});
