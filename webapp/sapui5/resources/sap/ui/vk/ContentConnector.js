/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["jquery.sap.global","sap/ui/base/ManagedObjectObserver","sap/ui/core/Element","./Messages","./Core"],function(q,M,E,a,V){"use strict";var l=q.sap.log;var C=E.extend("sap.ui.vk.ContentConnector",{metadata:{library:"sap.ui.vk",aggregations:{contentResources:{type:"sap.ui.vk.ContentResource",bindable:"bindable"},viewStateManagers:{type:"sap.ui.vk.ViewStateManager"},contentManagers:{type:"sap.ui.vk.ContentManager",visibility:"hidden"}},defaultAggregation:"contentResources",events:{contentChangesStarted:{parameters:{}},contentChangesFinished:{parameters:{content:{type:"any"},failureReason:{type:"any"}}},contentChangesProgress:{parameters:{phase:{type:"string"},percentage:{type:"float"},source:{type:"any"}}},contentReplaced:{parameters:{newContent:{type:"any"},oldContent:{type:"any"}}},contentDestroying:{parameters:{content:{type:"any"},preventGarbageCollection:{type:"function"}}}}}});sap.ui.vk.getCore().registerClass(C);var b=C.getMetadata().getParent().getClass().prototype;C.prototype.isTreeBinding=function(n){return n==="contentResources";};C.prototype.init=function(){if(b.init){b.init.call(this);}this._inLoading=false;this._delayContentResourcesUpdate=false;this._scheduleContentResourcesUpdateTimerId=null;this._content=null;this._contentManager=null;this._decryptionHandler=null;this._authorizationHandler=null;this._selfObserver=new M(this._observeChanges.bind(this));this._selfObserver.observe(this,{aggregations:["contentResources","viewStateManagers"]});};C.prototype.exit=function(){this._selfObserver.disconnect();this._selfObserver=null;if(this._scheduleContentResourcesUpdateTimerId){q.sap.clearDelayedCall(this._scheduleContentResourcesUpdateTimerId);this._scheduleContentResourcesUpdateTimerId=null;}this._delayContentResourcesUpdate=false;this._setContent(null,null);if(b.exit){b.exit.call(this);}};C.prototype._observeChanges=function(d){if(d.name==="contentResources"){this._scheduleContentResourcesUpdate();}else if(d.name==="viewStateManagers"){if(d.mutation==="insert"){d.child.setContentConnector(this);}else if(d.mutation==="remove"){d.child.setContentConnector(null);}}};C.prototype.invalidate=function(o){if(sap.ui.vk.ContentResource&&o instanceof sap.ui.vk.ContentResource){this._scheduleContentResourcesUpdate();return;}b.invalidate.apply(this,arguments);};C.prototype._scheduleContentResourcesUpdate=function(){if(this._inLoading){this._delayContentResourcesUpdate=true;return this;}if(!this._scheduleContentResourcesUpdateTimerId){this._scheduleContentResourcesUpdateTimerId=q.sap.delayedCall(0,this,function(){this._scheduleContentResourcesUpdateTimerId=null;var d=this.getContentResources();if(d.length>0){this._collectContentResourceSourceTypeInformation(d).then(function(i){if(i.dimensions.length>1){q.sap.delayedCall(0,this,function(){this.fireContentChangesStarted();this._setContent(null,null);this.fireContentChangesFinished({content:null,failureReason:{errorMessage:sap.ui.vk.getResourceBundle().getText(a.VIT17.cause)}});l.error(sap.ui.vk.getResourceBundle().getText(a.VIT17.summary),a.VIT17.code,"sap.ui.vk.ContentConnector");});}else if(i.contentManagerClassNames.length>1){q.sap.delayedCall(0,this,function(){this.fireContentChangesStarted();this._setContent(null,null);this.fireContentChangesFinished({content:null,failureReason:{errorMessage:sap.ui.vk.getResourceBundle().getText(a.VIT35.cause)}});l.error(sap.ui.vk.getResourceBundle().getText(a.VIT35.summary),a.VIT35.code,"sap.ui.vk.ContentConnector");});}else if(i.contentManagerClassNames.length===0){q.sap.delayedCall(0,this,function(){this.fireContentChangesStarted();this._setContent(null,null);this.fireContentChangesFinished({content:null,failureReason:{errorMessage:sap.ui.vk.getResourceBundle().getText(a.VIT36.cause)}});l.error(sap.ui.vk.getResourceBundle().getText(a.VIT36.summary),a.VIT36.code,"sap.ui.vk.ContentConnector");});}else if(i.contentManagerClassNames.length===1){var e=this._getContentManagerByClassName(i.contentManagerClassNames[0]);if(e!==this._contentManager){this._setContent(null,null);}e.loadContent(this._content,d);}}.bind(this));}else{q.sap.delayedCall(0,this,function(){this.fireContentChangesStarted();this._setContent(null,null);this.fireContentChangesFinished({content:null});});}});}return this;};C.prototype._handleContentChangesStarted=function(e){this._inLoading=true;this.fireContentChangesStarted();};C.prototype._handleContentChangesFinished=function(e){var d=e.getParameter("content");this._setContent(d,e.getSource());this.fireContentChangesFinished({content:d,failureReason:e.getParameter("failureReason")});this._inLoading=false;if(this._delayContentResourcesUpdate){this._delayContentResourcesUpdate=false;this._scheduleContentResourcesUpdate();}};C.prototype._handleContentChangesProgress=function(e){this.fireContentChangesProgress({phase:e.getParameter("phase"),source:e.getParameter("source"),percentage:e.getParameter("percentage")});};C.prototype._getContentManagerByClassName=function(d){var e,g=this.getAggregation("contentManagers",[]);for(var i=0,h=g.length;i<h;++i){e=g[i];if(e.getMetadata().getName()===d){return e;}}q.sap.require(d);e=new(q.sap.getObject(d));this.addAggregation("contentManagers",e);e.attachContentChangesStarted(this._handleContentChangesStarted,this);e.attachContentChangesFinished(this._handleContentChangesFinished,this);e.attachContentChangesProgress(this._handleContentChangesProgress,this);this._assignDecryptionHandler([e]);this._assignAuthorizationHandler([e]);return e;};C.prototype.getContent=function(){return this._content;};C.prototype.getContentManager=function(){return this._contentManager;};C.prototype._assignDecryptionHandler=function(d){for(var i=0;i<d.length;i++){d[i].setDecryptionHandler(this._decryptionHandler);}};C.prototype._assignAuthorizationHandler=function(d){for(var i=0;i<d.length;i++){d[i].setAuthorizationHandler(this._authorizationHandler);}};C.prototype.setDecryptionHandler=function(h){this._decryptionHandler=h;this._assignDecryptionHandler(this.getAggregation("contentManagers",[]));return this;};C.prototype.setAuthorizationHandler=function(h){this._authorizationHandler=h;this._assignAuthorizationHandler(this.getAggregation("contentManagers",[]));return this;};C.prototype._setContent=function(n,d){var o=this._content,e=this._contentManager;if(o!==n){this._content=n;this._contentManager=d;this.fireContentReplaced({oldContent:o,newContent:n});if(o){var p=false;this.fireContentDestroying({content:o,preventGarbageCollection:function(v){p=v;}});e.destroyContent(o);if(!p){e.collectGarbage();}}}return this;};var r=[{pattern:/(^threejs[:.])|(^(threejs|stream)$)/,dimension:3,contentManagerClassName:"sap.ui.vk.threejs.ContentManager"},{pattern:/^vdsl?$/,dimension:3,contentManagerClassName:"sap.ui.vk.dvl.ContentManager"},{pattern:/^(png|jpg|jpeg|gif|bmp|tiff?|svg)$/,dimension:2,contentManagerClassName:"sap.ui.vk.ImageContentManager"},{pattern:"cgm",dimension:2,contentManagerClassName:"sap.ui.vk.dvl.ContentManager"}];var c=function(d){return new Promise(function(e,g){var h=r.slice();var t=function(i){if(i>=h.length){g();return;}var j=h[i];(function(){var s=d.getSourceType();if(s){s=s.toLowerCase();}if(typeof j==="function"){return j(d);}else if(typeof j.pattern==="string"){var p=j.pattern.toLowerCase();if(p===s){return Promise.resolve(j);}}else if(j.pattern instanceof RegExp){if(j.pattern.test(s)){return Promise.resolve(j);}}return Promise.reject();})().then(function(v){e({dimension:v.dimension,contentManagerClassName:v.contentManagerClassName,settings:v.settings});},function(){t(i+1);});};t(0);});};C.addContentManagerResolver=function(d){if(typeof d==="function"){r.unshift(d);}else{r.unshift({pattern:d.pattern,dimension:d.dimension,contentManagerClassName:d.contentManagerClassName,settings:d.settings});}return this;};C.removeAllContentManagerResolvers=function(){r=[];return this;};C.removeContentManagerResolver=function(d){var e=typeof d==="function",g=typeof d==="string",h=d instanceof RegExp;for(var i=0,j=r.length;i<j;++i){if(e||g){if(r[i]===d){r.splice(i,1);return true;}}else if(h){if(typeof r[i]==="object"&&r[i].pattern instanceof RegExp&&r[i].pattern.source===d.source){r.splice(i,1);return true;}}}return false;};C.prototype._collectContentResourceSourceTypeInformation=function(d){var n=false,u=false,e={},g={},h=[];d.forEach(function flatten(i){h.push(i);i.getContentResources().forEach(flatten);});return Promise.all(h.map(function(i){return c(i).then(function(j){e[j.dimension]=true;g[j.contentManagerClassName]=true;return j;},function(){if(i.getSourceType()){u=true;}else{n=true;}return false;});})).then(function(j){for(var i=0,k=h.length;i<k;++i){if(j[i]){h[i]._contentManagerResolver=j[i];}}return{noSourceTypes:n,unknownSourceTypes:u,dimensions:Object.getOwnPropertyNames(e).sort(),contentManagerClassNames:Object.getOwnPropertyNames(g)};});};var f=C.getMetadata().getName();var m={init:function(){this._contentConnector=null;sap.ui.vk.getCore().attachEvent(f+"-created",this._handleContentConnectorCreated,this).attachEvent(f+"-destroying",this._handleContentConnectorDestroying,this);},exit:function(){this.setContentConnector(null);sap.ui.vk.getCore().detachEvent(f+"-destroying",this._handleContentConnectorDestroying,this).detachEvent(f+"-created",this._handleContentConnectorCreated,this);},setContentConnector:function(d){this.setAssociation("contentConnector",d,true);this._updateContentConnector();return this;},_updateContentConnector:function(){var n=this.getContentConnector(),d=n&&sap.ui.getCore().byId(n)||null;if(this._contentConnector!==d){this._clearContentConnector();if(d){if(this._handleContentChangesStarted){d.attachContentChangesStarted(this._handleContentChangesStarted,this);}if(this._handleContentChangesFinished){d.attachContentChangesFinished(this._handleContentChangesFinished,this);}if(this._handleContentChangesProgress){d.attachContentChangesProgress(this._handleContentChangesProgress,this);}if(this._handleContentReplaced){d.attachContentReplaced(this._handleContentReplaced,this);}if(this._handleContentDestroying){d.attachContentDestroying(this._handleContentDestroying,this);}this._contentConnector=d;if(this._onAfterUpdateContentConnector){this._onAfterUpdateContentConnector();}}}return this;},_clearContentConnector:function(){if(this._contentConnector){if(this._onBeforeClearContentConnector){this._onBeforeClearContentConnector();}if(this._handleContentDestroying){this._contentConnector.detachContentDestroying(this._handleContentDestroying,this);}if(this._handleContentReplaced){this._contentConnector.detachContentReplaced(this._handleContentReplaced,this);}if(this._handleContentChangesProgress){this._contentConnector.detachContentChangesProgress(this._handleContentChangesProgress,this);}if(this._handleContentChangesFinished){this._contentConnector.detachContentChangesFinished(this._handleContentChangesFinished,this);}if(this._handleContentChangesStarted){this._contentConnector.detachContentChangesStarted(this._handleContentChangesStarted,this);}this._contentConnector=null;}return this;},_handleContentConnectorCreated:function(e){if(this.getContentConnector()===e.getParameter("object").getId()){this._updateContentConnector();}},_handleContentConnectorDestroying:function(e){if(this.getContentConnector()===e.getParameter("object").getId()){this._clearContentConnector();}}};C.injectMethodsIntoClass=function(d){var p=d.prototype,i=p.init,e=p.exit;p.init=function(){if(i){i.call(this);}m.init.call(this);};p.exit=function(){m.exit.call(this);if(e){e.call(this);}};p.setContentConnector=m.setContentConnector;p._updateContentConnector=m._updateContentConnector;p._clearContentConnector=m._clearContentConnector;p._handleContentConnectorCreated=m._handleContentConnectorCreated;p._handleContentConnectorDestroying=m._handleContentConnectorDestroying;};return C;});
