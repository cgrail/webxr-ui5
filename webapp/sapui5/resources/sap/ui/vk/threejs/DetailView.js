/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["jquery.sap.global","../library","./thirdparty/three","sap/ui/base/ManagedObject","../ve/thirdparty/html2canvas"],function(q,c,t,B,d){"use strict";var D=B.extend("sap.ui.vk.threejs.DetailView",{metadata:{properties:{name:{type:"string",defaultValue:""},camera:{type:"any",defaultValue:null},type:{type:"sap.ui.vk.DetailViewType",defaultValue:sap.ui.vk.DetailViewType.DetailView},shape:{type:"sap.ui.vk.DetailViewShape",defaultValue:sap.ui.vk.DetailViewShape.Box},borderWidth:{type:"float",defaultValue:2},backgroundColor:{type:"sap.ui.core.CSSColor",defaultValue:"#fff"},borderColor:{type:"sap.ui.core.CSSColor",defaultValue:"#000"},renderOrder:{type:"int",defaultValue:0},origin:{type:"any",defaultValue:new THREE.Vector3(0,0)},size:{type:"any",defaultValue:new THREE.Vector3(0.5,0.5)},attachmentPoint:{type:"any",defaultValue:null},metadata:{type:"any",defaultValue:{}},veId:{type:"any",defaultValue:{}}}},constructor:function(i,S,a){this._backgroundColor=new THREE.Color();B.apply(this,arguments);var m=new THREE.MeshBasicMaterial({depthTest:false,depthWrite:false,transparent:true});this._billboard=new THREE.Mesh(new THREE.BufferGeometry(),m);var b=new THREE.MeshBasicMaterial({depthTest:false,depthWrite:false,transparent:true});this._border=new THREE.Mesh(new THREE.BufferGeometry(),b);this._line=new THREE.Mesh(new THREE.BufferGeometry(),b);var f=new THREE.BufferGeometry();f.setIndex([0,1,2]);var h=new THREE.MeshBasicMaterial({color:this._backgroundColor,depthTest:false,depthWrite:false,transparent:true});this._triangle=new THREE.Mesh(f,h);this._node=new THREE.Group();this._node.add(this._billboard);this._node.add(this._border);this._node.add(this._line);this._node.add(this._triangle);this._node.isDetailView=true;this._node.traverse(function(l){if(l.geometry!==undefined){l.geometry.boundingBox=new THREE.Box3();}l.matrixAutoUpdate=false;});this.setRenderOrder(this.getRenderOrder());}});D.prototype.setCamera=function(a){if(a instanceof sap.ui.vk.threejs.PerspectiveCamera||a instanceof sap.ui.vk.threejs.OrthographicCamera){this.setProperty("camera",a,true);}return this;};D.prototype.setShape=function(a){this.setProperty("shape",a,true);return this;};D.prototype.setBackgroundColor=function(a){this.setProperty("backgroundColor",a,true);this._backgroundColor.setStyle(a);if(this._triangle){this._triangle.material.color.copy(this._backgroundColor);}return this;};D.prototype.setBorderColor=function(a){this.setProperty("borderColor",a,true);if(this._border){this._border.material.map=null;}return this;};D.prototype.setBorderWidth=function(a){this.setProperty("borderWidth",a,true);if(this._border){this._border.material.map=null;}return this;};D.prototype.setOrigin=function(a){if(a instanceof THREE.Vector2){this.setProperty("origin",a,true);}return this;};D.prototype.setSize=function(a){if(a instanceof THREE.Vector2){this.setProperty("size",a,true);}return this;};D.prototype.setRenderOrder=function(a){this.setProperty("renderOrder",a,true);if(this._billboard){this._billboard.renderOrder=a;this._border.renderOrder=a+0.1;this._triangle.renderOrder=a-0.1;this._line.renderOrder=a-0.1;}return this;};var e=-0.5,g=1.5,p=new THREE.Vector4(),j=new THREE.Vector3(),k=new THREE.Vector3(),P=new THREE.Vector3(),n=new THREE.Vector2(),s=new THREE.Vector2(),o=new THREE.Vector2(),r=new THREE.Matrix4();function v(a,b){return Math.PI*(3*(a+b)-Math.sqrt((3*a+b)*(a+3*b)));}function z(a,b,h,i,l,m){var u=a[b],w=a[b+1],x=a[l],y=a[l+1],H=a[m],I=a[m+1],J=i-w,K=u-h;var f=((x-u)*J+(y-w)*K)/((x-H)*J+(y-I)*K);a[l]=x+(H-x)*f;a[l+1]=y+(I-y)*f;}function A(f,a,b,h){n.set(f[b+1]-f[a+1],f[a]-f[b]).normalize().multiplyScalar(h);f[a]+=n.x;f[a+1]+=n.y;f[b]+=n.x;f[b+1]+=n.y;}function C(a,b){var f=a.length;for(var h=0;h<6;h+=3){var l=h===0?b*e:b*g;var m=a[h],u=a[h+1];for(var i=h;i<f-6;i+=6){var w=a[i],x=a[i+1];a[i]=m;a[i+1]=u;m=a[i+6];u=a[i+7];A(a,i,i+6,l);if(i>h){z(a,i-6,w,x,i,i+6);}}}}D.prototype._createBoxViewport=function(a,b,f,h){var l=[-a,-b,0,a,-b,0,a,b,0,-a,b,0];var m=this._billboard.geometry;m.setIndex([0,1,2,0,2,3]);m.addAttribute("position",new THREE.Float32BufferAttribute(l,3));m.addAttribute("uv",new THREE.Float32BufferAttribute([0,0,1,0,1,1,0,1],2));if(this._border.visible){var u=[],i;for(i=0;i<l.length;i+=3){var x=l[i],y=l[i+1];u.push(x,y,0,x,y,0);}u.push(u[0],u[1],0,u[0],u[1],0);C(u,this._borderWidth);i=u.length-6;u[0]=u[i];u[i+1]=u[1];u[3]=u[i+3];u[i+4]=u[4];this._createBorderGeometry(this._border.geometry,u);}};D.prototype._createCircleViewport=function(b,f,h,l){var m=[0,0,0],u=[0.5,0.5],w=[];var x=THREE.Math.clamp(Math.round(v(b,f)/24),32,256);var y=2*Math.PI/x;for(var i=0;i<x;i++){var a=i*y,H=Math.cos(a),I=Math.sin(a);m.push(H*b,I*f,0);u.push(H*0.5+0.5,I*0.5+0.5);w.push(0,i+1,i+1<x?i+2:1);}var J=this._billboard.geometry;J.setIndex(w);J.addAttribute("position",new THREE.Float32BufferAttribute(m,3));J.addAttribute("uv",new THREE.Float32BufferAttribute(u,2));var K=this._borderWidth*g;this._createCircleBorder(m,b,f,h&&n.set(h.x/(b+K),h.y/(f+K)).length()>1?h:null,l);};D.prototype._createCircleBorder=function(b,f,h,m,u){var w=this._borderWidth,H=[],i,x,y;if(m&&(u!==sap.ui.vk.DetailViewShape.Circle&&u!==sap.ui.vk.DetailViewShape.CircleLine)){H.push(m.x,m.y,0,m.x,m.y,0);var I=Math.PI*0.05;var J=Math.atan2(m.y*f,m.x*h)+I;var K=(b.length/3)-3;I=2*(Math.PI-I)/K;for(i=0;i<=K;i++){var a=J+i*I;x=Math.cos(a)*f;y=Math.sin(a)*h;H.push(x,y,0,x,y,0);}var L=[m.x,m.y,0,H[6],H[7],0,H[H.length-3],H[H.length-2],0];H.push(m.x,m.y,0,m.x,m.y,0);C(H,w);i=H.length-6;var M=n.set(H[9],H[10]).sub(m).length();var N=n.set(H[9]-H[i-3],H[10]-H[i-2]).length()*0.5;var l=m.length();l=1-w*2*M/(N*l);H[i+0]=H[0]=m.x*l;H[i+1]=H[1]=m.y*l;H[i+3]=H[3]=m.x;H[i+4]=H[4]=m.y;var O=this._triangle.geometry;l=(1+l)*0.5;L[0]*=l;L[1]*=l;O.addAttribute("position",new THREE.Float32BufferAttribute(L,3));this._triangle.visible=true;this._triangle.material.color.set(u===sap.ui.vk.DetailViewShape.SolidPointer||u===sap.ui.vk.DetailViewShape.SolidArrow?this.getBorderColor():this._backgroundColor);}else{this._line.visible=this._line.visible&&m!==null;for(i=3;i<b.length;i+=3){x=b[i];y=b[i+1];H.push(x,y,0,x,y,0);}H.push(H[0],H[1],0,H[0],H[1],0);C(H,w);i=H.length-6;H[i]=H[0]=b[3]+w*e;H[i+3]=H[3]=b[3]+w*g;H[i+1]=H[1]=b[4];H[i+4]=H[4]=b[4];}this._createBorderGeometry(this._border.geometry,H);};D.prototype._createBorderGeometry=function(a,b){var i,f=b.length/3;var h=[];for(i=2;i<f;i+=2){h.push(i-2,i,i-1,i-1,i,i+1);}var l=[];var u=this._borderU;for(i=0;i<f;i+=2){l.push(0,0.5,u,0.5);}a.setIndex(h);a.addAttribute("position",new THREE.Float32BufferAttribute(b,3));a.addAttribute("uv",new THREE.Float32BufferAttribute(l,2));};D.prototype._createLine=function(a){var b=[0,0,0,0,0,0,a.x,a.y,0,a.x,a.y,0];A(b,0,6,-this._borderWidth);A(b,3,9,this._borderWidth);this._createBorderGeometry(this._line.geometry,b);};D.prototype._updateGeometry=function(s,a,b){var f=this.getShape(),h=this.getAttachmentPoint(),i=this.getOrigin();this._border.visible=f!==sap.ui.vk.DetailViewShape.BoxNoOutline;this._line.visible=f===sap.ui.vk.DetailViewShape.BoxLine||f===sap.ui.vk.DetailViewShape.CircleLine;this._triangle.visible=false;if(h){p.copy(h).applyMatrix4(b.matrixWorldInverse).applyMatrix4(b.projectionMatrix);h=p.w>0?h:null;var l=(p.x/p.w)*a.width/a.height,m=p.y/p.w;P.set(l-i.x,m-i.y,0).multiplyScalar(a.height);}switch(f){default:case sap.ui.vk.DetailViewShape.Box:case sap.ui.vk.DetailViewShape.BoxLine:case sap.ui.vk.DetailViewShape.BoxNoOutline:this._createBoxViewport(s.x,s.y,h?P:null,f);break;case sap.ui.vk.DetailViewShape.Circle:case sap.ui.vk.DetailViewShape.CircleLine:case sap.ui.vk.DetailViewShape.CirclePointer:case sap.ui.vk.DetailViewShape.CircleArrow:case sap.ui.vk.DetailViewShape.CircleBubbles:case sap.ui.vk.DetailViewShape.SolidPointer:case sap.ui.vk.DetailViewShape.SolidArrow:this._createCircleViewport(s.x,s.y,h?P:null,f);break;}if(this._line.visible){this._createLine(P);}};D.prototype._updateBorderTexture=function(a){var b=Math.round(this.getBorderWidth()*a);this._borderWidth=b+2;var f=THREE.Math.ceilPowerOfTwo(this._borderWidth);this._borderU=this._borderWidth/f;this._borderWidth/=a;var h=new ArrayBuffer(f*4);var l=new Uint32Array(h);var m=new THREE.Color(this.getBorderColor());m=(m.r*255)|((m.g*255)<<8)|((m.b*255)<<16)|0xFF000000;l.fill(m&0xFFFFFF);for(var i=1;i<=b;i++){l[i]=m;}var u=new THREE.DataTexture(new Uint8Array(h),f,1,THREE.RGBAFormat,THREE.UnsignedByteType,THREE.UVMapping,THREE.ClampToEdgeWrapping,THREE.ClampToEdgeWrapping,THREE.LinearFilter,THREE.LinearFilter);u.needsUpdate=true;this._border.material.map=u;this._border.material.needsUpdate=true;this._line.material=this._border.material;};function E(a){var m=a.elements;var i=m[15]===1;var b=2/m[0];var f=2/m[5];var h,l;if(i){h=-m[12]*b;l=-m[13]*f;}else{h=m[8]*b;l=m[9]*f;}var u=(b+h)*0.5;var w=h-u;var x=(f+l)*0.5;var y=l-x;return{left:w,top:x,right:u,bottom:y};}function F(a,b){var m=a.elements;var i=m[15]===1;m[0]=2/(b.right-b.left);m[5]=2/(b.top-b.bottom);if(i){m[12]=-(b.right+b.left)/(b.right-b.left);m[13]=-(b.top+b.bottom)/(b.top-b.bottom);}else{m[8]=(b.right+b.left)/(b.right-b.left);m[9]=(b.top+b.bottom)/(b.top-b.bottom);}}function G(a,b,s,f){var w=s.x/f.width;var h=s.y/f.height;p.copy(b).applyMatrix4(a.matrixWorldInverse).applyMatrix4(a.projectionMatrix);var x=((p.x/p.w)-w)*0.5+0.5;var y=((p.y/p.w)-h)*0.5+0.5;var i=E(a.projectionMatrix);var l={};l.left=THREE.Math.lerp(i.left,i.right,x);l.right=THREE.Math.lerp(i.left,i.right,x+w);l.top=THREE.Math.lerp(i.top,i.bottom,1-y-h);l.bottom=THREE.Math.lerp(i.top,i.bottom,1-y);F(a.projectionMatrix,l);}D.prototype._update=function(a,b,f,h){var i=a.getSize(),l=a.getPixelRatio(),m=this.getOrigin(),u=this._node,w=u.position;if(!this._border.material.map){this._updateBorderTexture(l);}s.copy(this.getSize()).multiplyScalar(i.height*0.5);s.set(Math.round(s.x)<<1,Math.round(s.y)<<1);w.set(m.x*i.height/i.width,m.y,0).unproject(b);p.copy(w).applyMatrix4(b.matrixWorldInverse).applyMatrix4(b.projectionMatrix);var x=((p.x/p.w)*0.5+0.5)*i.width,y=((p.y/p.w)*0.5+0.5)*i.height;var H=p.w/(i.width*b.projectionMatrix.elements[0]);u.scale.setScalar(H);j.setFromMatrixColumn(b.matrixWorld,0).multiplyScalar(H*2*(Math.round(x)-x));k.setFromMatrixColumn(b.matrixWorld,1).multiplyScalar(H*2*(Math.round(y)-y));w.add(j).add(k);u.matrixWorld.compose(u.position,b.quaternion,u.scale);u.matrix.getInverse(u.parent.matrixWorld).multiply(u.matrixWorld);u.matrix.decompose(u.position,u.rotation,u.scale);this._updateGeometry(s,i,b);o.copy(s).multiplyScalar(l);if(!this._renderTarget||this._renderTarget.width!==o.x||this._renderTarget.height!==o.y){this._renderTarget=new THREE.WebGLRenderTarget(o.x,o.y,{minFilter:THREE.LinearFilter,magFilter:THREE.NearestFilter,format:THREE.RGBFormat});this._billboard.material.map=this._renderTarget.texture;this._billboard.material.needsUpdate=true;}if(this.getType()===sap.ui.vk.DetailViewType.Cutaway){r.copy(b.projectionMatrix);G(b,w,s,i);}else{b=this.getCamera();b.adjustClipPlanes(h);b.update(s.x,s.y);b=b.getCameraRef();}f.children.forEach(function(I){if(I.userData._vkCallouts){I.userData._vkCallouts.forEach(function(J){J._update(a,b);});}});a.setClearColor(this._backgroundColor,1);a.render(f,b,this._renderTarget,true);if(this.getType()===sap.ui.vk.DetailViewType.Cutaway){b.projectionMatrix.copy(r);}};return D;});
