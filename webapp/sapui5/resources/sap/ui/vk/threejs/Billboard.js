/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["jquery.sap.global","../library","./thirdparty/three","sap/ui/base/ManagedObject","../ve/thirdparty/html2canvas"],function(q,l,t,B,h){"use strict";var b=B.extend("sap.ui.vk.threejs.Billboard",{metadata:{properties:{text:{type:"string",defaultValue:"Annotation"},font:{type:"string",defaultValue:""},fontSize:{type:"float",defaultValue:20},fontWeight:{type:"string",defaultValue:"normal"},fontItalic:{type:"boolean",defaultValue:false},textColor:{type:"sap.ui.core.CSSColor",defaultValue:"#fff"},borderColor:{type:"sap.ui.core.CSSColor",defaultValue:"#fff"},borderOpacity:{type:"float",defaultValue:1},backgroundColor:{type:"sap.ui.core.CSSColor",defaultValue:"#fff"},backgroundOpacity:{type:"float",defaultValue:0.5},encoding:{type:"sap.ui.vk.BillboardTextEncoding",defaultValue:sap.ui.vk.BillboardTextEncoding.PlainText},width:{type:"float",defaultValue:100},height:{type:"float",defaultValue:100},style:{type:"sap.ui.vk.BillboardStyle",defaultValue:sap.ui.vk.BillboardStyle.None},borderLineStyle:{type:"sap.ui.vk.BillboardBorderLineStyle",defaultValue:sap.ui.vk.BillboardBorderLineStyle.Solid},borderWidth:{type:"float",defaultValue:2},horizontalAlignment:{type:"sap.ui.vk.BillboardHorizontalAlignment",defaultValue:sap.ui.vk.BillboardHorizontalAlignment.Left},texture:{type:"any",defaultValue:null},link:{type:"string",defaultValue:""},coordinateSpace:{type:"sap.ui.vk.BillboardCoordinateSpace",defaultValue:sap.ui.vk.BillboardCoordinateSpace.Viewport},position:{type:"any",defaultValue:new THREE.Vector3(0,0,0)},renderOrder:{type:"int",defaultValue:0}}},constructor:function(i,s,S){B.apply(this,arguments);var g=new THREE.BufferGeometry();g.setIndex([0,1,2,2,1,3]);g.addAttribute("position",new THREE.Float32BufferAttribute([-0.5,-0.5,0,0.5,-0.5,0,-0.5,0.5,0,0.5,0.5,0],3));g.addAttribute("normal",new THREE.Float32BufferAttribute([0,0,1,0,0,1,0,0,1,0,0,1],3));g.addAttribute("uv",new THREE.Float32BufferAttribute([0,0,1,0,0,1,1,1],2));var m=new THREE.MeshBasicMaterial({map:this.getTexture(),depthTest:false,depthWrite:false,transparent:true,alphaTest:0.05,premultipliedAlpha:true,side:THREE.DoubleSide});this._billboard=new THREE.Mesh(g,m);this._billboard.renderOrder=this.getRenderOrder();this._updateTexture();this._node=new THREE.Group();this._node.add(this._billboard);this._node.matrixAutoUpdate=false;this._node.isBillboard=true;this._node.userData.billboard=this;}});b.prototype.setEncoding=function(v){this.setProperty("encoding",v,true);this._updateTexture();return this;};b.prototype.setText=function(v){this.setProperty("text",v,true);this._updateTexture();return this;};b.prototype.setFont=function(v){this.setProperty("font",v,true);this._updateTexture();return this;};b.prototype.setFontSize=function(v){this.setProperty("fontSize",v,true);this._updateTexture();return this;};b.prototype.setFontWeight=function(v){this.setProperty("fontWeight",v,true);this._updateTexture();return this;};b.prototype.setFontItalic=function(v){this.setProperty("fontItalic",v,true);this._updateTexture();return this;};b.prototype.setStyle=function(v){this.setProperty("style",v,true);this._updateTexture();return this;};b.prototype.setWidth=function(v){this.setProperty("width",v,true);this._updateTexture();return this;};b.prototype.setHeight=function(v){this.setProperty("height",v,true);this._updateTexture();return this;};b.prototype.setTextColor=function(v){this.setProperty("textColor",v,true);this._updateTexture();return this;};b.prototype.setBackgroundColor=function(v){this.setProperty("backgroundColor",v,true);this._updateTexture();return this;};b.prototype.setBackgroundOpacity=function(v){this.setProperty("backgroundOpacity",v,true);this._updateTexture();return this;};b.prototype.setBorderWidth=function(v){this.setProperty("borderWidth",v,true);this._updateTexture();return this;};b.prototype.setBorderLineStyle=function(v){this.setProperty("borderLineStyle",v,true);this._updateTexture();return this;};b.prototype.setBorderColor=function(v){this.setProperty("borderColor",v,true);this._updateTexture();return this;};b.prototype.setBorderOpacity=function(v){this.setProperty("borderOpacity",v,true);this._updateTexture();return this;};b.prototype.setHorizontalAlignment=function(v){this.setProperty("horizontalAlignment",v,true);this._updateTexture();return this;};b.prototype.setLink=function(v){this.setProperty("link",v,true);this._updateTexture();return this;};b.prototype.setTexture=function(v){this.setProperty("texture",v,true);if(this._billboard){this._billboard.material.map=v;}return this;};b.prototype.setRenderOrder=function(v){this.setProperty("renderOrder",v,true);if(this._billboard){this._billboard.renderOrder=v;}return this;};b.prototype._renderBackground=function(a,w,e,f){a.fillStyle=this.getBackgroundColor();a.strokeStyle=this.getBorderColor();a.lineWidth=f;switch(this.getBorderLineStyle()){default:a.setLineDash([]);break;case sap.ui.vk.BillboardBorderLineStyle.Dash:a.setLineDash([f*5,f]);break;case sap.ui.vk.BillboardBorderLineStyle.Dot:a.setLineDash([f*2,f]);break;case sap.ui.vk.BillboardBorderLineStyle.DashDot:a.setLineDash([f*5,f,f*2,f]);break;case sap.ui.vk.BillboardBorderLineStyle.DashDotDot:a.setLineDash([f*5,f,f*2,f,f*2,f]);break;}var g=f/2;if(this.getStyle()===sap.ui.vk.BillboardStyle.RectangularShape){a.globalAlpha=this.getBackgroundOpacity();if(a.globalAlpha>0){a.fillRect(0,0,w,e);}a.globalAlpha=f>0?this.getBorderOpacity():0;if(a.globalAlpha>0){a.strokeRect(g,g,w-f,e-f);}}else if(this.getStyle()===sap.ui.vk.BillboardStyle.CircularShape){var x=w/2;var y=e/2;var r=w/2;a.beginPath();a.arc(x,y,r-g,0,2*Math.PI);a.closePath();a.globalAlpha=this.getBackgroundOpacity();if(a.globalAlpha>0){a.fill();}a.globalAlpha=f>0?this.getBorderOpacity():0;if(a.globalAlpha>0){a.stroke();}}a.globalAlpha=1;a.setLineDash([]);};b.prototype._getFont=function(a){return(this.getFontItalic()?"italic ":"")+this.getFontWeight()+" "+(this.getFontSize()*a)+"px "+(this.getFont()||"Arial");};b.prototype._renderPlainText=function(e){var f=document.createElement("canvas");var g=f.getContext("2d");var j=this.getFontSize()*e;var k=this._getFont(e);g.font=k;var m=Math.ceil(j);var n=this.getBorderLineStyle()!==sap.ui.vk.BillboardBorderLineStyle.None?this.getBorderWidth()*e:0;var o=Math.ceil(j*0.2+n);var r=this.getText().split("\n");var s=0;r.forEach(function(C){s=Math.max(s,g.measureText(C).width);});var u=this.getLink();if(u.length>0){s=Math.max(s,g.measureText(u).width);}s=Math.ceil(s*0.5)*2;var v=r.length+(u.length>0?1:0);var w=Math.ceil(m*v*0.5)*2;var z=s+o*2;var A=w+o*2;if(this.getStyle()===sap.ui.vk.BillboardStyle.CircularShape){z=A=Math.max(z,A);}this._width=z/e;this._height=A/e;f.width=THREE.Math.ceilPowerOfTwo(z);f.height=THREE.Math.ceilPowerOfTwo(A);this._renderBackground(g,z,A,n);g.font=k;g.textAlign=this.getHorizontalAlignment();g.textBaseline="middle";var a=["left","center","right"].indexOf(g.textAlign);var x=(z+s*(a-1))>>1;var y=(A-(v-1)*m)>>1;g.fillStyle=this.getTextColor();g.filter="blur(0px)";for(var i in r){g.fillText(r[i],x,y+m*i);}if(u.length>0){g.fillStyle="#00f";g.textAlign="right";g.textBaseline="bottom";g.fillText(u,z-o,A-o);}this._setBillboardTexture(f,z,A);};b.prototype._renderHtmlText=function(a){var e=document.createElement("canvas");var f=e.getContext("2d");var g=this.getBorderLineStyle()!==sap.ui.vk.BillboardBorderLineStyle.None?this.getBorderWidth()*a:0;var m=Math.ceil(g);var w=Math.ceil(this.getWidth()*a)+m*2;var i=Math.ceil(this.getHeight()*a)+m*2;if(this.getStyle()===sap.ui.vk.BillboardStyle.CircularShape){w=i=Math.max(w,i);}this._width=w/a;this._height=i/a;e.width=THREE.Math.ceilPowerOfTwo(w);e.height=THREE.Math.ceilPowerOfTwo(i);this._renderBackground(f,w,i,g);var j=this.getLink();if(j.length>0){f.font=this._getFont(a);f.fillStyle="#00f";f.textAlign="right";f.textBaseline="bottom";f.fillText(j,w-m,i-m);}var k=document.createElement("iframe");k.style.visibility="hidden";k.width=(w-m*2)/a;k.height=(i-m*2)/a;document.body.appendChild(k);var n=k.contentDocument||k.contentWindow.document;n.open();n.close();n.body.innerHTML=this.getText();var o=document.createElement("canvas");o.width=k.width*a;o.height=k.height*a;o.style.width=k.width+"px";o.style.height=k.height+"px";var r=o.getContext("2d");r.scale(a,a);this._billboard.material.visible=false;h(n.body,{canvas:o}).then(function(o){if(o.width>0&&o.height>0){e.getContext("2d").drawImage(o,m,m);}setTimeout(this._setBillboardTexture.bind(this,e,w,i),0);document.body.removeChild(k);}.bind(this));};b.prototype._setBillboardTexture=function(a,w,e){var u=w/a.width,v=e/a.height;this._billboard.geometry.addAttribute("uv",new THREE.Float32BufferAttribute([0,1-v,u,1-v,0,1,u,1],2));var f=new THREE.CanvasTexture(a);f.magFilter=THREE.NearestFilter;this._billboard.material.map=f;this._billboard.material.needsUpdate=true;this._billboard.material.visible=true;};b.prototype._updateTexture=function(){if(!this._billboard||this.getTexture()){this._width=this.getWidth();this._height=this.getHeight();return;}switch(this.getEncoding()){default:case sap.ui.vk.BillboardTextEncoding.PlainText:this._renderPlainText(window.devicePixelRatio);break;case sap.ui.vk.BillboardTextEncoding.HtmlText:this._renderHtmlText(window.devicePixelRatio);break;}};var p=new THREE.Vector4(),c=new THREE.Vector3(),d=new THREE.Vector3();b.prototype._update=function(r,a){this._node.matrix.getInverse(this._node.parent.matrixWorld);this._node.matrix.decompose(this._node.position,this._node.rotation,this._node.scale);this._node.matrixWorld.identity();this._billboard.rotation.copy(a.rotation);var v=r.getSize(),s=this.getPosition(),e=this._billboard.position,f=1;if(s){e.copy(s);}else{e.setScalar(0);}var g=this.getCoordinateSpace();if(g===sap.ui.vk.BillboardCoordinateSpace.Screen){e.multiplyScalar(2/a.projectionMatrix.elements[5]);e.z=-1;f=(a.near+a.far)*0.5;e.multiplyScalar(f).applyMatrix4(a.matrixWorld);}else if(g===sap.ui.vk.BillboardCoordinateSpace.Viewport){if(v.width>v.height){e.x*=v.height/v.width;}else{e.y*=v.width/v.height;}e.unproject(a);p.copy(e).applyMatrix4(a.matrixWorldInverse).applyMatrix4(a.projectionMatrix);var i=(p.x/p.w)*0.5*v.width,j=(p.y/p.w)*0.5*v.height;f=p.w*2/(v.width*a.projectionMatrix.elements[0]);c.setFromMatrixColumn(a.matrixWorld,0).multiplyScalar(f*(Math.round(i)-i));d.setFromMatrixColumn(a.matrixWorld,1).multiplyScalar(f*(Math.round(j)-j));e.add(c).add(d);}this._billboard.scale.set(this._width*f,this._height*f,1);this._billboard.updateMatrixWorld();};return b;});
