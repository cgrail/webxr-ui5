/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/base/Log"],function(L){"use strict";var S=function(b,c,e,i){this._id=S._nextId++;S.add(this);this._parentNode=b;this._contentResource=c;this._resolve=e;this._reject=i;this._nodes=new Map();this._meshes=new Map();this._callouts=new Map();this._cameras=new Map();this._detailViews=new Map();this._materials=new Map();this._images=new Map();this._viewportGroups=new Map();this._modelViews=new Map();this._modelViewThumbnails=new Map();this._animations=new Map();this._animationTracks=new Map();this._sequences=new Map();var l=this._parentNode;while(l.parent){l=l.parent;}if(!l.userData){l.userData={};}l.userData.animations=this._animations;l.userData.animationTracks=this._animationTracks;l.userData.sequences=this._sequences;};S._nextId=1;S._map=new Map();S.add=function(s){this._map.set(s.getId(),s);return this;};S.getById=function(i){return this._map.get(i);};S.prototype.getId=function(){return this._id;};S.prototype.setScene=function(i){if(i.result!==1){this._reject(i.result);}else{var c=this._cameras.get(i.cameraRef);this._resolve({node:this._parentNode,camera:c,contentResource:this._contentResource,builder:this});}};S.prototype.createNode=function(i){var b=this._nodes.get(i.parentRef)||null;var c=new THREE.Group();c.name=i.name;c.visible=i.visible;c.matrix.set(i.matrix[0],i.matrix[4],i.matrix[8],i.matrix[12],i.matrix[1],i.matrix[5],i.matrix[9],i.matrix[13],i.matrix[2],i.matrix[6],i.matrix[10],i.matrix[14],i.matrix[3],i.matrix[7],i.matrix[11],i.matrix[15]);c.matrix.decompose(c.position,c.quaternion,c.scale);c.userData.metadata=i.metadata;c.userData.veids=i.veids;(b||this._parentNode).add(c);this._nodes.set(i.nodeRef,c);};var n=new Float32Array([0.0,0.0,1.0,0.0,0.0,1.0,0.0,0.0,1.0,0.0,0.0,1.0,0.0,0.0,-1.0,0.0,0.0,-1.0,0.0,0.0,-1.0,0.0,0.0,-1.0,0.0,1.0,0.0,0.0,1.0,0.0,0.0,1.0,0.0,0.0,1.0,0.0,0.0,-1.0,0.0,0.0,-1.0,0.0,0.0,-1.0,0.0,0.0,-1.0,0.0,1.0,0.0,0.0,1.0,0.0,0.0,1.0,0.0,0.0,1.0,0.0,0.0,-1.0,0.0,0.0,-1.0,0.0,0.0,-1.0,0.0,0.0,-1.0,0.0,0.0]);var a=new Uint16Array([0,1,2,2,1,3,4,6,5,5,6,7,8+0,8+1,8+2,8+2,8+1,8+3,8+4,8+6,8+5,8+5,8+6,8+7,16+0,16+1,16+2,16+2,16+1,16+3,16+4,16+6,16+5,16+5,16+6,16+7]);S.prototype.createMesh=function(i){var b=i.boundingBox;var c=new Float32Array([b[0],b[1],b[5],b[3],b[1],b[5],b[0],b[4],b[5],b[3],b[4],b[5],b[0],b[1],b[2],b[3],b[1],b[2],b[0],b[4],b[2],b[3],b[4],b[2],b[0],b[4],b[5],b[3],b[4],b[5],b[0],b[4],b[2],b[3],b[4],b[2],b[0],b[1],b[5],b[3],b[1],b[5],b[0],b[1],b[2],b[3],b[1],b[2],b[3],b[1],b[5],b[3],b[1],b[2],b[3],b[4],b[5],b[3],b[4],b[2],b[0],b[1],b[5],b[0],b[1],b[2],b[0],b[4],b[5],b[0],b[4],b[2]]);var e=new THREE.BufferGeometry();e.setIndex(new THREE.BufferAttribute(a,1));e.addAttribute("position",new THREE.BufferAttribute(c,3));e.addAttribute("normal",new THREE.BufferAttribute(n,3));var m=new THREE.Mesh(e,this._materials.get(i.materialRef));this._meshes.set(i.meshRef,m);if(i.matrix){m.matrix.set(i.matrix[0],i.matrix[4],i.matrix[8],i.matrix[12],i.matrix[1],i.matrix[5],i.matrix[9],i.matrix[13],i.matrix[2],i.matrix[6],i.matrix[10],i.matrix[14],i.matrix[3],i.matrix[7],i.matrix[11],i.matrix[15]);m.matrix.decompose(m.position,m.quaternion,m.scale);}};S.prototype.setMeshGeometry=function(b){var m=this._meshes.get(b.meshRef);var c=b.data;var e=new THREE.BufferGeometry();e.setIndex(new THREE.BufferAttribute(c.index,1));e.addAttribute("position",new THREE.BufferAttribute(c.position,3));if(c.normal){e.addAttribute("normal",new THREE.BufferAttribute(c.normal,3));}if(c.uv){e.addAttribute("uv",new THREE.BufferAttribute(c.uv,2));}if(b.flags&1){for(var i=0,l=m.parent.children.length;i<l;i++){if(m.parent.children[i]===m){m.parent.children[i]=new THREE.LineSegments(e,new THREE.LineBasicMaterial({color:m.material.color}));break;}}}else{m.geometry.copy(e);}if(this._fireSceneUpdated){this._fireSceneUpdated();}};S.prototype.insertMesh=function(b,m){var c=this._nodes.get(b);var e=this._meshes.get(m);c.add(e.parent?e.clone():e);};var d=[sap.ui.vk.BillboardTextEncoding.PlainText,sap.ui.vk.BillboardTextEncoding.HtmlText];var f=[sap.ui.vk.BillboardStyle.RectangularShape,sap.ui.vk.BillboardStyle.CircularShape,sap.ui.vk.BillboardStyle.None,sap.ui.vk.BillboardStyle.TextGlow];var g=[sap.ui.vk.BillboardBorderLineStyle.None,sap.ui.vk.BillboardBorderLineStyle.Solid,sap.ui.vk.BillboardBorderLineStyle.Dash,sap.ui.vk.BillboardBorderLineStyle.Dot,sap.ui.vk.BillboardBorderLineStyle.DashDot,sap.ui.vk.BillboardBorderLineStyle.DashDotDot];var h=[sap.ui.vk.BillboardHorizontalAlignment.Left,sap.ui.vk.BillboardHorizontalAlignment.Center,sap.ui.vk.BillboardHorizontalAlignment.Right];var j=[sap.ui.vk.LeaderLineMarkStyle.None,sap.ui.vk.LeaderLineMarkStyle.Point,sap.ui.vk.LeaderLineMarkStyle.Arrow];function k(c){var b=c.toString(16);return"#"+"000000".substring(b.length)+b;}function o(b){for(var i=0,l=b.length;i<l;i++){if(!isFinite(b[i])){return false;}}return true;}S.prototype.createTextAnnotation=function(i){if(!o(i.position)){return;}var b=new sap.ui.vk.threejs.Billboard({coordinateSpace:sap.ui.vk.BillboardCoordinateSpace.Viewport,renderOrder:3,position:new THREE.Vector3().fromArray(i.position),encoding:d[i.encoding],text:i.text,font:i.font,fontSize:i.fontSize,fontWeight:Math.min(i.fontWeight,900),fontItalic:i.fontItalic,style:f[i.style],width:i.width,height:i.height,textColor:k(i.textColor),backgroundColor:k(i.backgroundColor),backgroundOpacity:i.backgroundOpacity,borderColor:k(i.borderColor),borderOpacity:i.borderOpacity,borderWidth:i.borderWidth,borderLineStyle:g[i.borderLineStyle],horizontalAlignment:h[i.horizontalAlignment],link:i.link});var c=this._nodes.get(i.nodeRef);(c||this._parentNode).add(b._node);if(!this._parentNode.userData._vkBillboards){this._parentNode.userData._vkBillboards=[];}this._parentNode.userData._vkBillboards.push(b);};S.prototype.createImageNote=function(i){var m=this._materials.get(i.materialRef);var b=new sap.ui.vk.threejs.Billboard({coordinateSpace:sap.ui.vk.BillboardCoordinateSpace.Screen,renderOrder:2,position:new THREE.Vector3().fromArray(i.position),width:i.width,height:i.height,texture:m?m.emissiveMap:null});var c=this._nodes.get(i.nodeRef);(c||this._parentNode).add(b._node);if(!this._parentNode.userData._vkBillboards){this._parentNode.userData._vkBillboards=[];}this._parentNode.userData._vkBillboards.push(b);};S.prototype.createTextNote=function(i){var c=new sap.ui.vk.threejs.Callout({anchorNode:this._nodes.get(i.targetNodeRef)||this._parentNode,coordinateSpace:sap.ui.vk.BillboardCoordinateSpace.World,position:new THREE.Vector3().fromArray(i.position),renderOrder:i.alwaysOnTop?1:0,depthTest:!i.alwaysOnTop,encoding:d[i.encoding],text:i.text,font:i.font,fontSize:i.fontSize,fontWeight:Math.min(i.fontWeight,900),fontItalic:i.fontItalic,style:f[i.style],width:i.width,height:i.height,textColor:k(i.textColor),backgroundColor:k(i.backgroundColor),backgroundOpacity:i.backgroundOpacity,borderColor:k(i.borderColor),borderOpacity:i.borderOpacity,borderWidth:i.borderWidth,borderLineStyle:g[i.borderLineStyle],horizontalAlignment:h[i.horizontalAlignment],link:i.link});var b=this._nodes.get(i.nodeRef);this._callouts.set(b,c);(b||this._parentNode).add(c._node);if(!this._parentNode.userData._vkCallouts){this._parentNode.userData._vkCallouts=[];}this._parentNode.userData._vkCallouts.push(c);};S.prototype.insertLeaderLine=function(b){var c=this._nodes.get(b.nodeRef);var e=this._nodes.get(b.targetNodeRef)||this._parentNode;var m=this._materials.get(b.materialRef);var l=this._callouts.get(c);if(l){var s=[];for(var i=0;i<b.points.length;i+=3){s.push(new THREE.Vector3().fromArray(b.points,i));}l.addLeaderLine(s,e,m,j[b.startPointStyle],j[b.endPointStyle],b.styleConstant,b.extensionLength);}};S.prototype.createCamera=function(i){var c=null;if(i.projection==="perspective"){c=new sap.ui.vk.threejs.PerspectiveCamera();c.setFov(i.fov);}else if(i.projection==="orthographic"){c=new sap.ui.vk.threejs.OrthographicCamera();c.setZoomFactor(i.orthoZoomFactor);}if(c){c.setNearClipPlane(i.nearClip);c.setFarClipPlane(i.farClip);c.setUsingDefaultClipPlanes(i.autoEvaluateClipPlanes);var b=new THREE.Vector3().fromArray(i.origin);var e=new THREE.Vector3().fromArray(i.target).sub(b);var l=new THREE.Vector3().fromArray(i.up).sub(b);c.setUpDirection(l.toArray());c.setPosition(b.toArray());c.setTargetDirection(e.toArray());}this._parentNode.userData.camera=c;this._cameras.set(i.cameraRef,c);};S.prototype.insertCamera=function(b,c){var e=this._nodes.get(b);var i=this._cameras.get(c);i=i?i.getCameraRef():null;if(e&&i){(e||this._parentNode).add(i.parent?i.clone():i);}};S.prototype.createViewportGroup=function(i){var b=this._parentNode;while(b.parent){b=b.parent;}var c={name:i.name,type:i.type,description:i.description,metadata:i.metadata,veids:i.veids,modelViews:[]};b.userData.viewportGroups=b.userData.viewportGroups||[];b.userData.viewportGroups.push(c);this._viewportGroups.set(i.viewportGroupRef,c);};S.prototype.insertModelView=function(i){var m={name:i.name,description:i.description,camera:this._cameras.get(i.cameraRef),type:i.type,flyToTime:i.flyToTime,preDelay:i.preDelay,postDelay:i.postDelay,navigationMode:i.navigationMode,topColor:i.topColor,bottomColor:i.bottomColor,renderMethod:i.renderMethod,dimension:i.dimension,query:i.query,metadata:i.metadata,veids:i.veids,visibleNodes:[],highlights:[]};var b=this._viewportGroups.get(i.viewportGroupRef);if(b){b.modelViews.push(m);}this._modelViews.set(i.modelViewRef,m);this._modelViewThumbnails.set(i.thumbnail,m);};S.prototype.setModelViewVisibilitySet=function(i){var m=this._modelViews.get(i.modelViewRef);var b=new Set();i.visibleNodes.forEach(function(c){var e=this._nodes.get(c);if(e){while(e&&!b.has(e)){b.add(e);e=e.parent;}}else{}}.bind(this));m.visibleNodes=Array.from(b);};S.prototype.insertModelViewHighlight=function(i){var m=this._modelViews.get(i.modelViewRef);if(m){var b=[];i.highlightNodes.forEach(function(e){var l=this._nodes.get(e);if(l){b.push(l);}else{}}.bind(this));var c={highlightNodes:b,color1:i.color1,color2:i.color2,opacity1:i.opacity1,opacity2:i.opacity2,duration:i.duration,cycles:i.cycles};m.highlights.push(c);}};S.prototype.createThumbnail=function(i){var m=this._modelViewThumbnails.get(i.imageRef);if(m){m.thumbnailData="data:image/"+"jpeg"+";base64,"+window.btoa(String.fromCharCode.apply(null,i.data));if(this._fireThumbnailLoaded){this._fireThumbnailLoaded({modelView:m});}}};var p=[sap.ui.vk.DetailViewType.DetailView,sap.ui.vk.DetailViewType.Cutaway];var q=[sap.ui.vk.DetailViewShape.Box,sap.ui.vk.DetailViewShape.Circle,sap.ui.vk.DetailViewShape.CircleLine,sap.ui.vk.DetailViewShape.CirclePointer,sap.ui.vk.DetailViewShape.CircleArrow,sap.ui.vk.DetailViewShape.CircleBubbles,sap.ui.vk.DetailViewShape.BoxLine,sap.ui.vk.DetailViewShape.BoxNoOutline,sap.ui.vk.DetailViewShape.SolidPointer,sap.ui.vk.DetailViewShape.SolidArrow];S.prototype.createDetailView=function(i){var b=new sap.ui.vk.threejs.DetailView({name:i.name,camera:this._cameras.get(i.cameraRef),type:p[i.type],shape:q[i.shape],borderWidth:i.borderWidth,backgroundColor:k(i.backgroundColor),borderColor:k(i.borderColor),renderOrder:i.renderOrder||0,origin:new THREE.Vector2().fromArray(i.origin),size:new THREE.Vector2().fromArray(i.size),attachmentPoint:new THREE.Vector3().fromArray(i.attachmentPoint),metadata:i.metadata,veId:i.veid});this._detailViews.set(i.detailViewRef,b);var c=this._nodes.get(i.nodeRef);(c||this._parentNode).add(b._node);if(!this._parentNode.userData._vkDetailViews){this._parentNode.userData._vkDetailViews=[];}this._parentNode.userData._vkDetailViews.push(b);};S.prototype.createMaterial=function(i){var m;var l=i.linestyle;if(l.width>0){m=new THREE.LineBasicMaterial({color:new THREE.Color(l.color[0],l.color[1],l.color[2]),depthTest:false,linewidth:l.width});m.userData.lineStyle=l;}else{if(i.textures){i.textures.forEach(function(b){var c=new THREE.Texture(this._images.get(b.imageRef),b.type==="reflection"?THREE.SphericalReflectionMapping:THREE.UVMapping,b.repeatX?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping,b.repeatY?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping,b.filterMode===1?THREE.NearestFilter:THREE.LinearFilter,b.filterMode===1?THREE.NearestFilter:THREE.LinearMipMapLinearFilter,undefined,undefined,4);c.offset.set(b.offsetX,b.offsetX);c.repeat.set(b.scaleX,b.scaleY);i[b.type+"Texture"]=c;c.needsUpdate=true;c.influence=b.amount;},this);}m=new THREE.MeshPhongMaterial({opacity:i.opacity,color:new THREE.Color(i.diffuse[0],i.diffuse[1],i.diffuse[2]),shininess:i.glossiness*2+i.specularLevel*3,emissive:new THREE.Color(i.emissive[0]+i.ambient[0]*0.2,i.emissive[1]+i.ambient[1]*0.2,i.emissive[2]+i.ambient[2]*0.2),specular:new THREE.Color(i.specular[0],i.specular[1],i.specular[2]),map:i.diffuseTexture?i.diffuseTexture:null,specularMap:i.specularTexture?i.specularTexture:null,emissiveMap:i.emissiveTexture?i.emissiveTexture:null,envMap:i.reflectionTexture?i.reflectionTexture:null,alphaMap:i.opacityTexture?i.opacityTexture:null,bumpMap:i.bumpTexture?i.bumpTexture:null,transparent:i.opacity<1||!!i.opacityTexture||(i.diffuseTexture&&i.diffuseTexture.image.hasAlpha)||false});if(m.map){m.color.lerp(new THREE.Color(1,1,1),m.map.influence?m.map.influence:0);}if(m.bumpMap){m.bumpScale=m.bumpMap.influence?m.bumpMap.influence:0;}if(m.envMap){m.mapping=THREE.SphericalReflectionMapping;m.combine=THREE.AddOperation;m.reflectivity=m.envMap.influence?m.envMap.influence:0;}}this._materials.set(i.materialRef,m);};S.prototype.createImage=function(i){var b=window.btoa(i.data.reduce(function(b,e){return b+String.fromCharCode(e);},""));var c=new THREE.ImageLoader().load("data:image/"+i.format+";base64,"+b);this._images.set(i.imageRef,c);c.hasAlpha=i.format==="png"&&i.data[25]===6;};S.prototype.insertAnimationGroup=function(i){var b=this._sequences.get(i.animationGroupRef);if(!b){var c=[];b=new THREE.AnimationClip(i.name,-1,c);if(!b.userData){b.userData={};}b.userData.startTime=i.startTime;b.userData.endTime=i.endTime;b.userData.frameRate=i.frameRate;b.userData.active=i.active;b.userData.cyclic=i.cyclic;b.userData.currentTime=i.currentTime;b.userData.name=i.name;b.userData.animations=[];b.userData.nodesEndData=new Map();b.userData.nodesStartData=new Map();this._sequences.set(i.animationGroupRef,b);}if(i.modelViewRef){var m=this._modelViews.get(i.modelViewRef);if(m){if(!m.playbacks){m.playbacks=[];}var e={sequenceId:i.animationGroupRef,playbackSpeed:i.playbackSpeed,playbackPreDelay:i.playbackPreDelay,playbackPostDelay:i.playbackPostDelay,playbackRepeat:i.playbackRepeat,playbackReversed:i.playbackReversed};m.playbacks.push(e);}}};S.prototype.insertAnimation=function(i){var b=this._animations.get(i.animationRef);if(!b){b={};b.type=i.animationType;b.targetRefs=[];b.targetPivots=[];b.sequenceId=i.animationGroupRef;b.animationTracks=new Set();this._animations.set(i.animationRef,b);}if(i.animationGroupRef){var c=this._sequences.get(i.animationGroupRef);if(!c.userData.animations.includes(i.animationRef)){c.userData.animations.push(i.animationRef);}}};S.prototype.insertAnimationTarget=function(i){var b=this._animations.get(i.animationRef);if(b){if(!b.targetRefs.includes(i.targetRef)){b.targetRefs.push(i.targetRef);b.targetPivots.push({x:i.targetPivotX,y:i.targetPivotY,z:i.targetPivotZ});}}};S.prototype.insertAnimationTrack=function(i){var b=this._animationTracks.get(i.animationTrackRef);var e=i.animationRef;if(!b){delete i.animationRef;b=i;this._animationTracks.set(i.animationTrackRef,b);}if(b.keyCount<2){return;}if(!e){return;}var l=this._animations.get(e);if(!l||!l.sequenceId){return;}var A=this._sequences.get(l.sequenceId);if(l.animationTracks.has(b.animationTrackRef)){return;}else{l.animationTracks.add(b.animationTrackRef);}var B=function(x,y,z,Y){var c=Math.cos(Y);var s=Math.sin(Y);var _=c+x*x*(1-c);var a1=x*y*(1-c)-z*s;var b1=x*z*(1-c)+y*s;var c1=0;var d1=y*x*(1-c)+z*s;var e1=c+y*y*(1-c);var f1=y*z*(1-c)-x*s;var g1=0;var h1=z*x*(1-c)-y*s;var i1=z*y*(1-c)+x*s;var j1=c+z*z*(1-c);var k1=0;var m=new THREE.Matrix4();m.set(_,a1,b1,c1,d1,e1,f1,g1,h1,i1,j1,k1,0,0,0,1);return m;};var C=function(Y,_){var c=Math.cos(Y);var s=Math.sin(Y);var a1=1;var b1=0;var c1=0;var d1=0;var e1=0;var f1=1;var g1=0;var h1=0;var i1=0;var j1=0;var k1=1;var l1=0;if(_==="X"){f1=c;g1=-s;j1=s;k1=c;}else if(_==="Y"){a1=c;c1=s;i1=-s;k1=c;}else{a1=c;b1=-s;e1=s;f1=c;}var m=new THREE.Matrix4();m.set(a1,b1,c1,d1,e1,f1,g1,h1,i1,j1,k1,l1,0,0,0,1);return m;};for(var D=0;l.targetRefs&&D<l.targetRefs.length;D++){var E=l.targetRefs[D];var F=l.targetPivots[D];var G="";var H=[];var I=[];var J=null;var K,M,N,x,y,z,O;var P;var m,Q;if(l.type===0){var R=this._nodes.get(E);if(!R){continue;}G=R.uuid;var T={};A.userData.nodesEndData.set(R,T);if(!R.userData){R.userData={};}if(b.dataType===0){if(b.type===0){if(!R.material&&R.children&&R.children.length===1){R=R.children[0];G=R.uuid;if(!R.userData){R.userData={};}}if(R.material&&R.material.opacity){G+=".material.opacity";P=R.material.opacity;}else{continue;}}else if(b.type===3&&R.scale){G+=".scale";P=R.scale.clone();}else{continue;}if(b.values.length!==b.keyCount||b.times.length!==b.keyCount){continue;}for(K=0;K<b.keyCount;K++){H.push(b.times[K]);if(b.type===0){I.push(b.values[K]);if(K===b.keyCount-1){T.opacity=b.values[K];}}else if(b.type===3){for(var U=0;U<3;U++){I.push(b.values[K]);}if(K===b.keyCount-1){var V=new THREE.Vector3(b.values[K],b.values[K],b.values[K]);T.scale=V;}}}if(b.type===0){J=new THREE.NumberKeyframeTrack(G,H,I);}else if(b.type===3){J=new THREE.VectorKeyframTrack(G,H,I);}}else if(b.dataType===1){if(b.type===1&&R.material&&R.material.color){G+=".material.color";P=R.material.color.clone();}else{continue;}if(b.values.length!==3*b.keyCount||b.times.length!==b.keyCount){continue;}for(K=0;K<b.keyCount;K++){H.push(i.times[K]);}for(M=0;M<b.valueCount;M++){I.push(i.values[M]);}J=new THREE.ColorKeyframeTrack(G,H,I);}else if(b.dataType===2){}else if(b.dataType===3){if(b.type===2&&R.position){G+=".position";P=R.position.clone();}else if(b.type===3&&R.scale){G+=".scale";P=R.scale.clone();}else{continue;}if(b.values.length!==3*b.keyCount||b.times.length!==b.keyCount){continue;}for(K=0;K<b.keyCount;K++){H.push(b.times[K]);}for(M=0;M<b.valueCount;M++){I.push(b.values[M]);if(M===b.valueCount-1){var W=new THREE.Vector3(b.values[M-2],b.values[M-1],b.values[M]);if(b.type===2){T.position=W;}else if(b.type===3){T.scale=W;}}}J=new THREE.VectorKeyframeTrack(G,H,I);}else if(b.dataType===4){if(b.type===4&&R.quaternion){G+=".quaternion";P=R.quaternion.clone();}else{continue;}if(b.values.length!==4*b.keyCount||b.times.length!==b.keyCount){continue;}for(K=0;K<b.keyCount;K++){H.push(i.times[K]);}m=new THREE.Matrix4();var w;for(K=0;K<b.keyCount;K++){x=b.values[K*4];y=b.values[K*4+1];z=b.values[K*4+2];w=b.values[K*4+3];Q=B(x,y,z,w);m.premultiply(Q);N=new THREE.Quaternion();N.setFromRotationMatrix(m);I.push(N.x);I.push(N.y);I.push(N.z);I.push(N.w);if(K===b.keyCount-1){T.quaternion=N;}}J=new THREE.QuaternionKeyframeTrack(G,H,I);}else if(b.dataType===5){if(b.type===4&&R.quaternion){G+=".quaternion";if(R.userData.previousQuaternion){P=R.userData.previousQuaternion;}else{P=R.quaternion.clone();}}else{continue;}if(b.values.length!==4*b.keyCount||b.times.length!==b.keyCount){continue;}for(K=0;K<b.keyCount;K++){H.push(b.times[K]);}for(M=0;M<b.valueCount;M++){I.push(b.values[M]);}var X=new THREE.Quaternion(I[I.length-4],I[I.length-3],I[I.length-2],I[I.length-1]);T.quaternion=X;J=new THREE.QuaternionKeyframeTrack(G,H,I);}else if(b.dataType===6){if(b.type===4&&R.quaternion){G+=".quaternion";if(R.userData.previousQuaternion){P=R.userData.previousQuaternion;}else{P=R.quaternion.clone();}}else{continue;}if(b.values.length!==4*b.keyCount||b.times.length!==b.keyCount){continue;}for(K=0;K<b.keyCount;K++){H.push(b.times[K]);}for(K=0;K<b.keyCount;K++){O=b.values[K*4+3];O=Math.round(O);var Y;m=new THREE.Matrix4();for(var Z=0;Z<3;Z++){if(Z===0){Y=b.values[K*4];}else if(Z===1){Y=b.values[K*4+1];}else{Y=b.values[K*4+2];}if((O>>(Z*2)&3)===0){Q=C(Y,"X");m.multiply(Q);}else if((O>>(Z*2)&3)===1){Q=C(Y,"Y");m.multiply(Q);}else if((O>>(Z*2)&3)===2){Q=C(Y,"Z");m.multiply(Q);}}N=new THREE.Quaternion();N.setFromRotationMatrix(m);I.push(N.x);I.push(N.y);I.push(N.z);I.push(N.w);if(K===b.keyCount-1){T.quaternion=N;}}J=new THREE.QuaternionKeyframeTrack(G,H,I);}else{continue;}if(!J.userData){J.userData={};}J.userData.targetNode=R;J.userData.targetPivot=F;}else{var $=this._materials.get(E);if(!$){continue;}G=$.uuid;if(b.dataType===0){if(b.type===0&&$&&$.opactiy){G+=".opacity";P=$.opacity;}else{continue;}for(K=0;K<b.keyCount;K++){H.push(b.times[K]);I.push(b.values[K]);}}J=new THREE.NumberKeyframeTrack(G,H,I);if(!J.userData){J.userData={};}J.userData.targetMaterial=$;}if(b.type===0){J.userData.type="OPACITY";}else if(b.type===1){J.userData.type="COLOUR";}else if(b.type===2){J.userData.type="TRANSLATE";}else if(b.type===3){J.userData.type="SCALE";}else if(b.type===4){J.userData.type="ROTATE";}J.userData.originalValue=P;J.userData.info=b;if(b.interpolationType===1){J.setInterpolation(THREE.InterpolateSmooth);}else{J.setInterpolation(THREE.InterpolateLinear);}A.tracks.push(J);}};S.prototype.finalizeAnimation=function(b){var c=this._animations.get(b);if(!c||!c.sequenceId){return;}var e=this._sequences.get(c.sequenceId);if(e){e.resetDuration();e.optimize();e.hasOptimized=true;}};S.prototype.finalizePlaybacks=function(i){var b=this._viewportGroups.get(i.viewportGroupRef);var c=new Map();var m;var e,l,s;for(m=0;m<b.modelViews.length-1;m++){var w=b.modelViews[m];var x=b.modelViews[m+1];var y;if(w.playbacks&&w.playbacks.length){y=w.playbacks[w.playbacks.length-1];}if(y){e=this._sequences.get(y.sequenceId);l=e.userData.nodesEndData.entries();s=l.next();while(!s.done){c.set(s.value[0],s.value[1]);s=l.next();}}var z;if(x.playbacks&&x.playbacks.length){z=x.playbacks[x.playbacks.length-1];}if(z){e=this._sequences.get(z.sequenceId);l=c.entries();s=l.next();while(!s.done){e.userData.nodesStartData.set(s.value[0],s.value[1]);s=l.next();}}}var A,B,C;for(m=0;m<b.modelViews.length;m++){var D=b.modelViews[m];var E;if(D.playbacks&&D.playbacks.length){E=D.playbacks[D.playbacks.length-1];}if(E){e=this._sequences.get(E.sequenceId);A=c.keys();s=A.next();while(!s.done){B=s.value;C=e.userData.nodesStartData.get(B);if(!C){C={};C.position=B.position.clone();C.scale=B.scale.clone();C.quaternion=B.quaternion.clone();e.userData.nodesStartData.set(B,C);}s=A.next();}}else{D.animationNodeOriginalData=new Map();A=c.keys();s=A.next();while(!s.done){B=s.value;C={};C.position=B.position.clone();C.scale=B.scale.clone();C.quaternion=B.quaternion.clone();D.animationNodeOriginalData.set(B,C);s=A.next();}}}var F=this._parentNode;while(F.parent){F=F.parent;}if(!F.userData){F.userData={};}if(!F.userData.animationNodeOriginalData){F.userData.animationNodeOriginalData=new Map();}A=c.keys();s=A.next();while(!s.done){B=s.value;C={};C.position=B.position.clone();C.scale=B.scale.clone();C.quaternion=B.quaternion.clone();F.userData.animationNodeOriginalData.set(B,C);s=A.next();}};S.prototype.progress=function(b){L.log("reading progress:",b);};var r=function(e){var b=e.data;if(b.ready){r.resolve();}else{var s=S.getById(b.sceneBuilderId);s[b.method].apply(s,b.args);}};var t=function(e){L.error("Error in WebWorker",e);};var u=(function(){var b;return function(){return b||(b=new Promise(function(c){var w=new Worker(sap.ui.require.toUrl("sap/ui/vk/threejs/MataiLoaderWorker.js"));r.resolve=c.bind(null,w);w.onmessage=r;w.onerror=t;}));};})();var v=function(b,c,e,i,l,m){u().then(function(w){var s=new S(e,i,l,m);w.postMessage({method:"loadSceneFromArrayBuffer",sceneBuilderId:s.getId(),buffer:b,fileName:c,sourceLocation:"remote"},[b]);});};return function(b,c){return new Promise(function(i,l){if(typeof c.getSource()==="string"){var m=c.getSource();fetch(m).then(function(e){if(e.ok){return e.arrayBuffer();}throw(new Error(e.statusText));}).then(function(e){v(e,m,b,c,i,l);}).catch(function(e){l(e);});}else if(c.getSource()instanceof File){var s=new FileReader();s.onload=function(e){v(e.target.result,c.getSource().name,b,c,i,l);};s.onerror=function(e){l(e);};s.readAsArrayBuffer(c.getSource());}});};});
