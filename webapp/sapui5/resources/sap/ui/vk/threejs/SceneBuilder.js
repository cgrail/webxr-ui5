/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["jquery.sap.global","sap/base/Log","./thirdparty/three","./BBoxSubdivider","./UsageCounter","../totara/ListMap","./OrthographicCamera","./PerspectiveCamera","sap/ui/vk/View"],function(q,L,t,B,U,a,O,P,V){"use strict";var S=function(r){this._id=S._nextId++;S._add(this);this._submeshes=new Map();this._callouts=new Map();this._cameras=new Map();this._materials=new Map();this._images=new Map();this._geometries=new Map();if(r){this._rootNode=r;this._nodes=new Map();this._NodeMeshIdSubmeshIdsMap=new Map();this._sequences=new Map();this._tracks=new Map();this._trackIdSequenceNodeMap=new a();this._viewGroups=new Map();this._views=new Map();}else{this._rootNode=null;this._nodes=null;this._NodeMeshIdSubmeshIdsMap=null;this._sequences=null;this._tracks=null;this._trackIdSequenceNodeMap=null;this._viewGroups=null;this._views=null;}this._currentSceneId=null;this._sceneIdTreeNodesMap=new Map();this._sceneIdRootNodeMap=new Map();this._sceneIdNodMeshIdMap=new Map();this._sceneIdViewGroupMap=new Map();this._sceneIdViewMap=new Map();};S._nextId=1;S._map=new Map();S.prototype.getId=function(){return this._id;};S._add=function(s){S._map.set(s.getId(),s);return this;};S.prototype.setRootNode=function(r,c,s){this._rootNode=r;this._nodes=new Map();this._nodes.set(c,r);this._NodeMeshIdSubmeshIdsMap=new Map();if(!this._rootNode.userData){this._rootNode.userData={};}this._sequences=new Map();this._tracks=new Map();this._trackIdSequenceNodeMap=new a();this._viewGroups=new Map();this._views=new Map();if(s){this._sceneIdTreeNodesMap.set(s,this._nodes);this._sceneIdRootNodeMap.set(s,r);this._sceneIdNodMeshIdMap.set(s,this._NodeMeshIdSubmeshIdsMap);this._sceneIdViewGroupMap.set(s,this._viewGroups);this._sceneIdViewMap.set(s,this._views);this._currentSceneId=s;}return this;};S.prototype._resetCurrentScene=function(s){if(s&&s!==this._currentSceneId){var c=this._sceneIdTreeNodesMap.get(s);if(c){this._nodes=c;}else{this._nodes=null;}var e=this._sceneIdRootNodeMap.get(s);if(e){this._rootNode=e;}else{this._rootNode=null;}this._currentSceneId=s;}};S.prototype.getNode=function(c,s){this._resetCurrentScene(s);if(!this._nodes){return null;}return this._nodes.get(c);};S.prototype.getObjectId=function(c){do{if(c.userData&&c.userData.treeNode&&c.userData.treeNode.sid){return c.userData.treeNode.sid;}c=c.parent;}while(c);return null;};var b=function(c){var m=new THREE.Matrix4();if(c.length===3){m.setPosition(new THREE.Vector3().fromArray(c));}else if(c.length===12){m.set(c[0],c[3],c[6],c[9],c[1],c[4],c[7],c[10],c[2],c[5],c[8],c[11],0.0,0.0,0.0,1.0);}else if(c.length===16){m.set(c[0],c[4],c[8],c[12],c[1],c[5],c[9],c[13],c[2],c[6],c[10],c[14],c[3],c[7],c[11],c[15]);}else{throw"Invalid matrix format";}return m;};var D={r:0.0235,g:0.0235,b:0.0235};var d={r:0.0602,g:0.0602,b:0.0602};S.prototype._createTemporaryMaterial=function(m){var c=new THREE.MeshPhongMaterial({color:0xaaaaaa});if(!c.userData){c.userData={};}c.userData.defaultHighlightingEmissive=D;c.userData.defaultHighlightingSpecular=d;c.userData.materialUsed=0;c.userData.materialId=m;c.userData.toBeUpdated=true;this._materials.set(m,c);return c;};S.prototype.createNode=function(c,e,s){var r={needUpdateMaterial:false,needSetSubmesh:false,idOfGeometriesToUpdate:null,materialIds:[]};this._resetCurrentScene(s);var i=this._nodes.get(e)||null;var l=new THREE.Group();l.userData.treeNode=c;if(c.renderOrder){l.renderOrder=c.renderOrder;}l.visible=c.visible!==undefined?c.visible:true;if(c.name){l.name=c.name;}l.userData.opacity=c.opacity;if(c.transform){l.applyMatrix(b(c.transform));}(i||this._rootNode).add(l);this._nodes.set(c.sid,l);var m=this.attachSubMeshesToNode(c.sid,s);var v=this.applyNodeMaterialToSubmeshes(c.sid,s);var w=this.applyNodeOpacityToSubmeshes(c.sid,s);r.needUpdateMaterial=v.needUpdateMaterial;r.needSetSubmesh=m.needSetSubmesh;r.idOfGeometriesToUpdate=m.idOfGeometriesToUpdate;r.materialIds=w.materialIds;return r;};S.prototype.applyNodeMaterialToSubmeshes=function(c,s){var r={needUpdateMaterial:false};this._resetCurrentScene(s);var e=this._nodes.get(c);if(!e){return r;}var l=e.userData.treeNode;e.userData.materialId=l.materialId;if(!l.meshId||!e.userData.materialId){return r;}var m=this._materials.get(e.userData.materialId);if(!m){m=this._createTemporaryMaterial(e.userData.materialId);r.needUpdateMaterial=true;}if(e&&e.children){for(var i=0;i<e.children.length;i++){var v=e.children[i];v.material=m;v.userData.materialId=e.userData.materialId;U.increaseMaterialUsed(m);if(l.renderOrder){v.material.depthTest=false;}}}return r;};S.prototype.applyNodeOpacityToSubmeshes=function(c,s,m){var r={materialIds:[]};this._resetCurrentScene(s);var e=this._nodes.get(c);if(!e){return r;}var l=e.userData.treeNode;if(!l.meshId||!l.opacity){return r;}if(e&&e.children){var w=new Set();for(var i=0;i<e.children.length;i++){var x=e.children[i];if(x.material&&(!m||m===x.material.userData.materialId)){if(!x.material.userData.toBeUpdated){x.userData.opacity=l.opacity;x.userData.originalMaterial=x.material;x.material=x.material.clone();x.material.opacity*=x.userData.opacity;x.material.transparent=x.material.opacity<0.99;}else{w.add(x.material.userData.materialId);}}}w.forEach(function(v){r.materialIds.push(v);});}return r;};S.prototype.attachSubMeshesToNode=function(c,s){var r={needSetSubmesh:false,idOfGeometriesToUpdate:new Set()};this._resetCurrentScene(s);var e=this._nodes.get(c);var l=e.userData.treeNode;if(!l.meshId){return r;}var m=this._NodeMeshIdSubmeshIdsMap.get(l.meshId);if(!m){r.needSetSubmesh=true;return r;}var v=[];m.forEach(function(y){v.push(y);});var i;var w;for(i=0;i<v.length;i++){w=v[i];this._insertSubmesh(l.sid,w,s);}for(i=0;i<v.length;i++){w=v[i];var x=this._submeshes.get(w);if(x&&x.userData&&x.userData.isBoundingBox&&x.userData.geometryId){r.idOfGeometriesToUpdate.add(x.userData.geometryId);}}return r;};S.prototype.updateMaterialInNode=function(c,s){this._resetCurrentScene(s);var r={needUpdateMaterial:false,nodeUpdated:false};var e=this._nodes.get(c.sid);var l=e.userData.materialId;var m=e.userData.opacity;e.userData.treeNode=c;e.userData.materialId=c.materialId;e.userData.opacity=c.opacity;var v=false;if(l===undefined){if(e.userData.materialId!==undefined){v=true;}}else if(l!==e.userData.materialId){v=true;}var w=false;if(m===undefined){if(e.userData.opacity!==undefined){w=true;}}else if(m!==e.userData.opacity){w=true;}if(!v&&!w){return r;}r.nodeUpdated=true;var x=null;if(e.userData.materialId){x=this._materials.get(e.userData.materialId);if(x===undefined){x=this._createTemporaryMaterial(e.userData.materialId);r.needUpdateMaterial=true;}if(c.renderOrder){x.depthTest=false;}}if(e&&e.children){for(var i=0;i<e.children.length;i++){var y=e.children[i];if(x){y.material=x;y.userData.materialId=c.materialId;U.increaseMaterialUsed(x);}else{var z=this._materials.get(y.userData.initialMaterialId);y.material=z;y.userData.materialId=y.userData.initialMaterialId;U.increaseMaterialUsed(z);}delete y.userData.originalMaterial;if(e.userData.opacity!==undefined&&(y.material.userData&&!y.material.userData.toBeUpdated)){y.userData.opacity=e.userData.opacity;y.userData.originalMaterial=y.material;y.material=y.material.clone();y.material.opacity*=y.userData.opacity;y.material.transparent=y.material.opacity<0.99;}else{y.userData.opacity=undefined;}}}return r;};S.prototype.updateGeometryInNode=function(c,e,s){this._resetCurrentScene(s);var l=this._nodes.get(c);if(l&&l.children){for(var i=0;i<l.children.length;i++){var m=l.children[i];if(!m.isMesh){continue;}if(m.userData.geometryId===e){var r=this._geometries.get(e);if(r){if(r.isPolyline&&!m.isLineSegment){var v=m.parent;var w=m.material;v.remove(m);var x=new THREE.LineBasicMaterial({color:0xff0000,linewidth:1,depthTest:false});x.color.copy(w.color);var y=new THREE.LineSegments(r,x);v.add(y);y.userData.meshId=m.userData.meshId;if(r.isPositionQuantized){y.position.copy(m.position);y.scale.copy(m.scale);}y.userData.initialMaterialId=m.userData.initialMaterialId;y.userData.isBoundingBox=false;y.userData.geometryId=m.userData.geometryId;y.userData.meshId=m.userData.meshId;y.userData.materialId=m.userData.materialId;y.userData.submeshInfo=m.userData.submeshInfo;y.userData.submeshId=m.userData.submeshId;var z=this._submeshes.get(y.userData.submeshId);if(z&&z.renderOrder){y.renderOrder=z.renderOrder;}this._submeshes.set(y.userData.submeshId,y);}else{m.geometry=r;m.userData.isBoundingBox=false;if(!r.isPositionQuantized){m.position.set(0,0,0);m.scale.set(1,1,1);}}U.increaseGeometryUsed(r);}}}}return this;};S.prototype.getChildNodeIds=function(c,s,e){this._resetCurrentScene(s);var l=this._nodes.get(c);var m=[];if(!l){return m;}if(l&&l.children){for(var i=0;i<l.children.length;i++){var r=l.children[i];if(r.userData&&r.userData.treeNode&&r.userData.treeNode.sid){m.push(r.userData.treeNode.sid);}else if(e&&r.userData&&r.userData.submeshInfo&&r.userData.submeshInfo.id){m.push(r.userData.submeshInfo.id);}}}return m;};function f(c){var e=atob(c);var l=e.length;var m=new Uint8Array(l);for(var i=0;i<l;i++){m[i]=e.charCodeAt(i);}return m;}function g(l){if(l){for(var i=0;i<l.length;i++){if(l[i].type==="box"&&l[i].data){return l[i];}}}return null;}function h(v){if(v===0){return Number.EPSILON;}return v;}function u(m,c){m.position.set((c[3]+c[0])/2,(c[4]+c[1])/2,(c[5]+c[2])/2);m.scale.set(h(c[3]-c[0]),h(c[4]-c[1]),h(c[5]-c[2]));}S.prototype.setSubmesh=function(m,s){var r={needUpdataMaterial:false,geometryIdToRequest:null,geometryPriority:0};var c=this._NodeMeshIdSubmeshIdsMap.get(m);if(!c){c=new Set();this._NodeMeshIdSubmeshIdsMap.set(m,c);}c.add(s.id);if(!s.lods){return false;}var l=null;for(var i=0;i<s.lods.length;i++){if(s.lods[i].type===undefined||s.lods[i].type==="mesh"||s.lods[i].type==="line"){l=s.lods[i];}}if(!l){return false;}var v=null;if(s.materialId){v=this._materials.get(s.materialId);if(!v){v=this._createTemporaryMaterial(s.materialId);r.needUpdataMaterial=true;}}var w=null;var x=this._geometries.get(l.id);if(x){if(v){w=new THREE.Mesh(x,v);}else{w=new THREE.Mesh(x);}w.userData.initialMaterialId=s.materialId;w.userData.isBoundingBox=false;w.userData.geometryId=l.id;w.userData.meshId=m;w.userData.submeshId=s.id;w.userData.materialId=s.materialId;if(x.isPositionQuantized){u(w,l.boundingBox);}U.increaseGeometryUsed(x);}else{r.geometryIdToRequest=l.id;var y;try{var z=g(s.lods);if(z&&z.data){var E=f(z.data);var F=B.unpackSubDividedBoundingBox(E);y=B.makeSubDividedBoundingBoxGeometry(F);}}catch(e){}var G=new THREE.BoxBufferGeometry(1,1,1);w=new THREE.Mesh(y?y:G,v);var H=l.boundingBox;if(Array.isArray(H)&&H.length===6){r.geometryPriority=new THREE.Vector3(H[3]-H[0],H[4]-H[1],H[5]-H[2]).length();}else{H=[0,0,0,1,1,1];}u(w,H);w.userData.initialMaterialId=s.materialId;w.userData.isBoundingBox=true;w.userData.geometryId=l.id;w.userData.meshId=m;w.userData.materialId=s.materialId;w.userData.submeshId=s.id;}w.userData.submeshInfo=s;this._submeshes.set(s.id,w);return r;};S.prototype.getSubmesh=function(s){return this._submeshes.get(s);};S.prototype.setGeometry=function(c){if(c.error){return this;}var e=new THREE.BufferGeometry();var i=new THREE.BufferAttribute(new Uint16Array(c.data.indices),1);var l=new THREE.BufferAttribute(new Float32Array(c.data.points),3);e.setIndex(i);e.addAttribute("position",l);if(!c.isPolyline){if(c.data.normals.length===c.data.points.length){var m=new THREE.BufferAttribute(new Float32Array(c.data.normals),3);e.addAttribute("normal",m);}if(c.data.uvs&&c.data.uvs.length*3===c.data.points.length*2){e.addAttribute("uv",new THREE.BufferAttribute(new Float32Array(c.data.uvs),2));}}else{e.isPolyline=true;}try{e.computeBoundingSphere();}catch(r){return this;}e.isPositionQuantized=c.isPositionQuantized;if(!e.userData){e.userData={};}e.userData.geometryId=c.id;e.userData.geometryUsed=0;this._geometries.set(c.id,e);return this;};S.prototype.getGeometry=function(c){return this._geometries.get(c);};S.prototype._insertSubmesh=function(c,s,e){this._resetCurrentScene(e);var i=this._nodes.get(c);var l=this._submeshes.get(s);if(!i||!l){return false;}if(l.parent){l=l.clone();if(l.userData){if(l.userData.submeshInfo&&l.userData.initialMaterialId){var m=this._materials.get(l.userData.initialMaterialId);if(m){l.material=m;U.increaseMaterialUsed(m);}}if(l.userData&&l.userData.opacity){delete l.userData.opacity;}}}i.add(l);if(i.renderOrder){l.renderOrder=i.renderOrder;var M=this._materials.get(l.userData.initialMaterialId);if(M){M.depthTest=false;}}return true;};var j=[sap.ui.vk.BillboardStyle.RectangularShape,sap.ui.vk.BillboardStyle.CircularShape,sap.ui.vk.BillboardStyle.None,sap.ui.vk.BillboardStyle.TextGlow];var k=[sap.ui.vk.BillboardCoordinateSpace.Viewport,sap.ui.vk.BillboardCoordinateSpace.Screen,sap.ui.vk.BillboardCoordinateSpace.World];var n=[sap.ui.vk.BillboardBorderLineStyle.None,sap.ui.vk.BillboardBorderLineStyle.Solid,sap.ui.vk.BillboardBorderLineStyle.Dash,sap.ui.vk.BillboardBorderLineStyle.Dot,sap.ui.vk.BillboardBorderLineStyle.DashDot,sap.ui.vk.BillboardBorderLineStyle.DashDotDot];var o=[sap.ui.vk.LeaderLineMarkStyle.None,sap.ui.vk.LeaderLineMarkStyle.Point,sap.ui.vk.LeaderLineMarkStyle.Arrow];function p(c){var e=(((c[0]*255)<<16)|((c[1]*255)<<8)|(c[2]*255)).toString(16);return"#"+"000000".substring(e.length)+e;}S.prototype.createAnnotation=function(s,c,e){this._resetCurrentScene(s);var i=this._nodes.get(c);var l=e.position;var m={coordinateSpace:k[e.coordinateSpace],text:e.text,style:j[e.shape||0],width:e.width,height:e.height,backgroundColor:e.backgroundColour?p(e.backgroundColour):"#fff",backgroundOpacity:e.backgroundColour?e.backgroundColour[3]:0,borderColor:e.borderColour?p(e.borderColour):"#000",borderOpacity:e.borderColour?e.borderColour[3]:0,borderWidth:e.borderWidth,borderLineStyle:n[e.borderLineStyle]};if(e.fontFace){m.encoding=sap.ui.vk.BillboardTextEncoding.PlainText;m.font=e.fontFace;m.fontSize=Math.abs(e.fontSize);m.fontWeight=Math.min(e.fontWeight,900);m.textColor=p(e.textColour);}else{m.encoding=sap.ui.vk.BillboardTextEncoding.HtmlText;}if(e.coordinateSpace<2){m.position=new THREE.Vector3(l[0]*2-1,l[1]*-2+1,l[2]);m.renderOrder=2;var r=new sap.ui.vk.threejs.Billboard(m);i.add(r._node);if(!this._rootNode.userData._vkBillboards){this._rootNode.userData._vkBillboards=[];}this._rootNode.userData._vkBillboards.push(r);}else{m.anchorNode=this._nodes.get(e.sid);m.position=new THREE.Vector3().fromArray(l);m.depthTest=false;m.renderOrder=1;var v=new sap.ui.vk.threejs.Callout(m);this._callouts.set(e.id,v);i.add(v._node);if(!this._rootNode.userData._vkCallouts){this._rootNode.userData._vkCallouts=[];}this._rootNode.userData._vkCallouts.push(v);}};S.prototype.insertLeaderLine=function(s,c,e){var m=this._callouts.get(c);if(m){var v=[];for(var i=0,l=e.points.length;i<l;i++){v.push(new THREE.Vector3().fromArray(e.points[i]));}var r=this._nodes.get(e.startPointSid);m.addLeaderLine(v,r,e.material,o[e.startPointHeadStyle],o[e.endPointHeadStyle],e.pointHeadConstant,e.extensionLength);}};S.prototype._decrementResourceCounters=function(c){c.traverse(function(e){if(e.isMesh){U.decreaseMaterialUsed(e.material);U.decreaseGeometryUsed(e.geometry);}});};S.prototype.decrementResourceCountersForDeletedTreeNode=function(c,s){this._resetCurrentScene(s);var e=this;c=[].concat(c);c.forEach(function(i){var l=e._nodes.get(i);if(l){e._decrementResourceCounters(l);e._nodes.delete(i);}});return this;};S.prototype.remove=function(c,s){this._resetCurrentScene(s);var e=this;c=[].concat(c);c.forEach(function(l){var m=e._nodes.get(l);if(m){e._decrementResourceCounters(m);if(m.parent){m.parent.remove(m);}e._nodes.delete(l);for(var i=0;i<m.children.length;i++){var r=m.children[i];if(r.userData&&r.userData.treeNode&&r.userData.treeNode.sid){e.remove(r.userData.treeNode.sid,s);}}}});return this;};S.prototype.resourcesCleanUp=function(){var c=this._geometries;c.forEach(function(e){var i=e.userData.geometryUsed;if(i<=0){e.dispose();}});var m=this._materials;if(m){m.forEach(function(e){var i=e.userData.materialUsed;if(i<=0){e.dispose();}});}return this;};S.prototype.createCamera=function(c,s){this._resetCurrentScene(s);var e=null;var i=c.id;e=this._cameras.get(i);var l;if(e){l=e.getCameraRef();}if(!e||!l||(!l.isOrthographicCamera&&c.ortho)){if(c.ortho){l=new THREE.OrthographicCamera(-1,1,1,-1,c.near,c.far);}else{l=new THREE.PerspectiveCamera(c.fov*180/Math.PI,1,c.near,c.far);}}if(c.origin){var m=new THREE.Vector3().fromArray(c.origin);l.position.copy(m);}if(c.up){var r=new THREE.Vector3().fromArray(c.up).normalize();l.up.copy(r);}if(c.target){l.lookAt((new THREE.Vector3().fromArray(c.target)).add(l.position));}if(c.ortho){l.zoom=c.zoom||0.02;}this._rootNode.userData.camera=l;if(l.isOrthographicCamera){e=new sap.ui.vk.threejs.OrthographicCamera();}else if(l.isPerspectiveCamera){e=new sap.ui.vk.threejs.PerspectiveCamera();}e.setCameraRef(l);e.setUsingDefaultClipPlanes(true);if(c.zoom===-1){e.setZoomNeedRecalculate(true);}e.cameraInfo=c;if(i){this._cameras.set(i,e);}return e;};S.prototype.insertCamera=function(c,e,s){this._resetCurrentScene(s);var i=this._nodes.get(c);var l=this._cameras.get(e);if(i&&l){i.add(l.parent?l.clone():l);}return this;};S.prototype.getCamera=function(c){return this._cameras.get(c);};S.prototype.updateMaterialForGeometryWithoutNormal=function(m){var c=this._materials.get(m);if(c){c.emissive.copy(c.color);c.side=THREE.DoubleSide;}return this;};S.prototype.createMaterial=function(m){var r=[];var c=this._materials.get(m.id);if(m.lineWidth>0){if(!c||!c.isLineBasicMaterial){c=new THREE.LineBasicMaterial();this._materials.set(m.id,c);}c.color=new THREE.Color(m.lineColour[0],m.lineColour[1],m.lineColour[2]);c.depthTest=false;c.linewidth=m.lineWidth;c.userData.lineStyle={width:m.lineWidth,haloWidth:m.lineHaloWidth||0,endCapStyle:m.lineEndRound?1:0,dashPattern:m.lineDashPattern||[],dashPatternScale:m.lineDashPatternScale};c.userData.mateialInfo=m;c.userData.materialId=m.id;return r;}if(!c){c=this._createTemporaryMaterial(m.id);}if(c.userData&&c.userData.toBeUpdated){delete c.userData.toBeUpdated;}c.userData.materialInfo=m;if(m.diffuseColour){c.color.fromArray(m.diffuseColour);}if(m.specularColour){c.specular.fromArray(m.specularColour);}var e=true;if(m.emissiveColour){c.emissive.fromArray(m.emissiveColour);if(c.emissive.r!==0||c.emissive.g!==0||c.emissive.b!==0){e=false;}}if(e&&m.ambientColour){c.emissive.fromArray(m.ambientColour);c.emissive.multiplyScalar(0.2);}if(c.opacity!==undefined){c.opacity=m.opacity;c.transparent=m.opacity<1;if(c.transparent){c.side=THREE.DoubleSide;}}var i=c.glossiness?c.glossiness:0;var s=c.specularLevel?c.specularLevel:0;c.shininess=i*2+s*3;c.userData.defaultHighlightingEmissive=D;c.userData.defaultHighlightingSpecular=d;r=this.updateTextureMaps(m.id);return r;};S.prototype.getMaterial=function(m){return this._materials.get(m);};var A=function(c){var i="";try{var l=0x8000;var m=0;var r=c.length;var s;while(m<r){s=c.slice(m,Math.min(m+l,r));i+=String.fromCharCode.apply(null,s);m+=l;}}catch(e){i="";}return i;};S.prototype.createImage=function(i){var c=new DataView(i.binaryData.buffer);var e=true;if(c.getUint8(0,true)===parseInt("0xFF",16)&&c.getUint8(1,true)===parseInt("0xD8",16)){e=false;}var l=A(i.binaryData);var m="data:image/"+(e?"png":"jpeg")+";base64,"+btoa(l);this._images.set(i.id,m);return this;};var C=new THREE.TextureLoader();S.TextureType={Diffuse:0,Bump:1,Opacity:2,Reflection:3,Refraction:4,Specular:5,Ambient:6,Emissive:7,SpecularLevel:8,Glosiness:9,AmbientOcclusion:10,Decal:11};S.prototype.updateTextureMaps=function(m){var r=[];var c=this._materials.get(m);if(!c){return r;}var e=c.userData.materialInfo;if(!e){return r;}if(e.textureDiffuse){var i=this.updateTextureMap(e.id,S.TextureType.Diffuse);if(i.imageId){r.push(i);}}if(e.textureBump){var l=this.updateTextureMap(e.id,S.TextureType.Bump);if(l.imageId){r.push(l);}}if(e.textureOpacity){var s=this.updateTextureMap(e.id,S.TextureType.Opacity);if(s.imageId){r.push(s);}}if(e.textureEmissive){var v=this.updateTextureMap(e.id,S.TextureType.Emissive);if(v.imageId){r.push(v);}}if(e.textureAmbientOcclusion){var w=this.updateTextureMap(e.id,S.TextureType.AmbientOcclusion);if(w.imageId){r.push(w);}}if(e.textureReflection){var x=this.updateTextureMap(e.id,S.TextureType.Reflection);if(x.imageId){r.push(x);}}return r;};S.prototype.updateTextureMap=function(m,c){var r={textureType:c,imageId:null};var e=this._materials.get(m);if(!e){return r;}var i=e.userData.materialInfo;if(!i){return r;}var l=null;switch(c){case S.TextureType.Diffuse:l=i.textureDiffuse;break;case S.TextureType.Bump:l=i.textureBump;break;case S.TextureType.Opacity:l=i.textureOpacity;break;case S.TextureType.Reflection:l=i.textureReflection;break;case S.TextureType.Emissive:l=i.textureEmissive;break;case S.TextureType.AmbientOcclusion:l=i.textureAmbientOcclusion;break;default:break;}if(!l){return r;}var s=l[0];var v=this._images.get(s.imageId);if(!v){r.imageId=s.imageId;return r;}var w=C.load(v);w.wrapS=s.uvHorizontalTilingEnabled?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping;w.wrapT=s.uvVerticalTilingEnabled?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping;w.magFilter=s.filterMode===1?THREE.NearestFilter:THREE.LinearFilter;w.minFilter=s.filterMode===1?THREE.NearestFilter:THREE.LinearMipMapLinearFilter;w.anisotropy=4;var x=s.influence!==undefined?s.influence:0;var y=s.uvHorizontalScale!==undefined?s.uvHorizontalScale:1;var z=s.uvVerticalScale!==undefined?s.uvVerticalScale:1;var E=s.uvHorizontalOffset!==undefined?s.uvHorizontalOffset:0;var F=s.uvVerticalOffset!==undefined?s.uvVerticalOffset:0;w.repeat.set(y,z);w.center.set(-E,-F);w.offset.set(E,F);w.rotation=-s.uvRotationAngle;switch(c){case S.TextureType.Diffuse:e.map=w;e.transparent|=v.startsWith("data:image/png");break;case S.TextureType.Bump:e.bumpMap=w;e.bumpScale=x;break;case S.TextureType.Opacity:e.alphaMap=w;break;case S.TextureType.Reflection:w.mapping=THREE.SphericalReflectionMapping;e.envMap=w;e.combine=THREE.AddOperation;e.reflectivity=x;break;case S.TextureType.Emissive:e.emissiveMap=w;break;case S.TextureType.AmbientOcclusion:e.aoMap=w;break;default:}e.userData.textureAdded=true;e.needsUpdate=true;return r;};S.prototype.insertPlayback=function(c,v,s){this._resetCurrentScene(s);var e={id:c.id,sequenceId:c.sequenceId,playbackSpeed:c.speed?c.speed:0,playbackPreDelay:c.preDelay?c.preDelay:0,playbackPostDelay:c.postDelay?c.postDelay:0,playbackRepeat:c.repeat?Math.abs(c.repeat):0,playbackReversed:c.reversed?true:false};var i=this._views.get(v);if(i){var l=i.getPlaybacks();if(!l){l=[];}l.push(e);i.setPlaybacks(l);}return this;};S.prototype.insertSequence=function(i){var s=this._sequences.get(i.id);if(!s){var c=[];var e=new THREE.AnimationClip(i.name,-1,c);if(!e.userData){e.userData={};}e.userData.startTime=i.startTime?i.startTime:0;e.userData.endTime=i.endTime?i.endTime:1;e.userData.frameRate=i.frameRate?i.frameRate:30;e.userData.active=i.active?i.active:true;e.userData.cyclic=i.cyclic?i.cyclic:false;e.userData.currentTime=i.currentTime?i.currentTime:0;e.userData.name=i.name?i.name:"";e.userData.nodesEndData=new Map();e.userData.nodesStartData=new Map();this._sequences.set(i.id,e);for(var l=0;l<i.nodes.length;l++){var m=i.nodes[l];var r=this._trackIdSequenceNodeMap.getOrCreate(m.trackId);r.push({sequenceId:i.id,targetId:m.sid,type:m.binding,pivot:m.pivot});}}return this;};S.prototype.insertTrack=function(i){if(!this._nodes){return this;}var e=this._trackIdSequenceNodeMap.get(i.id);var l=function(x,y,z,_){var c=Math.cos(_);var s=Math.sin(_);var r=Math.sqrt(x*x+y*y+z*z);x=x/r;y=y/r;z=z/r;var a1=c+x*x*(1-c);var c1=x*y*(1-c)-z*s;var d1=x*z*(1-c)+y*s;var e1=0;var f1=y*x*(1-c)+z*s;var g1=c+y*y*(1-c);var h1=y*z*(1-c)-x*s;var i1=0;var j1=z*x*(1-c)-y*s;var k1=z*y*(1-c)+x*s;var l1=c+z*z*(1-c);var m1=0;var m=new THREE.Matrix4();m.set(a1,c1,d1,e1,f1,g1,h1,i1,j1,k1,l1,m1,0,0,0,1);return m;};var v=function(_,r){var c=Math.cos(_);var s=Math.sin(_);var a1=1;var c1=0;var d1=0;var e1=0;var f1=0;var g1=1;var h1=0;var i1=0;var j1=0;var k1=0;var l1=1;var m1=0;if(r==="X"){g1=c;h1=-s;k1=s;l1=c;}else if(r==="Y"){a1=c;d1=s;j1=-s;l1=c;}else{a1=c;c1=-s;f1=s;g1=c;}var m=new THREE.Matrix4();m.set(a1,c1,d1,e1,f1,g1,h1,i1,j1,k1,l1,m1,0,0,0,1);return m;};if(e){for(var E=0;E<e.length;E++){var F=this._sequences.get(e[E].sequenceId);if(!F){continue;}var G=this._nodes.get(e[E].targetId);if(!G){continue;}var H=F.userData.nodesEndData.get(G);if(!H){H={};F.userData.nodesEndData.set(G,H);}var I=G.uuid;var J;var K=[];var M=[];var N,Q;var R;var T;var m,W;var X;if(e[E].type==="TRANSLATE"){I+=".position";J=G.position.clone();for(N=0;N<i.keys.length;N++){T=i.keys[N];K.push(T.time);if(T.values.length===3){for(Q=0;Q<3;Q++){M.push(T.values[Q]);}}}if(K.length*3!==M.length){continue;}var Y=new THREE.Vector3(M[M.length-3],M[M.length-2],M[M.length-1]);H.position=Y;R=new THREE.VectorKeyframeTrack(I,K,M);}else if(e[E].type==="SCALE"){I+=".scale";J=G.scale.clone();for(N=0;N<i.keys.length;N++){T=i.keys[N];K.push(T.time);if(T.values.length===1){M.push(T.values[0]);M.push(T.values[0]);M.push(T.values[0]);}else if(T.values.length===3){for(Q=0;Q<3;Q++){M.push(T.values[Q]);}}}if(K.length*3!==M.length){continue;}var Z=new THREE.Vector3(M[M.length-3],M[M.length-2],M[M.length-1]);H.scale=Z;R=new THREE.VectorKeyframeTrack(I,K,M);}else if(e[E].type==="ROTATE"){I+=".quaternion";J=G.quaternion.clone();if(i.type==="euler"){for(N=0;N<i.keys.length;N++){T=i.keys[N];K.push(T.time);var $=T.values[3];$=Math.round($);var _;m=new THREE.Matrix4();for(var oi=0;oi<3;oi++){if(oi===0){_=T.values[0];}else if(oi===1){_=T.values[1];}else{_=T.values[2];}if(($>>(oi*2)&3)===0){W=v(_,"X");m.multiply(W);}else if(($>>(oi*2)&3)===1){W=v(_,"Y");m.multiply(W);}else if(($>>(oi*2)&3)===2){W=v(_,"Z");m.multiply(W);}}X=new THREE.Quaternion();X.setFromRotationMatrix(m);M.push(X.x);M.push(X.y);M.push(X.z);M.push(X.w);}}else if(i.type==="angleAxis"){m=new THREE.Matrix4();for(N=0;N<i.keys.length;N++){T=i.keys[N];K.push(T.time);var x=T.values[0];var y=T.values[1];var z=T.values[2];var w=T.values[3];W=l(x,y,z,w);m.premultiply(W);X=new THREE.Quaternion();X.setFromRotationMatrix(m);M.push(X.x);M.push(X.y);M.push(X.z);M.push(X.w);}}else{for(N=0;N<i.keys.length;N++){T=i.keys[N];K.push(T.time);if(T.values.length===4){for(Q=0;Q<4;Q++){M.push(T.values[Q]);}}}}if(K.length*4!==M.length){continue;}var b1=new THREE.Quaternion(M[M.length-4],M[M.length-3],M[M.length-2],M[M.length-1]);H.quaternion=b1;R=new THREE.QuaternionKeyframeTrack(I,K,M);}else if(e[E].type==="OPACITY"){if(!G.material&&G.children&&G.children.length===1){G=G.children[0];I=G.uuid;}if(G.material&&G.material.opacity){I+=".material.opacity";J=G.material.opacity;}else{continue;}for(N=0;N<i.keys.length;N++){T=i.keys[N];K.push(T.time);M.push(T.values[0]);}H.opacity=M[M.length-1];R=new THREE.NumberKeyframeTrack(I,K,M);}else{continue;}R.userData={};R.userData.originalValue=J;R.userData.info=i;R.userData.type=e[E].type;R.userData.targetNode=G;if(i.interpolationType===1){R.setInterpolation(THREE.InterpolateSmooth);}else{R.setInterpolation(THREE.InterpolateLinear);}F.tracks.push(R);}this._trackIdSequenceNodeMap.delete(i.id);}return this;};S.prototype.finalizeAnimation=function(){var c=this._rootNode;if(c){while(c.parent){c=c.parent;}if(!c.userData){c.userData={};}c.userData.sequences=this._sequences;c.userData.tracks=this._tracks;}return this;};S.prototype.finalizePlaybacks=function(){var c=this._rootNode;if(c){while(c.parent){c=c.parent;}if(!c.userData){c.userData={};}}else{return this;}if(!c.userData.animationNodeOriginalData){c.userData.animationNodeOriginalData=new Map();}var v=this._viewGroups.values();var e=v.next();while(!e.done){var i=e.value;if(!i||!i.views||!i.views.length){e=v.next();continue;}var l=new Map();var m;var r,s,w;for(m=0;m<i.views.length-1;m++){var x=i.views[m].id;var y=i.views[m+1].id;var z=this._views.get(x);var E=this._views.get(y);var F;if(z){var G=z.getPlaybacks();if(G&&G.length){F=G[G.length-1];}}if(F){r=this._sequences.get(F.sequenceId);s=r.userData.nodesEndData.entries();w=s.next();while(!w.done){l.set(w.value[0],w.value[1]);w=s.next();}}var H;if(E){var I=E.getPlaybacks();if(I&&I.length){H=I[I.length-1];}}if(H){r=this._sequences.get(H.sequenceId);s=l.entries();w=s.next();while(!w.done){r.userData.nodesStartData.set(w.value[0],w.value[1]);w=s.next();}}}var J,K,M;for(m=0;m<i.views.length;m++){var N=i.views[m].id;var Q=this._views.get(N);var R;if(Q){var T=Q.getPlaybacks();if(T&&T.length){R=T[T.length-1];}}if(R){r=this._sequences.get(R.sequenceId);J=l.keys();w=J.next();while(!w.done){K=w.value;M=r.userData.nodesStartData.get(K);if(!M){M={};M.position=K.position.clone();M.scale=K.scale.clone();M.quaternion=K.quaternion.clone();r.userData.nodesStartData.set(K,M);}w=J.next();}}else if(Q){Q.animationNodeOriginalData=new Map();J=l.keys();w=J.next();while(!w.done){K=w.value;M={};M.position=K.position.clone();M.scale=K.scale.clone();M.quaternion=K.quaternion.clone();Q.animationNodeOriginalData.set(K,M);w=J.next();}}}J=l.keys();w=J.next();while(!w.done){K=w.value;M={};M.position=K.position.clone();M.scale=K.scale.clone();M.quaternion=K.quaternion.clone();c.userData.animationNodeOriginalData.set(K,M);w=J.next();}e=v.next();}return this;};S.prototype.finalizeViewGroups=function(s){this._resetCurrentScene(s);var c=this._rootNode;if(c){while(c.parent){c=c.parent;}if(!c.userData){c.userData={};}}else{return this;}var v=[];var e=this._viewGroups.entries();var i=e.next();while(!i.done){var l=i.value[1];if(!l||!l.views||!l.views.length){i=e.next();continue;}var m=[];for(var r=0;r<l.views.length;r++){var w=l.views[r].id;var x=this._views.get(w);if(x&&x.userData.viewInfo.thumbnailId&&!x.thumbnailData){var y=this._images.get(x.userData.viewInfo.thumbnailId);if(y){x.thumbnailData=y;}}if(x){m.push(x);}}var z={};z.originalId=i.value[0];z.name=l.name;z.modelViews=m;z.sceneId=i.value[1].sceneId;v.push(z);i=e.next();}c.userData.viewportGroups=v;return this;};S.prototype.insertViewGroup=function(i,s){this._resetCurrentScene(s);this._viewGroups.set(i.id,i);return this;};S.prototype.getViewGroup=function(v,s){this._resetCurrentScene(s);var c=this._viewGroups.get(v);var e=[];if(c&&c.views){for(var i=0;i<c.views.length;i++){var l=c.views[i].id;var m=this._views.get(l);if(m){e.push(m);}}}return e;};S.prototype.insertView=function(v,s){this._resetCurrentScene(s);var c=new sap.ui.vk.View({name:v.name});c.userData={};c.userData.viewInfo=v;if(v.thumbnailId){var i=this._images.get(c.thumbnailId);if(i){c.thumbnailData=i;}}this._views.set(v.id,c);return this;};S.prototype.getView=function(v,s){this._resetCurrentScene(s);return this._views.get(v);};S.prototype.getSequence=function(s){return this._sequences.get(s);};S.prototype.setViewCamera=function(c,v,s){this._resetCurrentScene(s);var e=this._cameras.get(c);var i=this._views.get(v);if(e&&i){i.camera=e;var l=e.getCameraRef();if(e.cameraInfo&&l){var m=true;var r=false;if(e.cameraInfo.zoom===-1){r=true;}if(l.type==="PerspectiveCamera"){i.setCameraInfo({type:l.type,fov:e.cameraInfo.fov*180/Math.PI,position:l.position.toArray(),nearClipPlane:l.near,farClipPlane:l.far,upDirection:l.up.toArray(),targetDirection:l.getWorldDirection().toArray(),usingDefaultClipPlanes:m});}if(l.type==="OrthographicCamera"){i.setCameraInfo({type:l.type,zoomFactor:l.zoom,position:l.position.toArray(),nearClipPlane:l.near,farClipPlane:l.far,upDirection:l.up.toArray(),targetDirection:l.getWorldDirection().toArray(),usingDefaultClipPlanes:m,zoomNeedRecalculate:r});}}}return this;};S.prototype.setViewNodeInfos=function(c,v,s){this._resetCurrentScene(s);var e=this._views.get(v);e.setNodeInfos(c);return this;};S.prototype.setViewThumbnail=function(i,v,s){this._resetCurrentScene(s);var c=this._views.get(v);var e=this._images.get(i);if(c&&e){c.thumbnailData=e;}return this;};S.prototype.cleanup=function(){this._rootNode=null;if(this._nodes){this._nodes.clear();}if(this._NodeMeshIdSubmeshIdsMap){this._NodeMeshIdSubmeshIdsMap.clear();}this._submeshes.clear();this._callouts.clear();this._cameras.clear();this._materials.clear();this._images.clear();this._geometries.clear();this._currentSceneId=null;this._sceneIdTreeNodesMap.clear();this._sceneIdRootNodeMap.clear();this._sceneIdNodMeshIdMap.clear();this._sequences.clear();this._tracks.clear();this._trackIdSequenceNodeMap.clear();this._viewGroups.clear();this._views.clear();this._sceneIdTreeNodesMap.clear();this._sceneIdRootNodeMap.clear();this._sceneIdNodMeshIdMap.clear();this._sceneIdViewGroupMap.clear();this._sceneIdViewMap.clear();S._map.delete(this._id);};return S;});
