/*!
* SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
*/
sap.ui.define(["jquery.sap.global","sap/ui/base/ManagedObject","./thirdparty/three","sap/ui/vk/totara/TotaraLoader","./PerspectiveCamera","./OrthographicCamera","sap/ui/vk/View","./Material"],function(q,M,t,T,P,O,V,a){"use strict";var C=M.extend("sap.ui.vk.threejs.ContentDeliveryService",{metadata:{properties:{authorizationHandler:"any"},events:{cameraChanged:{parameters:{sceneId:{type:"string"},camera:{type:"any"}},enableEventBubbling:true},sceneUpdated:{parameters:{},enableEventBubbling:true},viewGroupUpdated:{parameters:{},enableEventBubbling:true},errorReported:{parameters:{error:{type:"any"}}}}}});var b=C.getMetadata().getParent().getClass().prototype;C.prototype.init=function(){if(b.init){b.init.call(this);}this._loader=null;this._transientSceneMap=new Map();this._currentNodeHierarchy=null;};C.prototype.initUrl=function(u,k){var c=this;function n(){c.fireSceneUpdated({});}function d(){c.fireViewGroupUpdated({});}if(!c._loader||c._loader.getUrl()!==u){this._loader=new T();var s=this._loader.getState();s.onErrorCallbacks.attach(this._reportError.bind(c));s.onMaterialFinishedCallbacks.attach(n);s.onImageFinishedCallbacks.attach(n);s.onSetGeometryCallbacks.attach(n);s.onViewGroupUpdatedCallbacks.attach(d);return this._loader.init(u);}else if(!k){var e=this._loader.getState();if(e){e.cleanup();}}return Promise.resolve("Loader is ready");};C.prototype._reportError=function(e){this.fireErrorReported(e);};C.prototype._createLoadParam=function(r,c,p,d){var e=this;var i;var s=false;var f={root:p,includeHidden:d.getIncludeHidden(),includeAnimation:d.getIncludeAnimation(),pushPMI:d.getPushPMI(),metadataFilter:d.getMetadataFilter(),useSecureConnection:d.getUseSecureConnection(),activateView:d.getActivateView(),enableLogger:d.getEnableLogger()===true,pushViewGroups:d.getPushViewGroups(),onActiveCamera:function(n){var h=false;var j=e._loader.getState();if(j){var k=j.contextMap.get(d.getVeid());if(k&&k.phase<2){i=n;h=true;}}if(!h){e.fireCameraChanged({sceneId:d.getVeid(),camera:n});}},onInitialSceneFinished:function(){s=true;r({node:p,camera:i,contentResource:d,loader:e});}};var g=function(h){var j;if(h.getParameter("errorText")){j=h.getParameter("errorText");}else if(h.getParameter("error")){j=h.getParameter("error");}else if(h.getParameter("reason")){j=h.getParameter("reason");}else{j="failed to load: unknown reason";}if(s){var k=h.getParameter("error");if(k&&k===4){this.initUrl(this._loader.getUrl(),true);}}else{e.detachErrorReported(g);if(h.getParameter("events")){j=j+"\n"+JSON.stringify(h.getParameter("events"));}c(j);}};e.attachErrorReported(g);return f;};C.prototype.load=function(p,c,d){var e=this;var n=c.getNodeProxy();if(n){this._currentNodeHierarchy=n.getNodeHierarchy();}return new Promise(function(r,f){if(!c.getSource()||!c.getVeid()){f("url or veid not specified");return;}e.initUrl(c.getSource(),true);var g=e._createLoadParam(r,f,p,c);if(e._loader){e._loader.request(c.getVeid(),g,d);}});};C.prototype.getState=function(){if(this._loader){return this._loader.getState();}return null;};C.prototype.getSceneBuilder=function(){if(this._loader){return this._loader.getSceneBuilder();}return null;};C.prototype.decrementResourceCountersForDeletedTreeNode=function(s){var c=this.getState();if(c){var d=c.getContext(c.currentSceneInfo.id);this._loader.decrementResourceCountersForDeletedTreeNode(c,d,s);}};C.prototype.loadTransientScene=function(s,p,u){var c=this;return new Promise(function(r,d){if(!s||!p){d("invalid arguments");return;}if(c._transientSceneMap.has(s)){var e=c._transientSceneMap.get(s).clone();p.add(e);r({nodeRef:e});return;}if(!c._loader){d("ContentDeliveryService is not initialised");return;}var f=new THREE.Object3D();f.name="transient";var o=function(){var h=c._loader.getState().getContext(s);h.onSceneCompletedCallbacks.detach(o);c._transientSceneMap.set(s,f);var e=f.clone();p.add(e);r({nodeRef:e});};var g={root:f,onSceneCompleted:o,useSecureConnection:u};c._loader.request(s,g);});};C.prototype.update=function(s,c,v){var d=this;return new Promise(function(r,e){if(!d._loader){e("ContentDeliveryService is not initialised");return;}d._loader.update(s,c,v).then(function(f){if(d._currentNodeHierarchy){for(var i=0;i<f.replacedNodeRefs.length;i++){d._currentNodeHierarchy.fireNodeReplaced({ReplacedNodeRef:f.replacedNodeRefs[i],ReplacementNodeRef:f.replacementNodeRefs[i],ReplacedNodeId:f.replacedNodeRefs[i],ReplacementNodeId:f.replacementNodeRefs[i]});}}r({sceneVeId:f.sceneVeId,sids:f.sidArray});}).catch(function(f){return e(f);});});};C.prototype.exit=function(){if(b.exit){b.exit.call(this);}if(this._loader){this._loader.dispose();this._loader=null;}this._transientSceneMap=null;};C.prototype.loadView=function(s,v,c,u){if(typeof c==="undefined"){c="static";}var d=this;return this._loader.requestView(s,c,v,u).then(function(e){if(d._currentNodeHierarchy){for(var i=0;i<e.updatedNodes.length;i++){d._currentNodeHierarchy.fireNodeUpdated({nodeRef:e.updatedNodes[i]});}}d.fireSceneUpdated({});return e;}).catch(function(e){q.sap.log.error(e);return null;});};C.prototype.loadViewGroup=function(s,v){var c=this;return this._loader.requestViewGroup(s,v).then(function(d){c.fireSceneUpdated({});return d;}).catch(function(e){q.sap.log.error(e);return null;});};C.prototype.assignMaterialToNodes=function(s,m,n,c){var d=this;return this._loader.requestMaterial(m).then(function(e){function f(e,k,r){if(!k){return;}if(k.userData.markedForNotAssigningMaterial){delete k.userData.markedForNotAssigningMaterial;return;}if(d._currentNodeHierarchy){var l=d._currentNodeHierarchy.createNodeProxy(k);var o=new a();o.setMaterialRef(e);l.assignMaterial(o);}if(r){k.children.forEach(function(p){if(!p){return;}f(e,p,r);});}}if(!c){for(var i=0;i<n.length;i++){f(e,n[i]);}}else{for(var j=0;j<n.length;j++){n[j].userData.markedForNotAssigningMaterial=true;}var g=d._loader.getState().contextMap.get(s);var h=g.root;f(e,h,true);}d.fireSceneUpdated({});return true;}).catch(function(e){q.sap.log.error(e);return false;});};C.prototype.printLogTokens=function(){if(this._loader){this._loader.printLogTokens();return true;}else{return false;}};return C;});
