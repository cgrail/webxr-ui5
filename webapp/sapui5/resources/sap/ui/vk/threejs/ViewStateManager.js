/*!
* SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
*/
sap.ui.define(["jquery.sap.global","sap/ui/core/Element","../ContentConnector","../ViewStateManagerBase","./thirdparty/three"],function(q,E,C,V,t){"use strict";var a;var b=V.extend("sap.ui.vk.threejs.ViewStateManager",{metadata:{}});var d=b.getMetadata().getParent().getClass().prototype;b.prototype.init=function(){if(d.init){d.init.call(this);}this._nodeHierarchy=null;this._nodeStates=new Map();this._selectedNodes=new Set();this._visibilityTracker=new a();this._showSelectionBoundingBox=true;this._boundingBoxesScene=new THREE.Scene();this.setHighlightColor("rgba(255, 0, 0, 1.0)");};b.prototype._setContent=function(c){var s=null;if(c&&c instanceof sap.ui.vk.threejs.Scene){s=c;}this._setScene(s);};b.prototype._onAfterUpdateContentConnector=function(){this._setContent(this._contentConnector.getContent());};b.prototype._onBeforeClearContentConnector=function(){this._setScene(null);};b.prototype._handleContentReplaced=function(e){var c=e.getParameter("newContent");this._setContent(c);};b.prototype._setScene=function(s){this._boundingBoxesScene=new THREE.Scene();this._setNodeHierarchy(s?s.getDefaultNodeHierarchy():null);if(s){s.setViewStateManager(this);}return this;};b.prototype._setNodeHierarchy=function(n){var o=this._nodeHierarchy;if(this._nodeHierarchy){this._nodeHierarchy=null;this._nodeStates.clear();this._selectedNodes.clear();this._visibilityTracker.clear();}if(n){this._nodeHierarchy=n;this._nodeHierarchy.attachNodeReplaced(this._handleNodeReplaced,this);this._nodeHierarchy.attachNodeUpdated(this._handleNodeUpdated,this);this._initialState={visible:[],hidden:[]};var c=this;var e=n.findNodesByName();e.forEach(function(f){(f.visible?c._initialState.visible:c._initialState.hidden).push(f);});this.fireVisibilityChanged({visible:this._initialState.visible,hidden:this._initialState.hidden});}if(n!==o){this.fireNodeHierarchyReplaced({oldNodeHierarchy:o,newNodeHierarchy:n});}return this;};b.prototype._handleNodeReplaced=function(e){var r=e.getParameter("ReplacedNodeRef");var c=e.getParameter("ReplacementNodeRef");if(this.getSelectionState(r)){this.setSelectionState(c,true);this.setSelectionState(r,false);}};b.prototype._handleNodeUpdated=function(e){var n=e.getParameter("nodeRef");if(this.getSelectionState(n)){this.setSelectionState(n,false);this.setSelectionState(n,true);}};b.prototype.getNodeHierarchy=function(){return this._nodeHierarchy;};b.prototype.getVisibilityChanges=function(){return this.getShouldTrackVisibilityChanges()?this._visibilityTracker.getInfo(this.getNodeHierarchy()):null;};b.prototype.getVisibilityComplete=function(){var n=this.getNodeHierarchy(),c=n.findNodesByName(),v=[],h=[];c.forEach(function(e){var f=n.createNodeProxy(e);var g=f.getVeId();n.destroyNodeProxy(f);if(g){if(this.getVisibilityState(e)){v.push(g);}else{h.push(g);}}},this);return{visible:v,hidden:h};};b.prototype.resetVisibility=function(){this.setVisibilityState(this._initialState.visible,true,false);this.setVisibilityState(this._initialState.hidden,false,false);this._visibilityTracker.clear();};b.prototype.getVisibilityState=function(n){return Array.isArray(n)?n.map(function(c){return c.visible;}):n.visible;};b.prototype.setVisibilityState=function(n,v,r){if(!Array.isArray(n)){n=[n];}n=(r?this._collectNodesRecursively(n):n).filter(function(e,i,s){return s.indexOf(e)===i;});var c=n.filter(function(e){return e.visible!=v;},this);if(c.length>0){c.forEach(function(e){e.visible=v;if(v){var f=this._nodeHierarchy.getAncestors(e);this.setVisibilityState(f,true,false);}},this);if(this.getShouldTrackVisibilityChanges()){c.forEach(this._visibilityTracker.trackNodeRef,this._visibilityTracker);}this.fireVisibilityChanged({visible:v?c:[],hidden:v?[]:c});}return this;};b.prototype.enumerateSelection=function(c){this._selectedNodes.forEach(c);return this;};b.prototype.getSelectionState=function(n){var s=this._selectedNodes;function i(c){return s.has(c);}return Array.isArray(n)?n.map(i):i(n);};b.prototype._isAChild=function(c,n){var e=c.parent;while(e){if(n.has(e)){return true;}e=e.parent;}return false;};THREE.Box3.prototype._setFromObjectExcludingHotSpotAndPMI=function(o){this.makeEmpty();var v=new THREE.Vector3();var c=this;o.updateMatrixWorld(true);o.traverse(function(n){var u=n.userData;if(u){if(u.treeNode){if(u.treeNode.contentType==="HOTSPOT"){u.isHotspot=true;}else if(u.treeNode.contentType==="PMI"){u.isPMI=true;}}if(n.parent){if(n.parent.userData){if(n.parent.userData.isHotspot){u.isHotspot=true;}else if(n.parent.userData.isPMI){u.isPMI=true;}}}if(u.isHotspot||u.isPMI){return;}}var i,l;var g=n.geometry;if(g!==undefined){if(g.isGeometry){var e=g.vertices;for(i=0,l=e.length;i<l;i++){v.copy(e[i]);v.applyMatrix4(n.matrixWorld);c.expandByPoint(v);}}else if(g.isBufferGeometry){var f=g.attributes.position;if(f!==undefined){for(i=0,l=f.count;i<l;i++){v.fromBufferAttribute(f,i).applyMatrix4(n.matrixWorld);c.expandByPoint(v);}}}}});return this;};THREE.Object3D.prototype._vkCalculateObjectOrientedBoundingBox=function(){var p=this.parent,m=this.matrix.clone(),c=this.matrixAutoUpdate;this.parent=null;this.matrix.identity();this.matrixAutoUpdate=false;this.userData.boundingBox._setFromObjectExcludingHotSpotAndPMI(this);this.matrixAutoUpdate=c;this.matrix.copy(m);this.parent=p;this.updateMatrixWorld(true);};b.prototype._AddBoundingBox=function(n){if(n.userData.boundingBox===undefined){n.userData.boundingBox=new THREE.Box3();n._vkCalculateObjectOrientedBoundingBox();}if(!n.userData.boundingBox.isEmpty()&&this._boundingBoxesScene&&n.userData.boxHelper===undefined){var c=new THREE.Box3Helper(n.userData.boundingBox,0xffff00);this._boundingBoxesScene.add(c);c.parent=n;n.userData.boxHelper=c;}};b.prototype._RemoveBoundingBox=function(n){if(n.userData.boundingBox!==undefined){delete n.userData.boundingBox;}if(n.userData.boxHelper!==undefined){this._boundingBoxesScene.remove(n.userData.boxHelper);delete n.userData.boxHelper;}};b.prototype._updateBoundingBoxesIfNeeded=function(){var u=new Set();this._selectedNodes.forEach(function(n){var p=n.parent;while(p){if(this._selectedNodes.has(p)){u.add(p);}p=p.parent;}}.bind(this));u.forEach(function(n){n._vkCalculateObjectOrientedBoundingBox();});};b.prototype.setShowSelectionBoundingBox=function(v){this._showSelectionBoundingBox=v;if(this._showSelectionBoundingBox){this._selectedNodes.forEach(function(n){this._AddBoundingBox(n);}.bind(this));}else{this._selectedNodes.forEach(function(n){this._RemoveBoundingBox(n);}.bind(this));}this.fireSelectionChanged({selected:this._selectedNodes,unselected:[]});};b.prototype.getShowSelectionBoundingBox=function(){return this._showSelectionBoundingBox;};THREE.Object3D.prototype.defaultEmissive={r:0.0235,g:0.0235,b:0.0235};THREE.Object3D.prototype.defaultSpecular={r:0.0602,g:0.0602,b:0.0602};THREE.Object3D.prototype._vkTraverseNodeGeometry=function(c){c(this);for(var i=0,l=this.children.length;i<l;i++){var e=this.children[i];if(e.geometry!==undefined&&!e.name&&e.children.length===0){c(e);}}};THREE.Object3D.prototype._vkSetTintColor=function(c){this._vkTraverseNodeGeometry(function(n){n.userData.tintColor=c;n._vkUpdateMaterialColor();});};THREE.Object3D.prototype._vkSetOpacity=function(o){this._vkTraverseNodeGeometry(function(n){n.userData.opacity=o;n._vkUpdateMaterialOpacity();});};THREE.Object3D.prototype._vkUpdateMaterialColor=function(){if(!this.material||!this.material.color){return;}var u=this.userData;if(u.originalMaterial){if(u.originalMaterial.color.r===undefined){u.originalMaterial=null;}else if(u.originalMaterial.userData&&u.originalMaterial.userData.textureAdded){this.material=u.originalMaterial.clone();if(u.opacity){this.material.opacity*=u.opacity;this.material.transparent=this.material.transparent||this.material.opacity<0.99;}delete u.originalMaterial.userData.textureAdded;}else{this.material.color.copy(u.originalMaterial.color);if(this.material.emissive!==undefined){this.material.emissive.copy(u.originalMaterial.emissive);}if(this.material.specular!==undefined){this.material.specular.copy(u.originalMaterial.specular);}}}if(u.highlightColor!==undefined||u.tintColor!==undefined){if(!u.originalMaterial){u.originalMaterial=this.material;this.material=this.material.clone();}var c;if(u.tintColor!==undefined){c=sap.ui.vk.abgrToColor(u.tintColor);this.material.color.lerp(new THREE.Color(c.red/255.0,c.green/255.0,c.blue/255.0),c.alpha);if(this.material.emissive!==undefined){if(this.material.userData.defaultHighlightingEmissive){this.material.emissive.copy(this.material.userData.defaultHighlightingEmissive);}else{this.material.emissive.copy(THREE.Object3D.prototype.defaultEmissive);}}if(this.material.specular!==undefined){if(this.material.userData.defaultHighlightingSpecular){this.material.specular.copy(this.material.userData.defaultHighlightingSpecular);}else{this.material.specular.copy(THREE.Object3D.prototype.defaultSpecular);}}}if(u.highlightColor!==undefined){c=sap.ui.vk.abgrToColor(u.highlightColor);this.material.color.lerp(new THREE.Color(c.red/255.0,c.green/255.0,c.blue/255.0),c.alpha);if(this.material.emissive!==undefined){if(this.material.userData.defaultHighlightingEmissive){this.material.emissive.copy(this.material.userData.defaultHighlightingEmissive);}else{this.material.emissive.copy(THREE.Object3D.prototype.defaultEmissive);}}if(this.material.specular!==undefined){if(this.material.userData.defaultHighlightingSpecular){this.material.specular.copy(this.material.userData.defaultHighlightingSpecular);}else{this.material.specular.copy(THREE.Object3D.prototype.defaultSpecular);}}}}};THREE.Object3D.prototype._vkUpdateMaterialOpacity=function(){if(!this.material){return;}var u=this.userData;if(u.originalMaterial){this.material.opacity=u.originalMaterial.opacity;this.material.transparent=u.originalMaterial.transparent;}if(u.opacity!==undefined){if(!u.originalMaterial){u.originalMaterial=this.material;this.material=this.material.clone();}if(this.material.opacity){this.material.opacity*=u.opacity;this.material.transparent=this.material.transparent||this.material.opacity<0.99;}}};b.prototype._isAncestorSelected=function(n){n=n.parent;while(n){if(this._selectedNodes.has(n)){return true;}n=n.parent;}return false;};b.prototype._updateHighlightColor=function(n,p){var s=p||this._selectedNodes.has(n);n.userData.highlightColor=s?this._highlightColorABGR:undefined;n._vkUpdateMaterialColor();var c=n.children;for(var i=0,l=c.length;i<l;i++){var u=c[i].userData;if(u&&u.treeNode&&u.treeNode.contentType==="HOTSPOT"){continue;}this._updateHighlightColor(c[i],s);}};b.prototype.setSelectionState=function(n,s,r,c){if(!Array.isArray(n)){n=[n];}n=(r||this.getRecursiveSelection()?this._collectNodesRecursively(n):n).filter(function(v,i,f){return f.indexOf(v)===i;});if(this.getRecursiveSelection()&&!s){n=this._nodeHierarchy._appendAncestors(n);}var e=n.filter(function(f){return this._selectedNodes.has(f)!==s;},this);if(e.length>0){e.forEach(function(f){this._selectedNodes[s?"add":"delete"](f);if(this._showSelectionBoundingBox){this[s?"_AddBoundingBox":"_RemoveBoundingBox"](f);}},this);e.forEach(function(f){this._updateHighlightColor(f,s||this._isAncestorSelected(f));},this);if(!c){this.fireSelectionChanged({selected:s?e:[],unselected:s?[]:e});}}return this;};b.prototype.setSelectionStates=function(s,u,r,c){if(!Array.isArray(s)){s=[s];}if(!Array.isArray(u)){u=[u];}s=(r||this.getRecursiveSelection()?this._collectNodesRecursively(s):s);u=(r||this.getRecursiveSelection()?this._collectNodesRecursively(u):u);if(this.getRecursiveSelection()){u=this._nodeHierarchy._appendAncestors(u,s);}var e=s.filter(function(n){return this._selectedNodes.has(n)===false;},this);var f=u.filter(function(n){return this._selectedNodes.has(n)===true;},this);if(e.length>0||f.length>0){e.forEach(function(n){this._selectedNodes.add(n);this._updateHighlightColor(n,true);if(this._showSelectionBoundingBox){this._AddBoundingBox(n);}},this);f.forEach(function(n){this._selectedNodes.delete(n);if(this._showSelectionBoundingBox){this._RemoveBoundingBox(n);}},this);f.forEach(function(n){this._updateHighlightColor(n,this._isAncestorSelected(n));},this);if(!c){this.fireSelectionChanged({selected:e,unselected:f});}}return this;};b.prototype._collectNodesRecursively=function(n){var r=[],c=this;n.forEach(function collectChildNodes(e){r.push(e);c._nodeHierarchy.enumerateChildren(e,collectChildNodes,false,true);});return r;};b.prototype._getOpacity=function(n){return n.userData.opacity!==undefined?n.userData.opacity:null;};b.prototype.getOpacity=function(n){if(Array.isArray(n)){return n.map(this._getOpacity,this);}else{return this._getOpacity(n);}};b.prototype.setOpacity=function(n,o,r){if(!Array.isArray(n)){n=[n];}n=(r?this._collectNodesRecursively(n):n).filter(function(v,i,s){return s.indexOf(v)===i;});if(o===null){o=undefined;}var c=n.filter(function(e){return e.userData.opacity!==o;},this);if(c.length>0){c.forEach(function(e){e._vkSetOpacity(o);},this);this.fireOpacityChanged({changed:c,opacity:o});}return this;};b.prototype._getTintColorABGR=function(n){return n.userData.tintColor!==undefined?n.userData.tintColor:null;};b.prototype._getTintColor=function(n){return n.userData.tintColor!==undefined?sap.ui.vk.colorToCSSColor(sap.ui.vk.abgrToColor(n.userData.tintColor)):null;};b.prototype.getTintColor=function(n,i){var g=i?"_getTintColorABGR":"_getTintColor";if(Array.isArray(n)){return n.map(this[g],this);}else{return this[g](n);}};b.prototype.setTintColor=function(n,c,r){if(!Array.isArray(n)){n=[n];}var e=null;switch(typeof c){case"number":e=c;break;case"string":if(sap.ui.core.CSSColor.isValid(c)){e=sap.ui.vk.colorToABGR(sap.ui.vk.cssColorToColor(c));}break;default:c=null;break;}n=(r?this._collectNodesRecursively(n):n).filter(function(v,i,s){return s.indexOf(v)===i;});var f=n.filter(function(g){return g.userData.tintColor!==e;},this);if(f.length>0){f.forEach(function(g){g._vkSetTintColor(e);},this);this.fireTintColorChanged({changed:f,tintColor:c,tintColorABGR:e});}return this;};b.prototype.setHighlightColor=function(c){switch(typeof c){case"number":this._highlightColorABGR=c;break;case"string":if(sap.ui.core.CSSColor.isValid(c)){this._highlightColorABGR=sap.ui.vk.colorToABGR(sap.ui.vk.cssColorToColor(c));}break;default:return this;}if(this._selectedNodes.size>0){this._selectedNodes.forEach(function(n){this._updateHighlightColor(n,true);},this);}this.fireHighlightColorChanged({highlightColor:sap.ui.vk.colorToCSSColor(sap.ui.vk.abgrToColor(this._highlightColorABGR)),highlightColorABGR:this._highlightColorABGR});return this;};b.prototype.getHighlightColor=function(i){return i?this._highlightColorABGR:sap.ui.vk.colorToCSSColor(sap.ui.vk.abgrToColor(this._highlightColorABGR));};a=function(){this._visibilityChanges=new Set();};a.prototype.getInfo=function(n){var c=[];this._visibilityChanges.forEach(function(e){var f=n.createNodeProxy(e);var v=f.getVeId();n.destroyNodeProxy(f);if(v){c.push(v);}else{c.push(n.getScene().nodeRefToPersistentId(e));}});return c;};a.prototype.clear=function(){this._visibilityChanges.clear();};a.prototype.trackNodeRef=function(n){if(this._visibilityChanges.has(n)){this._visibilityChanges.delete(n);}else{this._visibilityChanges.add(n);}};C.injectMethodsIntoClass(b);return b;});
