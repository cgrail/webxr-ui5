/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["jquery.sap.global","../library","../ViewportBase","sap/ui/core/ResizeHandler","../Loco","./thirdparty/three","../ContentConnector","../ViewStateManager","./ViewportGestureHandler","./OrthographicCamera","./PerspectiveCamera","./NodesTransitionHelper","../Messages","sap/ui/base/ManagedObjectObserver","./ViewportRenderer"],function(q,l,V,R,L,a,C,b,c,O,P,N,M,d,f){"use strict";var g=V.extend("sap.ui.vk.threejs.Viewport",{metadata:{library:"sap.ui.vk",properties:{renderMode:{type:"sap.ui.vk.RenderMode",defaultValue:sap.ui.vk.RenderMode.Default}},events:{cameraChanged:{parameters:{position:"float[]",quaternion:"float[]",zoom:"float"},enableEventBubbling:true},cameraUpdateCompleted:{parameters:{position:"float[]",quaternion:"float[]",zoom:"float"},enableEventBubbling:true}}}});var j=g.getMetadata().getParent().getClass().prototype;g.prototype.init=function(){if(j.init){j.init.call(this);}this._resizeListenerId=null;this._renderLoopRequestId=0;this._renderLoopFunction=this._renderLoop.bind(this);this._shouldRenderFrame=true;this._clippingPlanes=[];this._animationMixer=null;this._currentPlaybacks=null;this._clock=new THREE.Clock(false);this._renderer=new THREE.WebGLRenderer({antialias:true,alpha:true});this._renderer.setPixelRatio(window.devicePixelRatio);this._renderer.setSize(1,1);this._renderer.shadowMap.enabled=true;this._camera=new P();var e=["varying float vPos;","void main() {","	gl_Position = vec4(position, 1.0);","	vPos = position.y * -0.5 + 0.5;","}"].join("\n");var h=["uniform vec4 topColor;","uniform vec4 bottomColor;","varying float vPos;","void main() {","	gl_FragColor = mix(topColor, bottomColor, vPos);","}"].join("\n");var i=new THREE.Vector4();var k=new THREE.Vector4();this._updateColor(i,this.getBackgroundColorTop());this._updateColor(k,this.getBackgroundColorBottom());this._checkBackgroundColor();this._backgroundMaterial=new THREE.ShaderMaterial({uniforms:{topColor:{value:i},bottomColor:{value:k}},vertexShader:e,fragmentShader:h,side:THREE.DoubleSide,depthTest:false,depthWrite:false,blending:THREE.NoBlending});var m=new THREE.Geometry();m.vertices.push(new THREE.Vector3(-1,1,0),new THREE.Vector3(1,1,0),new THREE.Vector3(-1,-1,0),new THREE.Vector3(1,-1,0));m.faces.push(new THREE.Face3(0,2,1),new THREE.Face3(1,2,3));this._backgroundCamera=new THREE.Camera();this._backgroundScene=new THREE.Scene();this._backgroundScene.add(new THREE.Mesh(m,this._backgroundMaterial));var x=["#include <clipping_planes_pars_vertex>","varying vec3 vNormal;","void main() {","#include <begin_vertex>","#include <project_vertex>","#include <clipping_planes_vertex>","#include <beginnormal_vertex>","#include <defaultnormal_vertex>","	vNormal = normalize( transformedNormal );","}"].join("\n");var n=["#include <clipping_planes_pars_fragment>","uniform vec4 color1;","uniform vec4 color2;","varying vec3 vNormal;","void main() {","#include <clipping_planes_fragment>","	gl_FragColor = mix(color1, color2, abs(normalize(vNormal).z));","}"].join("\n");this._xrayColor1=new THREE.Vector4(0,0.75,1,0.45);this._xrayColor2=new THREE.Vector4(0,0,1,0);this._xrayMaterial=new THREE.ShaderMaterial({uniforms:{color1:{value:this._xrayColor1},color2:{value:this._xrayColor2}},vertexShader:x,fragmentShader:n,side:THREE.DoubleSide,depthWrite:false,depthFunc:THREE.LessDepth,blending:THREE.NormalBlending,clipping:true,transparent:true});this._viewportGestureHandler=new c(this);this._loco=new L();this._loco.addHandler(this._viewportGestureHandler);this._zoomedObject=null;this._nodesTransitionHelper=new N();this._nodesTransitionHelper.setViewport(this);this._cdsLoader=null;this.attachCameraChanged(function(s){this.setShouldRenderFrame();});this.attachCameraUpdateCompleted(function(s){var t=function(v){v.startAnimation();};var u=this;setTimeout(t,20,u);});this._sceneObserver=new d(this.setShouldRenderFrame.bind(this));this._currentViews=null;this._currentViewIndex=0;this._playingProcedure=false;};g.prototype.exit=function(){this._loco.removeHandler(this._viewportGestureHandler);this._viewportGestureHandler.destroy();if(this._resizeListenerId){R.deregister(this._resizeListenerId);this._resizeListenerId=null;}this._stopRenderLoop();this.setScene(null);this.setCamera(null);this._renderer=null;this._backgroundCamera=null;this._backgroundMaterial=null;this._backgroundScene=null;this._loco=null;this._viewportGestureHandler=null;if(this._cdsLoader){this._cdsLoader.detachSceneUpdated(this._handleCdsSceneUpdate,this);}if(j.exit){j.exit.call(this);}};g.prototype._startRenderLoop=function(){if(!this._renderLoopRequestId){this._renderLoopRequestId=window.requestAnimationFrame(this._renderLoopFunction);}return this;};g.prototype._stopRenderLoop=function(){if(this._renderLoopRequestId){window.cancelAnimationFrame(this._renderLoopRequestId);this._renderLoopRequestId=0;}return this;};g.prototype.setBackgroundColorTop=function(v){j.setBackgroundColorTop.call(this,v);if(this._backgroundMaterial!==null){this._updateColor(this._backgroundMaterial.uniforms.topColor.value,v);this._checkBackgroundColor();}return this;};g.prototype.setBackgroundColorBottom=function(v){j.setBackgroundColorBottom.call(this,v);if(this._backgroundMaterial!==null){this._updateColor(this._backgroundMaterial.uniforms.bottomColor.value,v);this._checkBackgroundColor();}return this;};g.prototype.setClippingPlanes=function(e){this._clippingPlanes=e;return this;};g.prototype.onBeforeRendering=function(){if(this._resizeListenerId){R.deregister(this._resizeListenerId);this._resizeListenerId=null;}this._stopRenderLoop();};g.prototype.onAfterRendering=function(){var e=this.getDomRef();e.appendChild(this._renderer.domElement);this._resizeListenerId=R.register(this,this._handleResize.bind(this));this._handleResize({size:{width:e.clientWidth,height:e.clientHeight}});this._startRenderLoop();};g.prototype._handleResize=function(e){if(!this._camera||!this._renderer){return false;}var w=e.size.width;var h=e.size.height;if(this._camera){this._camera.update(w,h);}this._renderer.setSize(w,h);this.fireResize({size:{width:w,height:h}});this.setShouldRenderFrame();return true;};g.prototype.setScene=function(s){this._scene=s;this._homeCamera=null;this._sceneObserver.disconnect();var n=this._scene?this._scene.getSceneRef():undefined;if(n){this._sceneObserver.observe(this._scene,{properties:["doubleSided"]});var e;for(var i=0;i<n.children.length;i++){e=n.children[i];if(e.private&&e.name==="DefaultLights"&&e.children.length){if(e.children[0]instanceof THREE.PointLight){this._eyePointLight=e.children[0];}}}}this.setShouldRenderFrame();return this;};g.prototype.getScene=function(){return this._scene;};g.prototype.setCamera=function(e){if(j.setCamera){j.setCamera.call(this,e);}var h=this.getCamera();if(h&&this._renderer){var s=this._renderer.getSize();h.update(s.width,s.height);if(!this._homeCamera&&h.getCameraRef()){this._homeCamera=h.getCameraRef().clone();}}this.setShouldRenderFrame();return this;};g.prototype.getRenderer=function(){return this._renderer;};g.prototype._getViewStateManagerThreeJS=function(){if(this._viewStateManager){if(this._viewStateManager instanceof sap.ui.vk.threejs.ViewStateManager){return this._viewStateManager;}if(this._viewStateManager instanceof sap.ui.vk.ViewStateManager&&this._viewStateManager._implementation instanceof sap.ui.vk.threejs.ViewStateManager){return this._viewStateManager._implementation;}}return null;};g.prototype._updateBoundingBoxesIfNeeded=function(){var v=this._getViewStateManagerThreeJS();if(v){v._updateBoundingBoxesIfNeeded();}};g.prototype._updateColor=function(e,h){var i=sap.ui.vk.cssColorToColor(h);e.color=new THREE.Color(i.red/255,i.green/255,i.blue/255);e.alpha=i.alpha;e.x=e.color.r*e.alpha;e.y=e.color.g*e.alpha;e.z=e.color.b*e.alpha;e.w=e.alpha;};g.prototype._checkBackgroundColor=function(){var e=this.getBackgroundColorTop();if(e===this.getBackgroundColorBottom()){if(this._backgroundColor===null){this._backgroundColor=new THREE.Vector4();}this._updateColor(this._backgroundColor,e);}else{this._backgroundColor=null;}this.setShouldRenderFrame();};g.prototype._handleCdsSceneUpdate=function(){this.setShouldRenderFrame();};g.prototype.setShouldRenderFrame=function(){this._shouldRenderFrame=true;return this;};g.prototype.shouldRenderFrame=function(){return this._shouldRenderFrame;};g.prototype.setRenderMode=function(e){this.setProperty("renderMode",e,true);if(this._scene){switch(e){case sap.ui.vk.RenderMode.LineIllustration:case sap.ui.vk.RenderMode.ShadedIllustration:case sap.ui.vk.RenderMode.SolidOutline:this._scene._createOutlineGeometry(e);break;default:this._scene._hideOutlineGeometry();break;}}this.setShouldRenderFrame();return this;};g.prototype.hitTest=function(x,y){var n=this._scene?this._scene.getSceneRef():undefined;var e=this._camera?this._camera.getCameraRef():undefined;if(!e||!n){return null;}var h=this._renderer.domElement;var m=new THREE.Vector2((x-h.clientLeft)/h.clientWidth*2-1,(h.clientTop-y)/h.clientHeight*2+1);var k=new THREE.Raycaster();k.setFromCamera(m,e);if(this._clippingPlanes){for(var i in this._clippingPlanes){var s=this._clippingPlanes[i];var u=s.distanceToPoint(k.ray.origin),t=-u/s.normal.dot(k.ray.direction);if(t>0){if(u<0){k.near=Math.max(k.near,t);}else{k.far=Math.min(k.far,t);}}else if(u<0){return null;}}}var v=k.intersectObjects(n.children,true);if(v&&v.length){var w=v[0];if(!w.object.name&&w.object.children.length===0){w.object=w.object.parent;}return w;}return null;};g.prototype.tap=function(x,y,i){if(!i){if(this._viewStateManager){var h=this.hitTest(x,y);var n=h&&h.object;var e={picked:n?[n]:[]};this.fireNodesPicked(e);if(this.getSelectionMode()===sap.ui.vk.SelectionMode.Exclusive){this.exclusiveSelectionHandler(e.picked);}else if(this.getSelectionMode()===sap.ui.vk.SelectionMode.Sticky){this.stickySelectionHandler(e.picked);}if(n!==null){this.fireNodeClicked({nodeRef:n,x:x,y:y},true,true);}}}else if(!this.getFreezeCamera()){var k=this.hitTest(x,y);if(k&&(this._zoomedObject===null||this._zoomedObject!==k.object)){this._zoomedObject=k.object;this._viewportGestureHandler.zoomObject(this._zoomedObject,true);}else{this._viewportGestureHandler.zoomObject(this._zoomedObject,false);this._zoomedObject=null;}}return this;};var o={x:-2,y:-2};var r=2;var p=5;[{key:"left",dx:-r,dy:0},{key:"right",dx:+r,dy:0},{key:"up",dx:0,dy:-r},{key:"down",dx:0,dy:+r}].forEach(function(i){g.prototype["onsap"+i.key]=function(e){var h=this._viewportGestureHandler._cameraController;h.beginGesture(o.x,o.y);h.rotate(i.dx,i.dy,true);h.endGesture();this.setShouldRenderFrame();e.preventDefault();e.stopPropagation();};});[{key:"left",dx:-p,dy:0},{key:"right",dx:+p,dy:0},{key:"up",dx:0,dy:-p},{key:"down",dx:0,dy:+p}].forEach(function(i){g.prototype["onsap"+i.key+"modifiers"]=function(e){if(e.shiftKey&&!(e.ctrlKey||e.altKey||e.metaKey)){var h=this._viewportGestureHandler._cameraController;h.beginGesture(o.x,o.y);h.pan(i.dx,i.dy);h.endGesture();this.setShouldRenderFrame();e.preventDefault();e.stopPropagation();}};});[{key:"minus",d:0.98},{key:"plus",d:1.02}].forEach(function(i){g.prototype["onsap"+i.key]=function(e){var h=this._viewportGestureHandler._cameraController;h.beginGesture(this.$().width()/2,this.$().height()/2);h.zoom(i.d);h.endGesture();this.setShouldRenderFrame();e.preventDefault();e.stopPropagation();};});g.prototype._handleVisibilityChanged=g.prototype._handleOpacityChanged=g.prototype._handleTintColorChanged=g.prototype._handleHighlightColorChanged=function(e){this.setShouldRenderFrame();};g.prototype._handleSelectionChanged=function(e){var t=this.getTools();for(var i=0;i<t.length;i++){var h=sap.ui.getCore().byId(t[i]);var k=h.getGizmoForContainer(this);if(k&&k.handleSelectionChanged){k.handleSelectionChanged(e);}}this.setShouldRenderFrame();};g.prototype.setSelectionRect=function(e){this.setShouldRenderFrame();if(!e){this._selectionRect=null;return;}var s=this._renderer.getSize();var x=(e.x1/s.width)*2-1,y=(e.y1/s.height)*-2+1,h=(e.x2/s.width)*2-1,i=(e.y2/s.height)*-2+1;if(!this._selectionRect){var k=new THREE.Geometry();k.vertices.push(new THREE.Vector3(x,i,-1),new THREE.Vector3(h,i,-1),new THREE.Vector3(h,y,-1),new THREE.Vector3(x,y,-1));this._selectionRect=new THREE.LineLoop(k,new THREE.LineBasicMaterial({color:0xFFFF00,linewidth:window.devicePixelRatio}));}else{var v=this._selectionRect.geometry.vertices;v[0].set(x,i,-1);v[1].set(h,i,-1);v[2].set(h,y,-1);v[3].set(x,y,-1);this._selectionRect.geometry.verticesNeedUpdate=true;}};g.prototype._renderLoop=function(){if(!this._renderer||!this.getDomRef()){this._renderLoopRequestId=0;return;}if(this._viewportGestureHandler){this._viewportGestureHandler.animateCameraUpdate();}if(this._nodesTransitionHelper){this._nodesTransitionHelper.displayNodesMoving();}if(this.getCamera()){var n=this.getCamera().getCameraRef();if(this._eyePointLight&&n){this._eyePointLight.position.copy(n.position);}if(this.getCamera().getIsModified()){this.getCamera().setIsModified(false);this._shouldRenderFrame=true;}}if(this._shouldRenderFrame){this._shouldRenderFrame=false;this.render();}this._renderLoopRequestId=window.requestAnimationFrame(this._renderLoopFunction);};g.prototype._updateDynamicObjects=function(e,n,h,i){var k=false;h.children.forEach(function(m){if(m.userData._vkDetailViews&&m.userData._vkDetailViews.length>0){k=true;}});function s(v){h.children.forEach(function(m){if(m.userData._vkBillboards){m.userData._vkBillboards.forEach(function(t){t._node.visible=v;});}if(m.userData._vkDetailViews){m.userData._vkDetailViews.forEach(function(t){t._node.visible=v;});}});}if(k){i=i||this._scene._computeBoundingBox();s(false);h.children.forEach(function(m){if(m.userData._vkDetailViews){m.userData._vkDetailViews.forEach(function(t){t._update(e,n,h,i);});}});s(true);}h.children.forEach(function(m){if(m.userData._vkCallouts){m.userData._vkCallouts.forEach(function(t){t._update(e,n);});}if(m.userData._vkBillboards){m.userData._vkBillboards.forEach(function(t){t._update(e,n);});}});};g.prototype.render=function(){var e=this._renderer;if(!e){return;}var n=this._scene?this._scene.getSceneRef():null;var h=this._camera?this._camera.getCameraRef():null;if(!n||!h){return;}var t=this.getTools();var i,k,m,s;if(this._camera.getUsingDefaultClipPlanes()||(h.isOrthographicCamera&&this._camera.getZoomNeedRecalculate())){s=this._scene._computeBoundingBox();if(!s.isEmpty()){if(h.isOrthographicCamera&&this._camera.getZoomNeedRecalculate()){this._camera.adjustZoom(s);}if(this._camera.getUsingDefaultClipPlanes()){for(i=0;i<t.length;i++){k=sap.ui.getCore().byId(t[i]);m=k.getGizmoForContainer(this);if(m&&m.expandBoundingBox){m.expandBoundingBox(s);}}this._camera.adjustClipPlanes(s);}}}this._updateDynamicObjects(e,h,n,s);e.autoClear=this._backgroundColor!=null;if(e.autoClear){e.setClearColor(this._backgroundColor.color,this._backgroundColor.alpha);}else{e.render(this._backgroundScene,this._backgroundCamera);}var v=this._getViewStateManagerThreeJS();e.clippingPlanes=this._clippingPlanes;switch(this.getRenderMode()){case sap.ui.vk.RenderMode.XRay:if(v){var u=n.children[n.children.length-1].clone();v._selectedNodes.forEach(function(y){if(y.visible){y.add(u);e.render(y,h);e.autoClear=false;y.remove(u);}});}n.overrideMaterial=this._xrayMaterial;break;case sap.ui.vk.RenderMode.LineIllustration:case sap.ui.vk.RenderMode.ShadedIllustration:case sap.ui.vk.RenderMode.SolidOutline:this._scene._outlineMaterial.linewidth=this._renderer.getPixelRatio();break;default:break;}if(this._animationMixer){this.setShouldRenderFrame();var w=this._clock.getDelta();q.sap.log.debug("animationMixer delta: "+w.toString());this._animationMixer.update(w);}e.render(n,h);e.autoClear=false;e.clippingPlanes=[];n.overrideMaterial=null;if(v){var x=v._boundingBoxesScene;if(x){e.render(x,h);}}for(i=0;i<t.length;i++){k=sap.ui.getCore().byId(t[i]);m=k.getGizmoForContainer(this);if(m&&m.render){m.render(this);}}if(this._selectionRect){e.render(this._selectionRect,this._backgroundCamera);}};g.prototype.getImage=function(e,i,t,k,m){if(this._scene===null){return null;}e=e||16;i=i||16;if(e>2048){e=2048;}if(i>2048){i=2048;}var n=new THREE.WebGLRenderer({preserveDrawingBuffer:true});n.setSize(e,i);var s=this.getBackgroundColorTop();var u=this.getBackgroundColorBottom();if(t&&!k){n.setClearColor(t,1);}else if(!t&&k){n.setClearColor(k,1);}else{if(t&&k){this.setBackgroundColorTop(t);this.setBackgroundColorBottom(k);}n.render(this._backgroundScene,this._backgroundCamera);n.autoClear=false;}document.body.appendChild(n.domElement);var v=this.getCamera().getCameraRef().clone();var x=e/i;if(v.isOrthographicCamera){var w=v.right-v.left;var h=v.top-v.bottom;if(w>h){v.top=w/x/2;v.bottom=-w/x/2;}else{v.left=-h*x/2;v.right=h*x/2;}}else{var y=2*Math.atan(v.aspect*Math.tan(v.fov*Math.PI/360));if(v.fov<y*180/Math.PI){v.fov=360*Math.atan(Math.tan(y*0.5)/x)/Math.PI;}v.aspect=x;}v.updateProjectionMatrix();var z=[];var A=this._getViewStateManagerThreeJS();if(!m){if(A!==null){A.enumerateSelection(function(D){z.push(D);});A.setSelectionState(z,false,false,true);}}n.render(this._scene.getSceneRef(),v);var B=n.getContext().canvas.toDataURL();if(A!==null&&z.length>0){A.setSelectionState(z,true,false,true);}n.forceContextLoss();document.body.removeChild(n.domElement);if(u&&t){this.setBackgroundColorBottom(u);}if(s&&k){this.setBackgroundColorTop(s);}return B;};g.prototype._setContent=function(e){var s;var h;if(e){s=e;if(!(s instanceof sap.ui.vk.threejs.Scene)){s=null;}h=e.camera;if(!(h instanceof O||h instanceof P)){h=new P();}if(h instanceof sap.ui.vk.threejs.OrthographicCamera){var k=new THREE.Box3().setFromObject(s.getSceneRef());var m=k.getCenter();var n=h.getTargetDirection();var t=h.getPosition();var u=[m.x-t[0],m.y-t[1],m.z-t[2]];var v=u[0]*n[0]+u[1]*n[1]+u[2]*n[2];if(v<0){var w=k.getSize().length()/2;w-=v;t[0]-=n[0]*w;t[1]-=n[1]*w;t[2]-=n[2]*w;h.setPosition(t);}}var i;if(e.loaders){for(i=0;i<e.loaders.length;i++){if(e.loaders[i]instanceof sap.ui.vk.threejs.ContentDeliveryService){this._cdsLoader=e.loaders[i];this._cdsLoader.attachSceneUpdated(this._handleCdsSceneUpdate,this);break;}}}if(e.builders){for(i=0;i<e.builders.length;i++){e.builders[i]._fireSceneUpdated=this.setShouldRenderFrame.bind(this);}}}if(this._animationMixer){this._animationMixer.stopAllAction();this._animationMixer=null;}this._currentPlaybacks=null;this.setScene(s);if(h){this.setCamera(h);}};g.prototype._onAfterUpdateContentConnector=function(){this._setContent(this._contentConnector.getContent());};g.prototype._onBeforeClearContentConnector=function(){if(j._onBeforeClearContentConnector){j._onBeforeClearContentConnector.call(this);}this.setScene(null);};g.prototype._handleContentReplaced=function(e){var h=e.getParameter("newContent");this._setContent(h);};g.prototype._onAfterUpdateViewStateManager=function(){};g.prototype._onBeforeClearViewStateManager=function(){};C.injectMethodsIntoClass(g);b.injectMethodsIntoClass(g);g.prototype._restoreOriginalValueAfterAnimiation=function(){if(!this._currentPlaybacks||!this._currentPlaybacks.length){return;}var n=this._scene?this._scene.getSceneRef():undefined;if(!n){return;}for(var e=0;e<this._currentPlaybacks.length;e++){var h;if(n.userData&&n.userData.sequences){h=n.userData.sequences.get(this._currentPlaybacks[e].sequenceId);}if(h){if(h&&h.tracks){for(var t=0;t<h.tracks.length;t++){var k=h.tracks[t];var i=k.userData;if(!i){continue;}var m=i.originalValue;if(!m){continue;}var s=i.targetNode;if(!s){continue;}if(i.type==="SCALE"){s.scale.x=m.x;s.scale.y=m.y;s.scale.z=m.z;}else if(i.type==="TRANSLATE"){s.position.x=m.x;s.position.y=m.y;s.position.z=m.z;}else if(i.type==="ROTATE"){s.quaternion.w=m.w;s.quaternion.x=m.x;s.quaternion.y=m.y;s.quaternion.z=m.z;}}}}}};g.prototype._resetPlaybacks=function(e){if(this._animationMixer){this._animationMixer.stopAllAction();this._animationMixer=null;}this._restoreOriginalValueAfterAnimiation();if(e&&e.length){this._currentPlaybacks=e;}else{this._currentPlaybacks=null;}return;};g.prototype._resetNodePositionsAfterAnimation=function(){var n=this._scene?this._scene.getSceneRef():undefined;if(!n||!n.userData){return;}if(n.userData.animationNodeOriginalData){var e=n.userData.animationNodeOriginalData.entries();var h=e.next();while(!h.done){var i=h.value[0];var k=h.value[1];if(k.scale){i.scale.x=k.scale.x;i.scale.y=k.scale.y;i.scale.z=k.scale.z;}if(k.position){i.position.x=k.position.x;i.position.y=k.position.y;i.position.z=k.position.z;}if(k.quaternion){i.quaternion.w=k.quaternion.w;i.quaternion.x=k.quaternion.x;i.quaternion.y=k.quaternion.y;i.quaternion.z=k.quaternion.z;}h=e.next();}}return;};g.prototype._runAnimation=function(){if(!this._currentPlaybacks){return;}var n=this._scene?this._scene.getSceneRef():undefined;if(!n){return;}var t=0;for(var e=0;e<this._currentPlaybacks.length;e++){var h;if(n.userData&&n.userData.sequences){h=n.userData.sequences.get(this._currentPlaybacks[e].sequenceId);}if(h&&!h.hasOptimized){h.resetDuration();h.optimize();h.hasOptimized=true;}if(h){var i=this._animationMixer.clipAction(h);i.clampWhenFinished=true;if(this._currentPlaybacks[e].playbackRepeat>0){i.setLoop(THREE.LoopRepeat,this._currentPlaybacks[e].playbackRepeat-1);}else{i.setLoop(THREE.LoopOnce,1);}t+=this._currentPlaybacks[e].playbackPreDelay;i.startAt(t);if(this._currentPlaybacks[e].playbackReversed){i.timeScale=-1;}if(this._currentPlaybacks[e].playbackSpeed>0){i.timeScale*=this._currentPlaybacks[e].playbackSpeed;}i.play();t+=h.duration+this._currentPlaybacks[e].playbackPostDelay;}}this.setShouldRenderFrame();this._clock.start();};g.prototype.startAnimation=function(){if(!this._currentPlaybacks||!this._currentPlaybacks.length){this._playStep();return;}var n=this._scene?this._scene.getSceneRef():undefined;if(!n){return;}if(this._animationMixer){this._animationMixer.stopAllAction();this._animationMixer=null;}this._animationMixer=new THREE.AnimationMixer(n);if(!this._animationMixer.userData){this._animationMixer.userData={};}this._animationMixer.userData.viewport=this;this._animationMixer.addEventListener("finished",function(e){if(this.userData.viewport){if(this.userData.viewport._curentView){this.userData.viewport._curentView.animationCompleted=true;}var h=function(v){v._playStep();};setTimeout(h,200,this.userData.viewport);q.sap.log.debug("Animation finished");}},false);this._runAnimation();return;};g.prototype.stopAnimation=function(){if(this._animationMixer){this._animationMixer.stopAllAction();this._animationMixer=null;}this._playingProcedure=false;this.setShouldRenderFrame();};g.prototype._activateSingleView=function(v){var e=v.playbacks;if(!e&&v.getPlaybacks){e=v.getPlaybacks();}this._resetPlaybacks(e);var h=v.camera;if(!h){var i=v.getCameraInfo();if(i.type==="PerspectiveCamera"){h=new P();h.setFov(i.fov);}if(i.type==="OrthographicCamera"){h=new O();h.setZoomFactor(i.zoomFactor);if(i.zoomNeedRecalculate){h.setZoomNeedRecalculate(true);}}h.setPosition(i.position);h.setNearClipPlane(i.nearClipPlane);h.setFarClipPlane(i.farClipPlane);h.setUpDirection(i.upDirection);h.setTargetDirection(i.targetDirection);h.setUsingDefaultClipPlanes(i.usingDefaultClipPlanes);v.camera=h;}var n=this._scene?this._scene.getSceneRef():undefined;if(h){var k=h.getCameraRef();if(k.type==="OrthographicCamera"&&n){var m=h.getPosition();var s=this.getScene();if(s){var t=new THREE.Box3().setFromObject(n);var u=t.getCenter();var w=h.getTargetDirection();var x=[u.x-m[0],u.y-m[1],u.z-m[2]];var y=x[0]*w[0]+x[1]*w[1]+x[2]*w[2];if(y<0){var z=t.getSize().length()/2;z-=y;m[0]-=w[0]*z;m[1]-=w[1]*z;m[2]-=w[2]*z;}}h.setPosition(m);}}var A;if(v.getNodeInfos){A=v.getNodeInfos();}function B(T){return new THREE.Matrix4().set(T[0],T[1],T[2],T[3],T[4],T[5],T[6],T[7],T[8],T[9],T[10],T[11],0,0,0,1);}if(A){var D=this._viewStateManager.getNodeHierarchy();this._nodesTransitionHelper.clear();A.forEach(function(H){if(H.target===null){return;}function T(X,Y,Z){for(var $=0;$<X.elements.length;$++){if(Math.abs(X.elements[$]-Y.elements[$])>Z){return false;}}return true;}if(H.transform){var U=B(H.transform);if(!T(U,H.target.matrix,1e-6)){if(!this._currentPlaybacks){var W=D.createNodeProxy(H.target);this._nodesTransitionHelper.setNodeForDisplay(W);}U.decompose(H.target.position,H.target.quaternion,H.target.scale);H.target.updateMatrix();}}}.bind(this));}var E;if(v.animationNodeOriginalData){E=v.animationNodeOriginalData.entries();}else if(this._currentPlaybacks&&this._currentPlaybacks.length&&n){var F;if(n.userData&&n.userData.sequences){F=n.userData.sequences.get(this._currentPlaybacks[0].sequenceId);}if(F&&F.userData.nodesStartData){E=F.userData.nodesStartData.entries();}}if(E){var G=E.next();while(!G.done){var H=G.value[0];var I=G.value[1];if(I.scale){H.scale.x=I.scale.x;H.scale.y=I.scale.y;H.scale.z=I.scale.z;}if(I.position){H.position.x=I.position.x;H.position.y=I.position.y;H.position.z=I.position.z;}if(I.quaternion){H.quaternion.w=I.quaternion.w;H.quaternion.x=I.quaternion.x;H.quaternion.y=I.quaternion.y;H.quaternion.z=I.quaternion.z;}G=E.next();}}if(A){var J=[];var K=[];for(var Q=0;Q<A.length;Q++){if(A[Q].visible){J.push(A[Q].target);}else{K.push(A[Q].target);}}this._viewStateManager.setVisibilityState(J,true,false);this._viewStateManager.setVisibilityState(K,false,false);this._nodesTransitionHelper.startDisplay(500);}else if(v.visibleNodes&&n){this._viewStateManager.setVisibilityState(n.children[0],false,true);this._viewStateManager.setVisibilityState(n.children[0],true,false);this._viewStateManager.setVisibilityState(v.visibleNodes,true,false);}if(h){var S=2000;if(v.flyToTime){S=v.flyToTime;}this._viewportGestureHandler._activateCamera(h.getCameraRef(),S);}};g.prototype.activateView=function(v){this._playingProcedure=false;this._activateSingleView(v);return this;};g.prototype._playStep=function(){if(!this._playingProcedure){return;}var v=this._currentViews[this._currentViewIndex];this._activateSingleView(v);this._currentViewIndex++;if(this._currentViews.length<=this._currentViewIndex){this._playingProcedure=false;}};g.prototype.playProcedure=function(v){this._resetNodePositionsAfterAnimation();if(v){this._currentViews=v;}if(!this._currentViews){return this;}this._currentViewIndex=0;this._playingProcedure=true;var e=function(h){h._playStep();};var t=this;setTimeout(e,200,t);return this;};g.prototype.zoomTo=function(w,n,e,m){var h=this._scene?this._scene.getSceneRef():null;var i=this._camera?this._camera.getCameraRef():null;if(!i||!h){return this;}m=m||0;var k=new THREE.Box3();var s=null;var t=null;(Array.isArray(w)?w:[w]).forEach(function(w){switch(w){case sap.ui.vk.ZoomTo.All:h._expandBoundingBox(k,false);break;case sap.ui.vk.ZoomTo.Visible:h._expandBoundingBox(k,true);break;case sap.ui.vk.ZoomTo.Selected:var v=this._getViewStateManagerThreeJS();if(v){v.enumerateSelection(function(n){n._expandBoundingBox(k,false);});}break;case sap.ui.vk.ZoomTo.Node:if(!n){return this;}t=n;if(Array.isArray(n)){n.forEach(function(n){n._expandBoundingBox(k,false);});}else{n._expandBoundingBox(k,false);}break;case sap.ui.vk.ZoomTo.Restore:q.sap.log.error("sap.ui.vk.ZoomTo.Restore is not implemented");return this;case sap.ui.vk.ZoomTo.NodeSetIsolation:q.sap.log.error("sap.ui.vk.ZoomTo.NodeSetIsolation is not implemented");return this;case sap.ui.vk.ZoomTo.RestoreRemoveIsolation:q.sap.log.error("sap.ui.vk.ZoomTo.RestoreRemoveIsolation is not implemented");return this;case sap.ui.vk.ZoomTo.ViewLeft:s=new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(0,1,0),-Math.PI/2);break;case sap.ui.vk.ZoomTo.ViewRight:s=new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(0,1,0),Math.PI/2);break;case sap.ui.vk.ZoomTo.ViewTop:s=new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(1,0,0),-Math.PI/2);break;case sap.ui.vk.ZoomTo.ViewBottom:s=new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(1,0,0),Math.PI/2);break;case sap.ui.vk.ZoomTo.ViewBack:s=new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(0,1,0),Math.PI);break;case sap.ui.vk.ZoomTo.ViewFront:s=new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(0,1,0),0);break;default:break;}}.bind(this));if(!k.isEmpty()){this._viewportGestureHandler.zoomTo(k,s,m,e*1000,t,t!==null);}return this;};g.prototype.getViewInfo=function(e){var v={};if(e==null){e={};}if(e.camera==null){e.camera=true;}var n=this._camera?this._camera.getCameraRef():null;if(e.camera&&n){var h=n.rotation.clone();h.reorder("YXZ");v.camera={rotation:{yaw:THREE.Math.radToDeg(h.y),pitch:THREE.Math.radToDeg(h.x),roll:THREE.Math.radToDeg(h.z)},position:{x:n.position.x,y:n.position.y,z:n.position.z},projectionType:n.isOrthographicCamera?sap.ui.vk.CameraProjectionType.Orthographic:sap.ui.vk.CameraProjectionType.Perspective,bindingType:sap.ui.vk.CameraFOVBindingType.Vertical};if(v.camera.projectionType===sap.ui.vk.CameraProjectionType.Perspective){v.camera.fieldOfView=n.fov;}else if(v.camera.projectionType===sap.ui.vk.CameraProjectionType.Orthographic){v.camera.zoomFactor=n.zoom;}if(e.camera.matrices){v.camera.matrices={view:n.matrixWorldInverse.elements.slice(),projection:n.projectionMatrix.elements.slice()};}}if(e.visibility&&this._viewStateManager){var i=e.visibility.mode==null?sap.ui.vk.VisibilityMode.Complete:e.visibility.mode;v.visibility={mode:i};if(i===sap.ui.vk.VisibilityMode.Complete){var k=this._viewStateManager.getVisibilityComplete();v.visibility.visible=k.visible;v.visibility.hidden=k.hidden;}else if(this._viewStateManager.getShouldTrackVisibilityChanges()){v.visibility.changes=this._viewStateManager.getVisibilityChanges();}else{q.sap.log.warning(sap.ui.vk.getResourceBundle().getText(M.VIT32.summary),M.VIT32.code,"sap.ui.vk.threejs.Viewport");}}return v;};g.prototype.setViewInfo=function(v,e){var n=this._camera?this._camera.getCameraRef():null;if(v.camera&&n){var h=v.camera;var i=h.projectionType===sap.ui.vk.CameraProjectionType.Orthographic?new THREE.OrthographicCamera():new THREE.PerspectiveCamera();i.userData=n.userData;i.aspect=n.aspect;i.position.copy(h.position);var k=h.rotation;i.quaternion.setFromEuler(new THREE.Euler(THREE.Math.degToRad(k.pitch),THREE.Math.degToRad(k.yaw),THREE.Math.degToRad(k.roll),"YXZ"));i.fov=h.fieldOfView||i.fov;i.zoom=h.zoomFactor||i.zoom;this._viewportGestureHandler._activateCamera(i,(e||0)*1000);}if(v.visibility){var m=this._viewStateManager.getNodeHierarchy(),s=new Map(),t=m.findNodesByName();t.forEach(function(x){var y=m.createNodeProxy(x);var z=y.getVeId();m.destroyNodeProxy(y);if(z){s.set(z,x);}});switch(v.visibility.mode){case sap.ui.vk.VisibilityMode.Complete:var u=v.visibility.visible,w=v.visibility.hidden;u.forEach(function(x){this._viewStateManager.setVisibilityState(s.get(x),true,false);},this);w.forEach(function(x){this._viewStateManager.setVisibilityState(s.get(x),false,false);},this);break;case sap.ui.vk.VisibilityMode.Differences:this._viewStateManager.resetVisibility();v.visibility.changes.forEach(function(x){var y=s.get(x);if(y){this._viewStateManager.setVisibilityState(y,!this._viewStateManager.getVisibilityState(y),false);}},this);break;default:q.sap.log.error(sap.ui.vk.getResourceBundle().getText(M.VIT28.summary),M.VIT28.code,"sap.ui.vk.threejs.Viewport");break;}}return this;};g.prototype.queueCommand=function(e){if(this instanceof sap.ui.vk.threejs.Viewport){e();}return this;};g.prototype.getOutputSize=function(){var e=this.getDomRef().getBoundingClientRect();var v=e.width;var h=e.height;var i;i=Math.min(v,h);return{left:(v-i)/2,top:(h-i)/2,sideLength:i};};return g;});
