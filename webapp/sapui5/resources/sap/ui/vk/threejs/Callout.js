/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["jquery.sap.global","../library","./thirdparty/three","sap/ui/base/ManagedObject","./Billboard","../ve/thirdparty/html2canvas","./PolylineGeometry","./PolylineMaterial","./PolylineMesh"],function(Q,a,b,B,c,d,P,e,f){"use strict";var C=c.extend("sap.ui.vk.threejs.Callout",{metadata:{properties:{anchorNode:{type:"any",defaultValue:null},depthTest:{type:"boolean",defaultValue:true}}},constructor:function(i,s,S){c.apply(this,arguments);this._billboard.material.depthTest=this.getDepthTest();this._lines=[];}});C.prototype.setRenderOrder=function(h){c.prototype.setRenderOrder.call(this,h);if(this._lines){this._lines.forEach(function(l){l.renderOrder=h;});}return this;};C.prototype.setDepthTest=function(h){this.setProperty("depthTest",h,true);if(this._billboard){this._billboard.material.depthTest=h;this._lines.forEach(function(l){l.material.depthTest=h;});}return this;};var g=new THREE.Vector4(),j=new THREE.Vector4(),k=new THREE.Vector4(),m=new THREE.Vector2(),n=new THREE.Vector2(),o=new THREE.Vector2(),q=new THREE.Quaternion(),r=new THREE.Matrix4(),u=new THREE.Vector2(),v=new THREE.Vector3(),w=new THREE.Vector3(),z=new THREE.Vector3(0,0,1),A=new THREE.Vector2(),D=new THREE.Matrix4(),E=new THREE.Matrix4();C.prototype._update=function(h,i){this._node.matrix.getInverse(this._node.parent.matrixWorld);this._node.matrix.decompose(this._node.position,this._node.rotation,this._node.scale);this._node.matrixWorld.identity();var l=h.getSize(),s=this.getPosition(),x=this._billboard.position;if(s){x.copy(s);}else{x.setScalar(0);}var y=this.getAnchorNode();if(y){x.applyMatrix4(y.matrixWorld);}this._billboard.rotation.copy(i.rotation);A.set(l.width,l.height);D.multiplyMatrices(i.projectionMatrix,i.matrixWorldInverse);g.copy(x).applyMatrix4(D);m.copy(g).multiplyScalar(1/g.w).multiply(A);var F=g.w*2/(A.x*i.projectionMatrix.elements[0]);this._billboard.scale.set(F*this._width,F*this._height,1);v.setFromMatrixColumn(i.matrixWorld,0).multiplyScalar(F*(Math.round(m.x*0.5)-m.x*0.5));w.setFromMatrixColumn(i.matrixWorld,1).multiplyScalar(F*(Math.round(m.y*0.5)-m.y*0.5));x.add(v).add(w);this._billboard.updateMatrixWorld();var G=this.getStyle()===sap.ui.vk.BillboardStyle.CircularShape;var H=i.near;function I(p,t,J){if(p<t){return p-t;}else if(p>J){return p-J;}return 0;}this._lines.forEach(function(p){if(p.userData.targetNode){p.matrix.copy(p.userData.targetNode.matrixWorld);}else{p.matrix.identity();}p.matrixWorld.copy(p.matrix);if(p.isPolylineMesh){p.material.resolution.copy(A);}if(p.isHaloMesh){return;}var J=p.geometry.vertices;var K=J[0];var L=J[J.length-2];var M=J[J.length-1];var N=p.userData.startPointMesh;var O=false;var R=[0,J.length-1];if(N!==undefined){K.copy(N.userData.targetVertex);}E.multiplyMatrices(D,p.matrixWorld);if(p.userData.extensionLength>0&&J.length>2){R.push(J.length-2);g.copy(J[J.length-3]).applyMatrix4(E);n.copy(g).multiplyScalar(1/g.w).multiply(A);L.set(Math.sign(n.x-m.x)*0.5*(1+p.userData.extensionLength/this._width),0,0);L.applyMatrix4(this._billboard.matrixWorld).applyMatrix4(r.getInverse(p.matrixWorld));}g.copy(L).applyMatrix4(E);n.copy(g).multiplyScalar(1/g.w).multiply(A);if(G){var S=u.copy(n).sub(m).length();O=S<this._width;u.multiplyScalar(0.5/S);M.set(u.x,u.y,0);}else{var T=I(n.x,m.x-this._width,m.x+this._width),U=I(n.y,m.y-this._height,m.y+this._height);O=(T===0&&U===0);if(Math.abs(T)>Math.abs(U)){M.set(Math.sign(T)*0.5,0,0);}else{M.set(0,Math.sign(U)*0.5,0);}}if(O){M.copy(L);}else{M.applyMatrix4(this._billboard.matrixWorld).applyMatrix4(r.getInverse(p.matrixWorld));}p.geometry.verticesNeedUpdate=true;if(N!==undefined){N.position.copy(N.userData.targetVertex).applyMatrix4(p.matrixWorld);g.copy(N.position).applyMatrix4(D);var V=g.w/(A.x*i.projectionMatrix.elements[0]);N.scale.setScalar(V);N.visible=false;var W=false;if(g.w>=H){j.copy(g);k.copy(J[1]).applyMatrix4(E);if(k.w<H){var t=(j.w-H)/(j.w-k.w);k.sub(j).multiplyScalar(t).add(j);}o.copy(j).multiplyScalar(1/j.w);n.copy(k).multiplyScalar(1/k.w);u.copy(n).sub(o).multiply(A);W=u.length()<N.userData.lineOffset;q.setFromAxisAngle(z,Math.atan2(u.y,u.x));N.quaternion.copy(i.quaternion).multiply(q);N.matrix.compose(N.position,N.quaternion,N.scale);N.matrixWorld.copy(N.matrix);o.multiply(A).sub(m);N.visible=G?o.length()>this._width:Math.abs(o.x)>this._width||Math.abs(o.y)>this._height;if(W||!N.visible){K.copy(J[1]);}else{K.set(N.userData.lineOffset,0,0).applyMatrix4(N.matrixWorld).applyMatrix4(r.getInverse(p.matrixWorld));}}}p.geometry._updateVertices(R);p.computeLineDistances(E,A,H);if(p.userData.haloMesh){p.userData.haloMesh.material.lineLength=p.material.lineLength;}}.bind(this));};C.prototype._createMarkMesh=function(p,t,F,G){var H=F===sap.ui.vk.LeaderLineMarkStyle.Arrow;var I=window.devicePixelRatio;var J=t.width;var K=J*t.haloWidth;G=(Array.isArray(G)||G instanceof Float32Array)&&G.length===2?G:[1,1];var L,M;if(H){L=Math.max(35*G[0],J*5);M=Math.max(15*G[1],J*2);}else{L=M=Math.max(2*G[0],J*2);}L=Math.ceil(L+K*2);M=Math.ceil(M+K*2);var N=document.createElement("canvas");N.width=THREE.Math.ceilPowerOfTwo(L*I);N.height=THREE.Math.ceilPowerOfTwo(M*I);var O=N.getContext("2d");var x=L/2,y=M/2;O.fillStyle="#FFF";O.scale(I,I);if(H){O.beginPath();O.moveTo(0,y);O.lineTo(L,0);O.lineTo(L,M);O.closePath();O.fill();var h=L*y/Math.sqrt(L*L+y*y),s=(h-K)/h;var R=L-L*s,S=y*(L*s-K)/L;O.fillStyle=p.getStyle();O.beginPath();O.moveTo(R,y);O.lineTo(L-K,y-S);O.lineTo(L-K,y+S);O.closePath();O.fill();}else{var T=L*0.5,U=T-K;O.beginPath();O.ellipse(x,y,T,T,0,0,Math.PI*2);O.fill();O.fillStyle=p.getStyle();O.beginPath();O.ellipse(x,y,U,U,0,0,Math.PI*2);O.fill();}O.fillRect(L-K,y-J*0.5,K,J);var V=new THREE.MeshBasicMaterial({map:new THREE.CanvasTexture(N),flatShading:true,transparent:true,alphaTest:0.05,premultipliedAlpha:true,side:THREE.DoubleSide,depthTest:this.getDepthTest()});var W=new THREE.PlaneBufferGeometry(L*2,M*2);if(H){W.translate(L,0,0);}var X=new THREE.Mesh(W,V);X.matrixAutoUpdate=false;X.renderOrder=this.getRenderOrder();X.userData.lineOffset=(H?L*2-1:L-K*2);var Y=new THREE.Vector2(L*I/N.width,M*I/N.height);var Z=X.geometry.attributes.uv.array;for(var i=0,l=Z.length;i<l;i+=2){Z[i]*=Y.x;Z[i+1]=1-(1-Z[i+1])*Y.y;}return X;};C.prototype.addLeaderLine=function(h,t,i,s,l,p,x){if(x>0&&h.length<3){h.push(h[h.length-1].clone());}var y=i.userData.lineStyle||{};y.width=y.width||1;y.haloWidth=y.haloWidth||0;y.endCapStyle=y.endCapStyle||0;var F=y.endCapStyle||h.length>2?1:0;var G=(F&&(s!==sap.ui.vk.LeaderLineMarkStyle.None||y.endCapStyle===0)?1:0)|(F&&(l!==sap.ui.vk.LeaderLineMarkStyle.None||y.endCapStyle===0)?2:0);var H=new P();H.setVertices(h);var I;if(y.haloWidth>0){var J=new e({color:0xFFFFFF,lineColor:0xFFFFFF,linewidth:y.width*(y.haloWidth*2+1),dashCapStyle:y.endCapStyle,segmentCapStyle:F,trimStyle:G,transparent:true,depthTest:this.getDepthTest()});I=new f(H,J);I.userData.targetNode=t;I.matrixAutoUpdate=false;I.renderOrder=this.getRenderOrder();I.isHaloMesh=true;this._node.add(I);this._lines.push(I);}var K=new e({color:0xFFFFFF,lineColor:i.color,linewidth:y.width,dashCapStyle:y.endCapStyle,segmentCapStyle:F,trimStyle:G,dashPattern:y.dashPattern||[],dashScale:y.dashPatternScale||1,transparent:true,depthTest:this.getDepthTest()});var L=new f(H,K);L.userData.targetNode=t;L.userData.extensionLength=x;L.userData.haloMesh=I;L.matrixAutoUpdate=false;L.renderOrder=this.getRenderOrder();this._node.add(L);this._lines.push(L);if(s!==sap.ui.vk.LeaderLineMarkStyle.None){var M=this._createMarkMesh(i.color,y,s,p);M.userData.targetVertex=H.vertices[0].clone();L.userData.startPointMesh=M;this._node.add(M);}return L;};return C;});
