/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["jquery.sap.global","./library","./Gizmo"],function(q,l,G){"use strict";var C=G.extend("sap.ui.vk.tools.CrossSectionToolGizmo",{metadata:{library:"sap.ui.vk.tools"}});C.prototype.init=function(){if(G.prototype.init){G.prototype.init.apply(this);}this._viewport=null;this._tool=null;this._position=new THREE.Vector3(0,0,0);this._plane=new THREE.Plane(new THREE.Vector3(0,0,1),0);this._flip=false;this._matViewProj=new THREE.Matrix4();this._pos4=new THREE.Vector4();this._gizmoSize=144;this.setAxis(0);};C.prototype.hasDomElement=function(){return false;};C.prototype.show=function(v,t){this._viewport=v;this._tool=t;var b=v._scene?v._scene._computeBoundingBox():new THREE.Box3();this._position.copy(b.getCenter());this._plane.constant=-this._plane.normal.dot(this._position);v.setClippingPlanes([this._plane]);};C.prototype.hide=function(){if(this._viewport){this._viewport.setClippingPlanes([]);this._viewport=null;}this._tool=null;};C.prototype._getOffset=function(){return this._position.getComponent(this._axis);};C.prototype.getAxis=function(){return this._axis;};C.prototype.setAxis=function(i){this._axis=i;var d=new THREE.Vector3().setComponent(i,1);this._plane.normal.set(0,0,0).setComponent(i,this._flip?-1:1);this._plane.constant=-this._plane.normal.dot(this._position);var g=new THREE.BufferGeometry();var v=new Array(15);var a=new THREE.Vector3(d.y,d.z,d.x),b=new THREE.Vector3(d.z,d.x,d.y),p=new THREE.Vector3();p.sub(a).sub(b).multiplyScalar(0.5).toArray(v,0);p.toArray(v,12);p.add(a).toArray(v,3);p.add(b).toArray(v,6);p.sub(a).toArray(v,9);g.addAttribute("position",new THREE.Float32BufferAttribute(v,3));this._gizmoPlane=new THREE.Line(g,new THREE.LineBasicMaterial({color:0xFFFFFF,transparent:true,linewidth:window.devicePixelRatio}));var c=144,e=window.devicePixelRatio*0.5,f=32,h=6,t=48;d=this._plane.normal.clone().multiplyScalar(1/c);var j=0xFF<<(8*(2-i));var k=new THREE.CylinderBufferGeometry(e,e,c-f,4);var m=new THREE.Matrix4().makeBasis(new THREE.Vector3(d.y,d.z,d.x),d,new THREE.Vector3(d.z,d.x,d.y));m.setPosition(d.clone().multiplyScalar((c-f)*0.5));k.applyMatrix(m);this._gizmoArrow=new THREE.Mesh(k,new THREE.MeshBasicMaterial({color:j}));this._gizmoArrow.userData.color=j;var n=new THREE.CylinderBufferGeometry(0,h,f,12,1);m.setPosition(d.clone().multiplyScalar(c-f*0.5));n.applyMatrix(m);var o=new THREE.Mesh(n,new THREE.MeshBasicMaterial({color:j}));o.matrixAutoUpdate=false;this._gizmoArrow.add(o);var r=new THREE.CylinderGeometry(t*0.5,t*0.5,c,12,1);m.setPosition(d.clone().multiplyScalar(c*0.5));r.applyMatrix(m);this._touchMesh=new THREE.Mesh(r,new THREE.MeshBasicMaterial({visible:false,side:THREE.DoubleSide}));this._gizmoArrow.add(this._touchMesh);if(this._viewport){this._viewport.setShouldRenderFrame();}return this;};C.prototype.setFlip=function(f){this._flip=!!f;this.setAxis(this._axis);return this;};C.prototype.getTouchObject=function(){return this._touchMesh;};C.prototype._setOffset=function(o){var b=this._viewport._scene._computeBoundingBox();o=THREE.Math.clamp(o,b.min.getComponent(this._axis),b.max.getComponent(this._axis));this._position.setComponent(this._axis,o);this._plane.constant=-this._plane.normal.dot(this._position);this._viewport.setShouldRenderFrame();};C.prototype.highlightArrowHandle=function(h){var c=h?0xFFFF00:this._gizmoArrow.userData.color;this._gizmoArrow.material.color.setHex(c);this._gizmoArrow.children[0].material.color.setHex(c);};C.prototype._adjustBoundingBox=function(b){var s=b.getSize();var d=Math.max(s.x,s.y,s.z)*0.2;b.expandByScalar(d);};C.prototype._updateGizmo=function(b){var i=this._axis;var o=THREE.Math.clamp(this._position.getComponent(i),b.min.getComponent(i),b.max.getComponent(i));this._position.setComponent(i,o);this._plane.constant=-this._plane.normal.dot(this._position);this._adjustBoundingBox(b);this._gizmoPlane.position.copy(b.getCenter());this._gizmoPlane.position.setComponent(i,o);this._gizmoPlane.scale.copy(b.getSize());this._gizmoPlane.updateMatrixWorld(true);var r=this._viewport.getRenderer(),c=this._viewport.getCamera().getCameraRef();this._gizmoArrow.position.copy(this._gizmoPlane.position);this._matViewProj.multiplyMatrices(c.projectionMatrix,c.matrixWorldInverse);this._pos4.copy(this._gizmoArrow.position).applyMatrix4(this._matViewProj);var s=this._gizmoSize*this._pos4.w*r.getPixelRatio()/(r.getSize().width*c.projectionMatrix.elements[0]);this._gizmoArrow.scale.setScalar(s);this._gizmoArrow.updateMatrixWorld(true);};C.prototype.expandBoundingBox=function(b){if(this._viewport){var s=this._viewport._scene._computeBoundingBox();this._updateGizmo(s);b.min.min(s.min);b.max.max(s.max);b.expandByPoint(this._plane.normal.clone().multiply(this._gizmoArrow.scale).add(this._gizmoArrow.position));}};C.prototype.render=function(){var s=this._viewport._scene._computeBoundingBox();this._updateGizmo(s);var r=this._viewport.getRenderer(),c=this._viewport.getCamera().getCameraRef();r.render(this._gizmoPlane,c);r.clearDepth();r.render(this._gizmoArrow,c);};C.prototype.onBeforeRendering=function(){};C.prototype.onAfterRendering=function(){};return C;},true);
