/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["jquery.sap.global","./library","./Gizmo"],function(q,c,G){"use strict";var S=G.extend("sap.ui.vk.tools.ScaleToolGizmo",{metadata:{library:"sap.ui.vk.tools"}});S.prototype.init=function(){if(G.prototype.init){G.prototype.init.apply(this);}this._viewport=null;this._tool=null;this._nonUniformScaleEnabled=false;this._sceneGizmo=new THREE.Scene();this._gizmo=new THREE.Group();this._touchAreas=new THREE.Group();this._sceneGizmo.add(this._gizmo);this._gizmoScale=new THREE.Vector3().setScalar(1);this._coordinateSystem=sap.ui.vk.tools.CoordinateSystem.Local;this._nodes=[];this._matViewProj=new THREE.Matrix4();this._gizmoSize=132;var d=144,e=24/d,t=48/d;function f(a,b,i){var m=new THREE.Matrix4().makeBasis(new THREE.Vector3(a.y,a.z,a.x),a,new THREE.Vector3(a.z,a.x,a.y));var j=new THREE.BoxBufferGeometry(e,e,e);j.applyMatrix(m);var k=new THREE.Mesh(j,new THREE.MeshBasicMaterial({color:b,transparent:true}));k.userData.color=b;if(a){k.position.copy(a);var l=window.devicePixelRatio*0.5/d;var n=new THREE.CylinderBufferGeometry(l,l,1,4);m.setPosition(a.clone().multiplyScalar(-0.5));n.applyMatrix(m);var o=new THREE.Mesh(n,new THREE.MeshBasicMaterial({color:b,transparent:true}));o.renderOrder=1;k.add(o);m.setPosition(a);}var p=new THREE.BoxBufferGeometry(t,t,t);p.applyMatrix(m);i.add(new THREE.Mesh(p,new THREE.MeshBasicMaterial({opacity:0.2,transparent:true})));return k;}function g(a,b,i){var l=new THREE.BufferGeometry();var v=new Float32Array(6);v[a]=v[b+3]=0.7;l.addAttribute("position",new THREE.Float32BufferAttribute(v,3));var j=new Float32Array(6);j[a]=j[b+3]=1;l.addAttribute("color",new THREE.Float32BufferAttribute(j,3));var k=new THREE.Line(l,new THREE.LineBasicMaterial({vertexColors:THREE.VertexColors,transparent:true,linewidth:window.devicePixelRatio}));k.userData.colors=j;var m=new THREE.Geometry();var n=new THREE.Vector3().setComponent(a,0.7);var o=new THREE.Vector3().setComponent(b,0.7);m.vertices.push(new THREE.Vector3(),n,o);m.faces.push(new THREE.Face3(0,1,2));var p=new THREE.Mesh(m,new THREE.MeshBasicMaterial({color:0xFFFF00,opacity:0.5,transparent:true,side:THREE.DoubleSide,visible:false}));p.renderOrder=1;k.add(p);i.add(p.clone());return k;}this._gizmo.add(f(new THREE.Vector3(1,0,0),0xFF0000,this._touchAreas));this._gizmo.add(f(new THREE.Vector3(0,1,0),0x00FF00,this._touchAreas));this._gizmo.add(f(new THREE.Vector3(0,0,1),0x0000FF,this._touchAreas));this._gizmo.add(g(1,2,this._touchAreas));this._gizmo.add(g(2,0,this._touchAreas));this._gizmo.add(g(0,1,this._touchAreas));e-=0.1/d;var h=new THREE.MeshBasicMaterial({color:0xC0C0C0,transparent:true});this._gizmo.add(new THREE.Mesh(new THREE.BoxBufferGeometry(e,e,e),h));this._touchAreas.add(new THREE.Mesh(new THREE.BoxBufferGeometry(t,t,t),new THREE.MeshBasicMaterial()));this._axisTitles=this._createAxisTitles();this._sceneGizmo.add(this._axisTitles);this._updateGizmoPartVisibility();};S.prototype.hasDomElement=function(){return false;};S.prototype._updateGizmoPartVisibility=function(){var s=this._coordinateSystem===sap.ui.vk.tools.CoordinateSystem.Screen;var g=this._gizmo.children,t=this._touchAreas.children;g[2].visible=t[2].visible=!s;g[3].visible=g[4].visible=t[3].visible=t[4].visible=!s&&this._nonUniformScaleEnabled;g[5].visible=t[5].visible=this._nonUniformScaleEnabled;this._axisTitles.children[2].visible=!s;};S.prototype.getCoordinateSystem=function(){return this._coordinateSystem;};S.prototype.setCoordinateSystem=function(a){this._coordinateSystem=a;this._updateGizmoPartVisibility();};S.prototype.getNonUniformScaleEnabled=function(v){return this._nonUniformScaleEnabled;};S.prototype.setNonUniformScaleEnabled=function(v){this._nonUniformScaleEnabled=!!v;this._updateGizmoPartVisibility();};S.prototype.show=function(v,t){this._viewport=v;this._tool=t;this._nodes.length=0;this._updateSelection(v._viewStateManager);};S.prototype.hide=function(){this._viewport=null;this._tool=null;};S.prototype.getGizmoCount=function(){if(this._coordinateSystem===sap.ui.vk.tools.CoordinateSystem.Local){return this._nodes.length;}else{return this._nodes.length>0?1:0;}};S.prototype.getTouchObject=function(i){if(this._nodes.length===0){return null;}this._updateGizmoObjectTransformation(this._touchAreas,i);return this._touchAreas;};S.prototype.highlightHandle=function(a,h){var b=(a===6)||(a>=0&&!this._nonUniformScaleEnabled);var d=[];var i,o;for(i=0;i<3;i++){o=this._gizmo.children[i];var e=b||(a<3?i===a:((i===(a+1)%3)||(i===(a+2)%3)));d[i]=e;var f=e?0xFFFF00:o.userData.color;o.material.color.setHex(f);o.children[0].material.color.setHex(f);o.children[0].material.opacity=o.material.opacity=e||h?1:0.35;}for(i=3;i<6;i++){o=this._gizmo.children[i];var g=o.geometry.attributes.color;if(b||i===a){g.copyArray([1,1,0,1,1,0]);}else{g.copyArray(o.userData.colors);}g.needsUpdate=true;o.material.opacity=h||i===a?1:0.35;o.children[0].material.visible=i===a;}this._axisTitles.children.forEach(function(o,i){o.material.color.setHex(d[i]?0xFFFF00:o.userData.color);o.material.opacity=d[i]||h?1:0.35;});o=this._gizmo.children[6];o.material.color.setHex(b?0xFFFF00:0xC0C0C0);o.material.opacity=b||h?1:0.35;};S.prototype.beginGesture=function(){this._matOrigin=this._gizmo.matrixWorld.clone();this._nodes.forEach(function(n){n.scaleOrigin=n.node.scale.clone();n.matOrigin=n.node.matrixWorld.clone();n.matParentInv=new THREE.Matrix4().getInverse(n.node.parent.matrixWorld);});};S.prototype.endGesture=function(){this._tool.fireScaled({x:this._gizmoScale.x,y:this._gizmoScale.y,z:this._gizmoScale.z});this._gizmoScale.setScalar(1);};S.prototype._scale=function(s){this._gizmoScale.copy(s);if(this._coordinateSystem===sap.ui.vk.tools.CoordinateSystem.Local){this._nodes.forEach(function(n){n.node.scale.copy(n.scaleOrigin).multiply(s);n.node.matrixWorldNeedsUpdate=true;});this._viewport._updateBoundingBoxesIfNeeded();}else{var m=this._matOrigin.clone().scale(s).multiply(new THREE.Matrix4().getInverse(this._matOrigin));this._nodes.forEach(function(n){if(!n.ignore){var a=n.node;a.matrixWorld.multiplyMatrices(m,n.matOrigin);a.matrix.multiplyMatrices(n.matParentInv,a.matrixWorld);a.matrix.decompose(a.position,new THREE.Quaternion(),a.scale);a.matrixWorldNeedsUpdate=true;}});}this._viewport.setShouldRenderFrame();};S.prototype.scale=function(s){this.beginGesture();this._scale(s);};S.prototype._setScale=function(s){if(this._tool.fireEvent("scaling",{x:s.x,y:s.y,z:s.z},true)){this._scale(s);}};S.prototype.expandBoundingBox=function(b){if(this._viewport){this._expandBoundingBox(b,this._viewport.getCamera().getCameraRef());}};S.prototype.handleSelectionChanged=function(e){if(this._viewport){this._updateSelection(this._viewport._viewStateManager);}};S.prototype._updateGizmoTransformation=function(g,a){var s=this._updateGizmoObjectTransformation(this._gizmo,g);this._updateAxisTitles(this._axisTitles,this._gizmo,a,this._gizmoSize+30,s);};S.prototype.render=function(){if(this._nodes.length>0){var r=this._viewport.getRenderer(),a=this._viewport.getCamera().getCameraRef();this._matViewProj.multiplyMatrices(a.projectionMatrix,a.matrixWorldInverse);r.clearDepth();for(var i=0,l=this.getGizmoCount();i<l;i++){this._updateGizmoTransformation(i,a);r.render(this._sceneGizmo,a);}}};S.prototype.onBeforeRendering=function(){};S.prototype.onAfterRendering=function(){};return S;},true);
