/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["./Tool","./HitTestToolHandler"],function(T,H){"use strict";var a=T.extend("sap.ui.vk.tools.HitTestTool",{metadata:{properties:{IdMode:{type:"sap.ui.vk.tools.HitTestIdMode",defaultValue:sap.ui.vk.tools.HitTestIdMode.ThreeJS}},events:{hit:{parameters:{id:"any",object:"any",point:"any",clickType:"sap.ui.vk.tools.HitTestClickType"}}}},constructor:function(i,s){if(a._instance){return a._instance;}T.apply(this,arguments);this.setToolid("63150593-75f6-c330-2a7a-c1f85d36b2b9");this._viewport=null;this._handler=null;this._loco=null;a._instance=this;}});a.prototype.init=function(){if(T.prototype.init){T.prototype.init.call(this);}this.setFootprint(["sap.ui.vk.threejs.Viewport"]);};a.prototype.setActive=function(v,b,g){if(T.prototype.setActive){T.prototype.setActive.call(this,v,b,g);}if(v){this._activateTool(b);}else{this._deactivateTool();}return this;};a.prototype._activateTool=function(b){this._viewport=this.getViewportImplementation(b);this._handler=new H(this);this._prepare();};a.prototype._deactivateTool=function(){if(this._handler){this._viewport._loco.removeHandler(this._handler);}this._handler=null;};a.prototype._prepare=function(){var o=false;if(this._viewport._loco){this._viewport._loco.addHandler(this._handler);o=true;}if(o){if(this.isViewportType("sap.ui.vk.dvl.Viewport")&&this._viewport._dvl){this._dvlRendererId=this._viewport._dvlRendererId;this._dvl=this._viewport._dvl;o=true;}else if(this.isViewportType("sap.ui.vk.threejs.Viewport")&&(this._viewport._scene&&this._viewport._scene.getSceneRef())){o=true;}}return o;};a.prototype.queueCommand=function(c){if(this._prepare()){if(this._dvlRendererId){this._dvl.Renderer._queueCommand(c,this._dvlRendererId);}}return this;};a.prototype.hitTest=function(x,y,s,c,b){if(this._prepare()){var h=null;if(this.isViewportType("sap.ui.vk.dvl.Viewport")&&this._viewport._dvl){return null;}else if(this.isViewportType("sap.ui.vk.threejs.Viewport")){if(!s||!c){h=null;}else if(this._viewport._renderer){var e=this._viewport._renderer.domElement;var m=new THREE.Vector2((x-e.offsetLeft)/e.clientWidth*2-1,(e.offsetTop-y)/e.clientHeight*2+1);var r=new THREE.Raycaster();r.setFromCamera(m,c.getCameraRef());var i=r.intersectObjects(s.getSceneRef().children,true);if(i&&i.length){h=i[0];}}}var d=null;if(h){var f;switch(this.getIdMode()){case sap.ui.vk.tools.HitTestIdMode.VEsID:f=this._viewport._scene.nodeRefToPersistentId(h.object);break;case sap.ui.vk.tools.HitTestIdMode.ThreeJS:f=h.object.id;break;default:f=h.object.id;break;}d={id:f,object:h.object,point:h.point,clickType:b};this.fireHit(d);}return d;}};a.prototype.destroy=function(){T.prototype.destroy.call(this);this._viewport=null;this._handler=null;};return a;});
