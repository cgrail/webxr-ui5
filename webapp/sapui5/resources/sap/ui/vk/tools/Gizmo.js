/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["jquery.sap.global","./library","sap/ui/core/Control"],function(q,a,C){"use strict";var G=C.extend("sap.ui.vk.tools.Gizmo",{metadata:{library:"sap.ui.vk.tools"}});G.prototype.hasDomElement=function(){return true;};G.prototype._createAxisTitles=function(s,f,d){s=s||32;f=f||20;function c(t,b){var e=document.createElement("canvas");e.width=e.height=s*window.devicePixelRatio;var h=e.getContext("2d");var i=e.width*0.5;h.font="Bold "+f*window.devicePixelRatio+"px Arial";h.textAlign="center";h.textBaseline="middle";h.fillStyle="#000";h.globalAlpha=0.5;h.filter="blur(3px)";h.fillText(t,i+1,i+1);h.fillStyle="#fff";h.globalAlpha=1;h.filter="blur(0px)";h.fillText(t,i,i);if(d){h.beginPath();h.arc(i,i,i-window.devicePixelRatio,0,2*Math.PI,false);h.closePath();h.lineWidth=window.devicePixelRatio*2;h.strokeStyle="#fff";h.stroke();}var j=new THREE.Texture(e);j.needsUpdate=true;var m=new THREE.MeshBasicMaterial({map:j,color:b,transparent:true,alphaTest:0.05,premultipliedAlpha:true,side:THREE.DoubleSide});var k=new THREE.Mesh(new THREE.PlaneGeometry(s,s),m);k.userData.color=b;return k;}var g=new THREE.Group();g.add(c("X",0xFF0000));g.add(c("Y",0x00FF00));g.add(c("Z",0x0000FF));return g;};G.prototype._extractBasis=function(m){var b=[new THREE.Vector3(),new THREE.Vector3(),new THREE.Vector3()];m.extractBasis(b[0],b[1],b[2]);b[0].normalize();b[1].normalize();b[2].normalize();return b;};G.prototype._updateAxisTitles=function(o,g,c,d,s){var b=this._extractBasis(g.matrixWorld);o.children.forEach(function(e,i){e.position.copy(b[i]).multiplyScalar(d.constructor===THREE.Vector3?d.getComponent(i):d);e.quaternion.copy(c.quaternion);});o.position.copy(g.position);o.scale.setScalar(s);};G.prototype._updateSelection=function(b){var n=[];b.enumerateSelection(function(c){n.push({node:c});});if(this._nodes.length===n.length&&this._nodes.every(function(v,i){return n[i].node===v.node;})){return false;}this._nodes=n;n.forEach(function(c){c.ignore=false;var p=c.node.parent;while(p&&!c.ignore){for(var i=0,l=n.length;i<l;i++){if(n[i].node===p){c.ignore=true;break;}}p=p.parent;}});return true;};G.prototype._updateGizmoObjectTransformation=function(o,i){var r=this._viewport.getRenderer(),c=this._viewport.getCamera().getCameraRef();var p,s;if(this._coordinateSystem===sap.ui.vk.tools.CoordinateSystem.Local){var n=this._nodes[i].node;o.matrixAutoUpdate=false;n.matrixWorld.decompose(o.position,o.quaternion,o.scale);p=new THREE.Vector4().copy(o.position).applyMatrix4(this._matViewProj);s=p.w*r.getPixelRatio()/(r.getSize().width*c.projectionMatrix.elements[0]);var b=this._extractBasis(n.matrixWorld);o.matrix.makeBasis(b[0],b[1],b[2]);o.matrix.scale(new THREE.Vector3().setScalar(this._gizmoSize*s));o.matrix.copyPosition(n.matrixWorld);}else if(this._nodes.length>0){o.matrixAutoUpdate=true;if(this._nodes.length===1){o.position.setFromMatrixPosition(this._nodes[0].node.matrixWorld);}else{o.position.setScalar(0);var d=new THREE.Vector3();this._nodes.forEach(function(e){var n=e.node;if(n.userData.boundingBox){n.userData.boundingBox.getCenter(d);o.position.add(d.applyMatrix4(n.matrixWorld));}else{o.position.add(d.setFromMatrixPosition(n.matrixWorld));}});o.position.multiplyScalar(1/this._nodes.length);}if(this._coordinateSystem===sap.ui.vk.tools.CoordinateSystem.Screen){o.quaternion.copy(c.quaternion);}else if(this._coordinateSystem===sap.ui.vk.tools.CoordinateSystem.World){o.quaternion.set(0,0,0,1);}p=new THREE.Vector4().copy(o.position).applyMatrix4(this._matViewProj);s=p.w*r.getPixelRatio()/(r.getSize().width*c.projectionMatrix.elements[0]);o.scale.setScalar(this._gizmoSize*s);}o.updateMatrixWorld(true);return s;};G.prototype._expandBoundingBox=function(b,c){var g=this.getGizmoCount();if(g>0){this._matViewProj.multiplyMatrices(c.projectionMatrix,c.matrixWorldInverse);for(var i=0;i<g;i++){this._updateGizmoTransformation(i,c);this._sceneGizmo._expandBoundingBox(b,true);}}};return G;},true);
