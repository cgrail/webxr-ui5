/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/thirdparty/sinon","sap/ui/test/_OpaLogger","sap/ui/test/autowaiter/_utils"],function(s,_,a){"use strict";var l=_.getLogger("sap.ui.test.autowaiter._XHRWaiter");var h=_.getLogger("sap.ui.test.autowaiter._XHRWaiter#hasPending");var x=[];var u=s.useFakeXMLHttpRequest;s.useFakeXMLHttpRequest=function(){var F=u.apply(this,arguments);b();return F;};function b(){var k=XMLHttpRequest.restore;if(k){XMLHttpRequest.restore=function(){var r=k.apply(this,arguments);x=j();return r;};}}b();var o=s.FakeXMLHttpRequest.prototype.open;s.FakeXMLHttpRequest.prototype.open=function(){return o.apply(this,d.apply(this,arguments));};var O=XMLHttpRequest.prototype.open;XMLHttpRequest.prototype.open=function(){return O.apply(this,d.apply(this,arguments));};var f=s.FakeXMLHttpRequest.prototype.send;s.FakeXMLHttpRequest.prototype.send=function(){e.call(this,true);return f.apply(this,arguments);};var c=XMLHttpRequest.prototype.send;XMLHttpRequest.prototype.send=function(){e.call(this);return c.apply(this,arguments);};function d(m,U,A){var I="XHR_WAITER_IGNORE:";this.url=U;this.method=m;this.async=A;if(m.startsWith(I)){var M=m.substring(I.length);arguments[0]=M;this.method=M;this.ignored=true;}return arguments;}function e(I){if(this.ignored){return;}var n={url:this.url,method:this.method,async:this.async,fake:I,trace:a.resolveStackTrace()};var N=g(n);if(this.async){x.push(n);l.trace("New pending:"+N);this.addEventListener("readystatechange",function(){if(this.readyState===4){x.splice(x.indexOf(n),1);l.trace("Finished:"+N);}});}else{l.trace("Finished:"+N);}}function g(X){var m=X.fake?"\nFakeXHR: ":"\nXHR: ";m+="URL: '"+X.url+"' Method: '"+X.method+"' Async: '"+X.async+"'\nStack: "+X.trace;return m;}function i(){var F=j(true).length;var L="There are "+(x.length-F)+" open XHRs and "+F+" open FakeXHRs.";x.forEach(function(X){L+=g(X);});h.debug(L);}function j(I){return x.filter(function(X){return I?X.fake:!X.fake;});}return{hasPending:function(){var H=x.length>0;if(H){i();}return H;}};},true);
