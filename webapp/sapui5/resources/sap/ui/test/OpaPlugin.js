/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
(function(g){"use strict";var o;if(g.module){o=g.module;g.module=undefined;}sap.ui.define(['sap/ui/thirdparty/jquery','sap/ui/base/Object','sap/ui/core/mvc/View','sap/ui/test/matchers/Ancestor','sap/ui/test/matchers/MatcherFactory','sap/ui/test/pipelines/MatcherPipeline','sap/ui/test/_opaCorePlugin','sap/ui/test/_OpaLogger'],function($,U,V,A,M,a,_,b){var m=new M();var c=new a();var C=["id","viewName","viewId","controlType","searchOpenDialogs"];var O=U.extend("sap.ui.test.OpaPlugin",{constructor:function(){this._oLogger=b.getLogger("sap.ui.test.Opa5");},getAllControls:function(f,s){var d=_.getAllControls(f);this._oLogger.debug("Found "+d.length+" controls"+(f?" of type '"+(s||f)+"'":"")+" in page");return d;},getView:function(v){var d=this.getAllControls(V,"View");var e=d.filter(function(f){return f.getViewName()===v;});this._oLogger.debug("Found "+e.length+" views with viewName '"+v+"'");if(e.length>1){e=e.filter(function(f){var h=f.$();return h.length>0&&h.is(":visible")&&h.css("visibility")!=="hidden";});this._oLogger.debug("Found "+e.length+" visible views with viewName '"+v+"'");if(e.length!==1){this._oLogger.debug("Cannot identify controls uniquely. Please provide viewId to locate the exact view.");e=[];}}return e[0];},_getMatchingView:function(d){var v=null;var s;if(d.viewName){var e=(d.viewNamespace||"")+"."+(d.viewName||"");s=e.replace(/\.+/g,'.').replace(/^\.|\.$/g,"");}if(d.viewId){var f=_.getCoreElement(d.viewId,V);if(f&&(!s||f.getViewName()===s)){v=f;}}else{v=this.getView(s);}this._oLogger.debug("Found "+(v?"":"no ")+"view with ID '"+d.viewId+"' and viewName '"+s+"'");return v;},getControlInView:function(d){var v=this._getMatchingView(d);var s=typeof d.id==="string";if(!v){return s?null:[];}var e=v.getViewName();var f=d.fragmentId?d.fragmentId+O.VIEW_ID_DELIMITER:"";if($.isArray(d.id)){var h=[];var u=[];d.id.map(function(I){return f+I;}).forEach(function(I){var j=v.byId(I);if(j){h.push(j);}else{u.push(I);}});var i=u.length?". Found no controls matching the subset of IDs "+u:"";this._oLogger.debug("Found "+h.length+" controls with ID contained in "+d.id+" in view '"+e+"'"+i);return h;}if(s){var I=f+d.id;var j=v.byId(I)||null;this._oLogger.debug("Found "+(j?"":"no ")+"control with ID '"+I+"' in view '"+e+"'");return j;}var k=this.getAllControlsWithTheParent(v,d.controlType,d.sOriginalControlType);var l=$.type(d.id)==="regexp";if(l){k=k.filter(function(j){var n=this._getUnprefixedControlId(j.getId(),v.getId(),d.fragmentId);return d.id.test(n);}.bind(this));}this._oLogger.debug("Found "+k.length+" controls of type "+d.sOriginalControlType+(l?" with ID matching "+d.id:"")+" in view '"+e+"'");return k;},getAllControlsWithTheParent:function(p,f,s){var d=new A(p);return this._filterUniqueControlsByCondition(this.getAllControls(f,s),d);},getAllControlsInContainer:function(d,f,s,e){var h=this._filterUniqueControlsByCondition(this._getControlsInContainer(d),function(i){return _.checkControlType(i,f);});this._oLogger.debug("Found "+h.length+" controls in "+(e?e:"container")+" with controlType '"+s+"'");return h;},_getControlsInStaticArea:function(d){var v=this._getControlsInContainer($("#sap-ui-static"))||[];if(d.id){v=this._filterUniqueControlsByCondition(v,function(e){var u=e.getId();var f=this._getMatchingView(d);if(f){if(this._isControlInView(e,f.getViewName())){u=this._getUnprefixedControlId(e.getId(),f.getId(),d.fragmentId);}}var i=false;if(typeof d.id==="string"){i=u===d.id;}if($.type(d.id)==="regexp"){i=d.id.test(u);}if($.isArray(d.id)){i=d.id.filter(function(I){return I===u;}).length>0;}return i;}.bind(this));this._oLogger.debug("Found "+(v.length?v.length:"no")+" controls in the static area with ID matching '"+d.id+"'"+(d.fragmentId?" and fragmentId: '"+d.fragmentId+"'":""));}if(v.length&&d.controlType){v=this._filterUniqueControlsByCondition(v,function(e){return _.checkControlType(e,d.controlType);});this._oLogger.debug("Found "+(v.length?v.length:"no")+" controls in the static area with control type matching '"+d.controlType+"'");}if(d.id&&typeof d.id==="string"){return v[0]||null;}else{return v;}},_getControlsInContainer:function(j){return j.find("*").control();},_isControlInView:function(d,v){if(!d){return false;}if(d.getViewName&&d.getViewName()===v){return true;}else{return this._isControlInView(d.getParent(),v);}},getMatchingControls:function(d){var r=null;d=d||{};var h=this._modifyControlType(d);if(!h){return typeof d.id==="string"?r:[];}if(d.searchOpenDialogs){r=this._getControlsInStaticArea(d);}else if(d.viewName||d.viewId){r=this.getControlInView(d);}else if(d.id){r=this.getControlByGlobalId(d);}else if(d.controlType){r=this.getAllControls(d.controlType,d.sOriginalControlType);}else{r=this.getAllControls();}if(!r||d.visible===false){return r;}var i=m.getInteractabilityMatchers(d.interactable);var p=c.process({control:r,matchers:i});if(!p){if($.isArray(r)){return[];}if(r){return null;}return r;}return p;},_getFilteredControls:function(d){var v=this._filterControlsByCondition(d);return v===O.FILTER_FOUND_NO_CONTROLS?O.FILTER_FOUND_NO_CONTROLS:this._filterControlsByMatchers(d,v);},_getFilteredControlsByDeclaration:function(d){var v=this._filterControlsByCondition(d);var e=$.extend({},d,{useDeclarativeMatchers:true});return v===O.FILTER_FOUND_NO_CONTROLS?O.FILTER_FOUND_NO_CONTROLS:this._filterControlsByMatchers(e,v);},_filterControlsByCondition:function(d){var v=null;var p=this._isLookingForAControl(d);if(p){v=this.getMatchingControls(d);}var e=[typeof d.id==="string"&&!v,$.type(d.id)==="regexp"&&!v.length,$.isArray(d.id)&&(!v||v.length!==d.id.length),d.controlType&&$.isArray(v)&&!v.length,!d.id&&(d.viewName||d.viewId||d.searchOpenDialogs)&&!v.length];return e.some(Boolean)?O.FILTER_FOUND_NO_CONTROLS:v;},_filterControlsByMatchers:function(d,v){var e=d.useDeclarativeMatchers?m.getFilteringMatchers(d):d.matchers;var p=this._isLookingForAControl(d);var r=null;if((v||!p)&&e){r=c.process({matchers:e,control:v});if(!r){return O.FILTER_FOUND_NO_CONTROLS;}}else{r=v;}return r;},getControlByGlobalId:function(d){if(typeof d.id==="string"){var e=_.getCoreElement(d.id);if(e&&!_.checkControlType(e,d.controlType)){this._oLogger.error("A control with global ID '"+d.id+"' is found but does not have required controlType '"+d.sOriginalControlType+"'. Found control is '"+e+"' but null is returned instead");return null;}this._oLogger.debug("Found "+(e?"":"no ")+"control with the global ID '"+d.id+"'");return e;}var f=[];var h=$.type(d.id)==="regexp";var i=_.getCoreElements();if(h){for(var E in i){if(i.hasOwnProperty(E)&&d.id.test(E)){f.push(E);}}}if($.isArray(d.id)){f=d.id;}var j=[];var u=[];f.forEach(function(I){var e=i[I];if(e&&_.checkControlType(e,d.controlType)&&!e.bIsDestroyed){j.push(e);}else{u.push(I);}});var s=!h&&u.length?". Found no controls of matching the subset of IDs "+u:"";this._oLogger.debug("Found "+j.length+" controls of type "+d.sOriginalControlType+(h?" with ID matching '":" with ID contained in '")+d.id+s);return j;},getControlConstructor:function(s){if(sap.ui.lazyRequire._isStub(s)){this._oLogger.debug("The control type "+s+" is currently a lazy stub.");return null;}var f=$.sap.getObject(s);if(!f){this._oLogger.debug("The control type "+s+" is undefined.");return null;}return f;},_isLookingForAControl:function(d){return Object.keys(d).some(function(k){return C.indexOf(k)!==-1&&!!d[k];});},_filterUniqueControlsByCondition:function(d,f){return d.filter(function(e,p,h){var k=!!f(e);return k&&h.indexOf(e)===p;});},_modifyControlType:function(d){var v=d.controlType;if(typeof v!=="string"){if(v&&v._sapUiLazyLoader){this._oLogger.debug("The control type is currently a lazy stub");return false;}return true;}var f=this.getControlConstructor(v);if(!f){return false;}d.sOriginalControlType=v;d.controlType=f;return true;},_getUnprefixedControlId:function(s,v,f){var u=s.replace(v+O.VIEW_ID_DELIMITER,"");if(f){if(u.startsWith(f+O.VIEW_ID_DELIMITER)){u=u.replace(f+O.VIEW_ID_DELIMITER,"");}else{u="";}}return u;}});O.FILTER_FOUND_NO_CONTROLS="FILTER_FOUND_NO_CONTROL";O.VIEW_ID_DELIMITER="--";return O;});if(o){g.module=o;}})(window);
