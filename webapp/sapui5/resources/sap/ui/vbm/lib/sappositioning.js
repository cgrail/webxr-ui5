VBI.addScenePositioningFunctions=
function(s){"use strict";s.GetNearestPosArray=function(p){var a=p.slice();var n=Math.floor(a.length/3)*3;var b=a[0];var c=a[1];var m=b,d=b;var e=c,f=c;for(var g=3;g<n;g+=3){while(a[g]-b>180){a[g]-=360;}while(b-a[g]>180){a[g]+=360;}b=a[g];c=a[g+1];if(m>b){m=b;}if(d<b){d=b;}if(e>c){e=c;}if(f<c){f=c;}}a.m_MinX=m;a.m_MaxX=d;a.m_MinY=e;a.m_MaxY=f;return a;};s.GetNearestPos=function(a,n){var p=a.slice();var b=n[0];while(p[0]-b>180){p[0]-=360;}while(b-p[0]>180){p[0]+=360;}return p;};s.BuildCacheDataObj=function(){var n={};n.mul=Math.PI/180.0;var c=s.m_Canvas[0];var a=s.m_Canvas[s.m_nOverlayIndex];var l=c.m_nCurrentLOD;n.minLOD=s.GetMinLOD();n.lod=l;n.nMaxLODTiles=(1<<l);n.tilePixelWidth=s.m_nWidthCanvas/s.m_nTilesX;n.tilePixelHeight=s.m_nHeightCanvas/s.m_nTilesY;n.completeX=n.nMaxLODTiles*n.tilePixelWidth;n.completeY=n.nMaxLODTiles*n.tilePixelHeight;n.fx=a.getPixelWidth()/s.m_nWidthCanvas;n.fy=a.getPixelHeight()/s.m_nHeightCanvas;var p=s.m_Proj;n.ucs_min=p.m_nUCSMin*n.completeX;n.ucs_max=p.m_nUCSMax*n.completeX;n.ucs_compl=p.m_nXYRatio*n.completeX;n.ox=c.m_nCurrentX*n.tilePixelWidth+n.ucs_min;n.oy=c.m_nCurrentY*n.tilePixelHeight;n.factX=n.completeX*n.fx;n.factY=n.completeY*n.fy;n.addX=-n.ox*n.fx;n.addY=-n.oy*n.fy;s.m_CacheVars=n;};s.DestroyCacheDataObj=function(){s.m_CacheVars=undefined;};s.FillPositionCache=function(p,u){var n=s.m_CacheVars;var a=[1.0,1.0],c=[];var b=u?0:p[0];var d,e;var m=p[0],f=p[0];var g=p[1],h=p[1];var l=s.m_Proj.LonLatToUCS;var i=n.mul;for(var j=0,k=p.length;j<k;j+=3){d=p[j];e=p[j+1];while(d-b>180){d-=360;}while(b-d>180){d+=360;}if(d<m){m=d;}if(d>f){f=d;}if(e<g){g=e;}if(e>h){h=e;}a=l([i*d,i*e],[1.0,1.0]);c.push(a[0],a[1],0);if(!u){b=d;}}p.cache={data:c,ref:s.m_CacheVars,lt:l([i*m,i*h],[1.0,1.0]),rb:l([i*f,i*g],[1.0,1.0]),minLod:-Math.log(Math.max(f-m,h-g))/Math.log(2)};};s.GetVOExtension=function(p){if(p.cache==undefined){s.FillPositionCache(p);}return p.cache.BB;};s.GetPointArrayFromPosArrayWCache=function(p){if(p.cache==undefined){s.FillPositionCache(p);}return p.cache.data;};s.GetPointFromUCSPoint=function(p){var n=s.m_CacheVars;return[p[0]*n.factX+n.addX,p[1]*n.factY+n.addY];};s.GetPointArrayFromUCSArray=function(p){var n=s.m_CacheVars;var f=n.factX,a=n.factY;var b=n.addX,c=n.addY;var r=[];for(var d=0;d<=p.length-3;d+=3){r.push(p[d]*f+b,p[d+1]*a+c,0.0);}return r;};s.GetShortPointArrayFromUCSArray=function(p){var n=s.m_CacheVars;var f=n.factX,a=n.factY;var b=n.addX,c=n.addY;var r=[];for(var d=0;d<=p.length-3;d+=3){r.push(p[d]*f+b,p[d+1]*a+c);}return r;};s.GetPointArrayFromPosArray=function(p,a,i){var l=[0.0,0.0],r=[];var c=s.m_Canvas[0];var n=(1<<c.m_nCurrentLOD);var t=s.m_nWidthCanvas/s.m_nTilesX;var b=s.m_nHeightCanvas/s.m_nTilesY;var d=n*t;var e=n*b;var f=s.m_Canvas[s.m_nOverlayIndex];var g=i?1:f.getPixelWidth()/s.m_nWidthCanvas;var h=i?1:f.getPixelHeight()/s.m_nHeightCanvas;var j=s.m_Proj.LonLatToUCS;var u=[0,0],m=Math.PI/180.0;var k=s.m_Proj;var o=k.m_nUCSMin*d;var q=k.m_nUCSMax*d;var v=k.m_nXYRatio*d;var w=c.m_nCurrentX*t+o;var z=c.m_nCurrentY*b;var A,B;for(A=0,B=p.length;A<B;A+=3){l[0]=m*p[A];l[1]=m*p[A+1];u[0]=d;u[1]=e;u=j(l,u);u[0]=u[0]-w;u[1]=u[1]-z;if(a){while(u[0]<o){u[0]+=v;}while(u[0]>q){u[0]-=v;}}r.push(u[0]*g,u[1]*h,0.0);}if(B==1&&u){var x,y;r.m_bVisible=(((x=u[0])>0)&&((y=u[1])>0)&&(x<s.m_nWidthCanvas)&&(y<s.m_nHeightCanvas));}return r;};s.GetPointFromGeo=function(l,a){return s.GetPointArrayFromPosArray(VBI.MathLib.RadToDeg(l),a);};s.GetInstanceOffsets=function(r){var a=r.slice();var c=s.m_Canvas[0];var t=s.m_nWidthCanvas/s.m_nTilesX;var b=(1<<c.m_nCurrentLOD)*t*s.m_Proj.m_nXYRatio;var d=[0,0,s.m_nWidthCanvas,s.m_nHeightCanvas];var n=0;while(a[2]>0){--n;VBI.Utilities.RectOffset(a,-b,0);}var o=[];while(a[0]<s.m_nWidthCanvas){n++;VBI.Utilities.RectOffset(a,b,0);if(VBI.Utilities.RectIntersect(a,d)){o.push(n*b);}}return o;};s.GetCorrectedInstanceOffsets=function(r,z){var a=r.slice();var c=s.m_Canvas[0];var t=s.m_nWidthCanvas/s.m_nTilesX;var b=z[0]*(1<<c.m_nCurrentLOD)*t*s.m_Proj.m_nXYRatio;var d=[0,0,z[0]*s.m_nWidthCanvas,z[1]*s.m_nHeightCanvas];var n=0;while(a[2]>0){--n;VBI.Utilities.RectOffset(a,-b,0);}var o=[];while(a[0]<s.m_nWidthCanvas){n++;VBI.Utilities.RectOffset(a,b,0);if(VBI.Utilities.RectIntersect(a,d)){o.push(n*b);}}return o;};s.GetPosFromVPPoint=function(p){var c=s.m_Canvas[s.m_nOverlayIndex];var a=[p[0]-c.getPixelLeft(),p[1]-c.getPixelTop(),0];var t=this.GetGeoFromPoint(a);return VBI.MathLib.RadToDeg(t);};s.GetPosFromPoint=function(p){var t=this.GetGeoFromPoint(p);return VBI.MathLib.RadToDeg(t);};s.GetGeoFromPoint=function(p){var c=s.m_Canvas[0];var n=c.m_nCurrentLOD;var a=(1<<n);var b=p[0]*s.m_nWidthCanvas/c.getPixelWidth();var d=p[1]*s.m_nHeightCanvas/c.getPixelHeight();var t=s.m_nWidthCanvas/s.m_nTilesX;var e=s.m_nHeightCanvas/s.m_nTilesY;var f=c.m_nCurrentX*t;var g=c.m_nCurrentY*e;var h=f+b;var i=g+d;var j=a*t;var k=a*e;var l=[0,0];var u=[h/j*2.0-1.0,i/k*2.0-1.0];return s.m_Proj.UCSToLonLat(u,l);};}
;
