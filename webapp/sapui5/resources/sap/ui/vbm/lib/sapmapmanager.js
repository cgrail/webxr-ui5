VBI.MapManager=(function(){"use strict";var m={};m.vbiclass="MapManager";m.m_nRequest=0;m.m_tileWidth=256;m.m_tileHeight=256;m.m_runningRequests=0;m.m_limitRequests=12;m.m_requestQueue=[];m.m_renderQueue=[];m.m_renderRequestID=0;m.m_failedSendTimer=0;m.m_renderJunksize=100;m.onAbort=function(e){var i=e.srcElement;if(VBI.m_bTrace){VBI.Trace("onAbort "+i.src);}m.CheckReqQueue();m.UnlinkImage(i);m.CheckTmpCanvas(i.m_Target,i.m_nRequest,i.m_nLayersAbove);};m.onFailedSend=function(o){if(VBI.m_bTrace){VBI.Trace("onFailedSend "+o.src);}m.m_runningRequests--;m.m_bRequestError=true;if(!m.m_failedSendTimer){m.m_failedSendTimer=setInterval(function(){m.RetrySending();},750);}};m.onError=function(e){var i=e.srcElement;if(VBI.m_bTrace){VBI.Trace("onError "+i.src);}m.CheckReqQueue();var a=null;if(i.m_Next!=null){i.m_Next.m_FillStyle=i.m_FillStyle;}if(i.m_Prev==null&&i.m_Next!=null&&i.m_Next.complete==true){a=i.m_Next;}m.UnlinkImage(i);if(a!=null){m.m_renderQueue.push(a);if(!m.m_renderRequestID){m.m_renderRequestID=window.requestAnimationFrame(m.RenderTiles);}}else{m.CheckTmpCanvas(i.m_Target,i.m_nRequest,i.m_nLayersAbove);}};m.onLoad=function(e){var i=e.target;if(!i.complete){return;}if(VBI.m_bTrace){VBI.Trace("VBI.MapManager: onLoad  "+i.src);}m.CheckReqQueue();var c=true;var a;for(a=i.m_Prev;a!=null;a=a.m_Prev){c&=a.complete;}for(a=i.m_Next;a!=null;a=a.m_Next){c&=a.complete;}if(!c){if(VBI.m_bTrace){VBI.Trace("VBI.MapManager: onLoad skip as there is a a not yet loaded tile ");}return;}m.m_renderQueue.push(i);if(!m.m_renderRequestID){m.m_renderRequestID=window.requestAnimationFrame(m.RenderTiles);}};m.RetrySending=function(){clearInterval(m.m_failedSendTimer);m.m_failedSendTimer=0;m.m_bRequestError=false;m.m_runningRequests++;m.CheckReqQueue();};m.CheckReqQueue=function(){while((m.m_requestQueue.length)&&(!m.m_bRequestError)){var i=m.m_requestQueue.shift();var t=i.m_Target;if(i.m_nLOD!=t.m_nCurrentLOD||t.m_bInvalid){m.UnlinkImage(i);m.CheckTmpCanvas(t,i.m_nRequest,i.m_nLayersAbove);}else{try{i.src=i.src2execute;}catch(e){m.m_requestQueue.unshift(i);m.onFailedSend(i);}return;}}m.m_runningRequests--;};m.RenderTiles=function(){var n=Math.min(m.m_renderQueue.length,m.m_renderJunksize);for(var i=0;i<n;++i){m.RenderTile(m.m_renderQueue.shift());}m.m_renderRequestID=m.m_renderQueue.length>0?window.requestAnimationFrame(m.RenderTiles):0;};m.RenderTile=function(i){if(!i.bRendered){var t=i.m_Target;if((t.m_CanvasRedirect!=undefined)&&(t.m_CanvasRedirRequest==i.m_nRequest)){t=t.m_CanvasRedirect;}var c=t.m_Scene;if(!c){return;}var a=t.getPixelWidth();var b=t.getPixelHeight();t.m_nAppliedRequest=Math.max(t.m_nAppliedRequest,i.m_nRequest);var d=t.getContext('2d');var n=(1<<d.canvas.m_nCurrentLOD);var e=((i.m_nReqX-d.canvas.m_nCurrentX)%n+n)%n;if(n<c.m_nTilesX){e=i.m_nCol+i.m_nXOrigin-d.canvas.m_nCurrentX;}var f=i.m_nReqY-d.canvas.m_nCurrentY;if(i.m_bOutdated||(e<0)||(f<0)||(e>=i.m_numCol)||(f>=i.m_numRow)||(i.m_nLOD!=t.m_nCurrentLOD||t.m_bInvalid)){m.UnlinkImage(i);if(VBI.m_bTrace){VBI.Trace("VBI.MapManager: RenderTile  "+i.src+" is outdated");}m.CheckTmpCanvas(t,i.m_nRequest,i.m_nLayersAbove);return;}if(VBI.m_bTrace){VBI.Trace("VBI.MapManager: RenderTile  "+i.src);}var g=c.m_nWidthCanvas;var h=c.m_nHeightCanvas;t.setPixelWidth(g);t.setPixelHeight(h);var j=g/c.m_nTilesX;var k=h/c.m_nTilesY;var l=e*j;var o=f*k;var p=i.m_nXExpansion*j;var q=i.m_nYExpansion*k;var r=i;var s;while(r.m_Prev!=null){r=r.m_Prev;}while(r!=null&&r.complete==true){if(r.m_FillStyle!=null){if(VBI.m_bTrace){VBI.Trace("RenderTile fillRect "+r.src);}s=d.fillStyle;d.fillStyle=r.m_FillStyle;d.fillRect(l,o,p,q);d.fillStyle=s;}if(VBI.m_bTrace){VBI.Trace("RenderTile drawImage "+r.src);}d.globalAlpha=r.m_Opacity;d.drawImage(r,l,o,p,q);r.bRendered=true;if(r.m_Next!=null){r.m_Next.m_Prev=null;}r=r.m_Next;}if(VBI.m_bTrace){s=d.fillStyle;d.fillStyle="#FF0000";d.font="18px Arial";d.fillText(i.m_nRequest+"."+i.m_nCount+":"+i.m_nLOD+"/"+i.m_nReqX+"/"+i.m_nReqY+"@("+(l/256)+","+(o/256)+")",l+10,o+30);d.fillStyle=s;}t.setPixelWidth(a);t.setPixelHeight(b);if(t.onTileLoaded){t.onTileLoaded(i);}d.globalAlpha=1.0;m.CheckTmpCanvas(t,i.m_nRequest,0);if(c.m_Ctx.moThumbnail){c.Copy2Thumbnail();}}};m.CheckTmpCanvas=function(t,i,n){if((t.m_nTilesBefSwitch!=undefined)&&(t.m_nRequest==i)&&!n){t.m_nTilesBefSwitch--;if(!t.m_nTilesBefSwitch){t.m_Scene.SwitchTmpCanvasToActive();}}};m.RequestTiles=function(t,a,x,y,n,b,l,c,r,d,f,g){m.m_bRequestError=false;if(f<0){return false;}var h=t.m_Scene;if(!a||((h.AnimZoomTarget)&&(Math.abs(h.AnimZoomTarget-f)>h.m_nMaxAnimLodDiff))){t.m_nCurrentX=x;t.m_nCurrentY=y;t.m_nCurrentLOD=f;return false;}var j=0;var o=(1<<f);var p=h.m_Proj.m_nXYRatio;var q=o*p;var T=2.0/o;if(g){var u=t.getContext("2d");u.fillStyle='white';u.clearRect(0,0,u.canvas.width,u.canvas.height);}var v=a.m_MapLayerArray;t.m_nRequest=m.m_nRequest++;t.m_bInvalid=false;t.m_nCurrentX=x;t.m_nCurrentY=y;t.m_nCurrentLOD=f;var w,z,A,B=1;var C=y;if(a.m_bSingleBMP){z=1;C=Math.max(0,y);A=Math.min(b-c-d,o-C);}else{z=b-c-d;A=1;}var D=v.length;w=n-l-r;for(var i=0;i<w;++i){B--;if(!B){for(var k=0;k<z;++k){j++;var E=null;var F=null;var G=(x+l+i)%q;if(G<0){G=q+G;}var H=C+c+k;if((H+A)<=0||H>=o){if((t.m_nTilesBefSwitch!=undefined)&&(t.m_nTilesBefSwitch>0)){t.m_nTilesBefSwitch--;}continue;}B=a.m_bSingleBMP?Math.min(q-G,w-i):1;for(var s=0;s<D;++s){var I=v[s];if(a.fillStyle){F=a.fillStyle;}else if(a.m_colBkgnd){F=a.m_colBkgnd;}if((I.GetMinLOD()>f)||(I.GetMaxLOD()<f)){continue;}var J=new Image();J.m_nLayersAbove=D-s-1;J.m_nXOrigin=x;J.m_nYOrigin=y;J.m_nCol=i+l;J.m_nRow=k+c;J.m_numCol=n;J.m_numRow=b;J.m_Target=t;J.m_nRequest=t.m_nRequest;J.m_Opacity=I.m_fOpacity;J.m_bOutdated=false;J.m_Prev=E;if(E!=null){E.m_Next=J;}if(J.m_Prev==null){J.m_FillStyle=F;}J.m_nReqX=G;J.m_nReqY=H;J.m_nXExpansion=B;J.m_nYExpansion=A;J.m_nLOD=f;var K=I.GetMapProvider();var L;if(K.m_bPosRequired){var M=[G*T/p-1,H*T-1];var N=[(G+B)*T/p-1,(H+A)*T-1];L=K.CombineUrlWPos(G,H,f,T,M,N,B,A,m.m_requestTileWidth,m.m_requestTileHeight);}else{L=K.CombineUrl(G,H,f);}J.onload=m.onLoad;J.onerror=m.onError;J.onabort=m.onAbort;if((m.m_runningRequests<m.m_limitRequests)&&(!m.m_bRequestError)){m.m_runningRequests++;try{J.src=L;}catch(e){J.src2execute=L;m.m_requestQueue.push(J);m.onFailedSend(J);}}else{J.src2execute=L;m.m_requestQueue.push(J);}J.m_nCount=j;if(VBI.m_bTrace){VBI.Trace("RequestTiles "+L);}E=J;}}}}return true;};m.UnlinkImage=function(i){var a;for(a=i.m_Prev;a;a=a.m_Prev){a.m_bOutdated=true;}for(a=i.m_Next;a;a=a.m_Next){a.m_bOutdated=true;}var c=i.m_Prev;var b=i.m_Next;if(c!=null){i.m_Prev.m_Next=b;i.m_Prev=null;}if(b!=null){i.m_Next.m_Prev=c;i.m_Next=null;}};m.GetPreviewImage=function(l,a,b,c,s,d){if(!d||!c||!l||!b||!a||!s){return;}var e=Math.min(Math.max(b,s.GetMinLOD()),s.GetMaxLOD());b=Math.floor(e);var t=s.m_MapManager.m_tileWidth;var f=s.m_MapManager.m_tileHeight;var g=s.m_Proj.m_nXYRatio;var h=(1<<b);var j=2.0/h;var k=VBI.MathLib.DegToRad([parseFloat(l),parseFloat(a)]);var u=[h*t,h*f];s.m_Proj.LonLatToUCS(k,u);var x=Math.floor(u[0]/t);var y=Math.floor(u[1]/f);var n=c.m_MapLayerArray;var o={m_Callback:d,m_Images:[],m_ImagesRemain:n.length,m_MapLayerStack:c,compose:function(){this.m_ImagesRemain-=1;if(this.m_ImagesRemain<=0){var E=document.createElement('canvas');o=E.getContext('2d');var F=this.m_MapLayerStack.m_colBkgnd;o.fillStyle=F;o.fillRect(0,0,E.width,E.height);for(var i=0;i<this.m_Images.length;++i){if(this.m_Images[i]){o.globalAlpha=this.m_Images[i].m_Opacity;var G=0;var H=0;var I=this.m_Images[i].width;var J=this.m_Images[i].height;var K=0;var L=0;var M=E.width;var N=E.height;o.drawImage(this.m_Images[i],G,H,I,J,K,L,M,N);}}var O=new Image();O.src=E.toDataURL();d(O);}}};var p=function(E){if(VBI.m_bTrace){VBI.Trace("onLoad "+E.target.src);}var C=E.target;C.m_Context.compose();};var q=function(E){if(VBI.m_bTrace){VBI.Trace("onAbort "+E.target.src);}var C=E.target;C.m_Context.m_Images[C.m_Index]=null;C.m_Context.compose();};var r=function(E){if(VBI.m_bTrace){VBI.Trace("onError "+E.target.src);}var C=E.target;C.m_Context.m_Images[C.m_Index]=null;C.m_Context.compose();};for(var i=0;i<n.length;++i){var v=n[i];var w=v.GetMapProvider();if(v.GetMinLOD()>b||v.GetMaxLOD()<b){continue;}var z;if(w.m_bPosRequired){var A=[x*j/g-1,y*j-1];var B=[(x+1)*j/g-1,(y+1)*j-1];z=w.CombineUrlWPos(x,y,b,j,A,B,1,1,t,f);}else{z=w.CombineUrl(x,y,b);}var C=new Image();C.setAttribute('crossOrigin','anonymous');o.m_Images[i]=C;C.m_Index=i;C.m_Context=o;if(v.m_fOpacity){C.m_Opacity=v.m_fOpacity;}C.onload=p;C.onabort=q;C.onerror=r;try{C.src=z;}catch(D){if(VBI.m_bTrace){VBI.Trace("GetPreviewImage "+D);}C.m_Context.m_Images[C.m_Index]=null;C.m_Context.compose();}}};return m;})();
