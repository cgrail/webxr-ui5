/*
 * ! SAPUI5

		(c) Copyright 2009-2019 SAP SE. All rights reserved
	
 */
sap.ui.define(['sap/m/Link','sap/ui/core/Control','sap/m/VBox','sap/m/HBox','sap/m/Button','sap/m/Title','sap/m/Image','sap/m/Text','sap/ui/layout/form/SimpleForm','sap/m/VBoxRenderer','./Factory','./LinkData','sap/ui/model/json/JSONModel','./Util','sap/ui/layout/HorizontalLayout','sap/ui/layout/VerticalLayout','sap/ui/layout/library','sap/ui/comp/personalization/Util','sap/ui/base/ManagedObjectObserver','sap/m/FlexItemData','sap/ui/model/BindingMode','sap/m/library','sap/ui/comp/personalization/Controller','sap/ui/comp/personalization/SelectionWrapper','sap/ui/comp/personalization/ColumnWrapper','sap/base/Log','sap/ui/comp/navpopover/flexibility/changes/AddLink','sap/ui/core/CustomData'],function(L,C,V,H,B,T,I,a,S,b,F,c,J,U,d,e,l,P,M,f,g,m,h,i,j,k,A,n){"use strict";var o=l.form.SimpleFormLayout;var p=m.FlexJustifyContent;var q=m.ButtonType;var N=V.extend("sap.ui.comp.navpopover.NavigationContainer",{metadata:{library:"sap.ui.comp",properties:{mainNavigationId:{type:"string",group:"Misc",defaultValue:null},enableAvailableActionsPersonalization:{type:"boolean",defaultValue:true}},aggregations:{availableActions:{type:"sap.ui.comp.navpopover.LinkData",multiple:true,singularName:"availableAction"},mainNavigation:{type:"sap.ui.comp.navpopover.LinkData",multiple:false}},associations:{extraContent:{type:"sap.ui.core.Control",multiple:false},component:{type:"sap.ui.core.Element",multiple:false}},events:{navigate:{},beforePopoverOpen:{},afterPopoverClose:{}}},renderer:b.render});N.prototype.init=function(){V.prototype.init.call(this);var r=new J({mainNavigationLink:{title:undefined,subtitle:undefined,href:undefined,target:undefined},availableActions:[],enableAvailableActionsPersonalization:undefined,extraContent:undefined,initialAvailableActions:[]});r.setDefaultBindingMode(g.TwoWay);r.setSizeLimit(1000);this.setModel(r,"$sapuicompNavigationContainer");this._oObserver=null;this._oAvailableActionsObserver=new M(this._observeAvailableActionsChanges.bind(this));this._oAvailableActionsObserver.observe(this,{aggregations:["availableActions"]});this.oPersonalizationController=null;};N.prototype.applySettings=function(){V.prototype.applySettings.apply(this,arguments);this._createContent();};N.prototype.exit=function(r){if(this._getInternalModel()){this._getInternalModel().destroy();}if(this._oObserver){this._oObserver.disconnect();this._oObserver=null;}if(this._oAvailableActionsObserver){this._oAvailableActionsObserver.disconnect();this._oAvailableActionsObserver=null;}};N.prototype.openSelectionDialog=function(r,s,t,u,v,w){this.fireBeforePopoverOpen();return sap.ui.fl.FlexControllerFactory.createForControl(this).waitForChangesToBeApplied(this).then(function(){return new Promise(function(x){var y=this._getInternalModel();var z=U.getStorableAvailableActions(y.getProperty("/initialAvailableActions"));var D=U.getStorableAvailableActions(y.getProperty("/availableActions")).map(function(G){return{columnKey:G.key,visible:G.visible};});var E=false;if(!this.oPersonalizationController){this.oPersonalizationController=new h({resetToInitialTableState:true,table:new i({columns:z.map(function(G){return new j({label:G.text,selected:G.visible,href:r?undefined:G.href,target:G.target,press:function(O){this._onLinkPress(O);}.bind(this),description:G.description,customData:new n({key:"p13nData",value:{columnKey:G.key}})});}.bind(this))}),setting:{selection:{visible:true,payload:{callbackSaveChanges:function(G){var K=(G&&G.selection&&G.selection.selectionItems)||[];if(t){t(K.map(function(R){return{key:R.columnKey,visible:R.visible};}));return Promise.resolve(true);}var O=[];var Q=[];K.forEach(function(R){if(R.visible===true){O.push({key:R.columnKey,visible:R.visible});}else{Q.push({key:R.columnKey,visible:R.visible});}});if(E){return N._discardChanges(this,u).then(function(){return N._saveChanges(O,Q,this).then(function(){return true;});}.bind(this));}return N._saveChanges(O,Q,this).then(function(){return true;});}.bind(this)}}},dialogConfirmedReset:function(){E=true;},dialogAfterClose:function(){this.fireAfterPopoverClose();x();}.bind(this)});}this.oPersonalizationController.setPersonalizationData({selection:{selectionItems:D}});this.oPersonalizationController.openDialog({contentWidth:"25rem",contentHeight:"35rem",styleClass:""+v,showReset:s,selection:{visible:true}});if(w){w.addDependent(this.oPersonalizationController._oDialog);}}.bind(this));}.bind(this));};N._discardChanges=function(s,r){return new Promise(function(t){sap.ui.getCore().loadLibrary('sap.ui.fl',{async:true}).then(function(){sap.ui.require(['sap/ui/comp/navpopover/FlexConnector'],function(u){return u.discardChangesForControl(s,r).then(function(){return t(true);},function(E){k.error("Changes could not be discarded in LRep: "+E);return t(false);});});});});};N._saveChanges=function(r,s,t){return new Promise(function(u){sap.ui.getCore().loadLibrary('sap.ui.fl',{async:true}).then(function(){sap.ui.require(['sap/ui/comp/navpopover/FlexConnector'],function(v){return v.createAndSaveChangesForControl(r,s,t).then(function(){return u(true);},function(E){k.error("Changes could not be saved in LRep: "+E);return u(false);});});});});};N.prototype.getDirectLink=function(){var r=this._getInternalModel();if(r.getProperty('/extraContent')){return null;}if(r.getProperty('/mainNavigationLink/href')&&!r.getProperty('/availableActions').length){return this._oHeaderArea.getItems()[0];}if(r.getProperty('/availableActions').length===1&&!r.getProperty('/mainNavigationLink/href')){return this._oActionArea.getItems()[0].getItems()[0];}return null;};N.prototype.hasContent=function(){var r=this._getInternalModel();return!!r.getProperty("/mainNavigationLink/href")||!!r.getProperty("/availableActions").length||!!r.getProperty('/extraContent');};N.prototype.setExtraContent=function(r){this.setAssociation("extraContent",r);if(!r){return this;}var s=this._getInternalModel();if(s.getProperty("/extraContent")){this.removeItem(1);}if(typeof r==="string"){r=sap.ui.getCore().byId(r);}this.insertItem(r,1);s.setProperty("/extraContent",r);return this;};N.prototype.setMainNavigationId=function(s){this.setProperty("mainNavigationId",s,true);var r=this._getInternalModel();if(typeof s==="string"){r.setProperty("/mainNavigationLink/title",s);}return this;};N.prototype.setMainNavigation=function(r){this.setAggregation("mainNavigation",r,true);if(!r){return this;}var s=this._getInternalModel();if(r.getHref()){s.setProperty("/mainNavigationLink/href",this._convertToExternal(r.getHref()));s.setProperty("/mainNavigationLink/target",r.getTarget());}if(!s.getProperty("/mainNavigationLink/title")&&s.getProperty("/mainNavigationLink/title")!==''){s.setProperty("/mainNavigationLink/title",r.getText());}s.setProperty("/mainNavigationLink/subtitle",r.getDescription());return this;};N.prototype.setEnableAvailableActionsPersonalization=function(E){this.setProperty("enableAvailableActionsPersonalization",E,true);this._getInternalModel().setProperty("/enableAvailableActionsPersonalization",E);return this;};N.prototype.onAfterRenderingActionForm=function(){var r=this._getInternalModel();var $=r.getProperty("/extraContent")?r.getProperty("/extraContent").$()[0]:undefined;if($&&$.scrollHeight>$.clientHeight){this.setFitContainer(false).setJustifyContent(p.Start);}};N.prototype._createContent=function(){this.addStyleClass("navigationPopover");this._oObserver=new M(function(u){if((u.type==="property"||u.type==="binding")&&u.name==="visible"){var v=this._getInternalModel().getProperty("/availableActions");var w=v.filter(function(x){return x.visible===true;});r.setVisible(w.length>0||!!this._getInternalModel().getProperty("/enableAvailableActionsPersonalization"));this._oActionArea.setVisible(w.length>0);if(this.hasContent()&&!this._getInternalModel().getProperty("/extraContent")){D.setVisible(false);}}}.bind(this));var t=new L({href:{path:'/mainNavigationLink/href'},text:{path:'/mainNavigationLink/title'},target:{path:'/mainNavigationLink/target'},visible:{path:'/mainNavigationLink/title',formatter:function(u){return!!u;}},enabled:{path:'/mainNavigationLink/href',formatter:function(v){return!!v;}},press:this._onLinkPress.bind(this)});t.addStyleClass("navigationPopoverTitle");this._oObserver.observe(t,{bindings:["visible"],properties:["visible"]});var s=new a({text:{path:'/mainNavigationLink/subtitle'},visible:{path:'/mainNavigationLink/subtitle',formatter:function(v){return!!v;}}});this._oHeaderArea=new V({items:[t,s],visible:{path:'/mainNavigationLink/title',formatter:function(u){return!!u;}}});this._oHeaderArea.addStyleClass("navigationPopoverTitleH1");this._oHeaderArea.addStyleClass("navigationPopoverHeader");var D=new S({layout:o.ResponsiveGridLayout,content:[new T({text:sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp").getText("POPOVER_MSG_NO_CONTENT")})]});D.addStyleClass("navigationPopoverDefaultExtraContent");var r=new V({visible:false});r.addStyleClass("navigationPopoverSeparator");this._oActionArea=new V({items:{path:'/availableActions',templateShareable:false,factory:function(u,v){var w=new L({visible:"{visible}",text:"{text}",href:"{href}",target:"{target}",press:v.getProperty("press")});this._oObserver.observe(w,{bindings:["visible"],properties:["visible"]});return new V({visible:"{visible}",layoutData:new f({styleClass:v.getProperty("description")?"navigationPopoverAvailableLinkGroup":"navigationPopoverAvailableLinkWithoutGroup"}),items:[w,new a({visible:"{visible}",text:"{description}"})]});}.bind(this)}});this._oActionArea.addEventDelegate({onAfterRendering:this.onAfterRenderingActionForm.bind(this)});this._oActionArea.addStyleClass("navigationPopoverAvailableLinks");this._oPersonalizationButton=new H({visible:{parts:[{path:'/enableAvailableActionsPersonalization'}],formatter:function(E){return!!E;}},justifyContent:"End",items:new B({type:q.Transparent,text:sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp").getText("POPOVER_DEFINE_LINKS"),press:function(E){this.openSelectionDialog(false,true,undefined,true,undefined,E.getSource());}.bind(this)})});this._oPersonalizationButton.addStyleClass("navigationPopoverPersonalizationButton");this.setFitContainer(true);this.setJustifyContent(p.Start);this.addItem(this._oHeaderArea).addItem(this._getInternalModel().getProperty("/extraContent")||D).addItem(r).addItem(this._oActionArea).addItem(this._oPersonalizationButton);this._oHeaderArea.setModel(this._getInternalModel());r.setModel(this._getInternalModel());this._oActionArea.setModel(this._getInternalModel());this._oPersonalizationButton.setModel(this._getInternalModel());};N.prototype._onLinkPress=function(E){this.fireNavigate({text:E.getSource().getText(),href:E.getSource().getHref()});};N.prototype._convertToExternal=function(s){var x=F.getService("CrossApplicationNavigation");if(!x){return s;}return x.hrefForExternal({target:{shellHash:s}},this._getComponent());};N.prototype._getComponent=function(){var r=this.getComponent();if(typeof r==="string"){r=sap.ui.getCore().getComponent(r);}return r;};N.prototype._observeAvailableActionsChanges=function(r){var s;if(r.object.isA("sap.ui.comp.navpopover.NavigationContainer")){switch(r.name){case"availableActions":s=this._getInternalModel();var t=r.child?[r.child]:r.children;t.forEach(function(u){switch(r.mutation){case"insert":if(!u){return;}u.setHref(this._convertToExternal(u.getHref()));u.setPress(this._onLinkPress.bind(this));this._oAvailableActionsObserver.observe(u,{properties:["visible"]});s.setProperty("/initialAvailableActions/"+this.indexOfAvailableAction(u)+"/",u.getJson());s.setProperty("/availableActions/"+this.indexOfAvailableAction(u)+"/",u.getJson());break;case"remove":k.error("Deletion of AvailableActions is not supported");break;default:k.error("Mutation '"+r.mutation+"' is not supported jet.");}}.bind(this));break;default:k.error("The '"+r.name+"' of NavigationContainer is not supported yet.");}}else if(r.object.isA("sap.ui.comp.navpopover.LinkData")){switch(r.name){case"visible":var u=r.object;s=this._getInternalModel();var v=-1;s.getProperty("/availableActions").some(function(w,x){if(u.getKey()===w.key){v=x;return true;}});if(v<0){k.error("The available action with key '"+u.getKey()+"' does not exist in availableActions.");}if(u.getVisibleChangedByUser()){s.setProperty("/availableActions/"+v+"/visible",u.getVisible());}else{s.setProperty("/initialAvailableActions/"+v+"/visible",u.getVisible());s.setProperty("/availableActions/"+v+"/visible",u.getVisible());}break;default:k.error("The '"+r.name+"' of LinkData is not supported yet.");}}};N.prototype._getInternalModel=function(){return this.getModel("$sapuicompNavigationContainer");};return N;},true);
