/*!
 * SAPUI5

		(c) Copyright 2009-2019 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/thirdparty/jquery",".././library","sap/ui/core/Control","sap/ui/comp/smartmultiedit/Field","sap/ui/model/Context","sap/base/Log"],function(q,l,C,F,a,L){"use strict";var b=C.extend("sap.ui.comp.smartmultiedit.Container",{metadata:{library:"sap.ui.comp",properties:{entitySet:{type:"string",defaultValue:null},contexts:{type:"sap.ui.model.Context[]",defaultValue:[]}},defaultAggregation:"layout",aggregations:{layout:{type:"sap.ui.comp.smartform.SmartForm",multiple:false}},designTime:"sap/ui/comp/designtime/smartmultiedit/Container.designtime"},renderer:function(r,c){r.write("<div");r.writeControlData(c);r.addClass("sapUiCompSmartMultiEditContainer");r.writeClasses();r.write(">");if(c._bReadyToRender){r.renderControl(c.getLayout());}r.write("</div>");}});b.prototype.init=function(){this._bIsInitialized=false;this._bReadyToRender=false;this._aFields=null;this.attachEvent("modelContextChange",this._initializeMetadata,this);};b.prototype.setEntitySet=function(e){if(e!==this.getProperty("entitySet")){this.setProperty("entitySet",e,true);if(e){this._initializeMetadata();}}return this;};b.prototype.setContexts=function(c){if(Array.isArray(c)){for(var i=0;i<c.length;i++){if(!(c[i]instanceof a)){return this;}}this.setProperty("contexts",c,true);this._getFields().forEach(function(f){f._updateContextItems();});}else{L.error("Parameter contexts is expected to be an array.");}return this;};b.prototype.setLayout=function(s){this.setAggregation("layout",s,true);this._aFields=null;this._getFields();return this;};b.prototype.addCustomData=function(c){var o;if(!c){return this;}C.prototype.addCustomData.apply(this,arguments);this._getFields().forEach(function(f){o=c.clone();f._oSmartField.addCustomData(o);});};b.prototype.insertCustomData=function(c,i){var o;if(!c){return this;}C.prototype.insertCustomData.apply(this,arguments);this._getFields().forEach(function(f){o=c.clone();f._oSmartField.addCustomData(o);});};b.prototype.removeCustomData=function(c){var o=C.prototype.removeCustomData.apply(this,arguments);if(o){this._getFields().forEach(function(f){f._oSmartField.removeCustomData(o);});}return o;};b.prototype.removeAllCustomData=function(){var c=C.prototype.removeAllCustomData.apply(this,arguments);if(c.length>0){this._getFields().forEach(function(f){c.forEach(function(o){f._oSmartField.removeCustomData(o);});});}return c;};b.prototype.destroyCustomData=function(){C.prototype.destroyCustomData.apply(this,arguments);this._getFields().forEach(function(f){f._oSmartField.destroyCustomData();});return this;};b.prototype.getAllUpdatedContexts=function(m){var c=this.getContexts(),u=[],t=this,i=0,s=10;if(c.length===0){return Promise.resolve(u);}return new Promise(function(r){function g(d,e,f){for(i=e;i<Math.min(f,d.length);i++){u.push({context:d[i],data:t._getUpdatedDataObject(d[i].getObject(),m)});}if(i<d.length){setTimeout(g.bind(null,c,i,i+s),0);}else{r(u);}}g(c,i,i+s);});};b.prototype.getErroneousFields=function(){return this._getFields().filter(function(f){f._performValidation();return f.hasClientError();});};b.prototype.getErroneousFieldsAndTokens=function(){var p=this._getFields().map(function(f){return f._performValidation();});return Promise.all(p).then(function(){var e=this._getFields().filter(function(f){return f.hasClientError();});return e;}.bind(this));};b.prototype.indexField=function(f){var c;if(!(f instanceof F)){L.error("Container.indexField","Element '"+JSON.stringify(f)+"' must be of type sap.ui.comp.smartmultiedit.Field","sap.ui.comp.smartmultiedit.Container");return;}this._aFields.push(f);f._setContainer(this);this.getCustomData().forEach(function(o){if(f.getSmartField()){c=o.clone();f.getSmartField().addCustomData(c);}});};b.prototype._getUpdatedDataObject=function(o,m){var d=m?q.extend({},o):{},p,u,t,n;this._getFields().forEach(function(f){p=f.getPropertyName();u=f.getUnitOfMeasurePropertyName();n=f.getRawValue();if(n.hasOwnProperty(p)){if(f.isDate()||f.isDateTime()){if(!o[p]){if(n[p]){d[p]=n[p];}}else if(!n[p]){d[p]=null;}else if(!o[p].getTime){L.error("Container._getUpdatedDataObject","Field "+p+" has incompatible data and metadata, expected: Date/DateTime, but found "+typeof d[p],"sap.ui.comp.smartmultiedit.Container");return;}else if(n[p].getTime()!==o[p].getTime()){d[p]=n[p];}}else{if((n[p]!==o[p])&&(n[p]!==""&&n[p]!=null||o[p]!==""&&o[p]!=null)){d[p]=n[p];}}}if(f.isComposite()&&n.hasOwnProperty(u)&&n[u]!==o[u]){d[u]=n[u];}else if(f.isComboBox()){t=f.getRecordTextPath();if(n.hasOwnProperty(t)&&n[t]!==o[t]){d[t]=n[t];}}});return d;};b.prototype.getFields=function(){return this._getFields();};b.prototype._getFields=function(){if(!this._aFields&&this.getLayout()){this._aFields=[];this.getLayout().getGroups().forEach(function(g){g.getGroupElements().forEach(function(G){G.getElements().forEach(function(e){if(e instanceof F){this.indexField(e);}}.bind(this));}.bind(this));}.bind(this));}return this._aFields||[];};b.prototype._initializeMetadata=function(){var m=this.getModel();if(!this._bIsInitialized&&this.getEntitySet()&&m&&(m.getMetadata().getName()==="sap.ui.model.odata.v2.ODataModel")){if(!this.getBindingContext()){var c=m.createEntry("/"+this.getEntitySet()),o=m.mChangedEntities?m.mChangedEntities[c.getPath().substr(1)]:null,d=null;if(o&&o.__metadata&&o.__metadata.created){d=o.__metadata.created;o.__metadata.created=undefined;}this.setBindingContext(c);if(d){o.__metadata.created=d;}this.getModel().deleteCreatedEntry(c);}m.getMetaModel().loaded().then(this._onMetadataInitialized.bind(this));}};b.prototype._onMetadataInitialized=function(){if(this._bIsInitialized){return;}this._bIsInitialized=true;this._bReadyToRender=true;this.invalidate();};return b;});
