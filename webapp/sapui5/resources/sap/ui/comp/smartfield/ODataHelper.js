/*
 * SAPUI5

		(c) Copyright 2009-2019 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/comp/library","sap/ui/comp/odata/MetadataAnalyser","sap/ui/comp/smartfield/AnnotationHelper","sap/base/Log","sap/ui/model/odata/_ODataMetaModelUtils","sap/base/assert"],function(l,M,A,L,O,a){"use strict";var T=l.TextArrangementType;var b=function(m,u,o){if(m){this.oMeta=m.getMetaModel();}if(o){this.oMeta=o;}this._oModel=m;this._oUtil=u;this.oAnnotation=new A();};b.prototype.getAnalyzer=function(m){if(!this._oAnalyzer){this._oAnalyzer=new M(this._oModel||m);}return this._oAnalyzer;};b.prototype.checkNavigationProperty=function(m,c){var p,P,d,r;if(c&&m){p=this._oUtil.getNavigationProperties(c);d=p.paths.length;while(d--){P=p.paths.shift();P=this._oUtil.correctPath(P);if(P===""||P===m.entitySet.name){continue;}r=this.getNavigationProperty(m.entityType,P);if(r.entitySet){m.entitySet=r.entitySet;m.entityType=r.entityType;}}}};b.prototype.getNavigationProperty=function(e,p){var n,t,r={};n=this._getNamedProperty(p,"navigationProperty",e);if(n){t=this.oMeta.getODataAssociationSetEnd(e,n.name);r.entitySet=this.oMeta.getODataEntitySet(t.entitySet);r.entityType=this.oMeta.getODataEntityType(r.entitySet.entityType);}return r;};b.prototype.startWithNavigationProperty=function(p,m){var P=p.split("/"),o;if(P&&P.length>1){o=this._getNamedProperty(P.shift(),"navigationProperty",m.entityType);}if(o){return o.name;}return null;};b.prototype.getProperty=function(m){var n=[],c,p,P,s,d,r={entityType:m.entityType,entitySet:m.entitySet};if(m){p=m.path.split("/");c=p.length;if(c>1){while(r.entityType){s=p[0];r=this.getNavigationProperty(r.entityType,s);if(r.entityType){m.entityType=r.entityType;m.entitySet=r.entitySet;n.push(p.shift());c--;}}}m.navigationPath=n.join("/");if(c>1){P=this.oMeta.getODataProperty(m.entityType,p[0]);if(P){m.property=this._getComplex(P,p,c);}return;}if(m.navigationPath){d=m.path.replace(m.navigationPath+"/","");}else{d=m.path;}P=this.oMeta.getODataProperty(m.entityType,d);m.property={property:P,typePath:m.path,valueListAnnotation:null,valueListKeyProperty:null,valueListEntitySet:null,valueListEntityType:null};}};b.prototype._getComplex=function(p,P,i){var o=p,t,c=[];while(i--){if(o){if(i===0){t=o.name;o=this._getNamedProperty(P[0],"property",o);return{typePath:t+"/"+P[0],property:o,complex:true,parents:c};}o=this.oMeta.getODataComplexType(o.type);if(o){c.push(o);}}P.shift();}};b.prototype._getNamedProperty=function(n,s,p){var r;if(p[s]){for(var i=0;i<p[s].length;i++){if(p[s][i].name===n){r=p[s][i];break;}}}return r;};b.prototype.getTextProperty2=function(m){var s,o;s=this.oAnnotation.getText(m.property.property);if(s){o=this._preprocAnnotation(s,m);this.getProperty(o);this._postprocAnnotation(o,m);}return o;};b.prototype.getUnitOfMeasure2=function(m){var s,o;s=this.oAnnotation.getUnit(m.property.property);if(s){o=this._preprocAnnotation(s,m);this.getProperty(o);this._postprocAnnotation(o,m);}return o;};b.prototype._preprocAnnotation=function(s,m){var p,o;o=this.traverseNavigationProperties(s,m.entityType);if(!o.navigationPath){o.entitySet=m.entitySet;}if(m.navigationPath){o.path=m.path.replace(m.navigationPath+"/","");}else{o.path=m.path;}if(o.navigationPath){p=s.replace(o.navigationPath+"/","");}else{p=s;}o.path=o.path.replace(m.property.property.name,p);if(o.navigationPath){o.navigationPathHelp=o.navigationPath;}return o;};b.prototype._postprocAnnotation=function(m,o){var p;if(m.navigationPathHelp){m.navigationPath=m.navigationPathHelp;}if(m.navigationPath){p=m.navigationPath;}else{p="";}if(o.navigationPath){if(p){p=o.navigationPath+"/"+p;}else{p=o.navigationPath;}}m.navigationPath=p;if(m.navigationPath){m.path=m.navigationPath+"/"+m.path;}};b.prototype.traverseNavigationProperties=function(p,e){var r={},R={},P,s,c;P=p.split("/");c=P.length;r.entityType=e;R.entityType=e;while(c--){s=P.shift();if(s===""){continue;}R=this.getNavigationProperty(r.entityType,s);if(!R.entitySet){break;}r.entityType=R.entityType;r.entitySet=R.entitySet;if(r.navigationPath){r.navigationPath=r.navigationPath+"/"+s;}else{r.navigationPath=s;}}return r;};b.prototype.getValueListAnnotationPath=function(m){var p,c;if(m.property.complex){c=m.property.parents.length-1;p=m.property.parents[c].namespace;p=p+"."+m.property.typePath;}else{p=m.entitySet.entityType+"/"+m.property.property.name;}return p;};b.prototype.getUOMValueListAnnotationPath=function(m){var p;if(m.annotations.uom){p=this.getValueListAnnotationPath(m.annotations.uom);}if(p){m.annotations.valuelistuom=p;}};b.prototype.getUOMTextAnnotation=function(m){if(m&&m.annotations&&m.annotations.uom){m.annotations.textuom=this.getTextProperty2(m.annotations.uom);}};b.prototype.geValueListEntitySet=function(m){if(m&&m.annotations&&m.annotations.valuelist){if(m.annotations.valuelist.primaryValueListAnnotation&&m.annotations.valuelist.primaryValueListAnnotation.valueListEntitySetName){m.annotations.valuelistentityset=this.oMeta.getODataEntitySet(m.annotations.valuelist.primaryValueListAnnotation.valueListEntitySetName);}}};b.prototype.getEdmProperty=function(m){var o=m.property;return(o&&o.property)||null;};b.prototype.getValueListData=function(m){var o=this.getEdmProperty(m),c=m.annotations;if(M.isValueList(o)){c.valuelist=this.getValueListAnnotationPath(m);var v=M.getValueListMode(o);if(v){c.valuelistType=v;}else{c.valuelistType=this.getAnalyzer().getValueListSemantics(o["com.sap.vocabularies.Common.v1.ValueList"]);}}};b.prototype.findProperty=function(p,P){return O.findObject(p,P);};b.prototype.getAssociation=function(e,n){var N;if(e){N=this.findProperty(e.navigationProperty,n);}if(N){return O.getObject(this.oMeta.oModel,"association",N.relationship);}return null;};b.prototype.getToRoleAssociationEnd=function(c,n){if(Array.isArray(c)){for(var i=0;i<c.length;i++){var o=c[i];if(o.role===n){return o;}}}return null;};b.prototype.getToRoleAssociationEndMultiplicity=function(c,n){var o=this.getToRoleAssociationEnd(c,n);return o?o.multiplicity:"";};b.prototype.checkNavigationPropertyRequiredMetadata=function(m){var e=m.propertyName,t=m.textAnnotation,s=t?t.Path:"",E=m.entityType,c=E.namespace+"."+E.name,C="sap.ui.comp.smartfield.ODataHelper",d="com.sap.vocabularies.Common.v1.Text";if(!t){L.info('Missing "'+d+'" annotation for "'+e+'" EDM property of "'+c+'" entity type.',C);return false;}if(s===undefined){a(false,'Missing "Path" attribute of "'+d+'" annotation for "'+e+'" EDM property of "'+c+'" entity type. - '+C);return false;}if(s===""){a(false,'Missing URL path name of "'+d+'" annotation for "'+e+'" EDM property of "'+c+'" entity type. - '+C);return false;}var f="com.sap.vocabularies.UI.v1.TextArrangement",o=t[f];if(!o){L.info('Missing "'+f+'" annotation for "'+e+'" EDM property of "'+c+'" entity type.',C);return false;}var v=o.EnumMember;if(v===undefined){a(false,'Missing "EnumMember" attribute of "'+f+'" annotation for "'+e+'" EDM property of "'+c+'" entity type. - '+C);return false;}if(!(v.split("/")[1]in T)){a(false,'Invalid "'+v+'" Text annotation enumeration member for "'+e+'" EDM property of "'+c+'" entity type. - '+C);return false;}if(o.EnumMember===T.TextSeparate){return false;}if(s.indexOf("/")===-1){a(false,'Invalid navigation property URL path name specified in the "'+d+'" annotation of the "'+e+'" EDM property of the "'+c+'" entity type. - '+C);return false;}var n=s.split("/")[0],N=this.findProperty(E.navigationProperty,n);if(!N){a(false,'The navigation property URL path name "'+n+'" (specified in the Text annotation of the "'+e+'" EDM property) was not found in the "'+c+'" entity type of the service metadata document. - '+C);return false;}var g=this.getAssociation(E,n);if(!g){a(false,'Missing "'+N.relationship+'" association for "'+N.name+'" EDM navigation property of the "'+c+'" entity type. - '+C);return false;}var r=g.referentialConstraint;if(!r){a(false,'Missing referential constraint for "'+N.relationship+'" association in the service metadata document. - '+C);return false;}if(!Array.isArray(g.end)||!(g.end.length>0)){a(false,'Missing association end for "'+N.relationship+'" association in the service metadata document. - '+C);return false;}var h=this.getToRoleAssociationEndMultiplicity(g.end,N.toRole);if(h!=="1"){a(false,'Expected multiplicity of 1 for "'+N.toRole+'" association end of the "'+N.relationship+'" association in the service metadata document. - '+C);return false;}if((r.principal.propertyRef.length!==1)||(r.dependent.propertyRef.length!==1)){a(false,'Expected the single "'+e+'" foreign key EDM property as '+'referential constraint in the "'+N.relationship+'" association. - '+C);return false;}var i=m.entityTypeOfNavigationProperty||this.getNavigationProperty(E,n).entityType;if(i.key.propertyRef.length!==1){a(false,'Expected a single key property in the lookup "'+i.namespace+"."+i.name+'" entity type. - '+C);return false;}var R=r.principal.propertyRef[0].name;if(R!==i.key.propertyRef[0].name){a(false,'Expected a property named "'+R+'" to be the single key property in the lookup "'+i.namespace+"."+i.name+'" entity type. - '+C);return false;}return true;};b.prototype.checkValueListRequiredMetadataForTextArrangment=function(m){var v=m.valueListAnnotation,C="sap.ui.comp.smartfield.ODataHelper";if(!v){var e=m.entityType,E=e.namespace+"."+e.name;a(false,'Missing "ValueList" annotation for "'+m.propertyName+'" EDM property of "'+E+'" entity type. - '+C);return false;}if(!Array.isArray(v.fields)){a(false,'Missing fields for "'+v.valueListEntityName+'" entity. - '+C);return false;}var d=v.descriptionField,V=this.findProperty(v.fields,d);if(!V){a(false,'The "'+d+'" description field was not found '+'in the service metadata document. - '+C);return false;}if(V["sap:filterable"]==="false"){a(false,'Expected the "'+V.fullName+'" field to be filterable. - '+C);return false;}return true;};b.prototype.getEdmDisplayPath=function(m){var t=m.annotations.text;if(t){return t.path;}return m.path;};b.prototype.getTextAnnotationPropertyPath=function(m){var t=m.annotations.text;if(t){return t.path;}return"";};b.prototype.getAbsolutePropertyPathToValueListEntity=function(s){var v=s.property,V=v&&v["com.sap.vocabularies.Common.v1.Text"],o=s.entitySet;if(V&&o&&(s.entityID!==undefined)){return"/"+o.name+"('"+s.entityID+"')"+"/"+V.Path;}return"";};b.prototype.getODataValueListKeyProperty=function(v){for(var i=0;i<v.fields.length;i++){var f=v.fields[i];if(f.name===v.keyField){return f;}}};b.prototype.getUOMPath=function(m){if(m&&m.annotations&&m.annotations.uom){return m.annotations.uom.path;}return null;};b.prototype.getUOMTypePath=function(m){if(m.property.complex){return m.property.typePath.replace(m.property.property.name,m.annotations.uom.property.name);}return m.annotations.uom.property.name;};b.prototype.getUOMChangeHandler=function(c,u){return function(p){try{c.fireChange({value:p.mParameters.value,newValue:p.mParameters.value,unitChanged:u,validated:p.mParameters["validated"]});}catch(e){L.warning(e);}};};b.prototype.getSelectionChangeHandler=function(c){return function(p){var k="";try{var i=p.getParameter("selectedItem");if(i){k=i.getKey();}c.fireChange({value:k,newValue:k,selectionChange:true});}catch(e){L.warning(e);}};};b.prototype.destroy=function(){if(this._oAnalyzer){this._oAnalyzer.destroy();}if(this.oAnnotation){this.oAnnotation.destroy();}this._oUtil=null;this.oMeta=null;this.oAnalyzer=null;this.oAnnotation=null;};b.prototype.getAutoExpandProperties=function(m){var n=[],c=[];for(var s in m){switch(s){case"com.sap.vocabularies.Common.v1.Text":case"Org.OData.Measures.V1.Unit":case"Org.OData.Measures.V1.ISOCurrency":case"com.sap.vocabularies.Common.v1.FieldControl":if(m[s].Path){c=m[s].Path.split("/");}break;}if(c.length>1&&n.indexOf(c[0])<0){n.push(c[0]);}}return n.join(",");};b.prototype.loadValueListAnnotation=function(p){var P=this.getAnalyzer().getValueListAnnotationLazy(p);P.catch(function(){L.error("The value list annotation could not be loaded.",undefined,"sap.ui.comp.smartfield.ODataHelper.loadValueListAnnotation");});return P;};return b;},true);
