/*
 * SAPUI5

		(c) Copyright 2009-2019 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/core/Core","sap/ui/model/CompositeType","sap/ui/comp/util/FormatUtil","sap/ui/model/ParseException","sap/ui/model/ValidateException","sap/base/assert"],function(c,C,F,P,V,a){"use strict";var T=C.extend("sap.ui.comp.smartfield.type.TextArrangement",{constructor:function(o,b,s){this.getPrimaryType().call(this,o,b);C.call(this,o,b);this.init(o,b,s);a(s.keyField!==undefined,"Missing value for the keyField. - "+this.getName());a(s.descriptionField!==undefined,"Missing value for the descriptionField. - "+this.getName());},metadata:{"abstract":true}});T.prototype.init=function(o,b,s){this.sName="TextArrangement";this.bParseWithValues=true;this.async=true;this.oSettings=Object.assign({onBeforeValidateValue:function(){}},s);this.oFormatOptions=Object.assign({textArrangement:"idOnly"},o);this.fnParser=this.getValidator({textArrangement:this.oFormatOptions.textArrangement,prefix:"parse"});this.fnValidator=this.getValidator({textArrangement:this.oFormatOptions.textArrangement,prefix:"validate"});this.sDescription=undefined;};T.prototype.parseValue=function(v,s,b){var t=this.oFormatOptions.textArrangement;if(v===""||(t==="idOnly")){return this.parseIDOnly(v,s);}return this.fnParser(v,s,b,this.oFormatOptions,this.oSettings);};T.prototype.parseIDOnly=function(v,s){return[this.getPrimaryType().prototype.parseValue.call(this,v,s),undefined];};T.prototype.parseIDAndDescription=function(v,s,b,o){var r=/.*\s\(.*\)/i;if(r.test(v)){var d=/\s\(/gi;if(v.match(d).length>1){throw new P(this.getResourceBundleText("SMARTFIELD_NOT_FOUND"));}var e=T.splitIDAndDescription(v,{separator:d,textArrangement:o.textArrangement});v=e[0];this.sDescription=e[1];}else{this.sDescription=undefined;}return this.parseIDOnly(v,s);};T.prototype.parseDescriptionOnly=function(v,s,b,o,S){return new Promise(function(r,R){this.onBeforeValidateValue(v,{filterFields:this.getFilterFields(),success:function(d){var i,k=S.keyField,D=S.descriptionField;var I=f(v,{key:D,value:k,data:d});var e=I.length;if(e===1){i=this.getPrimaryType().prototype.parseValue.call(this,I[0],s);this.sDescription=v;r([i,undefined]);return;}if(e===0){I=f(v,{key:k,value:D,data:d});e=I.length;}if(e===0){R(new V(this.getResourceBundleText("SMARTFIELD_NOT_FOUND")));return;}if(e>1){R(new V(this.getResourceBundleText("SMARTFIELD_DUPLICATE_VALUES")));return;}i=this.getPrimaryType().prototype.parseValue.call(this,v,s);this.sDescription=I[0];r([i,undefined]);}.bind(this),error:function(){R(new V());}});}.bind(this));};T.prototype.validateValue=function(v){this.validateIDOnly(v);var i=v[0];if(i===null){return;}if(this.oFormatOptions.textArrangement==="descriptionOnly"){this.validateDescriptionOnly(v,this.oSettings);return;}return new Promise(function(r,R){this.onBeforeValidateValue(i,{filterFields:this.getFilterFields(),success:function(d){var s=Object.assign({},this.oSettings,{data:d,reject:R});var b=this.fnValidator(v,s);if(b){r(v);}}.bind(this),error:function(){R(new V());}});}.bind(this));};T.prototype.validateIDOnly=function(v){this.getPrimaryType().prototype.validateValue.call(this,v[0]);};T.prototype.validateIDAndDescription=function(v,s){var d=f(v[0],{key:s.keyField,value:s.descriptionField,data:s.data});var r=s.reject;if(d.length===0){r(new V(this.getResourceBundleText("SMARTFIELD_NOT_FOUND")));return false;}if(d.length>1){r(new V(this.getResourceBundleText("SMARTFIELD_DUPLICATE_VALUES")));return false;}var D=d[0];if((this.sDescription!==undefined)&&(D!==this.sDescription)){r(new V(this.getResourceBundleText("SMARTFIELD_NOT_FOUND")));return false;}this.sDescription=D;return true;};T.prototype.validateDescriptionOnly=function(v,s){};T.prototype.formatValue=function(v,t){var k=this.getPrimaryType().prototype.formatValue.call(this,v[0],t);if(k===""){return k;}var d=v[1];return F.getFormattedExpressionFromDisplayBehaviour(this.oFormatOptions.textArrangement,k,d);};T.prototype.destroy=function(){this.oFormatOptions=null;this.oSettings=null;this.fnParser=null;this.fnValidator=null;this.sDescription="";};T.prototype.getName=function(){return"sap.ui.comp.smartfield.type.TextArrangement";};T.prototype.onBeforeValidateValue=function(){};T.prototype.getResourceBundleText=function(k,p){return c.getLibraryResourceBundle("sap.ui.comp").getText(k,p);};T.prototype.getPrimaryType=function(){};T.prototype.getValidator=function(s){switch(s.textArrangement){case"idAndDescription":case"descriptionAndId":return this[s.prefix+"IDAndDescription"];case"descriptionOnly":return this[s.prefix+"DescriptionOnly"];default:return this[s.prefix+"IDOnly"];}};T.prototype.getFilterFields=function(){return["keyField","descriptionField"];};function f(k,s){var v=[];s.data.forEach(function(d,i,D){if(d[s.key]===k){v.push(d[s.value]);}});return v;}T.splitIDAndDescription=function(v,s){var b=s.separator.exec(v),i=b["index"];switch(s.textArrangement){case"idAndDescription":return[v.slice(0,i),v.slice(i+2,-1)];case"descriptionAndId":return[v.slice(i+2,-1),v.slice(0,i)];default:return["",""];}};return T;});
