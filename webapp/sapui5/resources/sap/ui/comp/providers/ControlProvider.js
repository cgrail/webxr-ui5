/*
 * ! SAPUI5

		(c) Copyright 2009-2019 SAP SE. All rights reserved
	
 */
sap.ui.define(['sap/ui/thirdparty/jquery','sap/m/CheckBox','sap/m/ComboBox','sap/m/DatePicker','sap/m/TimePicker','sap/m/HBox','sap/m/Input','sap/m/Text','sap/m/ObjectIdentifier','sap/m/ObjectStatus','sap/m/Image','sap/m/Link','sap/m/VBox','sap/m/FlexItemData','sap/m/library','sap/ui/comp/navpopover/SmartLink','sap/ui/comp/odata/MetadataAnalyser','sap/ui/comp/smartfield/ODataHelper','sap/ui/comp/smartfield/SmartField','sap/ui/comp/odata/ODataType','sap/ui/comp/odata/CriticalityMetadata','sap/ui/comp/util/FormatUtil','sap/ui/comp/util/MultiCurrencyUtil','sap/ui/core/Control','sap/ui/comp/navpopover/SemanticObjectController','sap/ui/comp/navpopover/NavigationPopoverHandler','./ValueHelpProvider','./ValueListProvider'],function(q,C,a,D,T,H,I,b,O,c,d,L,V,F,M,S,e,f,g,h,j,k,l,m,n,N,o,p){"use strict";var r;var s=function(P){if(P){this._oParentODataModel=P.model;this._oMetadataAnalyser=P.metadataAnalyser;this._aODataFieldMetadata=P.fieldsMetadata;this._oLineItemAnnotation=P.lineItemAnnotation;this._oSemanticKeyAnnotation=P.semanticKeyAnnotation;this._smartTableId=P.smartTableId;this._isAnalyticalTable=P.isAnalyticalTable;this._isMobileTable=P.isMobileTable;this._oDateFormatSettings=P.dateFormatSettings;this._bEnableDescriptions=P.enableDescriptions;this._oCurrencyFormatSettings=P.currencyFormatSettings;this._oDefaultDropDownDisplayBehaviour=P.defaultDropDownDisplayBehaviour||"descriptionAndId";this.useSmartField=P.useSmartField==="true";this.useSmartToggle=P.useSmartToggle==="true";this._sEntitySet=P.entitySet;this._oSemanticKeyAdditionalControl=P._semanticKeyAdditionalControl;this._oSemanticObjectController=P.semanticObjectController;}if(!this._oMetadataAnalyser&&this._oParentODataModel){this._oMetadataAnalyser=new e(this._oParentODataModel);this._intialiseMetadata();}this._mSmartField={};this._oHelper=new f(this._oMetadataAnalyser.oModel);this._aValueListProvider=[];this._aValueHelpProvider=[];this._aLinkHandlers=[];};s.prototype._intialiseMetadata=function(){if(!this._aODataFieldMetadata){this._aODataFieldMetadata=this._oMetadataAnalyser.getFieldsByEntitySetName(this.sEntity);}};s.prototype.getFieldViewMetadata=function(i,t){var u=this._createFieldMetadata(i);this._createFieldTemplate(u,t);return u;};s.prototype._createFieldTemplate=function(v,i){if(this.useSmartField){v.template=new g({value:{path:v.name},entitySet:this._sEntitySet,contextEditable:{path:"sm4rtM0d3l>/editable",mode:"OneWay"},controlContext:this._isMobileTable?"responsiveTable":"table",wrapping:this._isMobileTable});if(h.isNumeric(v.type)||h.isDateOrTime(v.type)||v.isCalendarDate){v.template.setTextAlign("Right");v.template.setWidth("100%");}this._completeSmartField(v);v.template._setPendingEditState(i);}if(this.useSmartToggle){v.template=new r({editable:{path:"sm4rtM0d3l>/editable",mode:"OneWay"},edit:this.useSmartField?v.template:this._createEditableTemplate(v),display:this._createDisplayOnlyTemplate(v)});}else if(!this.useSmartField){v.template=i?this._createEditableTemplate(v):this._createDisplayOnlyTemplate(v);}};s.prototype._completeSmartField=function(v){var i={annotations:{},path:v.name};if(!this._mSmartField.entitySetObject){this._mSmartField.entitySetObject=this._oHelper.oMeta.getODataEntitySet(this._sEntitySet);this._mSmartField.entityType=this._oHelper.oMeta.getODataEntityType(this._mSmartField.entitySetObject.entityType);}i.modelObject=this._oParentODataModel;i.entitySetObject=this._mSmartField.entitySetObject;i.entitySet=this._mSmartField.entitySetObject;i.entityType=this._mSmartField.entityType;this._oHelper.getProperty(i);v.fieldControlProperty=this._oHelper.oAnnotation.getFieldControlPath(i.property.property);if(v.fieldControlProperty&&v.parentPropertyName){v.fieldControlProperty=v.parentPropertyName+"/"+v.fieldControlProperty;}i.annotations.uom=this._oHelper.getUnitOfMeasure2(i);i.annotations.text=this._oHelper.getTextProperty2(i);i.annotations.lineitem=this._oLineItemAnnotation;i.annotations.semantic=e.getSemanticObjectsFromProperty(i.property.property);this._oHelper.getUOMTextAnnotation(i);if(i.property.property["sap:value-list"]||i.property.property["com.sap.vocabularies.Common.v1.ValueList"]){i.annotations.valuelist=this._oHelper.getValueListAnnotationPath(i);if(i.property.property["sap:value-list"]){i.annotations.valuelistType=i.property.property["sap:value-list"];}else{i.annotations.valuelistType=this._oMetadataAnalyser.getValueListSemantics(i.property.property["com.sap.vocabularies.Common.v1.ValueList"]);}}this._oHelper.getUOMValueListAnnotationPath(i);delete i.entitySet;v.template.data("configdata",{"configdata":i});v.template.data("dateFormatSettings",this._oDateFormatSettings);v.template.data("currencyFormatSettings",this._oCurrencyFormatSettings);v.template.data("defaultDropDownDisplayBehaviour",this._oDefaultDropDownDisplayBehaviour);if(i.annotations.uom||h.isNumeric(v.type)||h.isDateOrTime(v.type)||v.isCalendarDate){var A=v.template.getTextAlign();if(A==="Initial"){A="Right";}v.align=A;}s._createModelTypeInstance(v,this._oDateFormatSettings);};s.prototype._createEditableTemplate=function(v,B){var t=null,i;var u=v.type==="Edm.DateTime"&&v.displayFormat==="Date";if(u||v.isCalendarDate){t=new D({dateValue:{path:v.name}});}else if(v.type==="Edm.Boolean"){t=new C({selected:{path:v.name}});}i=s._createModelTypeInstance(v,this._oDateFormatSettings);if(v.semanticObjects&&(!B)){t=this._createSmartLinkFieldTemplate(v,i,function(){return this._createEditableTemplate(v,true);}.bind(this));}if(!t){if(v.type==="Edm.Time"){t=new T({value:{path:v.name,type:i}});}else{t=new I({value:{path:v.name,type:i}});if(v.unit){t.bindProperty("description",{path:v.unit});t.setTextAlign("Right");t.setTextDirection("LTR");t.setFieldWidth("80%");}else if(this._bEnableDescriptions&&v.description){t.bindProperty("description",{path:v.description});}else if(h.isNumeric(v.type)||h.isDateOrTime(v.type)||v.isCalendarDate){t.setTextAlign("Right");t.setTextDirection("LTR");}if(v.hasValueListAnnotation){this._associateValueHelpAndSuggest(t,v);}}}return t;};s.prototype._associateValueHelpAndSuggest=function(i,t){i.setShowValueHelp(true);this._aValueHelpProvider.push(new o({loadAnnotation:true,fullyQualifiedFieldName:t.fullName,metadataAnalyser:this._oMetadataAnalyser,control:i,model:this._oParentODataModel,preventInitialDataFetchInValueHelpDialog:true,dateFormatSettings:this._oDateFormatSettings,takeOverInputValue:false,fieldName:t.fieldName,type:t.type,maxLength:t.maxLength,displayFormat:t.displayFormat,displayBehaviour:t.displayBehaviour,title:t.label}));i.setShowSuggestion(true);i.setFilterSuggests(false);this._aValueListProvider.push(new p({loadAnnotation:true,fullyQualifiedFieldName:t.fullName,metadataAnalyser:this._oMetadataAnalyser,control:i,model:this._oParentODataModel,dateFormatSettings:this._oDateFormatSettings,typeAheadEnabled:true,aggregation:"suggestionRows",displayFormat:t.displayFormat,displayBehaviour:t.displayBehaviour}));};s.prototype._createDisplayOnlyTemplate=function(v,B){var t=null,i=null,A,u;i=s._createModelTypeInstance(v,this._oDateFormatSettings);if(h.isNumeric(v.type)||h.isDateOrTime(v.type)||v.isCalendarDate){A="Right";}if(this._isMobileTable){if(v.isImageURL){t=new d({src:{path:v.name},width:"3em",height:"3em"});}else if(this._oSemanticKeyAnnotation&&this._oSemanticKeyAnnotation.semanticKeyFields&&this._oSemanticKeyAnnotation.semanticKeyFields.indexOf(v.name)>-1){t=this._createObjectIdentifierTemplate(v,i,this._oSemanticKeyAnnotation.semanticKeyFields.indexOf(v.name)===0);}}if(this._oLineItemAnnotation&&this._oLineItemAnnotation.urlInfo&&this._oLineItemAnnotation.urlInfo[v.name]){t=this._createLink(v,i,this._oLineItemAnnotation.urlInfo[v.name]);}else if(this._oLineItemAnnotation&&this._oLineItemAnnotation.criticality&&this._oLineItemAnnotation.criticality[v.name]){t=this._createObjectStatusTemplate(v,i,this._oLineItemAnnotation.criticality[v.name]);}if(!t){if(v.semanticObjects&&(!B)){t=this._createSmartLinkFieldTemplate(v,i,function(){return this._createDisplayOnlyTemplate(v,true);}.bind(this));}else if(v.unit){t=this._createMeasureFieldTemplate(v,i);}else if(v.isEmailAddress||v.isPhoneNumber){t=this._createEmailOrPhoneLink(v,i);}else{u=this._getDefaultBindingInfo(v,i);t=new b({wrapping:this._isMobileTable,textAlign:A,text:u});}}v.align=A;return t;};s._createModelTypeInstance=function(v,i){var t,u;var w=v.type==="Edm.DateTime"&&v.displayFormat==="Date";if(w||v.isCalendarDate){t=i;u={displayFormat:"Date"};}else if(v.type==="Edm.Decimal"){u={precision:v.precision,scale:v.scale};}else if(v.type==="Edm.String"){u={isDigitSequence:v.isDigitSequence};}u=q.extend({},u,{maxLength:v.maxLength});if(v.type=="Edm.DateTime"){v.modelType=h.getType(v.type,t,u,v.isCalendarDate);v.modelType.formatValue(new Date(),"string");v.modelType.oFormat.oFormatOptions.UTC=false;return h.getType(v.type,t,u,v.isCalendarDate);}v.modelType=h.getType(v.type,t,u,v.isCalendarDate);return v.modelType;};s.prototype._createEmailOrPhoneLink=function(v,t){var i=new L({text:this._getDefaultBindingInfo(v,t),wrapping:this._isMobileTable,press:function(E){var u=E.getSource().getText();if(v.isEmailAddress){M.URLHelper.triggerEmail(u);}else if(v.isPhoneNumber){M.URLHelper.triggerTel(u);}}});return i;};s.prototype._getDefaultBindingInfo=function(v,t){var B={path:v.name,type:t};if(this._bEnableDescriptions&&v.description){B={parts:[{path:v.name,type:t},{path:v.description}],formatter:function(i,u){return k.getFormattedExpressionFromDisplayBehaviour(v.displayBehaviour,i,u);}};}return B;};s.prototype._createLink=function(v,t,i){var u=null;v.linkProperties=i.parameters||i.urlPath;if(i.urlPath){u={path:i.urlPath};}else if(i.urlTarget){u=i.urlTarget;}return new L({text:this._getDefaultBindingInfo(v,t),wrapping:this._isMobileTable,href:u});};s.prototype._createObjectIdentifierTemplate=function(v,t,i){var u,w,x,y,z,A;var B=this;var E=function(G){if(B._oSemanticObjectController&&B._oSemanticObjectController.getForceLinkRendering()&&B._oSemanticObjectController.getForceLinkRendering()[v.name]){return true;}var J=v.semanticObjects.additionalSemanticObjects.concat(v.semanticObjects.defaultSemanticObject);return n.hasDistinctSemanticObject(J,G);};if(v.semanticObjects){n.getDistinctSemanticObjects().then(function(G){if(E(G)){A=new N({semanticObject:v.semanticObjects.defaultSemanticObject,additionalSemanticObjects:v.semanticObjects.additionalSemanticObjects,semanticObjectLabel:v.label,fieldName:v.name,semanticObjectController:B._oSemanticObjectController,navigationTargetsObtained:function(J){var u=sap.ui.getCore().byId(J.getSource().getControl());var K=J.getParameters().mainNavigation;if(K){K.setDescription(u.getText());}J.getParameters().show(u.getTitle(),K,undefined,undefined);}});B._aLinkHandlers.push(A);}});}if(v.description){switch(v.displayBehaviour){case"descriptionAndId":w=v.description;x=v.name;y=t;break;case"idAndDescription":w=v.name;x=v.description;z=t;break;case"idOnly":w=v.name;y=t;break;default:w=v.description;break;}}else{w=v.name;z=t;}u=new O({title:w?{path:w,type:z}:undefined,text:x?{path:x,type:y}:undefined,titleActive:v.semanticObjects?{path:"$sapuicompcontrolprovider_distinctSO>/distinctSemanticObjects",formatter:function(G){return E(G);}}:false,titlePress:function(G){if(A){A.setControl(G.getSource());A.openPopover(G.getParameter("domRef"));}}});u.attachEvent("ObjectIdentifier.designtime",function(G){if(A){A.setControl(G.getSource());G.getParameters().registerNavigationPopoverHandler(A);}});u.setModel(n.getJSONModel(),"$sapuicompcontrolprovider_distinctSO");if(this._oSemanticKeyAdditionalControl&&i){this._bSemanticKeyAdditionalControlUsed=true;return new V({renderType:"Bare",items:[u,this._oSemanticKeyAdditionalControl]}).addStyleClass("sapMTableContentMargin");}return u;};s.prototype._createObjectStatusTemplate=function(v,t,i){var u,w,x,B;x=j.getShowCriticalityIcon(i.criticalityRepresentationType);if(i.path){v.criticality=i.path;u={path:i.path,formatter:j.getCriticalityState};if(i.criticalityRepresentationPath){v.criticalityRepresentation=i.criticalityRepresentationPath;w={parts:[{path:i.path},{path:i.criticalityRepresentationPath}],formatter:function(y,z){return j.getShowCriticalityIcon(z)?j.getCriticalityIcon(y):undefined;}};}else if(x){w={path:i.path,formatter:j.getCriticalityIcon};}}else{u=j.getCriticalityState(i.criticalityType);if(i.criticalityRepresentationPath){v.criticalityRepresentation=i.criticalityRepresentationPath;w={path:i.criticalityRepresentationPath,formatter:function(y){return j.getShowCriticalityIcon(y)?j.getCriticalityIcon(i.criticalityType):undefined;}};}else if(x){w=j.getCriticalityIcon(i.criticalityType);}}if(v.unit){B={parts:[{path:v.name,type:t},{path:v.unit}],formatter:v.isCurrencyField?k.getInlineAmountFormatter():k.getInlineMeasureUnitFormatter(),useRawValues:v.isCurrencyField};}else{B=this._getDefaultBindingInfo(v,t);}return new c({text:B,state:u,icon:w});};s.prototype._createSmartLinkFieldTemplate=function(v,t,i){var B=v.unit?{parts:[{path:v.name,type:t},{path:v.unit}],formatter:v.isCurrencyField?k.getAmountCurrencyFormatter():k.getMeasureUnitFormatter(),useRawValues:true}:this._getDefaultBindingInfo(v,t);var u=new S({semanticObject:v.semanticObjects.defaultSemanticObject,additionalSemanticObjects:v.semanticObjects.additionalSemanticObjects,semanticObjectLabel:v.label,fieldName:v.name,text:B,uom:v.unit?{path:v.unit}:undefined,wrapping:this._isMobileTable,semanticObjectController:this._oSemanticObjectController,navigationTargetsObtained:function(E){var w=this.getBinding("text");if(!w||!Array.isArray(w.getValue())||v.unit){E.getParameters().show();return;}var x=w.getValue();var y=k.getTextsFromDisplayBehaviour(v.displayBehaviour,x[0],x[1]);var z=E.getParameters().mainNavigation;if(z){z.setDescription(y.secondText);}E.getParameters().show(y.firstText,z,undefined,undefined);}});u.setCreateControlCallback(i);return u;};s.prototype._createMeasureFieldTemplate=function(v,t){var i,A,u,w,U,E=false;E=!!(v.isCurrencyField&&this._oCurrencyFormatSettings&&this._oCurrencyFormatSettings.showCurrencySymbol);w=new b({layoutData:new F({growFactor:1,baseSize:"0%"}),textDirection:"LTR",wrapping:false,textAlign:"End",text:{parts:[{path:v.name,type:t},{path:v.unit}],formatter:v.isCurrencyField?k.getAmountCurrencyFormatter():k.getMeasureUnitFormatter(),useRawValues:v.isCurrencyField}});U=new b({layoutData:new F({shrinkFactor:0}),textDirection:"LTR",wrapping:false,textAlign:"Begin",width:"2.5em",text:{path:v.unit,formatter:E?k.getCurrencySymbolFormatter():undefined}}).addStyleClass("sapUiCompUoMPart");i=new H({renderType:"Bare",justifyContent:"End",items:[w,U]});i.addStyleClass("sapUiCompDirectionLTR");if(v.isCurrencyField&&this._isAnalyticalTable){A=new L({text:sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp").getText("SMARTTABLE_MULTI_LINK_TEXT")||"Show Details",visible:{path:v.unit,formatter:l.isMultiCurrency},press:function(x){l.openMultiCurrencyPopover(x,{currency:v.name,unit:v.unit,additionalParent:this.useSmartToggle,smartTableId:this._smartTableId,template:u});}.bind(this)});u=i;u.bindProperty("visible",{path:v.unit,formatter:function(x){return!l.isMultiCurrency(x);}});i=new V({renderType:"Bare",items:[A,u]});}return i;};s.prototype._createFieldMetadata=function(i){var t=q.extend({},i);t.label=i.fieldLabel||i.name;t.quickInfo=i.quickInfo||t.label;t.displayBehaviour=t.displayBehaviour||this._oDefaultDropDownDisplayBehaviour;t.filterType=this._getFilterType(i);this._updateValueListMetadata(t);this._setAnnotationMetadata(t);return t;};s.prototype._updateValueListMetadata=function(i){i.hasValueListAnnotation=i["sap:value-list"]!==undefined;if(i.hasValueListAnnotation){i.hasFixedValues=i["sap:value-list"]==="fixed-values";}else if(i["com.sap.vocabularies.Common.v1.ValueList"]){i.hasValueListAnnotation=true;i.hasFixedValues=this._oMetadataAnalyser.getValueListSemantics(i["com.sap.vocabularies.Common.v1.ValueList"])==="fixed-values";}};s.prototype._setAnnotationMetadata=function(i){if(i&&i.fullName){i.semanticObjects=this._oMetadataAnalyser.getSemanticObjectsFromAnnotation(i.fullName);}};s.prototype._getFilterType=function(i){return k._getFilterType(i);};s.prototype.destroy=function(){var t=function(A){var i;if(A){i=A.length;while(i--){A[i].destroy();}}};if(this._oMetadataAnalyser&&this._oMetadataAnalyser.destroy){this._oMetadataAnalyser.destroy();}this._oMetadataAnalyser=null;if(!this._bSemanticKeyAdditionalControlUsed&&this._oSemanticKeyAdditionalControl&&this._oSemanticKeyAdditionalControl.destroy){this._oSemanticKeyAdditionalControl.destroy();}t(this._aValueHelpProvider);this._aValueHelpProvider=null;t(this._aValueListProvider);this._aValueListProvider=null;t(this._aLinkHandlers);this._aLinkHandlers=null;if(this._oHelper){this._oHelper.destroy();}this._oHelper=null;this._mSmartField=null;this._aODataFieldMetadata=null;this._oDateFormatSettings=null;this._oCurrencyFormatSettings=null;this._oDefaultDropDownDisplayBehaviour=null;this._oLineItemAnnotation=null;this._oSemanticKeyAnnotation=null;this._oParentODataModel=null;this.bIsDestroyed=true;};r=m.extend("sap.ui.comp.SmartToggle",{metadata:{library:"sap.ui.comp",properties:{editable:{type:"boolean",defaultValue:false}},aggregations:{edit:{type:"sap.ui.core.Control",multiple:false},display:{type:"sap.ui.core.Control",multiple:false}},associations:{ariaLabelledBy:{type:"sap.ui.core.Control",multiple:true,singularName:"ariaLabelledBy"}}},renderer:function(i,t){i.write("<span ");i.writeControlData(t);i.addClass("sapUiCompSmartToggle");i.writeClasses();i.write(">");i.renderControl(t.getEditable()?t.getEdit():t.getDisplay());i.write("</span>");}});r.prototype.getFocusDomRef=function(){var i=this.getEditable()?this.getEdit():this.getDisplay();if(i){return i.getFocusDomRef();}return m.prototype.getFocusDomRef.call(this);};r.prototype.getAccessibilityInfo=function(){var i=this.getEditable()?this.getEdit():this.getDisplay();if(i&&i.getAccessibilityInfo){return i.getAccessibilityInfo();}return null;};r.prototype.addAssociation=function(A,i,t){if(A==="ariaLabelledBy"){var E=this.getEdit(),u=this.getDisplay();E&&E.addAssociation(A,i,t);u&&u.addAssociation(A,i,t);}return m.prototype.addAssociation.apply(this,arguments);};r.prototype.removeAssociation=function(A,v,i){if(A==="ariaLabelledBy"){var E=this.getEdit(),t=this.getDisplay();E&&E.removeAssociation(A,v,i);t&&t.removeAssociation(A,v,i);}return m.prototype.removeAssociation.apply(this,arguments);};r.prototype.removeAllAssociation=function(A,i){if(A==="ariaLabelledBy"){var E=this.getEdit(),t=this.getDisplay();E&&E.removeAllAssociation(A,i);t&&t.removeAllAssociation(A,i);}return m.prototype.removeAllAssociation.apply(this,arguments);};return s;},true);
