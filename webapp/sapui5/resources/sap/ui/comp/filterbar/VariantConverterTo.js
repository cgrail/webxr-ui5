/*
 * ! SAPUI5

		(c) Copyright 2009-2019 SAP SE. All rights reserved
	
 */
sap.ui.define(['sap/ui/comp/library','sap/ui/comp/odata/ODataType','sap/ui/comp/util/FormatUtil','sap/ui/core/format/DateFormat',"sap/base/Log"],function(l,O,F,D,L){"use strict";var a=l.smartfilterbar.FilterType;var V=l.valuehelpdialog.ValueHelpRangeOperation;var A=l.ANALYTICAL_PARAMETER_PREFIX;var b=function(){};b.prototype.convert=function(k,f,d,o,v,p,s){var c,i,j,J,n=null,B,e;var S={SelectionVariantID:k};if(p){S.ParameterContextUrl=p;}if(s){S.FilterContextUrl=s;}this._sAPILevel=v;if(d&&f){j=JSON.parse(d);if(j){c=this._getFields(f);if(c&&c.length>0){for(i=0;i<c.length;i++){this._convertField(S,c[i],j,o);}}if(j._CUSTOM){if(typeof j._CUSTOM==="string"){J=JSON.parse(j._CUSTOM);}else{J=j._CUSTOM;}for(n in J){if(n){this._addSingleValue(S,n,b._getValue(J[n],true));}}}if(o&&o.getBasicSearchName){B=o.getBasicSearchName();if(B){e=o.getBasicSearchValue();this._addSingleValue(S,B,b._getValue(e,true));}}}}return JSON.stringify(S);};b.prototype._getParameterMetaData=function(n,f){var i,j,g;var c=f.getFilterBarViewMetadata();if(c){for(i=0;i<c.length;i++){g=c[i];for(j=0;j<g.fields.length;j++){if(n===g.fields[j].fieldName){return g.fields[j];}}}}if(f.getAnalyticalParameters){var d=f.getAnalyticalParameters();if(d){for(j=0;j<d.length;j++){if(n===d[j].fieldName){return d[j];}}}}return null;};b.prototype._convertField=function(s,f,c,o){var d,v,e=null,r,g,h,i;if(c&&f&&s){d=c[f];if(d){g=this._getParameterMetaData(f,o);if(g){if(g.isCustomFilterField){return;}if(g.filterRestriction===a.single){v=(d.value===undefined)?d:d.value;v=b._getValueWithMetadata(o,g,v,true);this._addSingleValue(s,f,v);}else if(g.filterRestriction===a.interval){if(d.conditionTypeInfo){this._convertFieldByValue(s,f,c,o,g);}else{r=b.addRangeEntry(s,f);if((g.type==="Edm.DateTime")&&!d.high){d.high=d.low;}else if((g.type==="Edm.String")&&!d.high){e="EQ";}if(g.type==="Edm.Time"){this._addRangeMultipleRangeValues(o,g,r,d.ranges,true);}else if(g.type==="Edm.DateTimeOffset"&&!d.high){if(!this._oFormat){this._oFormat=D.getDateTimeInstance({UTC:false});}e="BT";h=F.parseDateTimeOffsetInterval(d.low);if(h&&(h.length===2)&&h[0]){i={low:h[0],high:h[1]};this._addRangeLowHigh(o,g,r,i,"BT");}else{this._addRangeLowHigh(o,g,r,d,"EQ");}}else if(O.isNumeric(g.type)&&!d.high){h=F.parseFilterNumericIntervalData(d.low);if(h&&(h.length===2)&&h[0]){this._addRangeLowHigh(o,g,r,{low:h[0],high:h[1]},"BT");}else{this._addRangeLowHigh(o,g,r,d,"EQ");}}else{this._addRangeLowHigh(o,g,r,d,e);}}}else if(g.filterRestriction===a.multiple){r=b.addRangeEntry(s,f);if(d.items&&d.items.length>0){this._addRangeMultipleSingleValues(o,g,r,d.items);}else if(d.ranges&&d.ranges.length>0){this._addRangeMultipleRangeValues(o,g,r,d.ranges,d.conditionTypeInfo?true:false);}else{this._addRangeSingleValue(r,d.value);}}else{this._convertFieldByValue(s,f,c,o,g);}}else{this._convertFieldByValue(s,f,c,o,g);}}}};b.prototype._convertFieldByValue=function(s,f,c,o,d){var e;var r;if(c&&f&&s){e=c[f];if(e){if(e.conditionTypeInfo){if(e.ranges&&e.ranges.length>0){r=b.addRangeEntry(s,f);b.addRanges(r,e.ranges,o,d);}}else if((e.ranges!==undefined)&&(e.items!==undefined)&&(e.value!==undefined)){r=b.addRangeEntry(s,f);if(e.ranges&&e.ranges.length>0){b.addRanges(r,e.ranges,o,d);}if(e.items&&e.items.length>0){this._addRangeMultipleSingleValues(o,d,r,e.items);}if(e.value){this._addRangeSingleValue(r,b._getValueWithMetadata(o,d,e.value));}}else if((e.items!==undefined)&&e.items&&(e.items.length>0)){r=b.addRangeEntry(s,f);this._addRangeMultipleSingleValues(o,d,r,e.items);}else if((e.low!==undefined)&&e.low&&(e.high!==undefined)&&e.high){r=b.addRangeEntry(s,f);this._addRangeLowHigh(o,d,r,e);}else if((e.value!==undefined)&&e.value){this._addSingleValue(s,f,e.value);}else if(e){this._addSingleValue(s,f,e);}}}};b.addRangeEntry=function(s,f){var o={PropertyName:f,Ranges:[]};if(!s.SelectOptions){s.SelectOptions=[];}s.SelectOptions.push(o);return o.Ranges;};b.addRanges=function(r,R,f,o){var s,c,d,h;for(var i=0;i<R.length;i++){s=R[i].exclude?"E":"I";d=b._getValueWithMetadata(f,o,R[i].value1,true);h=null;if(R[i].operation===V.BT){h=b._getValueWithMetadata(f,o,R[i].value2);}switch(R[i].operation){case V.Contains:c="CP";if(d){d="*"+d+"*";}break;case V.StartsWith:c="CP";if(d){d=d+"*";}break;case V.EndsWith:c="CP";if(d){d="*"+d;}break;case V.Empty:c="EQ";d="";break;case V.EQ:case V.BT:case V.LE:case V.GE:case V.GT:case V.LT:c=R[i].operation;break;default:L.error("ValueHelpRangeOperation is not supported '"+R[i].operation+"'");return;}r.push({Sign:s,Option:c,Low:d,High:h});}};b.prototype._addRangeMultipleSingleValues=function(f,o,r,I){for(var i=0;i<I.length;i++){r.push({Sign:"I",Option:"EQ",Low:b._getValueWithMetadata(f,o,I[i].key,true),High:null});}};b.prototype._addRangeMultipleRangeValues=function(f,o,r,I,t){for(var i=0;i<I.length;i++){r.push({Sign:"I",Option:t?"BT":"EQ",Low:b._getValueWithMetadata(f,o,I[i].value1,true),High:t?b._getValueWithMetadata(f,o,I[i].value2):null});}};b.prototype._addRangeSingleValue=function(r,v){r.push({Sign:"I",Option:"EQ",Low:b._getValue(v,true),High:null});};b.prototype._addRangeLowHigh=function(f,o,r,c,s){var d=s||"BT";r.push({Sign:"I",Option:d,Low:b._getValueWithMetadata(f,o,c.low,true),High:b._getValueWithMetadata(f,o,c.high)});};b.prototype._addParamaterSingleValue=function(s,f,v){if(!s.Parameters){s.Parameters=[];}s.Parameters.push({PropertyName:f,PropertyValue:v});};b.prototype._createRangeSingleValue=function(s,f,v){var r=b.addRangeEntry(s,f);this._addRangeSingleValue(r,v);};b.prototype._addSingleValue=function(s,f,v){var n;if(this._sAPILevel){n=f.split(A);if(n.length>1){this._addParamaterSingleValue(s,n[n.length-1],v);}else{this._createRangeSingleValue(s,f,v);}}else{this._addParamaterSingleValue(s,f,v);}};b.prototype._getFields=function(f){var r=[];if(f){for(var i=0;i<f.length;i++){r.push(f[i].name);}}return r;};b._getValue=function(v,u){if((v===null)||(v===undefined)||(v==="")){return(u?"":null);}return""+v;};b._getValueWithMetadata=function(f,o,v,u){if((v===null)||(v===undefined)||(v==="")){return(u?"":null);}else if(f&&o){if((o.type==="Edm.DateTime")||(o.type==="Edm.Time")){if(f&&f.isInUTCMode&&f.isInUTCMode()&&f.getDateInUTCOffset){v=f.getDateInUTCOffset(new Date(v)).toJSON();}if(v.indexOf('Z')===(v.length-1)){v=v.substr(0,v.length-1);}}else if(o.type==="Edm.DateTimeOffset"){v=new Date(v).toJSON();}}return""+v;};return b;},true);
