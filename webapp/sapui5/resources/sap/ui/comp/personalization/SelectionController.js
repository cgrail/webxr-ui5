/*
 * ! SAPUI5

		(c) Copyright 2009-2019 SAP SE. All rights reserved
	
 */
sap.ui.define(['./BaseController','sap/m/library','sap/ui/comp/library','./Util'],function(B,M,C,U){"use strict";var S=B.extend("sap.ui.comp.personalization.SelectionController",{constructor:function(i,s){B.apply(this,arguments);this.setType(M.P13nPanelType.selection);this.setItemType(M.P13nPanelType.selection+"Items");},metadata:{events:{afterSelectionModelDataChange:{}}}});S.prototype.getColumn2Json=function(c,s,i){return{columnKey:s,text:c.getLabel(),visible:c.getSelected()};};S.prototype.getColumn2JsonTransient=function(c,s,t,T){return{columnKey:s,text:t,href:c.getHref(),target:c.getTarget(),press:c.getPress(),description:c.getDescription()};};S.prototype.syncJson2Table=function(j){this.fireBeforePotentialTableChange();this.fireAfterPotentialTableChange();};S.prototype.getPanel=function(p){return new Promise(function(r){sap.ui.require(['sap/m/P13nSelectionPanel','sap/m/P13nItem','sap/m/P13nSelectionItem'],function(P,a,b){return r(new P({titleLarge:sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp").getText("POPOVER_SELECTION_TITLE"),items:{path:'$sapmP13nPanel>/transientData/selection/selectionItems',template:new a({columnKey:'{$sapmP13nPanel>columnKey}',href:'{$sapmP13nPanel>href}',target:'{$sapmP13nPanel>target}',text:'{$sapmP13nPanel>text}',press:'{$sapmP13nPanel>press}'})},selectionItems:{path:"$sapmP13nPanel>/controlDataReduce/selection/selectionItems",template:new b({columnKey:"{$sapmP13nPanel>columnKey}",selected:"{$sapmP13nPanel>visible}"})},beforeNavigationTo:this.setModelFunction(),changeSelectionItems:function(e){if(!e.getParameter("items")){return;}var c=this.getControlDataReduce();c.selection.selectionItems=e.getParameter("items").map(function(m){return{columnKey:m.columnKey,visible:m.selected};});this.setControlDataReduce2Model(c);this.fireAfterPotentialModelChange({json:c});}.bind(this)}));}.bind(this));}.bind(this));};S.prototype.getChangeType=function(d,D){return this.getChangeData(d,D)?C.personalization.ChangeType.ModelChanged:C.personalization.ChangeType.Unchanged;};S.prototype.getChangeData=function(d,D){if(!D||!D.selection||!D.selection.selectionItems){return null;}var c={selection:U.copy(d.selection)};if(this._isSemanticEqual(d,D)){return null;}var t=[];c.selection.selectionItems.forEach(function(i){var I=U.getArrayElementByKey("columnKey",i.columnKey,D.selection.selectionItems);if(U.semanticEqual(i,I)){t.push(i);return;}for(var p in i){if(p==="columnKey"||!I){continue;}if(i[p]===I[p]){delete i[p];}}if(Object.keys(i).length<2){t.push(i);}});t.forEach(function(i){var I=U.getIndexByKey("columnKey",i.columnKey,c.selection.selectionItems);c.selection.selectionItems.splice(I,1);});return c;};S.prototype.getUnionData=function(d,D){var o=U.copy(d);if(!D||!D.selection||!D.selection.selectionItems){return o.selection?{selection:U.copy(o.selection)}:null;}if(!o||!o.selection||!o.selection.selectionItems){return{selection:U.copy(D.selection)};}var u=this.createControlDataStructure();o.selection.selectionItems.forEach(function(s){var a=U.getArrayElementByKey("columnKey",s.columnKey,D.selection.selectionItems);if(a){if(a.visible!==undefined){s.visible=a.visible;}}u.selection.selectionItems.push(s);});return u;};S.prototype._isSemanticEqual=function(d,D){var s=function(a,b){if(a.visible===true&&(b.visible===false||b.visible===undefined)){return-1;}else if((a.visible===false||a.visible===undefined)&&b.visible===true){return 1;}else if(a.visible===true&&b.visible===true){return 0;}else if((a.visible===false||a.visible===undefined)&&(b.visible===false||b.visible===undefined)){if(a.columnKey<b.columnKey){return-1;}else if(a.columnKey>b.columnKey){return 1;}else{return 0;}}};var c=U.copy(d.selection.selectionItems).sort(s);var e=U.copy(D.selection.selectionItems).sort(s);return!c.some(function(o,i){if(!U.semanticEqual(o,e[i])){return true;}});};return S;},true);
