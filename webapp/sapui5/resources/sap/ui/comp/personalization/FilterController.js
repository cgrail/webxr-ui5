/*
 * ! SAPUI5

		(c) Copyright 2009-2019 SAP SE. All rights reserved
	
 */
sap.ui.define(['sap/ui/thirdparty/jquery','./BaseController','sap/m/library','sap/ui/comp/library','./Util','./ChartWrapper','sap/ui/comp/filterbar/VariantConverterTo','sap/ui/comp/filterbar/VariantConverterFrom','sap/ui/model/odata/ODataModel','sap/ui/model/odata/v2/ODataModel','sap/ui/model/Model'],function(q,B,M,C,U,a,V,b,O,c,d){"use strict";var F=B.extend("sap.ui.comp.personalization.FilterController",{constructor:function(i,s){B.apply(this,arguments);this.setType(M.P13nPanelType.filter);this.setItemType(M.P13nPanelType.filter+"Items");},metadata:{events:{afterFilterModelDataChange:{}}}});F.prototype.setTable=function(t){B.prototype.setTable.apply(this,arguments);};F.prototype.getColumn2Json=function(o,s,i){if(this.getTableType()!==C.personalization.TableType.AnalyticalTable&&this.getTableType()!==C.personalization.TableType.Table&&this.getTableType()!==C.personalization.TableType.TreeTable){return null;}if(!U.isFilterable(o)){return null;}if(!o.getFiltered||(o.getFiltered&&!o.getFiltered())){return null;}return{columnKey:s,exclude:false,operation:o.getFilterOperator(),value1:o.getFilterValue(),value2:""};};F.prototype.getColumn2JsonTransient=function(o,s,t,T){if(!U.isFilterable(o)){return null;}var v;if(this.getTableType()===C.personalization.TableType.AnalyticalTable||this.getTableType()===C.personalization.TableType.Table||this.getTableType()===C.personalization.TableType.TreeTable){if(U.getColumnType(o)==="boolean"){v=U._getCustomProperty(o,"values");}return{columnKey:s,text:t,tooltip:T,maxLength:U._getCustomProperty(o,"maxLength"),precision:U._getCustomProperty(o,"precision"),scale:U._getCustomProperty(o,"scale"),type:U.getColumnType(o),typeInstance:U._getCustomProperty(o,"typeInstance"),values:v};}if(this.getTableType()===C.personalization.TableType.ResponsiveTable){if(U.getColumnType(o)==="boolean"){v=U._getCustomProperty(o,"values");}return{columnKey:s,text:t,tooltip:T,maxLength:U._getCustomProperty(o,"maxLength"),precision:U._getCustomProperty(o,"precision"),scale:U._getCustomProperty(o,"scale"),type:U.getColumnType(o),typeInstance:U._getCustomProperty(o,"typeInstance"),values:v};}if(this.getTableType()===C.personalization.TableType.ChartWrapper){return{columnKey:s,text:t,tooltip:T,maxLength:U._getCustomProperty(o,"maxLength"),precision:U._getCustomProperty(o,"precision"),scale:U._getCustomProperty(o,"scale"),type:U.getColumnType(o),typeInstance:U._getCustomProperty(o,"typeInstance"),values:v};}};F.prototype.handleIgnore=function(j,i){j.sort.sortItems.splice(i,1);};F.prototype.syncJson2Table=function(j){var o=this.getColumnMap();var e=q.extend(true,{},o);this.fireBeforePotentialTableChange();if(this.getTableType()===C.personalization.TableType.AnalyticalTable||this.getTableType()===C.personalization.TableType.Table||this.getTableType()===C.personalization.TableType.TreeTable){j.filter.filterItems.forEach(function(g){var f=o[g.columnKey];if(f){if(!f.getFiltered()){f.setFiltered(true);}delete e[g.columnKey];}});for(var s in e){var f=e[s];if(f&&f.getFiltered()){f.setFiltered(false);}}}this.fireAfterPotentialTableChange();};F.prototype.getDataSuiteFormat2Json=function(D){var j=this.createControlDataStructure();if(!D.SelectOptions||!D.SelectOptions.length){return j;}j.filter.filterItems=D.SelectOptions.map(function(s){var o=b.convertOption(s.Ranges[0].Option,s.Ranges[0].Low);return{columnKey:s.PropertyName,exclude:(s.Ranges[0].Sign==="E"),operation:o.op,value1:o.v,value2:s.Ranges[0].High};});return j;};F.prototype.getDataSuiteFormatSnapshot=function(D){var o=this.getUnionData(this.getControlDataInitial(),this.getControlData());if(!o.filter||!o.filter.filterItems||!o.filter.filterItems.length){return;}o.filter.filterItems.forEach(function(f){var r=V.addRangeEntry(D,f.columnKey);V.addRanges(r,[f]);});};F.prototype.getPanel=function(p){if(!U.hasFilterableColumns(this.getColumnMap())){return null;}if(p&&p.column){var s=U.getColumnKey(p.column);if(s){var j=this.getTransientData();j.filter.filterItems.forEach(function(i){i["isDefault"]=i.columnKey===s;});}}return new Promise(function(r){sap.ui.require(['sap/m/P13nFilterPanel','sap/m/P13nItem','sap/m/P13nAnyFilterItem','sap/ui/comp/providers/ValueListProvider'],function(P,e,f,g){var o=new P({containerQuery:true,items:{path:"$sapmP13nPanel>/transientData/filter/filterItems",template:new e({columnKey:'{$sapmP13nPanel>columnKey}',text:"{$sapmP13nPanel>text}",tooltip:"{$sapmP13nPanel>tooltip}",maxLength:"{$sapmP13nPanel>maxLength}",precision:"{$sapmP13nPanel>precision}",scale:"{$sapmP13nPanel>scale}",type:"{$sapmP13nPanel>type}",typeInstance:"{$sapmP13nPanel>typeInstance}",isDefault:"{$sapmP13nPanel>isDefault}",values:"{$sapmP13nPanel>values}"})},filterItems:{path:"$sapmP13nPanel>/controlDataReduce/filter/filterItems",template:new f({key:"{$sapmP13nPanel>key}",columnKey:"{$sapmP13nPanel>columnKey}",exclude:"{$sapmP13nPanel>exclude}",operation:"{$sapmP13nPanel>operation}",value1:"{$sapmP13nPanel>value1}",value2:"{$sapmP13nPanel>value2}"})},beforeNavigationTo:this.setModelFunction(),filterItemChanged:function(E){var R=E.getParameter("reason");var i=E.getParameter("index");var I=E.getParameter("itemData");var h=this.getControlDataReduce();if(I&&R==="added"){if(i>-1){h.filter.filterItems.splice(i,0,I);}else{h.filter.filterItems.push(I);}}if(R==="removed"&&i>-1){h[this.getType()][this.getItemType()].splice(i,1);}this.setControlDataReduce2Model(h);this.fireAfterPotentialModelChange({json:h});}.bind(this)});var S=function(h,i){var k=this.getColumnMap(true);var l=k[i];var m=U._getCustomProperty(l,"fullName");if(m){h.setShowSuggestion(true);h.setFilterSuggests(false);h.setModel(this.getTable().getModel());return new g({control:h,fieldName:i,typeAheadEnabled:true,aggregation:"suggestionRows",resolveInOutParams:false,loadAnnotation:true,fullyQualifiedFieldName:m,model:this.getTable().getModel(),enableShowTableSuggestionValueHelp:false});}}.bind(this);if(o.getIncludeOperations("string")){o.getIncludeOperations("string").push(sap.m.P13nConditionOperation.Empty);}else{o.setIncludeOperations([sap.m.P13nConditionOperation.EQ,sap.m.P13nConditionOperation.Empty],"string");}if(o.getExcludeOperations("string")){o.getExcludeOperations("string").push(sap.m.P13nConditionOperation.Empty);}else{o.setExcludeOperations([sap.m.P13nConditionOperation.EQ,sap.m.P13nConditionOperation.Empty],"string");}o._oIncludeFilterPanel._fSuggestCallback=S;o._oExcludeFilterPanel._fSuggestCallback=S;return r(o);}.bind(this));}.bind(this));};F.prototype.getChangeType=function(p,P){if(!P||!P.filter||!P.filter.filterItems){return C.personalization.ChangeType.Unchanged;}if(P&&P.filter&&P.filter.filterItems){P.filter.filterItems.forEach(function(f){delete f.key;delete f.source;});}if(p&&p.filter&&p.filter.filterItems){p.filter.filterItems.forEach(function(f){delete f.key;delete f.source;});}var i=JSON.stringify(p.filter.filterItems)!==JSON.stringify(P.filter.filterItems);return i?C.personalization.ChangeType.ModelChanged:C.personalization.ChangeType.Unchanged;};F.prototype.getChangeData=function(p,P){if(!p||!p.filter||!p.filter.filterItems){return this.createControlDataStructure();}if(P&&P.filter&&P.filter.filterItems){P.filter.filterItems.forEach(function(f){delete f.key;delete f.source;});}if(p&&p.filter&&p.filter.filterItems){p.filter.filterItems.forEach(function(f){delete f.key;delete f.source;});}if(!P||!P.filter||!P.filter.filterItems){return{filter:U.copy(p.filter)};}if(JSON.stringify(p.filter.filterItems)!==JSON.stringify(P.filter.filterItems)){return{filter:U.copy(p.filter)};}return null;};F.prototype.getUnionData=function(j,J){if(!J||!J.filter||!J.filter.filterItems){return{filter:U.copy(j.filter)};}return{filter:U.copy(J.filter)};};F.prototype.exit=function(){B.prototype.exit.apply(this,arguments);};return F;},true);
