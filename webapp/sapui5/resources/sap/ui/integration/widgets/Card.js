/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/core/Control","sap/ui/integration/util/CardManifest","sap/ui/integration/util/ServiceManager","sap/base/Log","sap/f/cards/Data","sap/f/cards/NumericHeader","sap/f/cards/Header","sap/f/cards/BaseContent","sap/m/HBox","sap/m/VBox","sap/ui/core/Icon","sap/m/Text","sap/f/CardRenderer"],function(q,C,a,S,L,D,N,H,B,b,V,I,T,c){"use strict";var M={TYPE:"/sap.card/type",DATA:"/sap.card/data",HEADER:"/sap.card/header",CONTENT:"/sap.card/content",SERVICES:"/sap.ui5/services",APP_TYPE:"/sap.app/type"};var d=C.extend("sap.ui.integration.widgets.Card",{metadata:{library:"sap.ui.integration",interfaces:["sap.f.ICard"],properties:{manifest:{type:"any",defaultValue:""},width:{type:"sap.ui.core.CSSSize",group:"Appearance",defaultValue:"100%"},height:{type:"sap.ui.core.CSSSize",group:"Appearance",defaultValue:"auto"}},aggregations:{_header:{type:"sap.f.cards.IHeader",multiple:false,visibility:"hidden"},_content:{type:"sap.ui.core.Control",multiple:false,visibility:"hidden"}},events:{action:{parameters:{actionSource:{type:"sap.ui.core.Control"},manifestParameters:{type:"object"},type:{type:"sap.ui.integration.CardActionType"}}}},associations:{hostConfigurationId:{}}},renderer:c});d.prototype.init=function(){this.setBusyIndicatorDelay(0);};d.prototype.exit=function(){if(this._oCardManifest){this._oCardManifest.destroy();this._oCardManifest=null;}if(this._oServiceManager){this._oServiceManager.destroy();this._oServiceManager=null;}};d.prototype.setManifest=function(v){this.setBusy(true);this.setProperty("manifest",v,true);if(typeof v==="string"&&v!==""){this._oCardManifest=new a();this._oCardManifest.load({manifestUrl:v}).then(function(){this._applyManifestSettings();}.bind(this));}else if(typeof v==="object"&&!q.isEmptyObject(v)){this._oCardManifest=new a(v);this._applyManifestSettings();}return this;};d.prototype._applyManifestSettings=function(){if(this._oCardManifest.get(M.APP_TYPE)!=="card"){L.error("sap.app/type entry in manifest is not 'card'");}this._registerServices();this._setData();this._setHeaderFromManifest();this._setContentFromManifest();};d.prototype._setData=function(){var o=this._oCardManifest.get(M.DATA);if(!o){this._oDataPromise=null;return;}this._oDataPromise=new Promise(function(r,e){var R=o.request;if(o.json){r({json:o.json,path:o.path});return;}if(R){D.fetch(R).then(function(f){r({json:f,path:o.path});}).catch(function(E){e(E);});}});};d.prototype._registerServices=function(){var s=this._oCardManifest.get(M.SERVICES);if(!s){return;}if(!this._oServiceManager){this._oServiceManager=new S(s,this);}var h=this._oCardManifest.get(M.HEADER);var o=this._oCardManifest.get(M.CONTENT);var t=this._oCardManifest.get(M.TYPE).toLowerCase();var e=h&&h.actions&&h.actions[0].service&&h.actions[0].type==="Navigation";var f;if(t==="list"){f=o&&o.item&&o.item.actions&&o.item.actions[0].service&&o.item.actions[0].type==="Navigation";}else if(t==="table"){f=o&&o.row&&o.row.actions&&o.row.actions[0].service&&o.row.actions[0].type==="Navigation";}var g=o&&o.data&&o.data.service;if(e){this._oServiceManager.registerService(h.actions[0].service,"sap.ui.integration.services.Navigation");}if(f){var v=t==="list"?o.item.actions[0].service:o.row.actions[0].service;this._oServiceManager.registerService(v,"sap.ui.integration.services.Navigation");}if(g){this._oServiceManager.registerService(o.data.service,"sap.ui.integration.services.Data");}};d.prototype.getCardHeader=function(){return this.getAggregation("_header");};d.prototype.getCardContent=function(){return this.getAggregation("_content");};d.prototype._setHeaderFromManifest=function(){var m=this._oCardManifest.get(M.HEADER);if(!m){L.error("Card header is mandatory!");return;}var h=H;if(m.type==="Numeric"){h=N;}this._setCardHeaderFromManifest(h);};d.prototype._setContentFromManifest=function(){var s=this._oCardManifest.get(M.TYPE),h=!!this._oCardManifest.get(M.CONTENT);if(!s){L.error("Card type property is mandatory!");return;}if(!h&&s.toLowerCase()!=="component"){this.setBusy(false);return;}this._setTemporaryContent();switch(s.toLowerCase()){case"list":sap.ui.require(["sap/f/cards/ListContent"],this._setCardContentFromManifest.bind(this));break;case"table":sap.ui.require(["sap/f/cards/TableContent"],this._setCardContentFromManifest.bind(this));break;case"object":sap.ui.require(["sap/f/cards/ObjectContent"],this._setCardContentFromManifest.bind(this));break;case"analytical":sap.ui.getCore().loadLibrary("sap.viz",{async:true}).then(function(){sap.ui.require(["sap/f/cards/AnalyticalContent"],this._setCardContentFromManifest.bind(this));}.bind(this)).catch(function(){this._handleError("Analytical type card is not available with this distribution");}.bind(this));break;case"timeline":sap.ui.getCore().loadLibrary("sap.suite.ui.commons",{async:true}).then(function(){sap.ui.require(["sap/f/cards/TimelineContent"],this._setCardContentFromManifest.bind(this));}.bind(this)).catch(function(){this._handleError("Timeline type card is not available with this distribution");}.bind(this));break;case"component":sap.ui.require(["sap/f/cards/ComponentContent"],this._setCardContentFromManifest.bind(this));break;default:L.error(s.toUpperCase()+" Card type is not supported");}};d.prototype._setCardHeaderFromManifest=function(e){var o=q.extend(true,{},this._oCardManifest.get(M.HEADER));var h=e.create(o,this._oServiceManager);h.attachEvent("_updated",function(){this.fireEvent("_headerUpdated");this.setBusy(false);}.bind(this));h.attachEvent("action",function(E){this.fireEvent("action",{manifestParameters:E.getParameter("manifestParameters"),actionSource:E.getParameter("actionSource"),type:E.getParameter("type")});}.bind(this));if(!o.data||(o.data&&o.data.json)){var f={onAfterRendering:function(){this.fireEvent("_headerUpdated");h.removeEventDelegate(f);this.setBusy(false);}};h.addEventDelegate(f,this);}if(Array.isArray(o.actions)&&o.actions.length>0){h._attachActions(o);}this.setAggregation("_header",h);if(this._oDataPromise){this._oDataPromise.then(function(g){if(h.isA("sap.f.cards.NumericHeader")){sap.f.cards.NumericHeader._handleData(h,g);}else{sap.f.cards.Header._handleData(h,g);}}).catch(function(E){});}};d.prototype.onBeforeRendering=function(){var s=this.getHostConfigurationId();if(s){this.addStyleClass(s.replace(/-/g,"_"));}};d.prototype._setCardContentFromManifest=function(e){var s=this._oCardManifest.get(M.CONTENT),t=this._oCardManifest.get(M.TYPE).toLowerCase();if(!s&&t==="component"){s=this._oCardManifest.getJson();}var o={configuration:q.extend(true,{},s)};if(this._oServiceManager){o.serviceManager=this._oServiceManager;}var f=new e(o);f.attachEvent("_updated",function(){this.fireEvent("_contentUpdated");this.setBusy(false);}.bind(this));f.attachEvent("action",function(E){this.fireEvent("action",{actionSource:E.getParameter("actionSource"),manifestParameters:E.getParameter("manifestParameters"),type:E.getParameter("type")});}.bind(this));f.attachEvent("_error",function(E){this._handleError(E.getParameter("logMessage"),E.getParameter("displayMessage"));}.bind(this));f.setBusyIndicatorDelay(0);this.setAggregation("_content",f);if(this._oDataPromise){this._oDataPromise.then(function(g){this.setBusy(false);f._setData(g);}.bind(this)).catch(function(E){this._handleError(E);}.bind(this));}};d.prototype._setTemporaryContent=function(){var h=new b({busy:true,busyIndicatorDelay:0,height:"100%"});h.addEventDelegate({onAfterRendering:function(){if(!this._oCardManifest){return;}var t=this._oCardManifest.get(M.TYPE)+"Content",o=this._oCardManifest.get(M.CONTENT),s=B.getMinHeight(t,o);h.$().css({"min-height":s});}},this);this.setAggregation("_content",h);};d.prototype._handleError=function(l,s){L.error(l);this.setBusy(false);this.fireEvent("_error");var e="Unable to load the data.",E=s||e;var o=new b({height:"100%",justifyContent:"Center",items:[new V({justifyContent:"Center",alignItems:"Center",items:[new I({src:"sap-icon://message-error",size:"1rem"}).addStyleClass("sapUiTinyMargin"),new T({text:E})]})]});o.addEventDelegate({onAfterRendering:function(){if(!this._oCardManifest){return;}var t=this._oCardManifest.get(M.TYPE)+"Content",f=this._oCardManifest.get(M.CONTENT),h=B.getMinHeight(t,f);o.$().css({"min-height":h});}},this);this.setAggregation("_content",o);};return d;});
