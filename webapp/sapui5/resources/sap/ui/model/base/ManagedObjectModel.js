/*
 * ! OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['../json/JSONModel','../json/JSONPropertyBinding','../json/JSONListBinding','sap/ui/base/ManagedObject','sap/ui/base/ManagedObjectObserver','../Context','../ChangeReason',"sap/base/util/uid","sap/base/Log","sap/base/util/isPlainObject"],function(J,a,b,M,c,C,d,u,L,e){"use strict";var f="@custom",I="--";function _(m,o,A,O){var n=A.get(o)||[],p,r;for(var i=0;i<n.length;i++){p=n[i];if(!(p instanceof M)){continue;}r=true;if(O){m._oObserver.observe(p,{properties:true,aggregations:true});}else{m._oObserver.unobserve(p,{properties:true,aggregations:true});}var q=p.getMetadata().getAllAggregations();for(var K in q){_(m,p,q[K],O);}}if(r){var K=o.getId()+"/@"+A.name;if(O){if(!m._mObservedCount.aggregations[K]){m._mObservedCount.aggregations[K]=0;}m._mObservedCount.aggregations[K]++;}else{delete m._mObservedCount.aggregations[K];}}}function g(n){var m,i=n.length-1,p=[];while(!(n[i].node instanceof M)){if(m){p.splice(0,0,m);}m=n[i].path;i--;}return[n[i].node,n[i+1],p,m];}function h(o){var D="",p;var t=typeof o;if(o==null||(t!="object"&&t!="function")){D=o;}else if(e(o)){D=JSON.stringify(o);}else if(o instanceof M){D=o.getId();for(p in o.mProperties){D=D+"$"+h(o.mProperties[p]);}}else if(Array.isArray(o)){for(var i=0;o.length;i++){D=D+"$"+h(o);}}else{L.warning("Could not stringify object "+o);D="$";}return D;}var j=b.extend("sap.ui.model.base.ManagedObjectModelAggregationBinding",{constructor:function(){b.apply(this,arguments);this._getOriginOfManagedObjectModelBinding();},getEntryKey:function(o){var O=o.getObject();if(O instanceof M){return O.getId();}return b.prototype.getEntryKey.apply(this,arguments);},getEntryData:function(o){var O=o.getObject();if(O instanceof M){return h(O);}return b.prototype.getEntryData.apply(this,arguments);},_getOriginOfManagedObjectModelBinding:function(){if(!this._oOriginMO){var m=this.oModel,n=[];m._getObject(this.sPath,this.oContext,n);var v=g(n);this._oOriginMO=v[0];this._aPartsInJSON=v[2];this._sMember=v[3];}},getLength:function(){if(this._aPartsInJSON.length==0){var i=this._oOriginMO.getBinding(this._sMember);if(i&&i.isA("sap.ui.model.ListBinding")){return i.getLength();}}return b.prototype.getLength.apply(this,arguments);},isLengthFinal:function(){if(this._aPartsInJSON.length==0){var i=this._oOriginMO.getBinding(this._sMember);if(i&&i.isA("sap.ui.model.ListBinding")){return i.isLengthFinal();}}return true;}});var k=a.extend("sap.ui.model.base.ManagedObjectModelPropertyBinding");var l=J.extend("sap.ui.model.base.ManagedObjectModel",{constructor:function(o,D){if(!D&&typeof D!="object"){D={};}D[f]={};this._oObject=o;this._mObservedCount={properties:{},aggregations:{}};this.mListBinding={};J.apply(this,[D]);this._oObserver=new c(this.observerChanges.bind(this));}});l.prototype.getAggregation=J.prototype.getProperty;l.prototype.setData=function(D,m){var i={};i[f]=D;J.prototype.setData.apply(this,[i,m]);};l.prototype.getJSON=function(){return JSON.stringify(this.oData[f]);};l.prototype.setProperty=function(p,v,o,A){var r=this.resolve(p,o),m,O,P;if(!r){return false;}if(r.indexOf("/"+f)===0){return J.prototype.setProperty.apply(this,arguments);}m=r.lastIndexOf("/");O=r.substring(0,m||1);P=r.substr(m+1);var n=[],q=this._getObject(O,null,n);if(q){if(q instanceof M){var s=q.getMetadata().getManagedProperty(P);if(s){if(s.get(q)!==v){s.set(q,v);var F=function(B){var p=this.resolve(B.sPath,B.oContext);return p.startsWith(r);}.bind(this);this.checkUpdate(false,A,F);return true;}}else{L.warning("The setProperty method only supports properties, the path "+r+" does not point to a property",null,"sap.ui.model.base.ManagedObjectModel");}}else if(q[P]!==v){var V=g(n);var t=V[1].node,w=V[2];var x=t;for(var i=0;i<w.length;i++){x=x[w[i]];}x[P]=v;var S="/"+w.join("/")+"/"+P;var D=r.lastIndexOf(S);var U=r.substr(0,D);return this.setProperty(U,t,o);}}return false;};l.prototype.addBinding=function(B){J.prototype.addBinding.apply(this,arguments);if(B instanceof j){var A=B.sPath.replace("/","");this.mListBinding[A]=B;}B.checkUpdate(false);};l.prototype.removeBinding=function(B){J.prototype.removeBinding.apply(this,arguments);if(B instanceof j){var A=B.sPath.replace("/","");delete this.mListBinding[A];}this._observeBeforeEvaluating(B,false);};l.prototype.firePropertyChange=function(A){if(A.reason===d.Binding){A.resolvedPath=this.resolve(A.path,A.context);}J.prototype.firePropertyChange.call(this,A);};l.prototype.bindAggregation=function(p,o,P){return J.prototype.bindProperty.apply(this,arguments);};l.prototype.bindProperty=function(p,o,P){var B=new k(this,p,o,P);return B;};l.prototype.bindList=function(p,o,s,F,P){var B=new j(this,p,o,s,F,P);return B;};l.prototype.getManagedObject=function(p,o){if(p instanceof C){o=p;p=o.getPath();}var O=this.getProperty(p,o);if(O instanceof M){return O;}return null;};l.prototype.getRootObject=function(){return this._oObject;};l.prototype._observePropertyChange=function(o,p){if(!o||!p){return;}var K=o.getId()+"/@"+p.name;if(!this._oObserver.isObserved(o,{properties:[p.name]})){this._oObserver.observe(o,{properties:[p.name]});this._mObservedCount.properties[K]=1;}else{this._mObservedCount.properties[K]++;}};l.prototype._unobservePropertyChange=function(o,p){if(!o||!p){return;}var K=o.getId()+"/@"+p.name;this._mObservedCount.properties[K]--;if(this._mObservedCount.properties[K]==0){this._oObserver.unobserve(o,{properties:[p.name]});delete this._mObservedCount.properties[K];}};l.prototype._observeAggregationChange=function(o,A){if(!o||!A){return;}var K=o.getId()+"/@"+A.name;if(!this._oObserver.isObserved(o,{aggregations:[A.name]})){this._oObserver.observe(o,{aggregations:[A.name]});this._mObservedCount.aggregations[K]=1;_(this,o,A,true);}else{this._mObservedCount.aggregations[K]++;}};l.prototype._unobserveAggregationChange=function(o,A){if(!o||!A){return;}var K=o.getId()+"/@"+A.name;this._mObservedCount.aggregations[K]--;if(this._mObservedCount.aggregations[K]==0){this._oObserver.unobserve(o,{aggregations:[A.name]});delete this._mObservedCount.aggregations[K];}};l.prototype._createId=function(i){var o=this._oObject;if(typeof o.createId==="function"){return o.createId(i);}if(!i){return o.getId()+I+u();}if(i.indexOf(o.getId()+I)!=0){return o.getId()+I+i;}return i;};l.prototype._getSpecialNode=function(n,s,p,P){if(n instanceof M){if(s==="className"){if(n.getMetadata){return n.getMetadata().getName();}else{return typeof n;}}else if(s==="id"){return n.getId();}else if(s==="metadataContexts"){return n._oProviderData;}}else if(s==="binding"&&p&&P){return p.getBinding(P);}else if(s==="bound"&&p&&P){return p.isBound(P);}else if(s==="bindingInfo"&&p&&P){return p.getBindingInfo(P);}else if(Array.isArray(n)){if(s==="length"){return n.length;}else if(s.indexOf("id=")===0){var m=s.substring(3),F=null;for(var i=0;i<n.length;i++){if(n[i].getId()===this._createId(m)||n[i].getId()===m){F=n[i];break;}}return F;}}return null;};l.prototype._getObject=function(p,o,n){var N=this._oObject,r="",t=this;if(n){n.push({path:"/",node:N});}this.aBindings.forEach(function(B){if(!B._bAttached){t._observeBeforeEvaluating(B,true);}});if(typeof p==="string"&&p.indexOf("/")!=0&&!o){return null;}if(o instanceof M){N=o;r=p;}else if(!o||o instanceof C){r=this.resolve(p,o);if(!r){return N;}if(r.indexOf("/"+f)===0){return J.prototype._getObject.apply(this,[p,o]);}}else{N=o;r=p;}if(!N){return null;}var P=r.split("/"),i=0;if(!P[0]){i++;}var m=null,s=null,q;while(N!==null&&P[i]){q=P[i];if(q=="id"){q="@id";}if(q.indexOf("@")===0){N=this._getSpecialNode(N,q.substring(1),m,s);}else if(N instanceof M){var v=N.getMetadata();if(v.isInstanceOf("sap.ui.core.IDScope")&&q.indexOf("#")===0){N=N.byId(q.substring(1));}else{m=N;s=q;var w=v.getManagedProperty(q);if(w){N=w.get(N);}else{var A=v.getManagedAggregation(q);if(A){N=A.get(N);}else{if(N&&N[q]&&typeof N[q]==="function"){N=N[q]();}else{N=null;}}}}}else if(Array.isArray(N)||e(N)){N=N[q];}else{if(N&&N[q]&&typeof N[q]==="function"){N=N[q]();}else{N=null;}}if(n){n.push({path:q,node:N});}i++;}return N;};l.prototype.destroy=function(){for(var n in this._mAggregationObjects){var o=this._mAggregationObjects[n];if(o.object.invalidate.fn){o.object.invalidate=o.object.invalidate.fn;}}J.prototype.destroy.apply(this,arguments);};l.prototype._observeBeforeEvaluating=function(B,o){if(!B.isResolved()){return;}var p=B.getPath();var i=B.getContext(),n=this._oObject,r;if(i instanceof M){n=i;r=p;}else if(!i||i instanceof C){r=this.resolve(p,i);if(!r){return;}if(r.indexOf("/"+f)===0){return;}}else{return;}var P=r.split("/");if(!P[0]){P.shift();}var s=P[0];if(n.getMetadata().isInstanceOf("sap.ui.core.IDScope")&&s.indexOf("#")===0){n=n.byId(s.substring(1));s=P[1];}if(n instanceof M){var N=n.getMetadata(),m=N.getManagedProperty(s);if(m){if(o===true){this._observePropertyChange(n,m);}else if(o===false){this._unobservePropertyChange(n,m);}}else{var A=N.getAggregation(s)||N.getAllPrivateAggregations()[s];if(A){if(o===true){this._observeAggregationChange(n,A);}else if(o===false){this._unobserveAggregationChange(n,A);}}}B._bAttached=o;}};l.prototype.observerChanges=function(o){if(o.type=="aggregation"){var A={};if(o.child instanceof M){A=o.child.getMetadata().getAllAggregations();}if(o.mutation=="insert"){if(o.child instanceof M){this._oObserver.observe(o.child,{properties:true,aggregations:true});}for(var K in A){_(this,o.child,A[K],true);}if(this.mListBinding[o.name]){var i=this._oObject.getBinding(o.name);var m=this._oObject.getAggregation(o.name);if(i&&i.getCurrentContexts().length!=m.length){return;}}}else{if(o.child instanceof M){this._oObserver.unobserve(o.child,{properties:true,aggregations:true});}for(var K in A){_(this,o.child,A[K],false);}}}this.checkUpdate();};l.prototype.checkUpdate=function(F,A,i){if(A){if(!this.sUpdateTimer){this.sUpdateTimer=setTimeout(function(){this.checkUpdate(F,false,i);}.bind(this),0);}return;}if(this.sUpdateTimer){clearTimeout(this.sUpdateTimer);this.sUpdateTimer=null;}var B=this.aBindings.slice(0);jQuery.each(B,function(m,o){if(!i||i(o)){o.checkUpdate(F);}});};return l;});
