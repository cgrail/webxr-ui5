/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["jquery.sap.global","sap/ui/core/Control","../Extension"],function(q,S,a){"use strict";var M={Error:"Error",ErrorOnDescendant:"ErrorOnDescendant",Warning:"Warning",WarningOnDescendant:"WarningOnDescendant",Information:"Information",None:"None"};var b=a.extend("sap.ui.vtm.extensions.MessageStatusCalculationExtension",{metadata:{interfaces:["sap.ui.vtm.interfaces.IMessageStatusCalculationExtension"]},constructor:function(i,s){a.apply(this,arguments);},initialize:function(){this._rb=sap.ui.vtm.getResourceBundle();this.applyPanelHandler(function(p){var t=p.getTree();t.attachBeforeModelUpdated(function(e){this._handleBeforeModelUpdated(p);}.bind(this));this._handleBeforeModelUpdated(p);}.bind(this));},_getMessageStatusPriority:function(m){switch(m){case M.Error:return 1;case M.ErrorOnDescendant:return 2;case M.Warning:return 3;case M.WarningOnDescendant:return 4;case M.Information:return 5;case M.None:return 6;default:throw"Unknown message status: '"+m+"'";}},_makeCascadedMessageStatus:function(m){switch(m){case M.Error:case M.ErrorOnDescendant:return M.ErrorOnDescendant;case M.Warning:case M.WarningOnDescendant:return M.WarningOnDescendant;case M.Information:case M.None:return M.None;default:throw"Unknown message status: '"+m+"'";}},_messageStatusCompareFunction:function(m,c){return this._getMessageStatusPriority(m)-this._getMessageStatusPriority(c);},_calculateHighestPriorityMessageStatus:function(t){var m=t.messages;if(m){var c=sap.ui.vtm.TreeItemUtilities.getMessages(t);c.sort(sap.ui.core.Message.compareByType).reverse();return c[0].getLevel();}else{return sap.ui.core.MessageType.None;}},_calculateHighestPriorityChildMessageStatus:function(t){var c=sap.ui.vtm.TreeItemUtilities.getIncludedChildren(t);if(c.length){var d=c.filter(function(e){return e.messageStatus;});if(d.length){d.sort(function(e,f){return this._getMessageStatusPriority(e.messageStatus)-this._getMessageStatusPriority(f.messageStatus);}.bind(this));return d[0].messageStatus;}}return sap.ui.core.MessageType.None;},_calculateMessageStatus:function(t){var h=this._calculateHighestPriorityMessageStatus(t);var c=this._calculateHighestPriorityChildMessageStatus(t);if(this._messageStatusCompareFunction(h,c)>0){if(c===sap.ui.core.MessageType.None){if(t.messageStatus){delete t.messageStatus;}}else{t.messageStatus=this._makeCascadedMessageStatus(c);}}else if(h===sap.ui.core.MessageType.None){if(t.messageStatus){delete t.messageStatus;}}else{t.messageStatus=h;}if(c===sap.ui.core.MessageType.None){if(t.childMessageStatus){delete t.childMessageStatus;}else{t.childMessageStatus=c;}}},_getIconSource:function(m){switch(m){case M.Error:return"sap-icon://error";case M.ErrorOnDescendant:return"sap-icon://message-error";case M.Warning:return"sap-icon://alert";case M.WarningOnDescendant:return"sap-icon://message-warning";case M.Information:return"sap-icon://message-information";case M.None:return null;default:throw"Unknown message type: '"+m+"'";}},_getStatusTooltip:function(m){switch(m){case M.Error:return this._rb.getText("MESSAGESTATUS_ERROR");case M.ErrorOnDescendant:return this._rb.getText("MESSAGESTATUS_ERRORONDESCENDANT");case M.Warning:return this._rb.getText("MESSAGESTATUS_WARNING");case M.WarningOnDescendant:return this._rb.getText("MESSAGESTATUS_WARNINGONDESCENDANT");case M.Information:return this._rb.getText("MESSAGESTATUS_INFORMATION");case M.None:return null;default:throw"Unknown message type: '"+m+"'";}},_getMessagesToShowTootip:function(t){if(t.messages){return this._rb.getText("MESSAGESTATUS_CLICKTOSHOWMESSAGES");}else{return this._rb.getText("MESSAGESTATUS_NOMESSAGESONTHISITEM");}},_getIconColor:function(m){switch(m){case M.Error:case M.ErrorOnDescendant:return sap.ui.core.IconColor.Negative;case M.Warning:case M.WarningOnDescendant:return sap.ui.core.IconColor.Critical;case M.Information:return sap.ui.core.IconColor.Neutral;case M.None:return null;default:throw"Unknown message type: '"+m+"'";}},_calculateMessageStatusForTree:function(t){var c=this._calculateMessageStatus.bind(this);var d=function(e,f){var g=sap.ui.vtm.TreeItemUtilities.getChildren(e);g.forEach(function(h){d(h,f);});if(f){f(e);}};t.getRootItems().forEach(function(e){d(e,c);});var r=false;sap.ui.vtm.TreeItemUtilities.traverseTree(t.getRootItems(),function(e){if(e.messageStatus){var m=this._getIconSource(e.messageStatus);if(e.messageStatusIconUrl!==m){e.messageStatusIconUrl=m;r=true;}var f=this._getIconColor(e.messageStatus);if(e.messageStatusIconColor!==f){e.messageStatusIconColor=f;r=true;}var g=this._getMessagesToShowTootip(e);var s=this._getStatusTooltip(e.messageStatus);var h=s?s+"\n"+g:g;if(e.messageStatusIconTooltip!=h){e.messageStatusIconTooltip=h;r=true;}}else if(e.messageStatusIconUrl||e.messageStatusIconColor||e.messageStatusIconTooltip){delete e.messageStatusIconUrl;delete e.messageStatusIconColor;delete e.messageStatusIconTooltip;r=true;}delete e.messageStatus;delete e.childMessageStatus;}.bind(this));if(r){t._updateBindings();}},_handleBeforeModelUpdated:function(p){if(!this.getEnabled()){return;}var t=p.getTree();this._calculateMessageStatusForTree(t);}});return b;});
