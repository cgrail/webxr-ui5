/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/thirdparty/jquery",'sap/ui/core/StashedControlSupport','sap/ui/dt/ElementUtil','sap/ui/rta/Utils','sap/base/Log','sap/ui/rta/util/BindingsExtractor'],function(q,S,E,R,L,B){"use strict";function _(P,i){var j=q.extend({},P);j.entityName=i.name;var l=P["com.sap.vocabularies.Common.v1.Label"];j.fieldLabel=l&&l.String;var Q=P["com.sap.vocabularies.Common.v1.QuickInfo"];j.quickInfo=Q&&Q.String;var H=P["com.sap.vocabularies.UI.v1.Hidden"];j.hidden=H&&H.Bool==="true";if(!j.hidden){var F=P["com.sap.vocabularies.Common.v1.FieldControl"];if(F){j.hidden=F.EnumMember==="com.sap.vocabularies.Common.v1.FieldControlType/Hidden";}}return j;}function a(P){if(P&&P.type){if(P.type.toLowerCase().indexOf("edm")!==0){return true;}}return false;}function b(O,M,i){return O.reduce(function(j,P){var l=_(P,i);if(a(l)){var C=M.getODataComplexType(l.type);if(C){l=C.property.map(function(x){x=_(x,i);x.bindingPath=l.name+"/"+x.name;x.referencedComplexPropertyName=l.fieldLabel||l.name;return x;});}}else{l.bindingPath=P.name;}return j.concat(l);},[]);}function c(O,i,j){return O.filter(function(P){return!P.hidden;}).filter(function(P){var F=P["com.sap.vocabularies.Common.v1.FieldControl"];var l=F&&F.Path;if(l){var x=i.getBinding(j)instanceof sap.ui.model.ListBinding;if(x){return true;}var y=i.getBindingContext().getProperty(l);return y!==0;}return true;});}function d(i,j){if(!i){return false;}var l=i.getBindingInfo(j);var P=l&&l.path;if(!P){return false;}if(P.indexOf(">")>-1){P=P.split(">").pop();}return P.indexOf("/")===0;}function e(i,j,l){var x;if(j){x=i.getBindingInfo(l);if(typeof x.model==="string"&&x.model!==""){x=undefined;}}else{x=i.getBindingContext();}return x;}function f(i,j){var l=d(i,j);var x=e(i,l,j);if(x){return l?x.path:x.getPath();}}function g(P,C){C.type="custom";if(C.id){C.itemId=P+"--"+C.id;C.key=C.itemId;}return C;}function h(i,j){var M=i.getModel();var D={property:[],navigationProperty:[],navigationEntityNames:[]};if(M){var l=M.getMetadata().getName();if(l==="sap.ui.model.odata.ODataModel"||l==="sap.ui.model.odata.v2.ODataModel"){var x=M.getMetaModel();return x.loaded().then(function(){var y=f(i,j);if(y){var z=x.getMetaContext(y);var O=z.getObject();var C=i.getMetadata().getAggregation();if(C){var F=i.getBindingInfo(C.name);var T=F&&F.template;if(T){var P=i.getBindingPath(C.name);var G=x.getODataAssociationEnd(O,P);var H=G&&G.type;if(H){var I=x.getODataEntityType(H);O=I;}}}D.property=O.property||[];D.property=b(D.property,x,O);D.property=c(D.property,i,j);if(O.navigationProperty){D.navigationProperty=O.navigationProperty;O.navigationProperty.forEach(function(N){var H=(x.getODataAssociationEnd(O,N.name)&&x.getODataAssociationEnd(O,N.name).type);var I=x.getODataEntityType(H);if(I&&I.name){if(D.navigationEntityNames.indexOf(I.name)===-1){D.navigationEntityNames.push(I.name);}}});}}return D;});}}return Promise.resolve(D);}function k(O){return{selected:false,label:O.fieldLabel||O.name,referencedComplexPropertyName:O.referencedComplexPropertyName?O.referencedComplexPropertyName:"",duplicateComplexName:O.duplicateComplexName?O.duplicateComplexName:false,tooltip:O.quickInfo||O.fieldLabel,originalLabel:"",type:"odata",entityType:O.entityName,name:O.name,bindingPath:O.bindingPath};}function m(D){var i=D.element;var j=D.action;return{selected:false,label:i.fieldLabel||E.getLabelForElement(i,j.getLabel),tooltip:i.quickInfo||i.name||E.getLabelForElement(i,j.getLabel),referencedComplexPropertyName:i.referencedComplexPropertyName?i.referencedComplexPropertyName:"",duplicateComplexName:i.duplicateComplexName?i.duplicateComplexName:false,bindingPaths:i.bindingPaths,originalLabel:i.renamedLabel&&i.fieldLabel!==i.originalLabel?i.originalLabel:"",type:"invisible",elementId:i.getId()};}function n(i,j,l){if(j&&j!==i){var x=R.getEntityTypeByPath(i.getModel(),f(i,l));return E.findAllSiblingsInContainer(i,j).filter(function(y){var P=f(y,l);if(P){return R.getEntityTypeByPath(y.getModel(),P)===x;}return false;});}else{return[i];}}function o(O){O.forEach(function(i,l,O){if(i["duplicateComplexName"]!==true){for(var j=l+1;j<O.length-1;j++){if(i.fieldLabel===O[j].fieldLabel){i["duplicateComplexName"]=true;O[j]["duplicateComplexName"]=true;}}}});return O;}function p(i,O){return O.some(function(D){return D.fieldLabel===i.fieldLabel;});}function r(I,M){I.bindingPaths=[];I.bindingContextPaths=[];var j=I.sParentAggregationName;var P=I.getParent();var x=B.getBindings(I,M);if(P){var D=P.getMetadata().getAggregation();if(D){var y=E.getAggregation(P,j).indexOf(I);var z=D.name;var C=P.getBindingInfo(z);var T=C&&C.template;if(T){var F=T.getMetadata().getAggregation();if(F){var G=F.name;var H=E.getAggregation(T,G)[y];x=x.concat(B.getBindings(H,null,true));}}}}for(var i=0,l=x.length;i<l;i++){if(x[i].getPath&&x[i].getPath()){if(I.bindingPaths.indexOf(x[i].getPath())===-1){I.bindingPaths.push(x[i].getPath());}}if(x[i].getContext&&x[i].getContext()){if(I.bindingContextPaths.indexOf(x[i].getContext().getPath())===-1){I.bindingContextPaths.push(x[i].getContext().getPath());}}if(q.isPlainObject(x[i])){if(I.bindingPaths.indexOf(x[i].parts[0].path)===-1){I.bindingPaths.push(x[i].parts[0].path);}}}return I;}function s(i){return Array.isArray(i)&&i.length>0;}function t(i,N,j,l){var x=s(i)&&i.some(function(P){var z=P.trim().replace(/^\//gi,'').split('/');if(z.length>1){return N.indexOf(z.shift())!==-1;}});var y=l.some(function(C){C=C.match(/^\/?([A-Za-z0-9_]+)/)[0];return(j.indexOf(C)>=0);});return x||y;}function u(i,O){return O.filter(function(D){return i.indexOf(D.bindingPath)!==-1;}).pop();}function v(i,O){i.originalLabel=O.fieldLabel||O.label;i.quickInfo=O.quickInfo||O.tooltip;i.name=O.name;if(i.fieldLabel!==i.originalLabel){i.renamedLabel=true;}if(O.referencedComplexPropertyName){i.referencedComplexPropertyName=O.referencedComplexPropertyName;}}function w(i,O,N,j){var l=i.bindingPaths,x=i.bindingContextPaths,y;return(!s(l)||t(l,N,j,x)||((y=u(l,O))&&(v(i,y)||true)));}var A={enhanceInvisibleElements:function(i,j){var M=i.getModel();var l=j.reveal;var x=j.addODataProperty;var C=j.custom;var D=i.getMetadata().getAggregation();var y=D?D.name:j.aggregation;return Promise.resolve().then(function(){return h(i,y);}).then(function(z){var O=z.property;var F=z.navigationProperty.map(function(N){return N.name;});var G=z.navigationEntityNames;O=o(O);var H=[];var I=l.elements||[];I.forEach(function(J){var K=J.element;var N=J.action;var P=true;K.fieldLabel=E.getLabelForElement(K,N.getLabel);if(x){if(f(i,y)===f(K,y)){K=r(K,M);K.duplicateComplexName=p(K,O);if(O.length>0){P=w(K,O,F,G);}}else if(B.getBindings(K,M).length>0){P=false;}}if(C&&P){C.items.forEach(function(Q){g(i.getParent().getId(),Q);if(Q.itemId===K.getId()){v(K,Q);}});}if(P){H.push({element:K,action:N});}});return H;}).then(function(z){return z.map(m);});},getUnboundODataProperties:function(i,j){var D=i.getMetadata().getAggregation();var l=D?D.name:j.action.aggregation;var M=i.getModel();return Promise.resolve().then(function(){return h(i,l);}).then(function(x){var O=x.property;var y=n(i,j.relevantContainer,l);var z=[];y.forEach(function(i){z=z.concat(B.getBindings(i,M));});var F=j.action.filter?j.action.filter:function(){return true;};O=O.filter(function(C){var H=false;if(z){H=z.some(function(G){return(q.isPlainObject(G)?G.parts[0].path:!!G.getPath&&G.getPath())===C.bindingPath;});}return!H&&F(j.relevantContainer,C);});O=o(O);return O;}).then(function(U){return U.map(k);});},getCustomAddItems:function(i,j){return new Promise(function(l){if(Array.isArray(j.items)){l(j.items.map(g.bind(null,i.getParent().getId())).filter(function(C){if(!C.id){L.error("CustomAdd item with label "+C.label+" does not contain an 'id' property","sap.ui.rta.plugin.AdditionalElementsAnalyzer#showAvailableElements");return false;}return!E.getElementInstance(C.itemId);}));}else{l();}});},getFilteredItemsList:function(i){var C=2;if(i[C]){var I=i[0].map(function(j){return j.elementId;});i[C]=i[C].filter(function(j){return!j.itemId||I.indexOf(j.itemId)===-1;});}return i.reduce(function(j,l){return j.concat(l);},[]);}};return A;});
