/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/dt/Plugin","sap/ui/fl/Utils","sap/ui/fl/registry/ChangeRegistry","sap/ui/dt/OverlayRegistry","sap/ui/dt/OverlayUtil","sap/ui/dt/ElementOverlay","sap/ui/fl/changeHandler/JsControlTreeModifier","sap/ui/base/ManagedObject"],function(P,F,C,O,a,E,J,M){"use strict";E.prototype._bElementHasStableId=undefined;E.prototype.getElementHasStableId=function(){return this._bElementHasStableId;};E.prototype.setElementHasStableId=function(h){this._bElementHasStableId=h;};E.prototype.hasElementStableId=function(){return this._bElementHasStableId?true:false;};var B=P.extend("sap.ui.rta.plugin.Plugin",{metadata:{"abstract":true,library:"sap.ui.rta",properties:{commandFactory:{type:"object",multiple:false}},events:{elementModified:{command:{type:"sap.ui.rta.command.BaseCommand"}}}}});B.prototype._isEditable=function(){};var e=function(o,f){var g=function(d){if(d.getSource().getGeometry()&&d.getSource().getGeometry().visible){o.detachEvent('geometryChanged',g,this);f();}};if(!o.getGeometry()||!o.getGeometry().visible){o.attachEvent('geometryChanged',g,this);}else{f();}};var _=function(o){var p=o.getParameters();var r;var d=o.getSource();if(p.type==="propertyChanged"&&p.name==="visible"){r=this._getRelevantOverlays(d);if(p.value===true){e(d,function(){this.evaluateEditable(r,{onRegistration:false});}.bind(this));}else{this.evaluateEditable(r,{onRegistration:false});}}else if(p.type==="afterRendering"){if(this.getDesignTime().getStatus()==='synced'){this.evaluateEditable([d],{onRegistration:false});}else{this.getDesignTime().attachEventOnce("synced",function(){this.evaluateEditable([d],{onRegistration:false});},this);}}else if(p.type==="insertAggregation"||p.type==="removeAggregation"){r=this._getRelevantOverlays(d,p.name);this.evaluateEditable(r,{onRegistration:false});}};B.prototype._getRelevantOverlays=function(o,A){var d=o.getRelevantOverlays();if(d.length===0){var r=a.findAllOverlaysInContainer(o);if(A){var f=o.getAggregationOverlay(A).getChildren();f=f.filter(function(g){return r.indexOf(g)===-1;});r=r.concat(f);}o.setRelevantOverlays(r);return r;}return d;};function b(d){return d.some(function(s){var S=O.getOverlay(s);return S&&a.isInAggregationBinding(S,s.sParentAggregationName);});}B.prototype.evaluateEditable=function(o,p){var d=this.getDesignTime()?this.getDesignTime().getPlugins():[];var s=d.some(function(f){return f.isBusy();});if(s){return;}var v;o.forEach(function(f){var i=false;var S=f.getDesignTimeMetadata().getStableElements(f);if(S[0]instanceof M){i=b(S);}if(i){v=false;}else{v=f.getElement()&&f.getDesignTimeMetadata()&&!f.getDesignTimeMetadata().markedAsNotAdaptable()&&this._isEditable(f,p);}if(v!==undefined&&v!==null){if(typeof v==="boolean"){this._modifyPluginList(f,v);}else{this._modifyPluginList(f,v.asChild,false);this._modifyPluginList(f,v.asSibling,true);}}}.bind(this));};B.prototype._modifyPluginList=function(o,i,d){if(i){this.addToPluginsList(o,d);}else{this.removeFromPluginsList(o,d);}};B.prototype._retrievePluginName=function(s){var n=this.getMetadata().getName();if(s!==undefined){n+=s?".asSibling":".asChild";}return n;};B.prototype._isEditableByPlugin=function(o,s){var p=this._retrievePluginName(s);var d=o.getEditableByPlugins();return d.indexOf(p)>-1;};B.prototype.registerElementOverlay=function(o){e(o,function(){this.evaluateEditable([o],{onRegistration:true});o.attachElementModified(_,this);}.bind(this));};B.prototype.deregisterElementOverlay=function(o){this.removeFromPluginsList(o);this.removeFromPluginsList(o,true);this.removeFromPluginsList(o,false);o.detachElementModified(_,this);};B.prototype.hasStableId=function(o){if(!o){return false;}if(!o.getDesignTimeMetadata()){return false;}if(o.getElementHasStableId()===undefined){var s=o.getDesignTimeMetadata().getStableElements(o);var u=s.length>0?s.some(function(S){var d=S.id||S;if(!F.checkControlId(d,S.appComponent)){return c(o,S);}}):true;o.setElementHasStableId(!u);}return o.hasElementStableId();};function c(o,s){var A=a.getAggregationInformation(o,o.getElement().sParentAggregationName);if(!A.templateId){return true;}else{return!F.checkControlId(A.templateId,s.appComponent);}}B.prototype.getVariantManagementReference=function(o,A,f,s){var d;if(!s){d=o.getElement();}else{d=s;}var r;if((A.changeOnRelevantContainer||f)&&!s){r=o.getRelevantContainer();}else{r=d;}var v;if(o.getVariantManagement&&this._hasVariantChangeHandler(A.changeType,r)){v=o.getVariantManagement();}return v;};B.prototype._hasVariantChangeHandler=function(s,o){var d=this._getChangeHandler(s,o);return(d&&d.revertChange);};B.prototype.checkAggregationsOnSelf=function(o,A,p){var d=o.getDesignTimeMetadata();var f=o.getElement();var i=false;var g=d.getActionDataFromAggregations(A,o.getElement());var h=g.filter(function(k){if(k&&p){return k.aggregation===p;}else{return true;}})[0];var s=h?h.changeType:null;var j=h&&h.changeOnRelevantContainer;if(j){f=o.getRelevantContainer();var r=O.getOverlay(f);if(!this.hasStableId(r)){return false;}}if(s&&this.hasChangeHandler(s,f)){i=true;}return i;};B.prototype.removeFromPluginsList=function(o,s){var n=this._retrievePluginName(s);o.removeEditableByPlugin(n);if(!o.getEditableByPlugins().length){o.setEditable(false);}};B.prototype.addToPluginsList=function(o,s){var n=this._retrievePluginName(s);var p=o.getEditableByPlugins();if(p.indexOf(n)===-1){o.addEditableByPlugin(n);o.setEditable(true);}};B.prototype.hasChangeHandler=function(s,o){return!!this._getChangeHandler(s,o);};B.prototype._getChangeHandler=function(s,o,d){if(!d){d=o.getMetadata().getName();}var l=this.getCommandFactory().getFlexSettings().layer;return C.getInstance().getChangeHandler(s,d,o,J,l);};B.prototype.isAvailable=function(d){return d.every(function(o){return this._isEditableByPlugin(o);},this);};B.prototype._checkRelevantContainerStableID=function(A,o){if(A.changeOnRelevantContainer){var r=o.getRelevantContainer();var R=O.getOverlay(r);if(!this.hasStableId(R)){return false;}}return true;};return B;},true);
