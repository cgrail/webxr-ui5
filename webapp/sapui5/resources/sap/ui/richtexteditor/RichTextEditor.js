/*!
 * SAPUI5

(c) Copyright 2009-2019 SAP SE. All rights reserved
 */
sap.ui.define(["sap/ui/thirdparty/jquery",'sap/ui/core/Control','sap/ui/core/ResizeHandler','./library','./ToolbarWrapper',"sap/ui/core/RenderManager","sap/ui/dom/includeScript","sap/base/Log","sap/base/security/sanitizeHTML","sap/ui/events/KeyCodes","sap/base/security/encodeXML","sap/ui/dom/jquery/Selectors","sap/ui/dom/jquery/control"],function(q,C,R,l,T,a,b,L,s,K,e){"use strict";var E={Initial:"Initial",Loading:"Loading",Initializing:"Initializing",Loaded:"Loaded",Ready:"Ready",Destroyed:"Destroyed"};
/**
	 * Constructor for a new RichTextEditor.
	 *
	 *
	 * @param {string} [sId] ID for the new control, generated automatically if no ID is given
	 * @param {object} [mSettings] Initial settings for the new control
	 *
	 * @class
	 *
	 * The RichTextEditor-Control is used to enter formatted text. It uses the third-party component called TinyMCE.
	 * In addition to the native toolbar, you can also use a toolbar built with SAPUI5 controls.
	 * <h3>Overview</h3>
	 *
	 * With version 1.48 onward, aside from the native toolbar of the TinyMCE, the RichTextEditor can also use a
	 * toolbar built with SAPUI5 controls. Which toolbar is used is taken into consideration only while the
	 * control is being initialized and it will not be possible to change it during runtime, because of
	 * lifecycle incompatibilities between the SAPUI5 and the third-party library.
	 * The custom toolbar acts like a wrapper to the native toolbar and takes care of
	 * synchronizing the state of its internal controls with the current state of the selection in the editor
	 * (bold, italics, font styles etc.).
	 *
	 * <h4>Limitations</h4>
	 *
	 * <ul>
	 *
	 * <li>As of version 1.60, the default editor type is TinyMCE4. Keep in mind that TinyMCE3 is no longer supported and cannot be used.</li>
	 *
	 * <li>The third-party component TinyMCE does not fully support the High Contrast themes. The control,
	 * which internally uses TinyMCE, is thus also not compliant to this product standard.
	 * Applications, which embed the RichTextEditor control and use the high-contrast theme,
	 * will not have a full High Contrast support. Certain buttons, menus etc. are available in the correct theme,
	 * but many elements are still showing up with a normal, non-contrast style.</li>
	 *
	 * <li>The <code>RichTextEditor</code> uses a third-party component, which might in some cases not be
	 * completely compatible with the way UI5's (re-)rendering mechanism works. <strong>If you keep hidden
	 * instances of the control (instances which are not visible in the DOM), you might run into
	 * problems with some browser versions.</strong> In this case, please make sure you destroy the
	 * <code>RichTextEditor</code> instance instead of hiding it and create a new one when you show it again.</li>
	 *
	 * <li>Known cases that might cause CSP relevant issues:
	 * <ul>
	 * <li>If you are using one of the following plugins: <code>compat3x, linkchecker, preview.</code></li>
	 * <li>If you are using the <code>tinymce.ui.Iframe</code> widget.</li>
	 * <li>If you are using the Internet Explorer 11, or below versions, and modify the <code>document.domain</code>.</li>
	 * </ul>
	 * </li>
	 *
	 * <li>If you want to use the custom toolbar, you need to instantiate the RichTextEditor in the application’s controller.
	 * This way the the controller can check and wait for the sap.m library to be loaded and then init the controls.
	 * <code>RichTextEditor</code> can be embedded in an XML view, but as the XML view adds an additional layer, this may lead to problems while loading the custom toolbar.
	 * The sap.m library cannot be required from TinyMCE. This means that sap.m may not be available in time for the rendering of the custom toolbar.
	 *
	 * See {@link topic:363cd16eba1f45babe3f661f321a7820 Library Combinations}
	 *
	 * Using the native toolbar in an XML view is still possible. </li>
	 * </ul>
	 *
	 * <h3>Guidelines</h3>
	 *
	 * <ul>
	 * <li> The RichTextEditor should be used for desktop apps only.</li>
	 * <li> In order to be usable, the control needs a minimum width 17.5 rem and height of 12.5 rem.</li>
	 * <li> Do not instantiate the RichTextEditor from a hidden container.</li>
	 * <li> Make sure you destroy the RichTextEditor instance instead of hiding it and create a new one when you show it again.</li>
	 * </ul>
	 *
	 * <h3>Usage</h3>
	 *
	 * <h4>When to use</h4>
	 * <ul>
	 * <li>You want to enable users to enter text and other elements (tables, images) with different styles and colors.</li>
	 * <li>You need to provide a tool for texts that require additional formatting.</li>
	 * </ul>
	 *
	 * <h4> When not to use</h4>
	 * <ul>
	 * <li>You want to let users add simple text that doesn’t require formatting. Use {@link sap.m.TextArea text area} instead.</li>
	 * <li>Use callbacks to the native third-party API with care, as there may be compatibility issues with later versions.</li>
	 * </ul>
	 *
	 * @extends sap.ui.core.Control
	 *
	 * @author SAP SE
	 *
	 * @constructor
	 * @public
	 * @disclaimer Since version 1.6.0.
	 * The RichTextEditor of SAPUI5 contains a third party component TinyMCE provided by Moxiecode Systems AB. The SAP license agreement covers the development of applications with RichTextEditor of SAPUI5 (as of May 2014).
	 * @alias sap.ui.richtexteditor.RichTextEditor
	 * @see {@link fiori:https://experience.sap.com/fiori-design-web/rich-text-editor/ Rich Text Editor}
	 * @see {@link topic:d4f3f1598373452bb73f2120930c133c}
	 * @ui5-metamodel This control/element also will be described in the UI5 (legacy) designtime metamodel
	 */
var c=C.extend("sap.ui.richtexteditor.RichTextEditor",{metadata:{library:"sap.ui.richtexteditor",properties:{value:{type:"string",group:"Data",defaultValue:''},textDirection:{type:"sap.ui.core.TextDirection",group:"Appearance",defaultValue:sap.ui.core.TextDirection.Inherit},width:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:null},height:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:null},editorType:{type:"string",group:"Misc",defaultValue:'TinyMCE4'},editorLocation:{type:"string",group:"Misc",defaultValue:'js/tiny_mce4/tinymce.js',deprecated:true},editable:{type:"boolean",group:"Misc",defaultValue:true},showGroupFontStyle:{type:"boolean",group:"Misc",defaultValue:true},showGroupTextAlign:{type:"boolean",group:"Misc",defaultValue:true},showGroupStructure:{type:"boolean",group:"Misc",defaultValue:true},showGroupFont:{type:"boolean",group:"Misc",defaultValue:false},showGroupClipboard:{type:"boolean",group:"Misc",defaultValue:true},showGroupInsert:{type:"boolean",group:"Misc",defaultValue:false},showGroupLink:{type:"boolean",group:"Misc",defaultValue:false},showGroupUndo:{type:"boolean",group:"Misc",defaultValue:false},wrapping:{type:"boolean",group:"Appearance",defaultValue:true},required:{type:"boolean",group:"Misc",defaultValue:false},sanitizeValue:{type:"boolean",group:"Misc",defaultValue:true},plugins:{type:"object[]",group:"Behavior",defaultValue:[]},useLegacyTheme:{type:"boolean",group:"Appearance",defaultValue:true},buttonGroups:{type:"object[]",group:"Behavior",defaultValue:[]},customToolbar:{type:"boolean",group:"Misc",defaultValue:false}},events:{change:{parameters:{newValue:{type:"string"}}},ready:{},readyRecurring:{},beforeEditorInit:{}},aggregations:{_toolbarWrapper:{type:"sap.ui.richtexteditor.IToolbar",multiple:false,visibility:"hidden",defaultValue:null},customButtons:{type:"sap.ui.core.Control",multiple:true,singularName:"customButton",defaultValue:null}}}});c._lastId=0;c._iCountInstances=0;c.BUTTON_GROUPS=l.ButtonGroups;c.EDITORTYPE_TINYMCE4=l.EditorType.TinyMCE4;c.EDITORLOCATION_TINYMCE4="js/tiny_mce4/tinymce.min.js";if(sap.ui.getCore().getConfiguration().getDebug()){c.EDITORLOCATION_TINYMCE4="js/tiny_mce4/tinymce.js";}c.MAPPED_LANGUAGES_TINYMCE4={"sh":"sr","ji":"yi","in":"id","iw":"he","no":"nb"};c.SUPPORTED_LANGUAGES_TINYMCE4={"en":true,"ar":true,"ar_SA":true,"hy":true,"az":true,"eu":true,"be":true,"bn_BD":true,"bs":true,"bg_BG":true,"ca":true,"zh_CN":true,"zh_TW":true,"hr":true,"cs":true,"da":true,"dv":true,"nl":true,"en_CA":true,"en_GB":true,"et":true,"fo":true,"fi":true,"fr_FR":true,"gd":true,"gl":true,"ka_GE":true,"de":true,"de_AT":true,"el":true,"he_IL":true,"hi_IN":true,"hu_HU":true,"is_IS":true,"id":true,"it":true,"ja":true,"kk":true,"km_KH":true,"ko_KR":true,"ku":true,"ku_IQ":true,"lv":true,"lt":true,"lb":true,"ml":true,"ml_IN":true,"mn_MN":true,"nb_NO":true,"fa":true,"fa_IR":true,"pl":true,"pt_BR":true,"pt_PT":true,"ro":true,"ru":true,"ru@petr1708":true,"sr":true,"si_LK":true,"sk":true,"sl_SI":true,"es":true,"es_MX":true,"sv_SE":true,"tg":true,"ta":true,"ta_IN":true,"tt":true,"th_TH":true,"tr_TR":true,"ug":true,"uk":true,"uk_UA":true,"vi":true,"vi_VN":true,"cy":true};c.SUPPORTED_LANGUAGES_DEFAULT_REGIONS={"zh":"CN","fr":"FR","bn":"BD","bg":"BG","ka":"GE","he":"IL","hi":"IN","hu":"HU","is":"IS","km":"KH","ko":"KR","ku":"IQ","ml":"IN","mn":"MN","nb":"NO","pt":"PT","si":"SI","sl":"SI","sv":"SE","th":"TH","tr":"TR","vi":"VN"};c.pLoadTinyMCE=null;c.loadTinyMCE=function(d){if(d){var r=sap.ui.resource('sap.ui.richtexteditor',d),S=document.querySelector("#sapui5-tinyMCE"),f=S?S.getAttribute("src"):"";if(r!==f&&c._iCountInstances===1){delete window.tinymce;delete window.TinyMCE;c.pLoadTinyMCE=null;}if(!c.pLoadTinyMCE){c.pLoadTinyMCE=new Promise(function(g,h){b(r,"sapui5-tinyMCE",g,h);});}}return c.pLoadTinyMCE;};c.prototype.init=function(){this._bEditorCreated=false;this._sTimerId=null;c._iCountInstances++;this.setButtonGroups([{name:"font-style",visible:true,row:0,priority:10,customToolbarPriority:20,buttons:["bold","italic","underline","strikethrough"]},{name:"text-align",visible:true,row:0,priority:20,customToolbarPriority:30,buttons:["justifyleft","justifycenter","justifyright","justifyfull"]},{name:"font",visible:false,row:0,priority:30,customToolbarPriority:50,buttons:["fontselect","fontsizeselect","forecolor","backcolor"]},{name:"clipboard",visible:true,row:1,priority:10,customToolbarPriority:110,buttons:["cut","copy","paste"]},{name:"structure",visible:true,row:1,priority:20,customToolbarPriority:60,buttons:["bullist","numlist","outdent","indent"]},{name:"e-mail",visible:false,row:1,priority:30,customToolbarPriority:10,buttons:[]},{name:"undo",visible:false,row:1,priority:40,customToolbarPriority:100,buttons:["undo","redo"]},{name:"insert",visible:false,row:1,priority:50,customToolbarPriority:80,buttons:["image","emoticons"]},{name:"link",visible:false,row:1,priority:60,customToolbarPriority:70,buttons:["link","unlink"]}]);this.setPlugins([{name:"lists"},{name:"emoticons"},{name:"directionality"},{name:"tabfocus"},{name:"table"}]);this._textAreaId=this.getId()+"-textarea";this._iframeId=this._textAreaId+"_ifr";this._textAreaDom=document.createElement("textarea");this._textAreaDom.id=this._textAreaId;this._textAreaDom.style.height="100%";this._textAreaDom.style.width="100%";this.initTinyMCE4();};c.prototype.onBeforeRendering=function(){this._customToolbarEnablement();var o=this.getAggregation("_toolbarWrapper");if(o){o.setToolbarEnabled(this.getEditable(),true);}if(!this._bCustomToolbarRequirementsFullfiled&&this.getCustomToolbar()){L.warning("Cannot set custom toolbar - not all requirements are fulfilled.");}this.onBeforeRenderingTinyMCE4();};c.prototype.onAfterRendering=function(){this.onAfterRenderingTinyMCE4();};c.prototype.reinitialize=function(){clearTimeout(this._iReinitTimeout);this._iReinitTimeout=window.setTimeout(this.reinitializeTinyMCE4.bind(this),0);};c.prototype.getNativeApi=function(){return this.getNativeApiTinyMCE4();};c.prototype.exit=function(){clearTimeout(this._reinitDelay);this.exitTinyMCE4();c._iCountInstances--;};c.prototype.setValue=function(v){v=(v===null||v===undefined)?"":v;if(this.getSanitizeValue()){L.trace("sanitizing HTML content for "+this);v=s(v);}if(v===this.getValue()){return this;}this.setProperty("value",v,true);v=this.getProperty("value");var m="setValue"+this.getEditorType();if(this[m]&&typeof this[m]==="function"){this[m].call(this,v);}else{this.reinitialize();}return this;};c.prototype.setEditable=function(d){var o=this.getAggregation("_toolbarWrapper");this.setProperty("editable",d,true);if(o){o.setToolbarEnabled(d,true);}this.reinitialize();return this;};c.prototype.setWrapping=function(w){this.setProperty("wrapping",w,true);this.reinitialize();return this;};c.prototype.setRequired=function(r){this.setProperty("required",r,true);this.reinitialize();return this;};c.prototype._setShowGroup=function(S,m){var o=this.getAggregation("_toolbarWrapper");this.setProperty(m.property,S,true);this.setButtonGroupVisibility(m.buttonGroup,S);if(!o){this.reinitialize();return this;}o.setShowGroup(m.buttonGroup,S);return this;};c.prototype.setShowGroupFontStyle=function(S){return this._setShowGroup(S,{property:'showGroupFontStyle',buttonGroup:'font-style'});};c.prototype.setShowGroupTextAlign=function(S){return this._setShowGroup(S,{property:'showGroupTextAlign',buttonGroup:'text-align'});};c.prototype.setShowGroupStructure=function(S){return this._setShowGroup(S,{property:'showGroupStructure',buttonGroup:'structure'});};c.prototype.setShowGroupFont=function(S){return this._setShowGroup(S,{property:'showGroupFont',buttonGroup:'font'});};c.prototype.setShowGroupClipboard=function(S){return this._setShowGroup(S,{property:'showGroupClipboard',buttonGroup:'clipboard'});};c.prototype.setShowGroupInsert=function(S){return this._setShowGroup(S,{property:'showGroupInsert',buttonGroup:'insert'});};c.prototype.setShowGroupLink=function(S){return this._setShowGroup(S,{property:'showGroupLink',buttonGroup:'link'});};c.prototype.setShowGroupUndo=function(S){return this._setShowGroup(S,{property:'showGroupUndo',buttonGroup:'undo'});};c.prototype.setCustomToolbar=function(d){if(!this._tinyMCE4Status||this._tinyMCE4Status===E.Initial){this.setProperty("customToolbar",d);}else{L.error("Cannot set customToolbar property to "+d+" after initialization.",this);}return this;};c.prototype.addPlugin=function(p){if(typeof p==="string"){p={name:p};}var P=this.getProperty("plugins");P.push(p);this.setProperty("plugins",P);this.reinitialize();return this;};c.prototype.removePlugin=function(p){var P=this.getProperty("plugins").slice(0);for(var i=0;i<P.length;++i){if(P[i].name===p){P.splice(i,1);--i;}}this.setProperty("plugins",P);this.reinitialize();return this;};c.prototype.setUseLegacyTheme=function(u){var d=this.getDomRef();if(d){q(d).toggleClass("sapUiRTELegacyTheme",u);}return this.setProperty("useLegacyTheme",u,true);};c.prototype.addButtonGroup=function(g){var G=this.getProperty("buttonGroups").slice(),o=this.getAggregation("_toolbarWrapper"),f=true;for(var i=0;i<G.length;++i){if(g==="string"&&G[i].name===g||G[i].name===g.name){return this;}}if(typeof g==="string"){f=false;switch(g){case"formatselect":f=true;g={name:"formatselect",buttons:["formatselect"]};break;case"styleselect":f=true;g={name:"styleselect",buttons:["styleselect"],customToolbarPriority:40};break;case"table":f=true;g={name:"table",buttons:["table"],customToolbarPriority:90};break;default:g={name:this._createId("buttonGroup"),buttons:[g]};}}if(g.visible===undefined){g.visible=true;}if(g.priority===undefined){g.priority=10;}if(g.row===undefined){g.row=0;}var B=this.getButtonGroups();B.push(g);this.setProperty("buttonGroups",B);if(o){o.addButtonGroupToContent(g,f);}return this;};c.prototype.removeButtonGroup=function(g){var G=this.getProperty("buttonGroups").slice(0),o=this.getAggregation("_toolbarWrapper");for(var i=0;i<G.length;++i){if(G[i].name===g){G.splice(i,1);--i;o&&o.removeButtonGroup(g);}}this.setProperty("buttonGroups",G);this.reinitialize();return this;};c.prototype.setButtonGroups=function(g){var o;if(!Array.isArray(g)){L.error("Button groups cannot be set: "+g+" is not an array.");return this;}this.setProperty("buttonGroups",g);o=this.getAggregation("_toolbarWrapper");if(o){o.setButtonGroups(g);}this.reinitialize();return this;};c.prototype.setButtonGroupVisibility=function(g,v){var B=this.getButtonGroups();for(var i=0,d=B.length;i<d;++i){if(B[i].name===g){B[i].visible=v;}}return this;};c.prototype._createId=function(p){if(p===undefined){p="_rte";}return p+(c._lastId++);};c.prototype.setEditorType=function(d){if(!this._bEditorCreated){this.setProperty("editorType",d);this.setEditorLocation(c.EDITORLOCATION_TINYMCE4);this.addPlugin("emoticons");this.addPlugin("lists");this.removeButtonGroup("text-align");this.addPlugin("image");this.addPlugin("link");this.addPlugin("textcolor");this.addPlugin("colorpicker");this.addPlugin("textpattern");this.addPlugin("powerpaste");this.addButtonGroup({name:"text-align",visible:true,row:0,priority:20,customToolbarPriority:30,buttons:["alignleft","aligncenter","alignright","alignjustify"]});this.addButtonGroup({name:"insert",visible:false,row:1,priority:50,customToolbarPriority:80,buttons:["image","emoticons"]});if(d===l.EditorType.TinyMCE4&&this.isPropertyInitial("editorType")){L.warning("editorType property is automatically set to TinyMCE 4, because of the removal of TinyMCE 3");}if(d!==l.EditorType.TinyMCE4){L.error('TinyMCE3 is removed now due to security concerns, please do NOT use it anymore. The framework automatically will load TinyMCE4 since v1.60');}this.initTinyMCE4();}else{L.error("editorType property cannot be set after the RichtextEditor has been rendered");}return this;};c.prototype.setEditorLocation=function(d){if(!this._bEditorCreated){this.setProperty("editorLocation",d);}else{L.error("editorLocation property cannot be set after the RichtextEditor has been rendered");}return this;};c.prototype._createButtonRowsTinyMCE=function(B,g){B=B===undefined?",":B;g=g===undefined?"|":g;var d=this.getButtonGroups(),G=B+g+B,i,f,m,o={},h=[];for(i=0,f=d.length;i<f;++i){m=d[i];if(!o[m.priority]){o[m.priority]=[];}if(m.priority===undefined){m.priority=Number.MAX_VALUE;}o[m.priority].push(m);}for(var k in o){for(i=0,f=o[k].length;i<f;++i){m=o[k][i];var r=m.row||0;if(!m.visible||!m.buttons||m.buttons.length===0){continue;}if(!h[r]){h[r]="";}h[r]+=m.buttons.join(B)+G;}}for(i=0;i<h.length;++i){if(h[i]===null){continue;}else if(!h[i]){h.splice(i,1);h.push(null);continue;}if(h[i].substr(-3)===G){h[i]=h[i].substr(0,h[i].length-G.length);}if(h[i].substr(-1)===B){h[i]=h[i].substr(0,h[i].length-B.length);}if(h[i].length===0){h.splice(i,1);h.push(null);}}return h;};c.prototype._createPluginsListTinyMCE=function(){var p=this.getPlugins(),P=[];for(var i=0,d=p.length;i<d;++i){P.push(p[i].name);}return P.join(",");};c.prototype.tinyMCEReady=function(){var i=(this._iframeId?window.document.getElementById(this._iframeId):null);return!!i;};c.prototype.setValueTinyMCE=function(v){if(this._bEditorCreated){q(document.getElementById(this._textAreaId)).text(v);this.setContentTinyMCE();}else{this.setProperty("value",v,true);if(this.getDomRef()){q(document.getElementById(this._textAreaId)).val(v);}}};c.prototype.onTinyMCEChange=function(o){var d=this.getValue(),n=o.getContent();if((d!==n)&&!this.bExiting){this.setProperty("value",n,true);this.fireChange({oldValue:d,newValue:n});}};c.prototype._tinyMCEKeyboardHandler=function(o){var n,k=o['keyCode'];switch(k){case K.TAB:if(!this.$focusables.index(q(o.target))===0){var i=this.$focusables.size()-1;this.$focusables.get(i).focus();}break;case K.ARROW_LEFT:case K.ARROW_UP:n=this.$focusables.index(q(o.target))-1;if(n===0){n=this.$focusables.size()-2;}this.$focusables.get(n).focus();break;case K.ARROW_RIGHT:case K.ARROW_DOWN:n=this.$focusables.index(q(o.target))+1;if(n===this.$focusables.size()-1){n=1;}this.$focusables.get(n).focus();break;default:break;}};c.prototype._getLanguageTinyMCE=function(){var o=new sap.ui.core.Locale(sap.ui.getCore().getConfiguration().getLanguage()),d=o.getLanguage(),r=o.getRegion(),m={"zh":"zh-"+(r?r.toLowerCase():"cn"),"sh":"sr","hi":"en"};d=m[d]?m[d]:d;return d;};c.prototype.initTinyMCE4=function(){this._oEditor=null;this._tinyMCE4Status=E.Initial;this._boundResizeEditorTinyMCE4=this._resizeEditorTinyMCE4.bind(this);this._bInitializationPending=false;this._lastRestHeight=0;a.attachPreserveContent(this._tinyMCE4PreserveHandler,this);sap.ui.getCore().getEventBus().subscribe("sap.ui","__beforePopupClose",this._tinyMCE4PreserveHandler,this);};c.prototype.exitTinyMCE4=function(){this._bUnloading=true;a.detachPreserveContent(this._tinyMCE4PreserveHandler);sap.ui.getCore().getEventBus().unsubscribe("sap.ui","__beforePopupClose",this._tinyMCE4PreserveHandler);R.deregister(this._resizeHandlerId);this._resizeHandlerId=null;this._removeEditorTinyMCE4();};c.prototype._removeEditorTinyMCE4=function(){switch(this._tinyMCE4Status){case E.Initial:case E.Loading:case E.Loaded:break;case E.Initializing:this._pTinyMCE4Initialized.then(this._removeEditorTinyMCE4.bind(this,this._oEditor));break;case E.Ready:this._oEditor.remove();this._tinyMCE4Status=E.Destroyed;this._boundResizeEditorTinyMCE4=null;this._oEditor=null;break;case E.Destroyed:break;default:L.error("Unknown TinyMCE4 status: "+this._tinyMCE4Status);break;}};c.prototype.onBeforeRenderingTinyMCE4=function(){if(!window.tinymce||window.tinymce.majorVersion!="4"){this._tinyMCE4Status=E.Loading;this._pTinyMCE4Loaded=c.loadTinyMCE(this.getEditorLocation()).then(function(){this._tinyMCE4Status=E.Loaded;}.bind(this));}else{this._pTinyMCE4Loaded=Promise.resolve();this._tinyMCE4Status=E.Loaded;}};c.prototype.onAfterRenderingTinyMCE4=function(){var d=this.getDomRef();if(d&&d.parentNode&&d.parentNode.getAttribute("data-sap-ui-preserve")){d.removeAttribute("data-sap-ui-preserve");}if(!window.tinymce){this._pTinyMCE4Loaded.then(this.onAfterRenderingTinyMCE4.bind(this));}else if(window.tinymce.majorVersion!="4"){this._pTinyMCE4Loaded.then(this.onAfterRenderingTinyMCE4.bind(this));}else if(!d){}else{var p=sap.ui.core.RenderManager.findPreservedContent(this.getId());switch(this._tinyMCE4Status){case E.Initializing:if(p.size()>0){this.$().replaceWith(p);}else{d.appendChild(this._textAreaDom);}break;case E.Loaded:case E.Loading:p.remove();this.getDomRef().appendChild(this._textAreaDom);this.reinitializeTinyMCE4();break;case E.Ready:if(p.size()>0){this.$().replaceWith(p);}else{d.appendChild(this._textAreaDom);}this.reinitializeTinyMCE4();break;default:L.error("Unknown TinyMCE4 status: "+this._tinyMCE4Status);break;}}};c.prototype.reinitializeTinyMCE4=function(){if(this._bInitializationPending||this._bUnloading){return;}var r=function(){if(this._oEditor){this._oEditor.remove();}this._initializeTinyMCE4();}.bind(this);switch(this._tinyMCE4Status){case E.Initial:break;case E.Loading:this._bInitializationPending=true;this._pTinyMCE4Loaded.then(r);break;case E.Initializing:this._bInitializationPending=true;this._pTinyMCE4Initialized.then(r);break;case E.Loaded:case E.Ready:this._bInitializationPending=true;setTimeout(function(){r();},0);break;default:L.error("Unknown TinyMCE4 status: "+this._tinyMCE4Status);break;}};c.prototype.getNativeApiTinyMCE4=function(){return this._oEditor;};c.prototype.setValueTinyMCE4=function(v){switch(this._tinyMCE4Status){case E.Initial:case E.Initializing:case E.Loading:break;case E.Ready:this._oEditor.setContent(v);this._oEditor.undoManager.clear();this._oEditor.undoManager.add();if(!this.getEditable()){q.each(this._oEditor.getDoc().getElementsByTagName("a"),function(i,A){A.target="_blank";});}break;default:L.error("Unknown TinyMCE4 status: "+this._tinyMCE4Status);break;}};c.prototype._initializeTinyMCE4=function(){this._pTinyMCE4Initialized=new Promise(function(r,f){this._bInitializationPending=false;this._tinyMCE4Status=E.Initializing;this._textAreaDom.value=this._patchTinyMCE4Value(this.getValue());window.tinymce.init(this._createConfigTinyMCE4(function(){this._tinyMCE4Status=E.Ready;setTimeout(function(){if(!this._bInitializationPending){this._onAfterReadyTinyMCE4();}r();}.bind(this),0);}.bind(this)));}.bind(this));};c.prototype._patchTinyMCE4Value=function(v){if(v.indexOf("<!--")===0){v="&#8203;"+v;}return v;};c.prototype._onAfterReadyTinyMCE4=function(){if(this._bUnloading){return;}this._oEditor.on("change",function(g){this.onTinyMCEChange(this._oEditor);}.bind(this));var $=q(this._oEditor.getContainer());$.bind('keydown',q.proxy(this,this._tinyMCEKeyboardHandler));var d=q(document.getElementById(this._iframeId)),B=q(this._oEditor.getBody()),t=false;B.bind('focus',function(){if(!t){t=true;if(sap.ui.Device.browser.internet_explorer||sap.ui.Device.browser.edge){d.trigger('activate');}else{d.trigger('focus');}B.focus();t=false;}});if(this.getTooltip()&&this.getTooltip().length>0){var f=this.getTooltip_Text();this._oEditor.getBody().setAttribute("title",f);d.attr("title",f);}this._registerWithPopupTinyMCE4();if(!this._resizeHandlerId){this._resizeHandlerId=R.register(this,this._boundResizeEditorTinyMCE4);}var r=this._resizeEditorTinyMCE4.bind(this);var o=this._oEditor.getDoc();if(o.readyState=="complete"){r();}else{o.addEventListener("readystatechange",function(){if(o.readyState=="complete"){r();}});}this.fireReadyTinyMCE4();};c.prototype.fireReadyTinyMCE4=function(){switch(this._tinyMCE4Status){case E.Initial:case E.Loading:case E.Loaded:case E.Initializing:break;case E.Ready:if(!this._bInitializationPending){if(!this._readyFired){this._readyFired=true;this.fireReady.apply(this,arguments);}this.fireReadyRecurring.apply(this,arguments);}break;default:L.error("Unknown TinyMCE4 status: "+this._tinyMCE4Status);break;}};c.prototype._getTextDirection=function(){if(this.getTextDirection()===this.getMetadata().getProperty("textDirection").getDefaultValue()){return sap.ui.getCore().getConfiguration().getRTL()?"rtl":"ltr";}else{return this.getTextDirection().toLowerCase();}};c.prototype._createConfigTinyMCE4=function(o){var d=this.getAggregation("_toolbarWrapper");var B=this._createButtonRowsTinyMCE(" ","|");if(B.length===0){B=false;}var p=this._createPluginsListTinyMCE();if(!this.getEditable()){p=p.replace(/(,powerpaste|powerpaste,)/gi,"");}var f={directionality:this._getTextDirection(),selector:"#"+this._textAreaId,theme:"modern",menubar:false,language:this._getLanguageTinyMCE4(),browser_spellcheck:true,convert_urls:false,plugins:p,toolbar_items_size:'small',toolbar:B,statusbar:false,image_advtab:true,readonly:(this.getEditable()?0:1),nowrap:!this.getWrapping(),init_instance_callback:function(g){this._oEditor=g;o();}.bind(this)};if(this._bCustomToolbarRequirementsFullfiled&&d){f=d.modifyRTEToolbarConfig(f);}this.fireBeforeEditorInit({configuration:f});return f;};c.prototype._getLanguageTinyMCE4=function(){var o=new sap.ui.core.Locale(sap.ui.getCore().getConfiguration().getLanguage()),d=o.getLanguage(),r=o.getRegion(),f;d=c.MAPPED_LANGUAGES_TINYMCE4[d]||d;if(!r){r=c.SUPPORTED_LANGUAGES_DEFAULT_REGIONS[d];}f=r?d+"_"+r.toUpperCase():d;if(!c.SUPPORTED_LANGUAGES_TINYMCE4[f]){f=d;}if(!c.SUPPORTED_LANGUAGES_TINYMCE4[f]){f="en";}return f;};c.prototype._resizeEditorTinyMCE4=function(){if(this._tinyMCE4Status!==E.Ready){return;}var o=this._oEditor.getContentAreaContainer(),f=this.getDomRef().offsetHeight,i=this._oEditor.getContainer().offsetHeight,d=o.offsetHeight,g,r,D;g=this.getAggregation("_toolbarWrapper")?this.getAggregation("_toolbarWrapper").getAggregation("_toolbar").getDomRef().offsetHeight:"0";r=f-(i-d)-g;D=Math.abs(this._lastRestHeight-r);if(D==0||D>5){try{this._oEditor.theme.resizeTo(undefined,r-2);}catch(h){}}this._lastRestHeight=r;};c.prototype._registerWithPopupTinyMCE4=function(){var B=sap.ui.getCore().getEventBus(),p=this.$().closest("[data-sap-ui-popup]");setTimeout(function(){if(p.length===1){var P=p.attr("data-sap-ui-popup"),o={id:this._iframeId};B.publish("sap.ui","sap.ui.core.Popup.addFocusableContent-"+P,o);if(this._oEditor){this._oEditor.on('OpenWindow',function(d){var o={id:d.win._id};B.publish("sap.ui","sap.ui.core.Popup.addFocusableContent-"+P,o);});this._oEditor.on('CloseWindow',function(d){var o={id:d.win._id};B.publish("sap.ui","sap.ui.core.Popup.removeFocusableContent-"+P,o);});}}}.bind(this),0);};c.prototype._tinyMCE4PreserveHandler=function(d){if((this.getDomRef()&&window.tinymce&&q(d.domNode).find(q(document.getElementById(this._textAreaId))).length>0)||(q(document.getElementById(this._textAreaId)).length===0)){if(this._oEditor){try{this._oEditor.save();var f=this._oEditor.getContent();this.setProperty("value",f,true);}catch(g){L.warning("TinyMCE was hidden before value could be read, changes might be lost.");}this._oEditor.hide();this._removeEditorTinyMCE4(this._oEditor);}}};c.prototype._checkCustomToolbarRequirements=function(){var r=this.getCustomToolbar()&&this.getEditorType()===l.EditorType.TinyMCE4&&l.RichTextEditorHelper.bSapMLoaded;this.$().toggleClass("sapUiRTEWithCustomToolbar",r);return r;};c.prototype._customToolbarEnablement=function(){var d,t=this.getAggregation("_toolbarWrapper");this._bCustomToolbarRequirementsFullfiled=this._checkCustomToolbarRequirements();if(this._bCustomToolbarRequirementsFullfiled&&!t){d=this.getAggregation("customButtons");this.removeAllAggregation("customButtons");t=new T({editor:this});this.setAggregation("_toolbarWrapper",t);if(d&&d.length){setTimeout(function(){d.forEach(function(B){t.modifyToolbarContent("add",B);});},0);}}};["add","destroy","get","indexOf","insert","removeAll","remove"].forEach(function(m){var M=m+"CustomButton"+(["destroy","get","removeAll"].indexOf(m)>-1?"s":"");c.prototype[M]=function(){var r=null,i=arguments[0],t=this.getAggregation("_toolbarWrapper");if(typeof i==="object"&&i.getMetadata().getName()!=="sap.m.Button"){L.error("Only sap.m.Button is allowed as aggregation.");return;}if(t&&t.modifyToolbarContent){r=t.modifyToolbarContent.bind(t,m).apply(t,arguments);}else{r=this[m+"Aggregation"].bind(this,"customButtons").apply(this,arguments);}return r;};});return c;},true);
