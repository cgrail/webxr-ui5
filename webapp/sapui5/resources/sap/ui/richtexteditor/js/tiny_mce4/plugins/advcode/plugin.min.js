/* Ephox advanced code plugin
 *
 * Copyright 2010-2016 Ephox Corporation.  All rights reserved.
 *
 * Version: 1.2.0-71
 */
!function(){"use strict";var t={},e=function(e,n,o){var r=o();tinymce.util.Tools.each(t[e].callbacks,function(t){t(r)}),t[e]={module:r,callbacks:null}},n=function(n,o,r){var i,c,u,a,s,l;n in t?(s=r,null===(l=t[n]).module?l.callbacks.push(s):s(l.module)):(i=n,c=o,u=r,a=document.createElement("script"),tinymce.codeMirrorLazyLoader={define:e},t[i]={module:null,callbacks:[u]},a.src=c,document.body.appendChild(a))},o=window.Promise?window.Promise:function(){function t(t,e){return function(){t.apply(e,arguments)}}var e=Array.isArray||function(t){return"[object Array]"===Object.prototype.toString.call(t)},n=function(e){if("object"!=typeof this)throw new TypeError("Promises must be constructed via new");if("function"!=typeof e)throw new TypeError("not a function");this._state=null,this._value=null,this._deferreds=[],a(e,t(i,this),t(c,this))},o=n.immediateFn||"function"==typeof setImmediate&&setImmediate||function(t){setTimeout(t,1)};function r(t){var e=this;null!==this._state?o(function(){var n=e._state?t.onFulfilled:t.onRejected;if(null!==n){var o;try{o=n(e._value)}catch(e){return void t.reject(e)}t.resolve(o)}else(e._state?t.resolve:t.reject)(e._value)}):this._deferreds.push(t)}function i(e){try{if(e===this)throw new TypeError("A promise cannot be resolved with itself.");if(e&&("object"==typeof e||"function"==typeof e)){var n=e.then;if("function"==typeof n)return void a(t(n,e),t(i,this),t(c,this))}this._state=!0,this._value=e,u.call(this)}catch(t){c.call(this,t)}}function c(t){this._state=!1,this._value=t,u.call(this)}function u(){for(var t=0,e=this._deferreds.length;t<e;t++)r.call(this,this._deferreds[t]);this._deferreds=null}function a(t,e,n){var o=!1;try{t(function(t){o||(o=!0,e(t))},function(t){o||(o=!0,n(t))})}catch(t){if(o)return;o=!0,n(t)}}return n.prototype.catch=function(t){return this.then(null,t)},n.prototype.then=function(t,e){var o=this;return new n(function(n,i){r.call(o,new function(t,e,n,o){this.onFulfilled="function"==typeof t?t:null,this.onRejected="function"==typeof e?e:null,this.resolve=n,this.reject=o}(t,e,n,i))})},n.all=function(){var t=Array.prototype.slice.call(1===arguments.length&&e(arguments[0])?arguments[0]:arguments);return new n(function(e,n){if(0===t.length)return e([]);var o=t.length;function r(i,c){try{if(c&&("object"==typeof c||"function"==typeof c)){var u=c.then;if("function"==typeof u)return void u.call(c,function(t){r(i,t)},n)}t[i]=c,0==--o&&e(t)}catch(t){n(t)}}for(var i=0;i<t.length;i++)r(i,t[i])})},n.resolve=function(t){return t&&"object"==typeof t&&t.constructor===n?t:new n(function(e){e(t)})},n.reject=function(t){return new n(function(e,n){n(t)})},n.race=function(t){return new n(function(e,n){for(var o=0,r=t.length;o<r;o++)t[o].then(e,n)})},n}(),r=function(t,e,n,r){var i,c,u=(i=t,{completeAfter:c=function(t,e){return e&&!e()||setTimeout(function(){t.state.completionActive||t.showHint({completeSingle:!1})},100),i.Pass},completeIfAfterLt:function(t){return c(t,function(){var e=t.getCursor();return"<"===t.getRange(i.Pos(e.line,e.ch-1),e)})},completeIfInTag:function(t){return c(t,function(){var e=t.getTokenAt(t.getCursor());return!!("string"!==e.type||/['"]/.test(e.string.charAt(e.string.length-1))&&1!==e.string.length)&&i.innerMode(t.getMode(),e.state).state.tagName})}});return new o(function(o){var i;i=tinymce.util.Tools.extend({lineWrapping:!0,lineNumbers:!0,foldGutter:!0,matchTags:{bothTags:!0},keyMap:"sublime",gutters:["CodeMirror-linenumbers","CodeMirror-foldgutter"],extraKeys:{"Alt-F":"findPersistent","Ctrl-J":"toMatchingTag","Ctrl-B":"selectNextOccurrence","'<'":u.completeAfter,"'/'":u.completeIfAfterLt,"' '":u.completeIfInTag,"'='":u.completeIfInTag,"Ctrl-Q":function(t){t.foldCode(t.getCursor())}}},n,{value:r,mode:"text/html"});var c=t(function(t){e.appendChild(t)},i);tinymce.DOM.bind(e,"keyup keydown keypress",function(t){27!==t.keyCode&&t.stopPropagation()}),setTimeout(function(){c&&(c.refresh(),c.focus())},100),o(c)})},i=function(t,e,i,c,u){return new o(function(o){tinymce.DOM.styleSheetLoader.load(e),n("ephox.wrap.CodeMirror",t,function(t){r(t,i,u,c).then(o)})})},c=function(t){var e;return e={lineWrapping:t.codemirror_linewrapping,lineNumbers:t.codemirror_linenumbers,foldGutter:t.codemirror_foldgutter,theme:t.codemirror_theme},!1===t.codemirror_gutter&&(e.gutters=[]),e},u=function(t,e){t.windowManager.open({title:e.title,body:e.body,buttons:[{text:"Ok",subtype:"primary",onclick:"submit",disabled:!0},{text:"Cancel",onclick:"close"}],onPostRender:function(){var t,n,o,r=this.getRoot();n=r.find("form > *")[0],o=r.getEl("body"),(t=new(0,tinymce.ui.Throbber)(o)).show(1e3),e.onPostRender(n).then(function(){t.hide(),r.statusbar.items().disabled(!1)})},onSubmit:function(t){e.onSubmit(t.data)}})},a=function(t,e){var n;u(t,{title:"Source code",body:{type:"panel",border:1,classes:"codemirror",minWidth:t.getParam("code_dialog_width",600),minHeight:t.getParam("code_dialog_height",Math.min(tinymce.DOM.getViewPort().h-200,500))},onPostRender:function(o){var r,u,a,s,l,f,d,h;return l=t.settings,f=e,a=l.codemirror_script||f+"/codemirror.min.js",d=t.settings,h=e,s=d.codemirror_css||h+"/codemirror.min.css",r=o.getEl("body"),u=t.getContent({source_view:!0}),i(a,s,r,u,c(t.settings)).then(function(t){n=t})},onSubmit:function(){t.focus(),t.undoManager.transact(function(){t.setContent(n.getValue())}),t.selection.setCursorLocation(),t.nodeChanged()}})},s=function(t){return parseInt(t,10)},l=function(t){return function(){return t}},f=function(t,e,n){return{major:l(t),minor:l(e),patch:l(n)}},d=function(t,e){var n=t-e;return 0===n?0:n>0?1:-1},h=function(t){var e=/([0-9]+)\.([0-9]+)\.([0-9]+)(?:(\-.+)?)/.exec(t);return e?f(s(e[1]),s(e[2]),s(e[3])):f(0,0,0)},m=function(t,e){var n=d(t.major(),e.major());if(0!==n)return n;var o=d(t.minor(),e.minor());if(0!==o)return o;var r=d(t.patch(),e.patch());return 0!==r?r:0},p=function(t){return t?h([(e=t).majorVersion,e.minorVersion].join(".").split(".").slice(0,3).join(".")):null;var e},g=function(t,e){return m(p(t),h(e))<0},y=function(t,e){return function(){for(var n=[],o=0;o<arguments.length;o++)n[o]=arguments[o];var r=t.console;r&&e in r&&r[e].apply(r,arguments)}},v={log:y(window,"log"),error:y(window,"error"),warn:y(window,"warm")},w=function(t,e){return function(){a(t,e)}};tinymce.PluginManager.add("advcode",function(t,e){return g(tinymce,"4.3.13")?(v.error("The advcode plugin requires at least 4.3.13 version of TinyMCE."),function(){}):(t.addCommand("mceCodeEditor",w(t,e)),t.addButton("code",{icon:"code",tooltip:"Source code",onclick:w(t,e)}),t.addMenuItem("code",{icon:"code",text:"Source code",context:"tools",onclick:w(t,e)}),{})})}();
