/*
 * ! SAPUI5

		(c) Copyright 2009-2019 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/m/Dialog","sap/m/Button","./p13n/FieldsUI2","./p13n/SortUI","sap/base/util/array/diff","sap/ui/mdc/p13n/Util"],function(D,B,F,S,d,U){"use strict";var T={_createAndOpenPanel:function(p,c,s,P,e,f){var o;var r=sap.ui.getCore().getLibraryResourceBundle("sap.ui.mdc");var a=function(){var g=[],h;P.forEach(function(j){var I=-1,i,l=e.length;for(i=0;i<l;i++){if(e[i].name===j.name){I=i;break;}}h={name:j.name,label:I>-1?e[I].label||e[I].name:j.label||j.name,sortOrder:I>-1?e[I].sortOrder:"",selected:I>-1,position:I};g.push(h);});return g;};var b,R,t;if(p==="Sort"){t=r.getText("table.SETTINGS_SORT_TITLE","Sort");b=new S({fetchFields:a});R="getSortedFields";}else{t=r.getText("table.SETTINGS_COLUMN","Column Settings");b=new F({fetchFields:a});R="getSelectedFields";}o=new D({title:t,resizable:true,draggable:true,contentWidth:"50%",contentHeight:"50%",content:b,escapeHandler:function(g){g.resolve();f([],true);},beginButton:new B({text:r.getText("table.SETTINGS_OK","OK"),press:function(){o.close();f(b[R]());}}),endButton:new B({text:r.getText("table.SETTINGS_CANCEL","Cancel"),press:function(){o.close();f([],true);}}),afterClose:function(){o.destroy();}});o.isPopupAdaptationAllowed=function(){return false;};c.addDependent(o);o.open();},showPanel:function(c,p,s,i){return new Promise(function(r,a){sap.ui.require([c.getMetadataDelegate()],function(M){if(!M||!M.fetchProperties||!M.getCurrentState){return;}var P=M.fetchProperties(c),e,R,I,f;if(p==="Sort"){T._getP13nStateOfSort(c).then(function(m){U.showP13nSort(s,m.baseData,m.runtimeData,c,function(C){U.handleUserChanges(C,c).then(function(b){r(b);});});});return;}else{e=M.getCurrentState(c).visibleFields;R="removeMDCColumn";I="addMDCColumn";f=function(o){return o.name;};}T._createAndOpenPanel(p,c,s,P,e,function(b,C){if(C){r([]);return;}var g=U._processResult(e,b,f,c,R,I);if(!i){U.handleUserChanges(g).then(function(h){r(h);});}else{r(g);}},c);});});},_getP13nStateOfSort:function(c){return new Promise(function(r){sap.ui.require([this.getMetadataDelegate()],function(M){if(!M||!M.fetchProperties||!M.createColumn){return r([]);}var p=M.fetchProperties(this);var g=function(k){var m=p.filter(function(P){return P.name===k;});return m.length?m[0].label:undefined;};r({baseData:{items:p.map(function(P){return{name:P.name,label:P.label||P.name,tooltip:P.label||P.name,sortOrder:undefined};})},runtimeData:{items:M.getCurrentState(this).sorters.map(function(s){return{name:s.name,label:g(s.name)||s.name,tooltip:g(s.name)||s.name,sortOrder:s.sortOrder?"Descending":"Ascending",selected:true};})}});}.bind(this));}.bind(c));},moveColumn:function(c,i,n){T._moveItem(c,i,n,"removeMDCColumn","addMDCColumn");},_moveItem:function(c,i,n,r,a){sap.ui.require([c.getMetadataDelegate()],function(M){if(!M||!M.getCurrentState){return;}var C=[];var v=M.getCurrentState(c).visibleFields||[];var R=v[i];R.index=i;R.preventRebind=true;C.push({selectorControl:c,changeSpecificData:{changeType:r,content:R}});var A=Object.assign({},R);A.index=n;C.push({selectorControl:c,changeSpecificData:{changeType:a,content:A}});U.handleUserChanges(C);});}};return T;},false);
