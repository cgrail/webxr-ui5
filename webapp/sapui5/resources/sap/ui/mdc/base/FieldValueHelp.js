/*
 * ! SAPUI5

		(c) Copyright 2009-2019 SAP SE. All rights reserved
	
 */
sap.ui.define(['./FieldHelpBase','./FilterOperatorConfig','./Condition','sap/ui/base/ManagedObjectObserver','sap/base/util/merge','sap/base/util/ObjectPath','sap/base/util/deepEqual'],function(F,a,C,M,m,O,d){"use strict";var D;var B;var V;var b;var c;var e;var f=F.extend("sap.ui.mdc.base.FieldValueHelp",{metadata:{library:"sap.ui.mdc",properties:{filterFields:{type:"string",defaultValue:"$search"},keyPath:{type:"string",defaultValue:""},descriptionPath:{type:"string",defaultValue:""},showConditionPanel:{type:"boolean",defaultValue:false},title:{type:"string",group:"Appearance",defaultValue:""},noDialog:{type:"boolean",group:"Appearance",defaultValue:false}},aggregations:{content:{type:"sap.ui.mdc.base.FieldValueHelpContentWrapperBase",multiple:false},filterBar:{type:"sap.ui.core.Control",multiple:false},_dialog:{type:"sap.m.Dialog",multiple:false,visibility:"hidden"}},defaultAggregation:"content"}});f.prototype.init=function(){F.prototype.init.apply(this,arguments);this._oObserver=new M(_.bind(this));this._oObserver.observe(this,{properties:["filterValue","conditions","showConditionPanel","title","filterFields"],aggregations:["content","filterBar"]});};f.prototype.exit=function(){F.prototype.exit.apply(this,arguments);if(this._oManagedObjectModel){this._oManagedObjectModel.destroy();delete this._oManagedObjectModel;}this._oObserver.disconnect();this._oObserver=undefined;if(this._oFilterOperatorConfig){this._oFilterOperatorConfig.destroy();delete this._oFilterOperatorConfig;}};f.prototype.invalidate=function(i){if(i){var j=this.getAggregation("_dialog");var L=this.getFilterBar();if((j&&i===j)||(L&&i===L)){if(i.bOutput&&!this._bIsBeingDestroyed){var P=this.getParent();if(P){P.invalidate(this);}}return;}}F.prototype.invalidate.apply(this,arguments);};f.prototype.connect=function(i){if(this._oField&&this._oField!==i){if(this._oFilterConditionModel){this._oFilterConditionModel.removeFilterField(this);}}F.prototype.connect.apply(this,arguments);if(this._oFilterConditionModel){this._oFilterConditionModel.addFilterField(this);}I.call(this,this.getShowConditionPanel());return this;};f.prototype.getIcon=function(){if(this.getNoDialog()){return"sap-icon://slim-arrow-down";}else{return"sap-icon://value-help";}};f.prototype._createPopover=function(){var P=F.prototype._createPopover.apply(this,arguments);if(P){var i=this._getField();if(i){P.setInitialFocus(i);}var W=this.getContent();if(W){W.initialize(true);}P._getAllContent=function(){var j=this.getParent();var L=[];if(j){var N=K.call(j);if(N){L.push(N);}}return L;};if(this._bNavigate){this._bNavigate=false;this.navigate(this._iStep);this._iStep=null;}}return P;};f.prototype._handleAfterOpen=function(i){F.prototype._handleAfterOpen.apply(this,arguments);var W=this.getContent();if(W){W.fieldHelpOpen(true);}};f.prototype.open=function(S){if(this.getNoDialog()&&!S){S=true;}var W=this.getContent();if(W&&W.getFilterEnabled()&&!this._oFilterConditionModel){r.call(this);}var P=this.getAggregation("_popover");if(S){if(!W){this._bOpenIfContent=true;this.fireOpen({suggestion:S});}else{if(P){var i=this._getField();P.setInitialFocus(i);}W.fieldHelpOpen(S);F.prototype.open.apply(this,[S]);}}else{if(P){if(P.isOpen()){this.close();}P.$().remove();}var j=z.call(this);if(j){var L=j.getContent()[0];L.setShowTokenizer(this.getMaxConditions()!==1&&!!W);L.setFormatOptions(t.call(this));L.bindProperty("conditions",{path:"$help>/conditions"});this.fireOpen({suggestion:S});if(W){W.fieldHelpOpen(false);n.call(this);}this._aOldConditions=m([],this.getConditions());j.open();}else{this._bOpen=true;}}return;};f.prototype.toggleOpen=function(S){if(this.getNoDialog()&&!S){S=true;}if(S){F.prototype.toggleOpen.apply(this,[S]);}else{var i=z.call(this);if(i){if(i.isOpen()){var j=i.oPopup.getOpenState();if(j!=="CLOSED"&&j!=="CLOSING"){this.close();}else{this._bReopen=true;}}else{this.open(S);}}else{this._bOpen=!this._bOpen;}}};f.prototype.close=function(){if(!this._bDialogOpen){F.prototype.close.apply(this,arguments);}else{var i=this.getAggregation("_dialog");if(i){this._bClosing=true;i.close();var W=this.getContent();if(W){W.fieldHelpClose();var j=this._oFilterConditionModel.getAllConditions();var R=false;for(var L in j){if(j[L].length>0){R=true;break;}}if(R){this._oFilterConditionModel.removeAllConditions();p.call(this);}}}this._bReopen=false;}};f.prototype._handleAfterClose=function(i){F.prototype._handleAfterClose.apply(this,arguments);if(this._bUpdateFilterAfterClose){this._bUpdateFilterAfterClose=false;o.call(this,this._sFilterValueAfterClose);this._sFilterValueAfterClose=null;}var W=this.getContent();if(W){W.fieldHelpClose();}};function _(i){if(i.name==="content"){y.call(this,i.mutation,i.child);}if(i.name==="filterBar"){J.call(this,i.mutation,i.child);}if(i.name==="conditions"){l.call(this,i.current);}if(i.name==="filterValue"){if(this._bClosing){this._bUpdateFilterAfterClose=true;this._sFilterValueAfterClose=i.current;}else{o.call(this,i.current);}}if(i.name==="showConditionPanel"){I.call(this,i.current);}if(i.name==="title"){var j=this.getAggregation("_dialog");if(j){j.setTitle(i.current);}}if(i.name==="filterFields"){var j=this.getAggregation("_dialog");if(j){var L=j.getContent()[0];L.bindProperty("filterConditions",{path:"filter>/conditions/"+i.current});}}}f.prototype.openByTyping=function(){return true;};f.prototype.navigate=function(S){var W=this.getContent();var P;if(W){P=this._getPopover();}if(!P){this._bNavigate=true;this._iStep=S;if(!W){this.fireOpen({suggestion:true});}return;}else if(!P.isOpen()){this.fireOpen({suggestion:true});}if(W){W.navigate(S);}};function g(i){var P=this._getPopover();var j=i.getParameter("key");var L=i.getParameter("description");var N;if(!P.isOpen()){this.open(true);}N=C.createItemCondition(j,L);this.setProperty("conditions",[N],true);this.fireNavigate({value:L,key:j});}f.prototype.getTextForKey=function(i){var T="";var W=this.getContent();if(W){T=W.getTextForKey(i);}return T;};f.prototype.getKeyForText=function(T){var i;var W=this.getContent();if(W){i=W.getKeyForText(T);}return i;};function h(L){var S=L.getParameter("selectedItems");var N;var P=m([],this.getConditions());var Q;var i=0;var j=0;var R=false;var T=this.getMaxConditions();for(i=P.length-1;i>=0;i--){Q=P[i];if(Q.operator==="EEQ"||Q.operator==="EQ"){R=false;for(j=0;j<S.length;j++){N=S[j];if(Q.values[0]===N.key){R=true;break;}}if(!R){P.splice(i,1);}}}for(i=0;i<S.length;i++){N=S[i];R=false;for(j=0;j<P.length;j++){Q=P[j];if((Q.operator==="EEQ"||Q.operator==="EQ")&&Q.values[0]===N.key){R=true;break;}}if(!R){Q=C.createItemCondition(N.key,N.description);P.push(Q);}}if(T>0&&P.length>T){P.splice(0,P.length-T);}if(this._bDialogOpen){this.setProperty("conditions",P,true);}else{this.close();this.setProperty("conditions",P,true);this.fireSelect({conditions:P,add:true});}}function k(i){if(i.getParameter("contentChange")){var P=this.getAggregation("_popover");var j=this.getAggregation("_dialog");var W=this.getContent();if(W){if(P&&this._bOpenIfContent){var L=this._getField();if(L){W.fieldHelpOpen(true);P.openBy(L);}this._bOpenIfContent=false;}else if(j){var N=j.getContent()[0];x.call(this,N,W.getDialogContent());}if(this._oFilterConditionModel&&W.getListBinding()!==this._oFilterConditionModel._oListBinding){this._oFilterConditionModel.destroy();this._oFilterConditionModel=undefined;}if(W.getFilterEnabled()&&!this._oFilterConditionModel){r.call(this);}}}this.fireDataUpdate();}function l(i){n.call(this);}function n(){if(!this._oField){return;}var W=this.getContent();if(W){var j=this.getConditions();var L=[];for(var i=0;i<j.length;i++){var N=j[i];if(N.operator==="EEQ"||N.operator==="EQ"){L.push({key:N.values[0],description:N.values[1]});}}if(!d(L,W.getSelectedItems())){W.setSelectedItems(L);}}}function o(i){if(!this._oFilterConditionModel){return;}var j=this.getFilterFields();if(!j){return;}if(i){this._bOwnFilterChange=true;}this._oFilterConditionModel.removeAllConditions(j);if(i){this._bOwnFilterChange=false;var L=C.createCondition("StartsWith",[i]);this._oFilterConditionModel.addCondition(j,L);}}function p(){if(!this._oFilterConditionModel){return;}if(this._oFilterConditionModel._oListBinding.isSuspended()){this._oFilterConditionModel._oListBinding.resume();}this._oFilterConditionModel.applyFilters(true);}function q(i){if(this._bOwnFilterChange){return;}p.call(this);}function r(){if(!c&&!this._bFilterConditionModelRequested){c=sap.ui.require("sap/ui/mdc/base/ConditionModel");if(!c){sap.ui.require(["sap/ui/mdc/base/ConditionModel"],s.bind(this));this._bFilterConditionModelRequested=true;}}if(c){var i=this.getFilterValue();var W=this.getContent();var L=W&&W.getListBinding();if(L){this._oFilterConditionModel=c.getFor(L,this.getId());if(i){o.call(this,i);}var j=this._oFilterConditionModel.bindProperty("/conditions",this._oFilterConditionModel.getContext("/conditions"));j.attachChange(q.bind(this));this.setModel(this._oFilterConditionModel,"filter");}}}function s(i){c=i;this._bFilterConditionModelRequested=false;if(!this._bIsBeingDestroyed){r.call(this);}}f.prototype.getMaxConditions=function(){if(this._oField.getMaxConditions){return this._oField.getMaxConditions();}else{return 1;}};f.prototype.getDisplay=function(){if(this._oField.getDisplay){return this._oField.getDisplay();}};f.prototype.getRequired=function(){if(this._oField.getRequired){return this._oField.getRequired();}else{return false;}};f.prototype.getFilterOperatorConfig=function(){if(this._oField&&this._oField._getFilterOperatorConfig){return this._oField._getFilterOperatorConfig();}else if(this._oFilterOperatorConfig){return this._oFilterOperatorConfig;}else{this._oFilterOperatorConfig=a.getFor();return this._oFilterOperatorConfig;}};f.prototype.getDataType=function(){if(this._oField.getDataType){return this._oField.getDataType();}else{return"sap.ui.model.type.String";}};f.prototype._getDataType=function(){if(this._oField._getDataType){return this._oField._getDataType();}else{var i=O.get("sap.ui.model.odata.type.String");return new i();}};function t(){if(this._oField&&this._oField._getFormatOptions){return this._oField._getFormatOptions();}else{return{};}}f.prototype._getKeyPath=function(){var i=this.getKeyPath();if(!i&&this._oField&&this._oField.getFieldPath&&this._oField.getFieldPath()){i=this._oField.getFieldPath();}return i;};function u(){var i;if((!D||!B||!V||!b)&&!this._bDialogRequested){D=sap.ui.require("sap/m/Dialog");B=sap.ui.require("sap/m/Button");V=sap.ui.require("sap/ui/mdc/base/ValueHelpPanel");b=sap.ui.require("sap/ui/mdc/base/DefineConditionPanel");e=sap.ui.require("sap/ui/model/base/ManagedObjectModel");if(!D||!B||!V||!b||!c){sap.ui.require(["sap/m/Dialog","sap/m/Button","sap/ui/mdc/base/ValueHelpPanel","sap/ui/mdc/base/DefineConditionPanel","sap/ui/model/base/ManagedObjectModel"],v.bind(this));this._bDialogRequested=true;}}if(D&&B&&V&&b&&!this._bDialogRequested){if(!this._oResourceBundle){this._oResourceBundle=sap.ui.getCore().getLibraryResourceBundle("sap.ui.mdc");}var j=new B(this.getId()+"-ok",{text:this._oResourceBundle.getText("valuehelp.OK"),press:A.bind(this)});var L=new B(this.getId()+"-cancel",{text:this._oResourceBundle.getText("valuehelp.CANCEL"),press:E.bind(this)});this._oManagedObjectModel=new e(this);var N=w.call(this);i=new D(this.getId()+"-dialog",{contentHeight:"600px",contentWidth:"1000px",horizontalScrolling:false,verticalScrolling:false,title:this.getTitle(),resizable:true,draggable:true,content:[N],afterOpen:G.bind(this),afterClose:H.bind(this),buttons:[j,L]});this.setAggregation("_dialog",i,true);i.setModel(new sap.ui.model.resource.ResourceModel({bundleName:"sap/ui/mdc/messagebundle",async:false}),"$i18n");I.call(this,this.getShowConditionPanel());}return i;}function v(i,j,L,N,P){D=i;B=j;V=L;b=N;e=P;this._bDialogRequested=false;if(!this._bIsBeingDestroyed){u.call(this);if(this._bOpen){this.open();delete this._bOpen;}}}function w(){var W=this.getContent();var i=this.getFilterBar();var j=new V(this.getId()+"-VHP",{height:"100%",showFilterbar:!!i,filterConditions:{path:"filter>/conditions/"+this.getFilterFields()},formatOptions:t.call(this)});j.setModel(this._oManagedObjectModel,"$help");if(W){W.initialize(false);x.call(this,j,W.getDialogContent());}if(i){j.setFilterbar(i);}return j;}function x(i,j){i.setTable(j);}function y(i,W){var P=this.getAggregation("_popover");var j=this.getAggregation("_dialog");if(i==="remove"){W.detachEvent("navigate",g,this);W.detachEvent("selectionChange",h,this);W.detachEvent("dataUpdate",k,this);W=undefined;}else{W.attachEvent("navigate",g,this);W.attachEvent("selectionChange",h,this);W.attachEvent("dataUpdate",k,this);n.call(this);}this.fireDataUpdate();if(this._bNavigate){this._bNavigate=false;this.navigate(this._iStep);this._iStep=null;}else if(P){P.invalidate();var L=this.getFilterValue();if(L){o.call(this,L);}if(W&&W.getFilterEnabled()&&!this._oFilterConditionModel){r.call(this);}if(W&&this._bOpenIfContent){W.initialize(true);var N=this._getField();if(N){W.fieldHelpOpen(true);P.openBy(N);}this._bOpenIfContent=false;}}else if(W&&this._bOpenIfContent){this._bOpenIfContent=false;this.open(true);}if(j){if(W){W.initialize(false);if(W.getFilterEnabled()&&!this._oFilterConditionModel){r.call(this);}var Q=j.getContent()[0];x.call(this,Q,W.getDialogContent());if(j.isOpen()){W.fieldHelpOpen(false);}}}}function z(){var i=this.getAggregation("_dialog");if(!i){i=u.call(this);}return i;}function A(i){this.close();var j=this.getAggregation("_dialog");var L=j.getContent()[0];L.unbindProperty("conditions",true);var N=this.getConditions();N=C._removeEmptyConditions(N);this._bNoConditionModelUpdate=true;this.setProperty("conditions",N,true);this.fireSelect({conditions:N,add:false});}function E(i){this.close();var j=this.getAggregation("_dialog");var L=j.getContent()[0];L.unbindProperty("conditions",true);this.setProperty("conditions",this._aOldConditions,true);}function G(i){this._bDialogOpen=true;}function H(i){this._bDialogOpen=false;this._aOldConditions=undefined;var W=this.getContent();if(W){W.fieldHelpClose();}this._handleAfterClose(i);}function I(i){var j=this.getAggregation("_dialog");if(j&&this._oField){var L=j.getContent()[0];if(i&&this._oField._getOnlyEEQ&&!this._oField._getOnlyEEQ()){if(!L._oDefineConditionPanel){var N=new b(this.getId()+"-DCP");L.setDefineConditions(N);}}else{L.setDefineConditions();}}}function J(i,j){if(i==="remove"){j=undefined;}var L=this.getAggregation("_dialog");if(L){var N=L.getContent()[0];N.setFilterbar(j);N.setShowFilterbar(!!j);}}function K(){var W=this.getContent();if(W){return W.getSuggestionContent();}}return f;},true);
