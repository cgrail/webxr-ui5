/*
 * ! SAPUI5

		(c) Copyright 2009-2019 SAP SE. All rights reserved
	
 */
sap.ui.define(['sap/ui/core/XMLComposite','sap/ui/mdc/library','sap/m/HBox','sap/m/VBox','sap/m/Text','sap/m/Image','sap/m/Link','./ILinkHandler','sap/ui/comp/personalization/Controller','sap/ui/comp/personalization/SelectionWrapper','sap/ui/comp/personalization/ColumnWrapper','sap/ui/core/CustomData','sap/base/Log','sap/m/SelectDialog','sap/m/StandardListItem','./SelectionDialog','./SelectionDialogItem','sap/ui/model/json/JSONModel','sap/ui/model/BindingMode','sap/ui/base/ManagedObjectObserver','sap/ui/mdc/flexibility/PanelItem.flexibility','sap/ui/mdc/flexibility/Panel.flexibility'],function(X,m,H,V,T,I,L,a,C,S,b,c,d,e,f,g,h,J,B,M,P,i){"use strict";var j=X.extend("sap.ui.mdc.base.info.Panel",{metadata:{library:"sap.ui.mdc",designtime:"sap/ui/mdc/designtime/base/info/Panel.designtime",defaultAggregation:"items",properties:{enablePersonalization:{type:"boolean",defaultValue:true,invalidate:true},metadataHelperPath:{type:"string"}},aggregations:{items:{type:"sap.ui.mdc.base.info.PanelItem",multiple:true,singularName:"item"},extraContent:{type:"sap.ui.core.Control",multiple:true,forwarding:{idSuffix:"--idSectionExtraContent",aggregation:"items"}}},events:{beforeSelectionDialogOpen:{},afterSelectionDialogClose:{}}}});j.prototype.init=function(){X.prototype.init.call(this);var o=new J({countMainItems:0,countNonMainItemsWithIcon:0,countNonMainItemsWithoutIcon:0,showResetEnabled:false,runtimeItems:[]});o.setDefaultBindingMode(B.TwoWay);o.setSizeLimit(1000);this.setModel(o,"$sapuimdcbaseinfoPanel");this._oObserver=new M(_.bind(this));this._oObserver.observe(this,{aggregations:["items"]});};j.prototype.exit=function(o){if(this._oObserver){this._oObserver.disconnect();this._oObserver=null;}};j.prototype.onPressLinkPersonalization=function(){this.openSelectionDialog(false,true,undefined);};j.prototype.openSelectionDialog=function(F,s,k){this.fireBeforeSelectionDialogOpen();return sap.ui.getCore().loadLibrary('sap.ui.fl',{async:true}).then(function(){sap.ui.require(['sap/ui/fl/FlexControllerFactory','sap/ui/fl/ControlPersonalizationAPI','sap/ui/fl/Utils',this.getMetadataHelperPath()||"sap/ui/mdc/base/info/ContentHandler"],function(l,n,U,o){return l.createForControl(this).waitForChangesToBeApplied(this).then(function(){return new Promise(function(r){var p=o.retrieveAllMetadata(this).filter(function(y){return y.isMain!==true;});var q=p.some(function(y){return!!y.icon;});var t=o.retrieveBaseline(this);var u=p.map(function(y){var z=j._getItemById(y.id,t);y.visible=z?z.visible:false;return y;});var v=jQuery.extend(true,[],this._getInternalModel().getProperty("/runtimeItems")).filter(function(y){return y.isMain!==true;});var w=function(x){x.close();x.destroy();this.fireAfterSelectionDialogClose();}.bind(this);var R=[];var A=function(K,y){R.push({id:K,visible:y});};var x=new g({showItemAsLink:!F,showReset:s,showResetEnabled:{path:'$selectionDialog>/showResetEnabled'},items:p.map(function(y){var z=j._getItemById(y.id,v);var D=y.icon;if(q&&!D){D="sap-icon://chain-link";}return new h({key:y.id,text:y.text,description:y.description,href:y.href,target:y.target,icon:D,visible:z?z.visible:false});}),visibilityChanged:function(E){A(E.getParameter("key"),E.getParameter("visible"));this._getInternalModel().setProperty("/showResetEnabled",!j._isEqual(u,j._convertSelectionDialogItems2MItems(x.getItems())));}.bind(this),ok:function(){w(x);var y=U.getAppComponentForControl(this);var z=i.createChanges(this,y,R);var D=[];n.addPersonalizationChanges({controlChanges:z,ignoreVariantManagement:true}).then(function(E){D=D.concat(E);var G=P.createChanges(R);return n.addPersonalizationChanges({controlChanges:G,ignoreVariantManagement:true});}).then(function(E){D=D.concat(E);return n.saveChanges(D,y);}).then(function(){return r(true);});}.bind(this),cancel:function(){w(x);return r(true);},reset:function(){x.getItems().forEach(function(y){var z=j._getItemById(y.getKey(),u);if(z.visible!==y.getVisible()){A(z.id,z.visible);}y.setVisible(z?z.visible:false);});}});if(k){x.addStyleClass(k);}this._getInternalModel().setProperty("/showResetEnabled",!j._isEqual(u,j._convertSelectionDialogItems2MItems(x.getItems())));jQuery.sap.syncStyleClass("sapUiSizeCompact",this,x);x.setModel(this._getInternalModel(),"$selectionDialog");this.addDependent(x);x.open();}.bind(this));}.bind(this));}.bind(this));}.bind(this));};j._getItemById=function(s,A){return A.filter(function(o){return o.id===s;})[0];};j._getDiffToBase=function(k,l){if(!l||!k||k.length!==l.length){return false;}return l.filter(function(o){var n=j._getItemById(o.id,k);return o.id!==n.id||o.visible!==n.visible;});};j._convertSelectionDialogItems2MItems=function(s){return s.map(function(o){return{id:o.getKey(),visible:o.getVisible()};});};j._isEqual=function(k,l){var n=j._getUnion(k,l);return j._getDiffToBase(n,k).length===0;};j._getUnion=function(k,l){if(!l){return jQuery.extend(true,[],k);}var u=jQuery.extend(true,[],l);k.forEach(function(o){var n=j._getItemById(o.id,u);if(!n){u.push(o);return;}if(n.visible===undefined&&o.visible!==undefined){n.visible=o.visible;}});return u;};j.prototype._getInternalModel=function(){return this.getModel("$sapuimdcbaseinfoPanel");};j.prototype._propagateDefaultIcon=function(s){if(!s){return;}var o=this._getInternalModel();o.getProperty("/runtimeItems").forEach(function(k,l){if(k.isMain===true||!!k.icon){return;}o.setProperty("/runtimeItems/"+l+"/icon","sap-icon://chain-link");});};function _(o){var k=this._getInternalModel();if(o.object.isA("sap.ui.mdc.base.info.Panel")){switch(o.name){case"items":var l=o.child?[o.child]:o.children;l.forEach(function(p){switch(o.mutation){case"insert":k.setProperty("/countMainItems",p.getIsMain()?k.getProperty("/countMainItems")+1:k.getProperty("/countMainItems"));if(!p.getIsMain()){k.setProperty("/countNonMainItemsWithIcon",p.getIcon()?k.getProperty("/countNonMainItemsWithIcon")+1:k.getProperty("/countNonMainItemsWithIcon"));k.setProperty("/countNonMainItemsWithoutIcon",p.getIcon()?k.getProperty("/countNonMainItemsWithoutIcon"):k.getProperty("/countNonMainItemsWithoutIcon")+1);}var r=k.getProperty("/runtimeItems/");r.splice(this.indexOfItem(p),0,p.getJson());k.setProperty("/runtimeItems",r);this._propagateDefaultIcon(k.getProperty("/countNonMainItemsWithIcon")>0&&k.getProperty("/countNonMainItemsWithoutIcon")>0);this._oObserver.observe(p,{properties:["visible"]});break;case"remove":this._oObserver.unobserve(p);d.error("Deletion of items is not supported yet");break;default:d.error("Mutation '"+o.mutation+"' is not supported yet.");}},this);break;default:d.error("The property or aggregation '"+o.name+"' has not been registered.");}}else if(o.object.isA("sap.ui.mdc.base.info.PanelItem")){switch(o.name){case"visible":var p=o.object;k.setProperty("/runtimeItems/"+this.indexOfItem(p)+"/visible",p.getVisible());break;default:d.error("The '"+o.name+"' of PanelItem is not supported yet.");}}}return j;},true);
