/*
 * ! SAPUI5

		(c) Copyright 2009-2019 SAP SE. All rights reserved
	
 */
sap.ui.define(['sap/ui/core/XMLComposite','sap/ui/model/Filter','sap/ui/model/FilterOperator','sap/ui/base/ManagedObjectObserver','sap/base/Log','sap/ui/Device','sap/ui/model/json/JSONModel','sap/ui/core/ResizeHandler'],function(X,F,c,M,L,D,J,R){"use strict";var V=X.extend("sap.ui.mdc.base.personalization.VisibilityPanel",{metadata:{library:"sap.ui.mdc",properties:{showReset:{type:"boolean",defaultValue:false,invalidate:true},showResetEnabled:{type:"boolean",defaultValue:false,invalidate:true}},associations:{source:{type:"sap.ui.core.Control"}},defaultAggregation:"items",aggregations:{items:{type:"sap.ui.mdc.base.personalization.VisibilityPanelItem",multiple:true,singularName:"item",invalidate:true}},events:{initialOrderChanged:{keys:{type:"string[]"}},visibilityChanged:{key:{type:"string"},visible:{type:"boolean"}},positionChanged:{key:{type:"string"},position:{type:"integer"}},reset:{}}}});V.prototype.init=function(){var d=new J(D);d.setDefaultBindingMode("OneWay");this.setModel(d,"device");this._sKeyOfMarkedItem=null;this.aFilters=[];this._oObserver=new M(_.bind(this));this._oObserver.observe(this,{properties:["showResetEnabled"]});var s=this.byId("idScrollContainer");this._fnHandleResize=function(){var C=false;if(!this.getParent){return C;}var p=this.getParent();if(!p||!p.$){return C;}var t=this._getCompositeAggregation().getContent()[0];var $=p.$("cont");var i,h;if($.children().length>0&&t.$().length>0){var S=s.$()[0].clientHeight;i=$.children()[0].clientHeight;h=t?t.$()[0].clientHeight:0;var a=i-h;if(S!==a){s.setHeight(a+'px');C=true;}}return C;}.bind(this);this._sContainerResizeListener=R.register(s,this._fnHandleResize);};V.prototype.open=function(){this.initialize();this._getCompositeAggregation().openBy(sap.ui.getCore().byId(this.getSource()));};V.prototype.initialize=function(){this._removeMarkedStyleFromTableItem(this._getMarkedTableItem());this._updateCountOfItems();this.fireInitialOrderChanged({keys:this._getInitialItemOrder()});var t=this._getVisibleTableItems()[0];this._toggleMarkedTableItem(t);this._updateEnableOfMoveButtons(t);};V.prototype.close=function(){this._getCompositeAggregation().close();};V.prototype.onDrop=function(e){this._moveTableItem(e.getParameter("draggedControl"),e.getParameter("droppedControl"));};V.prototype.onDragStart=function(e){this._toggleMarkedTableItem(e.getParameter("target"));};V.prototype.onSelectionChange=function(e){e.getParameter("listItems").forEach(function(t){this._selectTableItem(t);},this);};V.prototype.onItemPressed=function(e){var t=e.getParameter('listItem');this._toggleMarkedTableItem(t);this._updateEnableOfMoveButtons(t);};V.prototype.onSearchFieldLiveChange=function(e){var s=e.getSource();this._defineTableFiltersByText(s?s.getValue():"");this._filterTable(this.aFilters);};V.prototype.onPressButtonMoveToTop=function(){this._moveTableItem(this._getMarkedTableItem(),this._getVisibleTableItems()[0]);};V.prototype.onPressButtonMoveUp=function(){var v=this._getVisibleTableItems();this._moveTableItem(this._getMarkedTableItem(),v[v.indexOf(this._getMarkedTableItem())-1]);};V.prototype.onPressButtonMoveDown=function(){var v=this._getVisibleTableItems();this._moveTableItem(this._getMarkedTableItem(),v[v.indexOf(this._getMarkedTableItem())+1]);};V.prototype.onPressButtonMoveToBottom=function(){var v=this._getVisibleTableItems();this._moveTableItem(this._getMarkedTableItem(),v[v.length-1]);};V.prototype.onPressReset=function(){this._removeMarkedStyleFromTableItem(this._getMarkedTableItem());this.fireReset();};V.prototype._selectTableItem=function(t){this._toggleMarkedTableItem(t);this._updateEnableOfMoveButtons(t);this._updateCountOfItems();this.fireVisibilityChanged({key:this._getKeyByTableItem(t),visible:t.getSelected()});};V.prototype._moveTableItem=function(t,T){this._removeMarkedStyleFromTableItem(this._getMarkedTableItem());this.firePositionChanged({key:this._getKeyByTableItem(t),position:this._getItemPositionOfKey(this._getKeyByTableItem(T))});this._filterTable(this.aFilters);this._toggleMarkedTableItem(this._getMarkedTableItem());this._updateEnableOfMoveButtons(this._getMarkedTableItem());};V.prototype._getInitialItemOrder=function(){var k=this.getItems().filter(function(i){return i.getVisible();}).map(function(i){return i.getKey();});var K=this.getItems().filter(function(i){return!i.getVisible();}).sort(function(a,b){if(a.getText()<b.getText()){return-1;}else if(a.getText()>b.getText()){return 1;}else{return 0;}}).map(function(i){return i.getKey();});return k.concat(K);};V.prototype._isFilteredByShowSelected=function(){return false;};V.prototype._getSearchText=function(){var s=this.byId("idSearchField")||null;return s?s.getValue():"";};V.prototype._getTable=function(){return this.byId("idList")||null;};V.prototype._getTableBinding=function(){return this._getTable().getBinding("items");};V.prototype._getTableBindingContext=function(){return this._getTableBinding().getContexts();};V.prototype._setMarkedTableItem=function(t){this._sKeyOfMarkedItem=this._getKeyByTableItem(t);};V.prototype._getMarkedTableItem=function(){return this._getTableItemByKey(this._sKeyOfMarkedItem);};V.prototype._getVisibleTableItems=function(){return this._getTable().getItems().filter(function(t){return!!t.getVisible();});};V.prototype._getSelectedTableItems=function(){return this._getTable().getItems().filter(function(t){return!!t.getSelected();});};V.prototype._getTableItemByKey=function(k){var C=this._getTableBindingContext();var t=this._getTable().getItems().filter(function(T,i){return C[i].getObject().getKey()===k;});return t[0];};V.prototype._getKeyByTableItem=function(t){var i=this._getTable().indexOfItem(t);return i<0?null:this._getTableBindingContext()[i].getObject().getKey();};V.prototype._getItemPositionOfKey=function(k){return this.getItems().indexOf(this._getItemByKey(k));};V.prototype._getItemByKey=function(k){var i=this.getItems().filter(function(I){return I.getKey()===k;});return i[0];};V.prototype._defineTableFiltersByText=function(s){this.aFilters=[];if(this._isFilteredByShowSelected()===true){this.aFilters.push(new sap.ui.model.Filter("visible","EQ",true));}if(s){this.aFilters.push(new F([new F("text",c.Contains,s)],false));}};V.prototype._filterTable=function(f){this._removeMarkedStyleFromTableItem(this._getMarkedTableItem());this._getTableBinding().filter(f);this._toggleMarkedTableItem(this._getMarkedTableItem());this._updateEnableOfMoveButtons(this._getMarkedTableItem());};V.prototype._toggleMarkedTableItem=function(t){this._removeMarkedStyleFromTableItem(this._getMarkedTableItem());var k=this._getKeyByTableItem(t);if(k){this._setMarkedTableItem(t);this._addMarkedStyleToTableItem(t);}};V.prototype._addMarkedStyleToTableItem=function(t){if(t){t.addStyleClass("sapUiMdcPersonalizationDialogMarked");}};V.prototype._removeMarkedStyleFromTableItem=function(t){if(t){t.removeStyleClass("sapUiMdcPersonalizationDialogMarked");}};V.prototype._setFocus=function(i){i.getDomRef().focus();};V.prototype._updateCountOfItems=function(){this._getManagedObjectModel().setProperty("/@custom/countOfSelectedItems",this._getSelectedTableItems().length);};V.prototype._updateEnableOfMoveButtons=function(t){var v=this._getVisibleTableItems();var e=v.indexOf(t)>0;if(this._getManagedObjectModel().getProperty("/@custom/isMoveUpButtonEnabled")===true&&e===false){this._setFocus(t);}this._getManagedObjectModel().setProperty("/@custom/isMoveUpButtonEnabled",e);e=v.indexOf(t)>-1&&v.indexOf(t)<v.length-1;if(this._getManagedObjectModel().getProperty("/@custom/isMoveDownButtonEnabled")===true&&e===false){this._setFocus(t);}this._getManagedObjectModel().setProperty("/@custom/isMoveDownButtonEnabled",e);};V._getItemByKey=function(k,a){return a.filter(function(m){return m.key===k;})[0];};function _(C){if(C.object.isA("sap.ui.mdc.base.personalization.VisibilityPanel")){switch(C.name){case"showResetEnabled":if(C.current===false&&C.old===true){this._setFocus(this._getCompositeAggregation());}break;default:L.error("The property or aggregation '"+C.name+"' has not been registered.");}}}return V;},true);
