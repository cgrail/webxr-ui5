/*!
 * SAPUI5

		(c) Copyright 2009-2019 SAP SE. All rights reserved
	
 */
sap.ui.define(['sap/ui/model/json/JSONModel',"sap/base/util/array/diff","sap/m/Button"],function(J,d,B){"use strict";var U={showP13nSort:function(s,b,D,c,C){this._showDialog(s,b,D,c,C,"Sort");},_showDialog:function(s,o,D,c,C,p){return new Promise(function(r,e){var i=jQuery.sap.getUriParameters().get("P13nModal")==="true";sap.ui.require(i?['sap/m/Dialog','sap/ui/mdc/base/personalization/'+p+'Panel','sap/ui/mdc/base/personalization/'+p+'PanelItem']:['sap/m/ResponsivePopover','sap/ui/mdc/base/personalization/'+p+'Panel','sap/ui/mdc/base/personalization/'+p+'PanelItem'],function(f,P,g){o.items.sort(function(a,b){if(a.label<b.label){return-1;}else if(a.label>b.label){return 1;}else{return 0;}});var I=o.items.filter(function(m){return!this._getArrayElementByKey(m.name,D.items);}.bind(this));Object.assign(D,{items:D.items.concat(I)});this.oJSONModelRuntime=new J(D);this.oControl=c;var A=this._setAttributes(g,C,i,p);var h=new P(A);h.setModel(this.oJSONModelRuntime,"$sapuimdc"+p+"Panel");var j=this._createDialog(f,h,i,this.oJSONModelRuntime,c,"sort.PERSONALIZATION_DIALOG_TITLE",C);c.addDependent(j);if(i){j.open();}else{j.openBy(s);}}.bind(this));}.bind(this));},_setAttributes:function(P,c,i,p){this.fnHandleChange=function(C){c(C);};var a={showReset:false,showResetEnabled:{path:'$sapuimdc'+p+'Panel>/showResetEnabled'},items:{path:'$sapuimdc'+p+'Panel>/items',templateShareable:false,template:new P({name:'{$sapuimdc'+p+'Panel>name}',label:'{$sapuimdc'+p+'Panel>label}',tooltip:'{$sapuimdc'+p+'Panel>tooltip}',sortOrder:'{$sapuimdc'+p+'Panel>sortOrder}',selected:'{$sapuimdc'+p+'Panel>selected}'})},change:i?function(){}:this._registerChangeEvent.bind(this)};return a;},_registerChangeEvent:function(){var c=[],e,s=[],S;e=this._getFlexData(this.oControl,"Sort");this.oJSONModelRuntime.getData().items.forEach(function(o){if(!o.selected){return;}var a={name:o.name,sortOrder:o.sortOrder};s.push(a);});S=function(o){return o.name+o.sortOrder;};c=this._processResult(e,s,S,this.oControl,"removeSort","addSort");this.fnHandleChange(c);},_createDialog:function(C,p,i,j,c,m,f){var o;var D=jQuery.extend(true,{},j.getProperty("/"));var r=sap.ui.getCore().getLibraryResourceBundle("sap.ui.mdc");if(!i){p.initialize();o=new C({title:r.getText(m),horizontalScrolling:false,verticalScrolling:false,contentWidth:"25rem",resizable:true,placement:"HorizontalPreferredRight",content:p,afterClose:function(){f([]);}});}else{p.initialize();o=new C({title:r.getText(m),horizontalScrolling:false,contentWidth:"40rem",contentHeight:"55rem",draggable:true,resizable:true,stretch:"{device>/system/phone}",content:p,buttons:[new B({text:r.getText("p13nDialog.OK"),type:"Emphasized",press:function(){this._registerChangeEvent();o.close();o.destroy();}.bind(this)}),new B({text:r.getText("p13nDialog.CANCEL"),press:function(){o.close();o.destroy();j.setProperty("/",jQuery.extend(true,{},D));f([]);}})]});}o.addStyleClass("sapUiMdcPersonalizationDialog");o.toggleStyleClass("sapUiSizeCompact",!!jQuery(c.getDomRef()).closest(".sapUiSizeCompact").length);return o;},_processResult:function(e,c,s,C,r,i){var R=d(e,c,s);var m=function(f,A){return A.filter(function(E){return E&&(E.name===f.name);})[0];};var a=[];var p=e.slice(0);R.forEach(function(o){if(o.type==="delete"&&p[o.index]===undefined){p.splice(o.index,1);return;}var E;if(o.type==="insert"){E=m(c[o.index],p);if(E){E.index=p.indexOf(E);p.splice(E.index,1,undefined);a.push({selectorControl:C,changeSpecificData:{changeType:r,content:E}});}}var P=o.type==="delete"?p[o.index]:c[o.index];P.index=o.index;if(o.type==="delete"){p.splice(P.index,1);}else{p.splice(P.index,0,P);}a.push({selectorControl:C,changeSpecificData:{changeType:o.type==="delete"?r:i,content:P}});});return a;},_getArrayElementByKey:function(k,a){var e=a.filter(function(E){return E.name!==undefined&&E.name===k;});return e.length?e[0]:null;},_getFlexData:function(c,t){var f=c.data("$p13n"+t),v,s=[];if(typeof f==="string"){f=f.replace(/\\{/g,"{");v=JSON.parse(f);}if(v){s=v;}return s;},handleUserChanges:function(c,C){return new Promise(function(r,a){sap.ui.require(["sap/ui/fl/ControlPersonalizationAPI"],function(b){b.addPersonalizationChanges({controlChanges:c}).then(function(D){r(D);});});});}};return U;});
