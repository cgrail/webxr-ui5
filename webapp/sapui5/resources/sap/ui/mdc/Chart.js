/*!
 * SAPUI5

		(c) Copyright 2009-2019 SAP SE. All rights reserved
	
 */
sap.ui.define(['sap/ui/mdc/Control','sap/m/Title','./ActionToolbar','sap/m/OverflowToolbarButton','sap/m/OverflowToolbarToggleButton','sap/ui/base/ManagedObjectObserver','sap/ui/model/json/JSONModel','sap/ui/mdc/library','sap/ui/model/base/ManagedObjectModel','sap/ui/model/Sorter','sap/base/Log','sap/base/util/deepEqual'],function(B,T,A,O,a,M,J,b,c,S,L,d){"use strict";var C,e,f,g,D,h,F,l;var m=B.extend("sap.ui.mdc.Chart",{metadata:{library:"sap.ui.mdc",defaultAggregation:"items",properties:{header:{type:"string",group:"Misc",defaultValue:null},chartType:{type:"string",group:"Misc",defaultValue:"column"},selectionMode:{type:"string",group:"Misc",defaultValue:"MULTIPLE"},showZoomButtons:{type:"boolean",group:"Misc",defaultValue:true},conditionModelName:{type:"string",defaultValue:null},showLegendButton:{type:"boolean",group:"Misc",defaultValue:true},legendVisible:{type:"boolean",group:"Misc",defaultValue:true},vizProperties:{type:"object",group:"Misc"},_colorings:{type:"object",visibility:"_hidden",byValue:true}},aggregations:{data:{multiple:true},items:{type:"sap.ui.mdc.chart.Item",multiple:true},actions:{type:"sap.ui.core.Control",multiple:true,forwarding:{idSuffix:"--toolbar",aggregation:"actions"}},_chart:{type:"sap.chart.Chart",multiple:false},_toolbar:{type:"sap.ui.mdc.ActionToolbar",multiple:false},selectionDetailsActions:{type:"sap.ui.mdc.chart.SelectionDetailsActions",multiple:false},uiState:{type:"sap.ui.mdc.base.state.UiState",multiple:false}},events:{selectionDetailsActionPressed:{parameters:{action:{type:"sap.ui.core.Item"},itemContexts:{type:"sap.ui.model.Context"},level:{type:"sap.m.SelectionDetailsActionLevel"}}}}},renderer:function(r,o){r.write("<div");r.writeControlData(o);r.writeAccessibilityState(o);r.writeClasses();r.addStyle("flex",1);if(o.getHeight()){r.addStyle("height",o.getHeight());}if(o.getWidth()){r.addStyle("width",o.getWidth());}r.writeStyles();r.write(">");var t=o.getAggregation("_toolbar");if(t){r.renderControl(t);}var i=o.getAggregation("_chart");if(i){r.renderControl(i);}r.write("</div>");},init:function(){this._oObserver=new M(this.update.bind(this));this._oObserver.observe(this,{aggregations:["items","_chart"],properties:["fullScreen"]});this._oManagedObjectModel=new c(this);this.setModel(this._oManagedObjectModel,"$mdcChart");this.attachModelContextChange(this._onModelContextChange,this);if(!this.oDelegatePromise){this.setMetadataDelegate("/sap/ui/mdc/ChartDelegate");}},applySettings:function(s){s=s||{};var j=s.actions||[];delete s.actions;this.oChartPromise=this._getLibraryPromise().then(function(){if(!this._bIsBeingDestroyed){return this.oDelegatePromise.then(function(o){return o.fetchProperties(this.getCollectionModel(),this.getCollectionPath());}.bind(this)).then(function(p){var I={};for(var i=0;i<p.length;i++){I[p[i].name]=p[i];}this._createToolbar(j);return this._createInnerChart(s,I);}.bind(this));}else{return null;}}.bind(this));B.prototype.applySettings.apply(this,[s]);},bindAggregation:function(n,o){if(n=="data"){this.oDataInfo=o;var i=this.getAggregation("_chart");if(i){i.bindAggregation("data",o);}else{this.oChartPromise.then(function(i){i.bindAggregation("data",this.oDataInfo);}.bind(this));}return this;}return B.bindAggregation(n,o);},getBindingInfo:function(n){if(n=="data"){return this.oDataInfo;}return B.prototype.getBindingInfo.apply(this,[n]);},setLegendVisible:function(v){this.setVizProperties({'legend':{'visible':v},'sizeLegend':{'visible':v}});return this.setProperty("legendVisible",v);},_createInnerChart:function(s,I){var k={},o,v=[],n=[],p=[],V={};k.chartType='{$mdcChart>/chartType}';k.dimensions=[];k.measures=[];k.id=this.getId()+"--innerChart";k.height='100%';k.width='100%';k.vizProperties='{$mdcChart>/vizProperties}';s.items=s.items||[];function q(j){if(this&&this.getVizItemType()=="Dimension"){k.dimensions.push(j);}else{k.measures.push(j);}}function r(o,u){if(o.getCriticality()){u._addCriticality(o);}p.push(o.getKey());if(o.getAdditionalColoringMeasures){for(var j=0;j<o.getAdditionalColoringMeasures().length;j++){if(n.indexOf(o.getAdditionalColoringMeasures()[j])==-1){n.push(o.getAdditionalColoringMeasures()[j]);}}}}function t(j){var K,u;for(var i=0;i<n.length;i++){K=n[i];if(p.indexOf(K)==-1){u=j.retrieveAggregationItem("items",I[K]);u=l.getVizItemSettings(u.settings);v.push(l.createVizChartItem(u).then(q));}}}for(var i=0;i<s.items.length;i++){o=s.items[i];r(o,this);if(I[o.getKey()]){V=this.DELEGATE.retrieveAggregationItem("items",I[o.getKey()]).settings;}else{V=undefined;}v.push(o.toVizChartItem(V).then(q.bind(o)));}t(this.DELEGATE);var w=new Promise(function(j){sap.ui.require(["sap/ui/fl/FlexControllerFactory","sap/ui/fl/Utils"],function(u,U){if(!U.getAppComponentForControl(this)){return Promise.resolve();}u.createForControl(this).waitForChangesToBeApplied(this).then(function(){return j();});}.bind(this));}.bind(this));return Promise.all(v,w).then(function(){var j=new C(k);j.setVisibleDimensions([]);j.setVisibleMeasures([]);j.setInResultDimensions([]);j.setLayoutData(new F({growFactor:1,shrinkFactor:1,baseSize:"auto"}));this._oObserver.observe(j,{bindings:["data"],aggregations:["dimensions","measures"]});this.setAggregation("_chart",j);return j;}.bind(this));},setSelectionMode:function(v){var o=this.getAggregation("_chart");if(o){o.setSelectionMode(v);if(v!=="NONE"){this._prepareSelection();}}else{this.oChartPromise.then(function(o){if(o){o.setSelectionMode(v);if(v!=="NONE"){this._prepareSelection();}}}.bind(this));}return this.setProperty("selectionMode",v,true);},_getLibraryPromise:function(){if(!this.oChartLibPromise){this.oChartLibPromise=new Promise(function(r,i){if(!C){sap.ui.require(["sap/chart/Chart","sap/ui/mdc/chart/ChartTypeButton","sap/m/FlexItemData","sap/ui/mdc/chart/MeasureItem"],function(m,j,k,n){C=m;h=j;e=sap.ui.getCore().getLibraryResourceBundle("sap.chart.messages");f=sap.ui.getCore().getLibraryResourceBundle("sap.ui.mdc");F=k;l=n;r(true);});}else{r(true);}});}return this.oChartLibPromise;},addItem:function(i,s){var o=this.getAggregation("_chart");if(o){i.toChart(o);}else{this.oChartPromise.then(function(o){if(o){this.toChart(o);}}.bind(i));}this._oObserver.observe(i,{properties:["visible","inResult","role"]});return this.addAggregation("items",i,s);},insertItem:function(i,I,s){if(i.getCriticality()){this._addCriticality(i);}var o=this.getAggregation("_chart");if(o){i.toChart(o);}else{this.oChartPromise.then(function(o){if(o){this.toChart(o);}}.bind(i));}this._oObserver.observe(i,{properties:["visible","inResult","role"]});return this.insertAggregation("items",i,I,s);},removeItem:function(i,s){this._oObserver.unobserve(i);return this.removeAggregation("items",i,s);}});m.prototype.exit=function(){var o=this.getAggregation("_chart");this.detachModelContextChange(this._onModelContextChange,this);if(o){o.destroy();}else{this._bIsBeingDestroyed=true;this.oChartPromise.then(function(o){o?o.destroy():null;});}B.prototype.exit.apply(this,[]);};m.prototype._createToolbar=function(u){if(!this.getAggregation("_toolbar")){this._oTitle=new T(this.getId()+"-title",{text:this.getHeader()});this._oDrillDownBtn=new O(this.getId()+"-drillDown",{icon:"sap-icon://drill-down",text:"View By",tooltip:"View By",press:[this._showDrillDown,this]});var p=new O(this.getId()+"-chart_settings",{icon:"sap-icon://action-settings",tooltip:f.getText('chart.PERSONALIZATION_DIALOG_TITLE'),press:function(E){var s=E.getSource();sap.ui.require(["sap/ui/mdc/base/personalization/Controller","sap/ui/mdc/flexibility/Chart.flexibility","sap/ui/mdc/flexibility/ChartItem.flexibility"],function(i,j,k){this._getP13nStateOfChart().then(function(n){i.showChartDialog(s,n.initialData,n.runtimeData,this,function(q){q.forEach(function(r){switch(r.changeType){case"hideItemOrRevealItem":i.addChangeHideItemOrRevealItem(j,k,r,false);break;case"setRole":i.addChangeSetRole(j,k,r,false);break;case"moveItem":i.addChangeMoveItem(j,k,r,false);break;default:L.error("ChangeType "+r.changeType+" is not supported yet.");}});});}.bind(this));}.bind(this));}.bind(this)});var P=new O(this.getId()+"-sort_settings",{icon:"sap-icon://sort",tooltip:f.getText('sort.PERSONALIZATION_DIALOG_TITLE'),press:function(E){var s=E.getSource();sap.ui.require(["sap/ui/mdc/p13n/Util"],function(U){this._getP13nStateOfSort().then(function(i){U.showP13nSort(s,i.baseData,i.runtimeData,this,function(j){U.handleUserChanges(j,this);}.bind(this));}.bind(this));}.bind(this));}.bind(this)});var o=new O(this.getId()+"-filter_settings",{icon:"sap-icon://filter",tooltip:f.getText('filter.PERSONALIZATION_DIALOG_TITLE'),press:function(E){var s=E.getSource();sap.ui.require(["sap/ui/mdc/base/personalization/Controller","sap/ui/mdc/flexibility/Chart.flexibility"],function(i,j){this._getP13nStateOfFilter().then(function(k){i.showFilterDialog(s,k.initialData,k.runtimeData,k.runtimeData.modelName,k.runtimeData.model,this,function(n){n.forEach(function(q){i.addChange(j,q.changeType,q,false);});});}.bind(this));}.bind(this));}.bind(this)});this.oZoomInButton=new O({tooltip:f.getText("chart.TOOLBAR_ZOOM_IN"),icon:"sap-icon://zoom-in",visible:"{$mdcChart>/showZoomButtons}",enabled:"{= ${$mdcChart>/_chart/getZoomInfo/enabled} && ${$mdcChart>/_chart/getZoomInfo/currentZoomLevel} < 1}",press:[function(){var i=this.getAggregation("_chart");i.zoom({direction:"in"});this._oManagedObjectModel.checkUpdate();},this]});this.oZoomOutButton=new O({tooltip:f.getText("chart.TOOLBAR_ZOOM_OUT"),icon:"sap-icon://zoom-out",enabled:"{= ${$mdcChart>/_chart/getZoomInfo/enabled} && ${$mdcChart>/_chart/getZoomInfo/currentZoomLevel} > 0}",visible:"{$mdcChart>/showZoomButtons}",press:[function(){var i=this.getAggregation("_chart");i.zoom({direction:"out"});this._oManagedObjectModel.checkUpdate();},this]});this.oFullScreenButton=new O({icon:"{= ${$mdcChart>/fullScreen} ? 'sap-icon://exit-full-screen' : 'sap-icon://full-screen'}",press:[function(){this.setFullScreen(!this.getFullScreen());this._oManagedObjectModel.checkUpdate(true);},this]});this.oLegendVisibleButton=new a({type:"Transparent",text:f.getText("chart.LEGENDBTN_TEXT"),tooltip:f.getText("chart.LEGENDBTN_TOOLTIP"),icon:"sap-icon://legend",pressed:"{$mdcChart>/legendVisible}",visible:"{$mdcChart>/showLegendButton}"});var t=new A(this.getId()+"--toolbar",{design:"Transparent",left:[this._oTitle],actions:u,right:[this.oZoomInButton,this.oZoomOutButton,this._oDrillDownBtn,this.oLegendVisibleButton,p,P,o,this.oFullScreenButton,new h(this)]});this.setAggregation("_toolbar",t);}};m.prototype._showDrillDown=function(){if(D){if(!this._oDrillDownPopover){D.createDrillDownPopover(this);}D.showDrillDownPopover(this,this.getMetadataDelegate());}else{sap.ui.require(["sap/ui/mdc/chart/DrillStackHandler"],function(i){D=i;D.createDrillDownPopover(this);D.showDrillDownPopover(this,this.getMetadataDelegate());}.bind(this));}};m.prototype._getP13nStateOfChart=function(){return this.oDelegatePromise.then(function(o){return o.fetchProperties(this.getCollectionModel(),this.getCollectionPath());}.bind(this)).then(function(p){var o={Dimension:[{key:b.ChartItemRoleType.category,text:f.getText('chart.PERSONALIZATION_DIALOG_CHARTROLE_CATEGORY')},{key:b.ChartItemRoleType.category2,text:f.getText('chart.PERSONALIZATION_DIALOG_CHARTROLE_CATEGORY2')},{key:b.ChartItemRoleType.series,text:f.getText('chart.PERSONALIZATION_DIALOG_CHARTROLE_SERIES')}],Measure:[{key:b.ChartItemRoleType.axis1,text:f.getText('chart.PERSONALIZATION_DIALOG_CHARTROLE_AXIS1')},{key:b.ChartItemRoleType.axis2,text:f.getText('chart.PERSONALIZATION_DIALOG_CHARTROLE_AXIS2')},{key:b.ChartItemRoleType.axis3,text:f.getText('chart.PERSONALIZATION_DIALOG_CHARTROLE_AXIS3')}]};var s=f.getText('chart.PERSONALIZATION_DIALOG_TYPE_DIMENSION');var i=f.getText('chart.PERSONALIZATION_DIALOG_TYPE_MEASURE');var I={};p.forEach(function(j){I[j.name]=j;});return{initialData:{items:p.map(function(j){return{id:undefined,key:j.name,text:j.label,tooltip:j.label,visible:j.visible?j.visible:false,type:j.kind===b.ChartItemType.Dimension?s:i,roleKey:j.role,availableRoles:o[j.kind]};})},runtimeData:{items:this.getItems().map(function(j){return{id:j.getId(),key:j.getKey(),text:j.getLabel()||I[j.getKey()].label,tooltip:j.getLabel()||I[j.getKey()].label,visible:j.getVisible(),type:j.getVizItemType()===b.ChartItemType.Dimension?s:i,roleKey:j.getRole(),availableRoles:o[j.getVizItemType()]};})}};}.bind(this));};m.prototype._getP13nStateOfSort=function(){return this.oDelegatePromise.then(function(o){return o.fetchProperties(this.getCollectionModel(),this.getCollectionPath());}.bind(this)).then(function(p){var s={};for(var i=0;i<p.length;i++){if(p[i].sortable&&this._aInResultProperties.indexOf(p[i].name)!=-1){s[p[i].name]=p[i];}}var G=function(K,I){var t;I.some(function(o){if(o.getKey()===K){t=o.getLabel();return true;}});return t||s[K].label;};var j=function(I){var P=[];for(var K in s){P.push({name:s[K].name,label:G(K,I),tooltip:G(K,I),sortOrder:undefined,selected:false});}return P;};var I=this.getItems();var k=this._getSorters()?this._getSorters():[];return{baseData:{items:j(I)},runtimeData:{items:k.map(function(o){return{name:o.sPath,label:G(o.sPath,I),tooltip:G(o.sPath,I),sortOrder:o.bDescending?"Descending":"Ascending",selected:true};})}};}.bind(this));};m.prototype._getP13nStateOfFilter=function(){return this.oDelegatePromise.then(function(o){return o.fetchProperties(this.getCollectionModel(),this.getCollectionPath());}.bind(this)).then(function(p){var i={};p.filter(function(o){return o.filterable;}).forEach(function(o){i[o.name]=o;});var G=function(k,I){var t;I.some(function(o){if(o.getKey()===k){t=o.getLabel();return true;}});return t||i[k].label;};var j=function(w,s,I){var P=[];for(var k in i){var n={key:i[k].name,text:G(k,I),tooltip:G(k,I)};if(w){var o=new sap.ui.mdc.base.FilterField({dataType:i[k].type,maxConditions:i[k].filterExpression,conditions:{path:s+">/conditions/"+i[k].name}});n.controls=[o];}P.push(n);}return P;};var I=this.getItems();var s=this.getConditionModelName();return{initialData:{items:j(false,s,I)},runtimeData:{modelName:s,model:s?this.getModel(s):null,items:j(true,s,I)}};}.bind(this));};m.prototype.getAvailableChartTypes=function(){var j=[];var o=this.getAggregation("_chart");if(o){var k=o.getAvailableChartTypes().available;if(j){for(var i=0;i<k.length;i++){var t=k[i].chart;j.push({key:t,icon:h.mMatchingIcon[t],text:e.getText("info/"+t),selected:(t==this.getChartType())});}}}return j;};m.prototype.getTypeInfo=function(){var t=this.getChartType();var i={icon:h.mMatchingIcon[t],text:f.getText("chart.CHART_TYPE_TOOLTIP",[t])};return i;};m.prototype.getManagedObjectModel=function(){return this._oManagedObjectModel;};m.prototype.update=function(o){var i=this.getAggregation("_chart");if(i){this._update(i,o);}else{this.oChartPromise.then(function(i){if(i){this._update(i,o);}}.bind(this));}};m.prototype._update=function(o,j){var I=this.getItems(),v,k,V=[],n=[],p=[],q={};if(j.name==="fullScreen"){this.invalidate();return;}if(j.name==="data"&&j.type==="binding"&&j.mutation==="prepare"&&j.object.isA("sap.chart.Chart")){j.bindingInfo.sorter=this._getSorters();}this._aInResultProperties=[];for(var i=0;i<I.length;i++){k=I[i];v=k.getVizItemType()=="Measure"?o.getMeasureByName(k.getKey()):o.getDimensionByName(k.getKey());if(!v){continue;}if(k.getVisible()){if(k.getVizItemType()=="Measure"){V.push(v.getName());if(k.getDataPoint()){q[v.getName()]=k.getDataPoint();}}else{n.push(v.getName());}this._aInResultProperties.push(v.getName());}if(k.getVizItemType()=="Dimension"){if(k.getInResult()){p.push(v.getName());this._aInResultProperties.push(v.getName());}}}var r=false;if(!d(n,o.getVisibleDimensions())){o.setVisibleDimensions(n);r=true;}if(!d(V,o.getVisibleMeasures())){o.setVisibleMeasures(V);r=true;}if(!d(p,o.getInResultDimensions())){o.setInResultDimensions(p);r=true;}if(r){this._rebind();this._updateSemanticalPattern(o,V,q);this._updateColoring(o,n,V);}};m.prototype._updateSemanticalPattern=function(o,v,i){for(var k=0;k<v.length;k++){var j=i[v[k]];if(j){if(j.targetValue||j.foreCastValue){var n=o.getMeasureByName(v[k]);n.setSemantics("actual");if(j.targetValue!=null){var r=o.getMeasureByName(j.targetValue);if(r){r.setSemantics("reference");}else{L.error("sap.ui.mdc.Chart: "+j.targetValue+" is not a valid measure");}}if(j.foreCastValue){var p=o.getMeasureByName(j.foreCastValue);if(p){p.setSemantics("projected");}else{L.error("sap.ui.comp.SmartChart: "+j.ForecastValue.Path+" is not a valid measure");}}n.setSemanticallyRelatedMeasures({referenceValueMeasure:j.targetValue,projectedValueMeasure:j.foreCastValue});}}}};m.prototype._updateColoring=function(o,v,V,i){var j=this.getProperty("_colorings"),k;if(j&&j.Criticality){var n;for(k=0;k<v.length;k++){if(j.Criticality.DimensionValues[v[k]]){n={coloring:"Criticality",parameters:{dimension:v[k]}};delete j.Criticality.MeasureValues;break;}}if(!n){delete j.Criticality.DimensionValues;for(var s in j.Criticality.MeasureValues){if(V.indexOf(s)==-1){delete j.Criticality.MeasureValues[s];}}n={coloring:"Criticality",parameters:{measure:V}};}if(n){o.setColorings(j);o.setActiveColoring(n);}}};m.prototype._prepareSelection=function(){if(g){g.prepareChart(this);}else{if(!this.oSelectionHandlerPromise){this.oSelectionHandlerPromise=new Promise(function(r,i){sap.ui.require(["sap/ui/mdc/chart/SelectionHandler"],function(j){g=j;r(true);});});}this.oSelectionHandlerPromise.then(function(){g.prepareChart(this);}.bind(this));}};m.prototype._getSorters=function(){var s=[],p,v,j,o,k;p=this.data("$p13nSort");if(typeof p==="string"){p=p.replace(/\\{/g,"{");v=JSON.parse(p);}if(v){s=v;}for(var i=0;i<s.length;i++){o=s[i];if(this._aInResultProperties.indexOf(o.name)!=-1){k=new S(o.name,o.sortOrder==="Descending");if(j){j.push(k);}else{j=[k];}}}return j;};m.prototype._getSelectOptions=function(){return!this.getUiState()?[]:this.getUiState().getSelectOptions().map(function(s){return{propertyName:s.getPropertyName(),conditions:s.getCustomData("conditions")[0].getValue().conditions};});};m.prototype._applyFilters=function(o){this._getSelectOptions().forEach(function(s){o.removeAllConditions(s.propertyName);s.conditions.forEach(function(i){o.addCondition(s.propertyName,i);});});o.applyFilters();};m.prototype._rebind=function(){if(this.getAggregation("_chart")&&this.getAggregation("_chart").getBinding("data")){this.getAggregation("_chart").getBinding("data").sort(this._getSorters());}};m.prototype._onModelContextChange=function(){if(!this.getConditionModelName()||!this.getModel(this.getConditionModelName())){return;}this.detachModelContextChange(this._onModelContextChange,this);this._applyFilters(this.getModel(this.getConditionModelName()));};m.prototype.applyFiltersAfterChangesApplied=function(){if(this._bWaitForChangesToBeApplied){return;}this._bWaitForChangesToBeApplied=true;sap.ui.require(["sap/ui/fl/FlexControllerFactory"],function(i){i.createForControl(this).waitForChangesToBeApplied(this).then(function(){this._bWaitForChangesToBeApplied=false;this._rebind();if(!this.getConditionModelName()||!this.getModel(this.getConditionModelName())){L.error("sap.ui.mdc.Chart: no condition model obtained. Therefore flexibility changes for filtering can not be applied on Chart.");}else{this._applyFilters(this.getModel(this.getConditionModelName()));}}.bind(this));}.bind(this));};m.prototype._addCriticality=function(i){var o=this.getProperty("_colorings");o=o||{Criticality:{DimensionValues:{},MeasureValues:{}}};var j=i.getCriticality(),k={};if(i.getVizItemType()=="Dimension"){for(var K in j){k[K]={Values:j[K]};}o.Criticality.DimensionValues[i.getKey()]=k;}else{for(var K in j){k[K]=j[K];}o.Criticality.MeasureValues[i.getKey()]=k;}this.setProperty("_colorings",o);};m.prototype.getCollectionModel=function(){var o=this.getBindingInfo("data");return o?this.getModel(o.model):null;};m.prototype.getCollectionPath=function(){var o=this.getBindingInfo("data");return o?o.path+"/":null;};return m;},true);
