/*
 * ! SAPUI5

		(c) Copyright 2009-2019 SAP SE. All rights reserved
	
 */
sap.ui.define(['sap/ui/core/Control','./library','./ActionToolbar','sap/m/OverflowToolbarButton','sap/m/Text','sap/m/Title','sap/ui/core/format/NumberFormat','sap/ui/model/Sorter','sap/ui/core/dnd/DragDropInfo',"./TableSettings"],function(C,l,A,O,T,a,N,S,D,b){"use strict";var I,c,d,e,f;var g=l.SelectionMode;var h=l.TableType;var R=l.RowAction;var j=C.extend("sap.ui.mdc.Table",{library:"sap.ui.mdc",metadata:{designtime:"sap/ui/mdc/designtime/Table.designtime",specialSettings:{metadataContexts:{defaultValue:"{path:'',  name: 'collection'}"}},defaultAggregation:"columns",properties:{width:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:null,invalidate:true},height:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:null,invalidate:true},rowAction:{type:"sap.ui.mdc.RowAction[]"},p13nMode:{type:"sap.ui.mdc.TableP13nMode[]"},metadataDelegate:{type:"string",defaultValue:"sap/ui/mdc/TableDelegate"},header:{type:"string",group:"Misc",defaultValue:null},headerVisible:{type:"boolean",group:"Misc",defaultValue:true},initiallyVisibleFields:{type:"string[]"},selectionMode:{type:"sap.ui.mdc.SelectionMode",defaultValue:g.None},showRowCount:{type:"boolean",group:"Misc",defaultValue:true},type:{type:"sap.ui.mdc.TableType",defaultValue:h.Table},threshold:{type:"int",group:"Appearance",defaultValue:-1},noDataText:{type:"string"}},aggregations:{_content:{type:"sap.ui.core.Control",multiple:false,visibility:"hidden"},columns:{type:"sap.ui.mdc.Column",multiple:true},rows:{type:"sap.ui.base.ManagedObject",multiple:true},actions:{type:"sap.ui.core.Control",multiple:true,forwarding:{getter:"_createToolbar",aggregation:"actions"}}},events:{rowPress:{parameters:{bindingContext:{type:"sap.ui.model.Context"}}},selectionChange:{parameters:{bindingContext:{type:"sap.ui.model.Context"},selected:{type:"boolean"},selectAll:{type:"boolean"}}}}},constructor:function(){this._oTableReady=new Promise(this._resolveTable.bind(this));C.apply(this,arguments);this.bCreated=true;this._initializeContent(this.getType());},renderer:function(r,o){r.write("<div ");r.writeControlData(o);r.addClass("sapUiMdcTable");r.writeClasses();if(o.getHeight()){r.addStyle("height",o.getHeight());}if(o.getWidth()){r.addStyle("width",o.getWidth());}r.writeStyles();r.write(">");r.renderControl(o.getAggregation("_content"));r.write("</div>");}});j.prototype.done=function(){return this._oTableReady;};j.prototype._resolveTable=function(r,i){this._fResolve=r;this._fReject=i;};j.prototype.setType=function(t){var o=this.getType();if(t===o&&this._oTable){return this;}this.setProperty("type",t,true);if(this.bCreated){if(this._oTable){if(o==="ResponsiveTable"){this._oTable.setHeaderToolbar();}else{this._oTable.removeExtension(this._oToolbar);}this._oTable.destroy("KeepDom");this._bTableExists=false;this._oTableReady=new Promise(this._resolveTable.bind(this));}if(this._oTemplate){this._oTemplate.destroy();this._oTemplate=null;}this._initializeContent(t);}return this;};j.prototype.setSelectionMode=function(m){this.setProperty("selectionMode",m,true);if(this._oTable){if(this._bMobileTable){this._oTable.setMode(this._getSelectionMode());}else{this._oTable.setSelectionMode(this._getSelectionMode());}}return this;};j.prototype.setRowAction=function(i){var o=this.getRowAction();this.setProperty("rowAction",i,true);if(((i&&i.length)!=(o&&o.length))||o[0]!=i[0]){this._updateRowAction();}return this;};j.prototype.setP13nMode=function(m){var o=this.getP13nMode();this.setProperty("p13nMode",m,true);this._updatep13nSettings(o,m);return this;};j.prototype.setThreshold=function(t){this.setProperty("threshold",t,true);if(!this._oTable){return this;}t=this.getThreshold()>-1?this.getThreshold():undefined;if(this._bMobileTable){this._oTable.setGrowingThreshold(t);}else{this._oTable.setThreshold(t);}return this;};j.prototype.setNoDataText=function(n){this.setProperty("noDataText",n,true);if(!this._oTable){return this;}var s=this._getNoDataText();if(this._bMobileTable){this._oTable.setNoDataText(s);}else{this._oTable.setNoData(s);}return this;};j.prototype._getNoDataText=function(){if(!this._sFallbackNoData){var r=sap.ui.getCore().getLibraryResourceBundle("sap.ui.mdc");this._sFallbackNoData=r.getText("table.NO_DATA","No items available.");}return this.getNoDataText()||this._sFallbackNoData;};j.prototype._updateRowAction=function(){var i=this.getRowAction();var o;if(this._bMobileTable&&this._oTemplate){this._oTemplate.setType(this.hasListeners("rowPress")?"Active":"Inactive");}else if(this._oTable){o=this._oTable.getRowActionTemplate();if(o){o.destroy();}this._oTable.setRowActionTemplate();this._oTable.setRowActionCount();}if(i&&i.indexOf(R.Navigation)>-1){if(this._oTable){if(this._bMobileTable){this._oTemplate.setType(R.Navigation);}else{this._oTable.setRowActionTemplate(new e({items:[new f({type:R.Navigation,press:[this._onRowActionPress,this]})]}));this._oTable.setRowActionCount(1);}}}};j.prototype._initializeContent=function(t){if(!this.bColumnsOrdered){this.bColumnsOrdered=true;this._orderColumns();}var s=this.getMetadataDelegate();if(t==="Table"){this._loadGridTableLib().then(function(){sap.ui.require(["sap/ui/table/Table","sap/ui/table/Column","sap/ui/table/RowAction","sap/ui/table/RowActionItem",s],function(G,i,R,k,m){if(this.bIsDestroyed){return;}if(!this._bTableExists&&t===this.getType()){this._bMobileTable=false;this.oTableDelegate=m;I=G;c=i;e=R;f=k;this._createContent();this._bTableExists=true;}else{this._onAfterTableCreated();}}.bind(this));}.bind(this));}else if(t==="ResponsiveTable"){sap.ui.require(["sap/m/Table","sap/m/Column","sap/m/ColumnListItem",s],function(i,k,m,n){if(this.bIsDestroyed){return;}if(!this._bTableExists&&t===this.getType()){this._bMobileTable=true;this.oTableDelegate=n;I=i;c=k;d=m;this._createContent();this._bTableExists=true;}else{this._onAfterTableCreated();}}.bind(this));}};j.prototype._onAfterTableCreated=function(r){if(r&&this._fResolve){this._fResolve(this);}else if(this._fReject){this._fReject(this);}delete this._fResolve;delete this._fReject;};j.prototype._createContent=function(){this._createToolbar();this._createTable();this._updateRowAction();var m=this.getColumns();m.forEach(this._createInnerTableColumn,this);this._updatePopin();this.setAggregation("_content",this._oTable);this._onAfterTableCreated(true);this.rebindTable();};j.prototype.setHeader=function(t){this.setProperty("header",t,true);this._updateHeaderText();return this;};j.prototype.setHeaderVisible=function(v){this.setProperty("headerVisible",v,true);if(this._oTitle){this._oTitle.toggleStyleClass("sapMdcTableHeaderHidden",!this.getHeaderVisible());}return this;};j.prototype._createToolbar=function(){if(!this._oToolbar){this._oTitle=new a(this.getId()+"-title",{text:this.getHeader()});if(!this.getHeaderVisible()){this._oTitle.addStyleClass("sapMdcTableHeaderHidden");}this._oToolbar=new A(this.getId()+"-toolbar",{design:"Transparent",left:[this._oTitle],right:this._getP13nButtons()});}if(this._oToolbar){this._oToolbar.addStyleClass("sapMTBHeader-CTX");}return this._oToolbar;};j.prototype._getP13nButtons=function(){var r=sap.ui.getCore().getLibraryResourceBundle("sap.ui.mdc");var p=this.getP13nMode()||[],B=[];if(p.length>0){if(p.indexOf("Column")>-1){B.push(new O(this.getId()+"-settings",{icon:"sap-icon://table-column",text:r.getText("table.SETTINGS_COLUMN2","Add/Remove Columns"),press:[this._showSettings,this],tooltip:r.getText("table.SETTINGS_COLUMN2","Add/Remove Columns")}));}if(p.indexOf("Sort")>-1){B.push(new O(this.getId()+"-sort",{icon:"sap-icon://sort",text:r.getText("table.SETTINGS_SORT","Sort"),press:[this._showSort,this],tooltip:r.getText("table.SETTINGS_SORT","Sort")}));}}return B;};j.prototype._updatep13nSettings=function(o,m){if(this._oToolbar){var B=this._oToolbar.removeAllRight();if(B){B.forEach(function(k){k.destroy();});}B=this._getP13nButtons();B.forEach(function(k){this._oToolbar.addRight(k);},this);}if(this._oTable){var i=this._oTable.getDragDropConfig()[0];if(i){i.setEnabled((m||[]).indexOf("Column")>-1);}}};j.prototype._createTable=function(){var t=this.getThreshold()>-1?this.getThreshold():undefined;if(this._bMobileTable){this._oTable=new I(this.getId()+"-innerTable",{growing:true,sticky:["ColumnHeaders","HeaderToolbar"],itemPress:[this._onItemPress,this],selectionChange:[this._onSelectionChange,this],growingThreshold:t,mode:this._getSelectionMode(),noDataText:this._getNoDataText(),headerToolbar:this._oToolbar,ariaLabelledBy:[this._oTitle]});this._oTemplate=new d(this.getId()+"-innerTableRow");this._createColumn=j.prototype._createMobileColumn;this._sAggregation="items";this._oTable.bindRows=this._oTable.bindItems;}else{this._createColumn=j.prototype._createColumn;this._oTable=new I(this.getId()+"-innerTable",{enableBusyIndicator:true,enableColumnReordering:false,threshold:t,cellClick:[this._onCellClick,this],rowSelectionChange:[this._onRowSelectionChange,this],selectionMode:this._getSelectionMode(),visibleRowCountMode:"Auto",noData:this._getNoDataText(),extension:[this._oToolbar],ariaLabelledBy:[this._oTitle]});this._oTable.addStyleClass("sapUiTableFixedRowHeights");this._sAggregation="rows";}var o=new D({sourceAggregation:"columns",targetAggregation:"columns",dropPosition:"Between",enabled:(this.getP13nMode()||[]).indexOf("Column")>-1,drop:[this._onColumnRearrange,this]});o.bIgnoreMetadataCheck=true;this._oTable.addDragDropConfig(o);};j.prototype._onColumnRearrange=function(E){var o=E.getParameter("draggedControl");var i=E.getParameter("droppedControl");if(o===i){return;}var s=E.getParameter("dropPosition");var k=this._oTable.indexOfColumn(o);var m=this._oTable.indexOfColumn(i);var n=m+(s=="Before"?0:1)+(k<m?-1:0);b.moveColumn(this,k,n);};j.prototype._getInnerTableHeight=function(){return this._oTable.$(this._bMobileTable?"listUl":"sapUiTableCnt").height();};j.prototype._getSelectionMode=function(){var s=this.getSelectionMode();switch(s){case"Single":s=this._bMobileTable?"SingleSelectLeft":"Single";break;case"Multi":s=this._bMobileTable?"MultiSelect":"MultiToggle";break;default:s=g.None;}return s;};j.prototype._createInnerTableColumn=function(m){var o=this._createColumn(m);this._oTable.addColumn(o);};j.prototype._orderColumns=function(){var i,k=[],m=this.getColumns();m.forEach(function(o){i=o.getInitialIndex();if(i>-1){k.push({index:i,column:this.removeColumn(o)});}},this);k.sort(function(o,n){return o-n;});k.forEach(function(o){this.insertColumn(o.column,o.index);},this);};j.prototype._createColumn=function(m,i){var t=this._getColumnTemplate(m);if(t&&t.setWrapping){t.setWrapping(false);}return new c(m.getId()+"-innerColumn",{width:m.getWidth(),hAlign:m.getHAlign(),label:m.getHeader(),showSortMenuEntry:false,showFilterMenuEntry:false,sortProperty:m.getDataProperties()[0],filterProperty:m.getDataProperties()[0],template:t});};j.prototype._createMobileColumn=function(m,i){var o,k;o=new c(m.getId()+"-innerColumn",{width:m.getWidth(),hAlign:m.getHAlign(),header:new T(m.getId()+"-innerColumnHeader",{textAlign:m.getHAlign(),text:m.getHeader()})});k=this._getColumnTemplate(m);if(i>=0){this._oTemplate.insertCell(k,i);}else{this._oTemplate.addCell(k);}return o;};j.prototype._getColumnTemplate=function(m){var t=m.getTemplate(true);if(!t&&this.oTableDelegate){t=this.oTableDelegate.createColumnTemplate({name:m.getDataProperties()[0]});m.setTemplate(t);t=m.getTemplate(true);}return t;};j.prototype.removeColumn=function(m){m=this.removeAggregation("columns",m,true);if(this._oTable){var o=this._oTable.removeColumn(m.getId()+"-innerColumn");if(this._oTemplate){this._oTemplate.removeCell(m.getTemplate(true));}o.destroy();this._updatePopinDelayed();}return m;};j.prototype.addColumn=function(m){this.addAggregation("columns",m,true);if(this._oTable){var o=this._createColumn(m);this._oTable.addColumn(o);this._updatePopinDelayed();}return this;};j.prototype.insertColumn=function(m,i){this.insertAggregation("columns",m,i,true);if(this._oTable){var o=this._createColumn(m,i);this._oTable.insertColumn(o,i);this._updatePopinDelayed();}return this;};j.prototype._updatePopinDelayed=function(){if(this._bMobileTable){if(this._iPopinTimeout){clearTimeout(this._iPopinTimeout);}this._iPopinTimeout=setTimeout(this._updatePopin.bind(this),0);}};j.prototype._updatePopin=function(){delete this._iPopinTimeout;var k,m=0,s,n;if(this._bMobileTable&&this._oTable){k=this._oTable.getColumns();k.forEach(function(o,i){s=o.getWidth();if(s&&s.endsWith("em")){n=parseFloat(s);}else{n=10;}m+=n;o.setDemandPopin(!(i<2));o.setPopinDisplay("Inline");o.setMinScreenWidth(m+"rem");});}};j.prototype._onItemPress=function(E){this.fireRowPress({bindingContext:E.getParameter("listItem").getBindingContext()});};j.prototype._onSelectionChange=function(E){this.fireSelectionChange({bindingContext:E.getParameter("listItem").getBindingContext(),selected:E.getParameter("selected"),selectAll:E.getParameter("selectAll")});};j.prototype._loadGridTableLib=function(){if(!this._oGridTableLibLoaded){this._oGridTableLibLoaded=sap.ui.getCore().loadLibrary("sap.ui.table",true);}return this._oGridTableLibLoaded;};j.prototype._onCellClick=function(E){this.fireRowPress({bindingContext:E.getParameter("rowBindingContext")});};j.prototype._onRowActionPress=function(E){var r=E.getParameter("row");this.fireRowPress({bindingContext:r.getBindingContext()});};j.prototype._onRowSelectionChange=function(E){if(E.getParameter("userInteraction")){this.fireSelectionChange({bindingContext:E.getParameter("rowContext"),selected:E.getSource().isIndexSelected(E.getParameter("rowIndex")),selectAll:E.getParameter("selectAll")});}};j.prototype.getSelectedContexts=function(){var i;if(this._bMobileTable){i=this._oTable.getSelectedContexts();}else{i=this._oTable.getSelectedIndices().map(function(k){return this._oTable.getContextByIndex(k);},this);}return i;};j.prototype.bindAggregation=function(n,B){if(n==="rows"){return this.bindRows(B);}return C.prototype.bindAggregation.apply(this,arguments);};j.prototype.bindRows=function(B){this._oBindingInfo=B;if(this._oTable){if(this._bMobileTable&&this._oTemplate){B.template=this._oTemplate;}else{delete B.template;}if(!B.parameters){B.parameters={};}if(this.getShowRowCount()){j._addBindingListener(B,"dataReceived",this._onDataReceived.bind(this));j._addBindingListener(B,"change",this._updateHeaderText.bind(this));}this._updateColumnsBeforeBinding(B);this._oTable.bindRows(B);}return this;};j.prototype._onDataReceived=function(E){if(E&&E.getParameter&&E.getParameter("__simulateAsyncAnalyticalBinding")){return;}this._updateHeaderText();};j.prototype._updateHeaderText=function(){var H,r;if(this._oTitle&&this.getHeader()){H=this.getHeader();if(this.getShowRowCount()){r=this._getRowCount();if(r){H+=" ("+r+")";}}this._oTitle.setText(H);}};j.prototype._updateColumnsBeforeBinding=function(B){var s=[].concat(B.sorter||[]);var m=this.getColumns();var M=this._bMobileTable;m.forEach(function(o){var i=sap.ui.getCore().byId(o.getId()+"-innerColumn");if(M){i.setSortIndicator("None");}else{i.setSorted(false);}});s.forEach(function(o){var i=(o.bDescending)?"Descending":"Ascending";m.some(function(k){var n=sap.ui.getCore().byId(k.getId()+"-innerColumn");if(k.getDataProperties().indexOf(o.sPath)>-1){if(M){n.setSortIndicator(i);}else{n.setSorted(true).setSortOrder(i);}return true;}});});};j.prototype._getRowCount=function(){var r=this._getRowBinding(),i,v="";if(r){i=r.getLength();if(!this._oNumberFormatInstance){this._oNumberFormatInstance=N.getFloatInstance();}if(r.isLengthFinal()){v=this._oNumberFormatInstance.format(i);}}return v;};j.prototype._getRowBinding=function(){if(this._oTable){return this._oTable.getBinding(this._sAggregation);}};j._addBindingListener=function(B,E,H){if(!B.events){B.events={};}if(!B.events[E]){B.events[E]=H;}else{var o=B.events[E];B.events[E]=function(){H.apply(this,arguments);o.apply(this,arguments);};}};j.prototype._showSettings=function(E){this._showPanel("Columns",E.getSource());};j.prototype._showSort=function(E){this._showPanel("Sort",E.getSource());};j.prototype._showPanel=function(p,s){if(!this._settingsTriggered){this._settingsTriggered=true;b.showPanel(this,p,s).then(this._afterSettingsDone.bind(this));}};j.prototype.rebindTable=function(){if(!this._oBindingInfo){return;}this._oBindingInfo.sorter=this._getSorters();this.bindRows(this._oBindingInfo);};j.prototype._afterSettingsDone=function(){delete this._settingsTriggered;};j.prototype._getSorters=function(){if(!this.oTableDelegate){return[];}var s=this.oTableDelegate.getCurrentState(this).sorters;return s.map(function(o){return new S(o.name,o.sortOrder==="Descending");});};j.prototype.exit=function(){if(this._oTemplate){this._oTemplate.destroy();}this._oTemplate=null;this._oTable=null;this._oToolbar=null;this._oTitle=null;this._oNumberFormatInstance=null;this._oTableReady=null;this._oGridTableLibLoaded=null;this._fReject=null;this._fResolve=null;};return j;},true);
